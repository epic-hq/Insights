# Database & Storage Plan – Interview Insights

## Last updated: 2025-07-09

This document captures the agreed-upon architectural decisions for persistence, auth, media storage, and future analytics.

## 1. Stack Overview

| Layer | Choice | Rationale |
|-------|--------|----------|
| Relational DB | **Postgres (Supabase)** | Managed Postgres with integrated auth & RLS; fits structured research data. |
| Auth | **Supabase Auth** | Email / SSO; interviewer accounts map to `auth.users`. |
| Media Storage | **Cloudflare R2** | Low-cost object storage for large audio / video files. Supabase stores only signed-URL + metadata. |
| Vector Search (future) | **pgvector** extension on Supabase | Enables semantic similarity between themes / categories. |
| App Framework | **Remix (React Router 7)** | Universal React routing; fits Supabase + edge functions; allows o3/BAML processing in Remix actions/loaders. |

## 2. Tenancy & ACL Model

* Multi-tenant SaaS → every row scoped by `org_id` (UUID).
* `organizations` & `user_org_memberships` control membership & roles.
* Row-Level Security (RLS) policies restrict CRUD to members of the same `org_id`.
* Media ACL: files stored in R2 under path `org_id/<uuid>`.  Download/stream via **signed URLs** generated by a Supabase Edge Function that validates the caller’s JWT & org membership.

## 3. High-Level Entity Diagram

```text
organizations──┐
               ├─< user_org_memberships >─auth.users (interviewers)
               │
 research_projects──┐
                    ├─< interviews >─┐
                    │               ├─< media_files > (R2)
                    │               └─< transcripts >
                    │
 insignts──┐                ┌─< quotes >
           └─< insight_tags >──tags (global)

themes (flat)
personas (per org)
opportunities (per org)
```

## 4. Table Specifications (supabase schema `public`)

### 4.1  Core Multi-Tenant

`organizations`
| Column | Type | Notes |
| id | uuid PK | `gen_random_uuid()` |
| name | text | |
| created_at | timestamptz | default `now()` |

`user_org_memberships`
| user_id | uuid PK ↗ auth.users.id |
| org_id | uuid PK ↗ organizations.id |
| role | text | `owner`, `member` |
| joined_at | timestamptz default `now()` |

### 4.2  Research Projects

`research_projects`
| id | uuid PK |
| org_id | uuid FK |
| code | text | slug/short label e.g. `teacher_research` |
| title | text |
| description | text |
| created_at | timestamptz |

### 4.3  Interviews & Media

`interviews`
| id | uuid PK |
| org_id | uuid FK |
| project_id | uuid FK ↗ research_projects.id |
| title | text |
| interview_date | date |
| interviewer_id | uuid FK ↗ auth.users.id |
| participant_pseudonym | text |
| segment | text |
| duration_min | int |
| status | text `uploaded` / `transcribed` / `processed` |
| created_at | timestamptz |

`media_files`
| id | uuid PK |
| org_id | uuid FK |
| interview_id | uuid FK nullable |
| r2_path | text | `org_id/<uuid>` |
| file_name | text |
| mime_type | text |
| size_bytes | bigint |
| uploaded_by | uuid FK auth.users.id |
| uploaded_at | timestamptz |

`transcripts`
| id | uuid PK |
| org_id | uuid FK |
| interview_id | uuid FK |
| text | text |
| source_json | jsonb |
| created_at | timestamptz |

### 4.4  Qualitative Data

`insights`
| id | uuid PK |
| org_id | uuid FK |
| interview_id | uuid FK |
| tag | text |
| category | text |
| journey_stage | text |
| impact | smallint 1-5 |
| novelty | smallint 1-5 |
| jtbd | text |
| motivation | text |
| pain | text |
| desired_outcome | text |
| emotional_response | text low/neutral/high |
| opportunity_ideas | text[] |
| confidence | text low/medium/high |
| contradictions | text |
| embedding | vector (pgvector) NULL | semantic representation of insight text |
| created_at | timestamptz |

`quotes`
| id | uuid PK |
| org_id | uuid FK |
| insight_id | uuid FK |
| quote | text |
| timestamp_sec | int |
| created_at | timestamptz |

### 4.5  Themes & Categories (flat)

`themes`
| id | uuid PK |
| org_id | uuid FK |
| name | text |
| category | text | discrete, no parent |
| color_hex | text |
| embedding | vector | generated from `name` for similarity search |
| created_at | timestamptz |

Materialized view `theme_counts_mv` aggregates `insights` → themes for dashboard treemap.

### 4.6  Personas & Opportunities

`personas`
| id | uuid PK |
| org_id | uuid FK |
| name | text |
| description | text |
| percentage | numeric |
| color_hex | text |
| created_at | timestamptz |

`opportunities`
| id | uuid PK |
| org_id | uuid FK |
| title | text |
| owner_id | uuid FK auth.users.id nullable |
| kanban_status | text explore/validate/build |
| related_insight_ids | uuid[] |
| created_at | timestamptz |

### 4.7  Global Tag Glossary

`tags` (GLOBAL scope)
| tag | text PK |
| description | text |

`insight_tags`
| insight_id | uuid FK |
| tag | text FK tags.tag |

## 5. Vector Similarity (pgvector)

* Enable `CREATE EXTENSION IF NOT EXISTS pgvector;` on Supabase.
* Store `embedding` vectors for `themes` & optionally `insights`.
* Example query to populate embeddings with OpenAI:

  ```sql
  update themes
  set embedding = openai_embed(name)
  where embedding is null;
  ```

* Scatter-plot in the UI → fetch `SELECT id, name, embedding FROM themes` and apply PCA/UMAP in client.

## 6. Media Storage & Access Flow

1. Client obtains a pre-signed R2 upload URL via Edge Function (requires valid org JWT).
2. Upload audio/video directly to R2.
3. Edge Function stores `media_files` row with metadata.
4. Downloads/stream: client calls Edge Function → function returns short-lived signed URL after ACL check.

## 8. Transcript Processing Pipeline (o3 + BAML)

* Runs inside Remix **action** triggered after transcript generation.

* Steps:

  1. Pull transcript text from `transcripts.text`.
  2. Use **o3** with BAML schema to produce structured JSON for insights, quotes, themes.
  3. Insert/update rows in a single transaction via `@supabase/supabase-js`.

* Strong type-safety via BAML schemas; no separate Python service.

* Future: offload heavy workloads to a Supabase Edge Function/queue.

## 9. Migration & Seeding Strategy

* All DDL lives under `supabase/migrations` auto-generated via `supabase db diff`.  
* pgvector enabled in initial migration.
* Seed scripts insert default categories, sample tags, and demo personas for Storybook/testing.

---

Please **review** and confirm or suggest edits. Once approved I will:
1. Scaffold the Supabase migration SQL.
2. Add helper Edge Function stubs for R2 upload/download.
3. Wire the front-end data fetching to these tables.
