-- Migration: Populate all segment types from people attributes
-- Creates facet_account and person_facet entries for job_function, seniority_level,
-- title, industry, life_stage, and age_range

-- Step 1: Create facet_kind_global entries for all segment types
-- Using slug-based upsert to avoid ID conflicts
INSERT INTO facet_kind_global (slug, label, description, created_at, updated_at) VALUES
  ('job_function', 'Job Function', 'Department or functional role (Engineering, Product, Sales, etc.)', now(), now()),
  ('seniority_level', 'Seniority Level', 'Career level (C-Level, VP, Director, Manager, IC)', now(), now()),
  ('title', 'Job Title', 'Specific job titles', now(), now()),
  ('industry', 'Industry', 'Industry background (SaaS, FinTech, Healthcare, etc.)', now(), now()),
  ('life_stage', 'Life Stage', 'Life stage (Student, New Parent, Retiree, etc.)', now(), now()),
  ('age_range', 'Age Range', 'Age bracket (18-24, 25-34, 35-44, etc.)', now(), now())
ON CONFLICT (slug) DO UPDATE SET
  label = EXCLUDED.label,
  description = EXCLUDED.description,
  updated_at = now();

-- Step 2: Create facet_account entries for job_function
INSERT INTO facet_account (
  account_id,
  kind_id,
  slug,
  label,
  description,
  created_at,
  updated_at
)
SELECT DISTINCT
  p.account_id,
  (SELECT id FROM facet_kind_global WHERE slug = 'job_function') as kind_id,
  LOWER(REPLACE(TRIM(p.job_function), ' ', '-')) as slug,
  TRIM(p.job_function) as label,
  'Job function segment - auto-generated' as description,
  now() as created_at,
  now() as updated_at
FROM people p
WHERE p.job_function IS NOT NULL
  AND TRIM(p.job_function) != ''
  AND NOT EXISTS (
    SELECT 1 FROM facet_account fa
    JOIN facet_kind_global fkg ON fa.kind_id = fkg.id
    WHERE fa.account_id = p.account_id
      AND fkg.slug = 'job_function'
      AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.job_function), ' ', '-'))
  );

-- Step 3: Create facet_account entries for seniority_level
INSERT INTO facet_account (
  account_id,
  kind_id,
  slug,
  label,
  description,
  created_at,
  updated_at
)
SELECT DISTINCT
  p.account_id,
  3 as kind_id,
  LOWER(REPLACE(TRIM(p.seniority_level), ' ', '-')) as slug,
  TRIM(p.seniority_level) as label,
  'Seniority level segment - auto-generated' as description,
  now() as created_at,
  now() as updated_at
FROM people p
WHERE p.seniority_level IS NOT NULL
  AND TRIM(p.seniority_level) != ''
  AND NOT EXISTS (
    SELECT 1 FROM facet_account fa
    WHERE fa.account_id = p.account_id
      AND fa.kind_id = 3
      AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.seniority_level), ' ', '-'))
  );

-- Step 4: Create facet_account entries for title
INSERT INTO facet_account (
  account_id,
  kind_id,
  slug,
  label,
  description,
  created_at,
  updated_at
)
SELECT DISTINCT
  p.account_id,
  4 as kind_id,
  LOWER(REPLACE(TRIM(p.title), ' ', '-')) as slug,
  TRIM(p.title) as label,
  'Job title segment - auto-generated' as description,
  now() as created_at,
  now() as updated_at
FROM people p
WHERE p.title IS NOT NULL
  AND TRIM(p.title) != ''
  AND NOT EXISTS (
    SELECT 1 FROM facet_account fa
    WHERE fa.account_id = p.account_id
      AND fa.kind_id = 4
      AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.title), ' ', '-'))
  );

-- Step 5: Create facet_account entries for industry
INSERT INTO facet_account (
  account_id,
  kind_id,
  slug,
  label,
  description,
  created_at,
  updated_at
)
SELECT DISTINCT
  p.account_id,
  5 as kind_id,
  LOWER(REPLACE(TRIM(p.industry), ' ', '-')) as slug,
  TRIM(p.industry) as label,
  'Industry segment - auto-generated' as description,
  now() as created_at,
  now() as updated_at
FROM people p
WHERE p.industry IS NOT NULL
  AND TRIM(p.industry) != ''
  AND NOT EXISTS (
    SELECT 1 FROM facet_account fa
    WHERE fa.account_id = p.account_id
      AND fa.kind_id = 5
      AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.industry), ' ', '-'))
  );

-- Step 6: Create facet_account entries for life_stage
INSERT INTO facet_account (
  account_id,
  kind_id,
  slug,
  label,
  description,
  created_at,
  updated_at
)
SELECT DISTINCT
  p.account_id,
  6 as kind_id,
  LOWER(REPLACE(TRIM(p.life_stage), ' ', '-')) as slug,
  TRIM(p.life_stage) as label,
  'Life stage segment - auto-generated' as description,
  now() as created_at,
  now() as updated_at
FROM people p
WHERE p.life_stage IS NOT NULL
  AND TRIM(p.life_stage) != ''
  AND NOT EXISTS (
    SELECT 1 FROM facet_account fa
    WHERE fa.account_id = p.account_id
      AND fa.kind_id = 6
      AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.life_stage), ' ', '-'))
  );

-- Step 7: Create facet_account entries for age_range
INSERT INTO facet_account (
  account_id,
  kind_id,
  slug,
  label,
  description,
  created_at,
  updated_at
)
SELECT DISTINCT
  p.account_id,
  7 as kind_id,
  LOWER(REPLACE(TRIM(p.age_range), ' ', '-')) as slug,
  TRIM(p.age_range) as label,
  'Age range segment - auto-generated' as description,
  now() as created_at,
  now() as updated_at
FROM people p
WHERE p.age_range IS NOT NULL
  AND TRIM(p.age_range) != ''
  AND NOT EXISTS (
    SELECT 1 FROM facet_account fa
    WHERE fa.account_id = p.account_id
      AND fa.kind_id = 7
      AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.age_range), ' ', '-'))
  );

-- Step 8: Link people to job_function facets via person_facet
INSERT INTO person_facet (
  person_id,
  facet_account_id,
  account_id,
  project_id,
  source
)
SELECT DISTINCT
  p.id as person_id,
  fa.id as facet_account_id,
  p.account_id as account_id,
  e.project_id as project_id,
  'manual' as source
FROM people p
JOIN facet_account fa
  ON fa.account_id = p.account_id
  AND fa.kind_id = 2
  AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.job_function), ' ', '-'))
JOIN evidence_people ep ON ep.person_id = p.id
JOIN evidence e ON e.id = ep.evidence_id
WHERE p.job_function IS NOT NULL
  AND TRIM(p.job_function) != ''
ON CONFLICT (person_id, facet_account_id) DO NOTHING;

-- Step 9: Link people to seniority_level facets
INSERT INTO person_facet (
  person_id,
  facet_account_id,
  account_id,
  project_id,
  source
)
SELECT DISTINCT
  p.id as person_id,
  fa.id as facet_account_id,
  p.account_id as account_id,
  e.project_id as project_id,
  'manual' as source
FROM people p
JOIN facet_account fa
  ON fa.account_id = p.account_id
  AND fa.kind_id = 3
  AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.seniority_level), ' ', '-'))
JOIN evidence_people ep ON ep.person_id = p.id
JOIN evidence e ON e.id = ep.evidence_id
WHERE p.seniority_level IS NOT NULL
  AND TRIM(p.seniority_level) != ''
ON CONFLICT (person_id, facet_account_id) DO NOTHING;

-- Step 10: Link people to title facets
INSERT INTO person_facet (
  person_id,
  facet_account_id,
  account_id,
  project_id,
  source
)
SELECT DISTINCT
  p.id as person_id,
  fa.id as facet_account_id,
  p.account_id as account_id,
  e.project_id as project_id,
  'manual' as source
FROM people p
JOIN facet_account fa
  ON fa.account_id = p.account_id
  AND fa.kind_id = 4
  AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.title), ' ', '-'))
JOIN evidence_people ep ON ep.person_id = p.id
JOIN evidence e ON e.id = ep.evidence_id
WHERE p.title IS NOT NULL
  AND TRIM(p.title) != ''
ON CONFLICT (person_id, facet_account_id) DO NOTHING;

-- Step 11: Link people to industry facets
INSERT INTO person_facet (
  person_id,
  facet_account_id,
  account_id,
  project_id,
  source
)
SELECT DISTINCT
  p.id as person_id,
  fa.id as facet_account_id,
  p.account_id as account_id,
  e.project_id as project_id,
  'manual' as source
FROM people p
JOIN facet_account fa
  ON fa.account_id = p.account_id
  AND fa.kind_id = 5
  AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.industry), ' ', '-'))
JOIN evidence_people ep ON ep.person_id = p.id
JOIN evidence e ON e.id = ep.evidence_id
WHERE p.industry IS NOT NULL
  AND TRIM(p.industry) != ''
ON CONFLICT (person_id, facet_account_id) DO NOTHING;

-- Step 12: Link people to life_stage facets
INSERT INTO person_facet (
  person_id,
  facet_account_id,
  account_id,
  project_id,
  source
)
SELECT DISTINCT
  p.id as person_id,
  fa.id as facet_account_id,
  p.account_id as account_id,
  e.project_id as project_id,
  'manual' as source
FROM people p
JOIN facet_account fa
  ON fa.account_id = p.account_id
  AND fa.kind_id = 6
  AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.life_stage), ' ', '-'))
JOIN evidence_people ep ON ep.person_id = p.id
JOIN evidence e ON e.id = ep.evidence_id
WHERE p.life_stage IS NOT NULL
  AND TRIM(p.life_stage) != ''
ON CONFLICT (person_id, facet_account_id) DO NOTHING;

-- Step 13: Link people to age_range facets
INSERT INTO person_facet (
  person_id,
  facet_account_id,
  account_id,
  project_id,
  source
)
SELECT DISTINCT
  p.id as person_id,
  fa.id as facet_account_id,
  p.account_id as account_id,
  e.project_id as project_id,
  'manual' as source
FROM people p
JOIN facet_account fa
  ON fa.account_id = p.account_id
  AND fa.kind_id = 7
  AND LOWER(fa.slug) = LOWER(REPLACE(TRIM(p.age_range), ' ', '-'))
JOIN evidence_people ep ON ep.person_id = p.id
JOIN evidence e ON e.id = ep.evidence_id
WHERE p.age_range IS NOT NULL
  AND TRIM(p.age_range) != ''
ON CONFLICT (person_id, facet_account_id) DO NOTHING;

-- Step 14: Verify migration
DO $$
DECLARE
  persona_count INTEGER;
  job_function_count INTEGER;
  seniority_count INTEGER;
  title_count INTEGER;
  industry_count INTEGER;
  life_stage_count INTEGER;
  age_range_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO persona_count FROM facet_account WHERE kind_id = 1;
  SELECT COUNT(*) INTO job_function_count FROM facet_account WHERE kind_id = 2;
  SELECT COUNT(*) INTO seniority_count FROM facet_account WHERE kind_id = 3;
  SELECT COUNT(*) INTO title_count FROM facet_account WHERE kind_id = 4;
  SELECT COUNT(*) INTO industry_count FROM facet_account WHERE kind_id = 5;
  SELECT COUNT(*) INTO life_stage_count FROM facet_account WHERE kind_id = 6;
  SELECT COUNT(*) INTO age_range_count FROM facet_account WHERE kind_id = 7;

  RAISE NOTICE 'Segment type population summary:';
  RAISE NOTICE '  Personas: %', persona_count;
  RAISE NOTICE '  Job Functions: %', job_function_count;
  RAISE NOTICE '  Seniority Levels: %', seniority_count;
  RAISE NOTICE '  Titles: %', title_count;
  RAISE NOTICE '  Industries: %', industry_count;
  RAISE NOTICE '  Life Stages: %', life_stage_count;
  RAISE NOTICE '  Age Ranges: %', age_range_count;
  RAISE NOTICE 'Total facet_account entries: %', (persona_count + job_function_count + seniority_count + title_count + industry_count + life_stage_count + age_range_count);
END $$;
