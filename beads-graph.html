<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights | bv Graph</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-elevated: #252545;
            --bg-glass: rgba(26, 26, 46, 0.85);
            --fg: #e8e8f0;
            --fg-muted: #8888aa;
            --fg-dim: #555577;
            --purple: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.4);
            --pink: #ec4899;
            --cyan: #22d3ee;
            --green: #22c55e;
            --orange: #f97316;
            --red: #ef4444;
            --yellow: #eab308;
            --gold: #fbbf24;
            --gold-glow: rgba(251, 191, 36, 0.6);
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --shadow-glow: 0 0 40px var(--purple-glow);
            --radius: 12px;
            --radius-lg: 16px;
        }
        /* Light mode overrides */
        body.light-mode {
            --bg: #f8f9fc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f2f5;
            --bg-elevated: #e8eaf0;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --fg: #1a1a2e;
            --fg-muted: #555577;
            --fg-dim: #8888aa;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        body.light-mode #graph-container {
            background: radial-gradient(ellipse at center, #ffffff 0%, #f0f2f5 100%);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--purple);
            z-index: 100;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--purple), var(--pink));
            border-radius: var(--radius);
            display: flex; align-items: center; justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700; font-size: 16px;
            box-shadow: var(--shadow-glow);
        }
        h1 { font-size: 1.25rem; font-weight: 600; letter-spacing: -0.02em; }
        h1 span {
            background: linear-gradient(90deg, var(--purple), var(--pink), var(--cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }

        /* Toolbar */
        .toolbar { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .toolbar-group {
            display: flex; gap: 0.25rem;
            padding: 0.25rem;
            background: var(--bg);
            border-radius: var(--radius);
            border: 1px solid var(--bg-elevated);
        }
        button, select {
            font-family: inherit;
            font-size: 0.8rem;
            padding: 0.5rem 0.875rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        button { background: transparent; color: var(--fg-muted); }
        button:hover { background: var(--bg-elevated); color: var(--fg); transform: translateY(-1px); }
        button.active {
            background: linear-gradient(135deg, var(--purple), var(--pink));
            color: white;
            box-shadow: 0 4px 15px var(--purple-glow);
        }
        select {
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--bg-elevated);
            padding-right: 2rem;
        }
        select:focus { outline: none; border-color: var(--purple); box-shadow: 0 0 0 3px var(--purple-glow); }

        /* Search */
        .search-container { position: relative; }
        .search-input {
            font-family: inherit;
            font-size: 0.875rem;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--bg-elevated);
            border-radius: var(--radius);
            width: 280px;
            transition: all 0.2s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 0 3px var(--purple-glow);
            width: 320px;
        }
        .search-icon {
            position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%);
            color: var(--fg-muted); font-size: 0.875rem;
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-glass); backdrop-filter: blur(20px);
            border: 1px solid var(--purple); border-radius: var(--radius);
            margin-top: 0.5rem; max-height: 400px; overflow-y: auto;
            z-index: 1000; display: none; box-shadow: var(--shadow);
        }
        .search-results.visible { display: block; }
        .search-result-item {
            padding: 0.875rem 1rem; cursor: pointer;
            border-bottom: 1px solid var(--bg-elevated);
            transition: all 0.15s ease;
        }
        .search-result-item:hover { background: var(--bg-elevated); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-id { font-family: 'JetBrains Mono', monospace; color: var(--cyan); font-size: 0.8rem; font-weight: 600; }
        .search-result-title { font-size: 0.875rem; margin-top: 0.25rem; }
        .search-result-preview {
            font-size: 0.75rem; color: var(--fg-muted); margin-top: 0.5rem;
            max-height: 60px; overflow: hidden;
        }
        .search-result-preview p { margin: 0.25rem 0; }

        /* Main */
        main { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* Detail Sidebar (Left - Docked Mode) */
        #detail-sidebar {
            width: 420px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg) 100%);
            border-right: 1px solid var(--purple);
            overflow-y: auto; padding: 0;
            display: flex; flex-direction: column;
            transition: width 0.3s ease, opacity 0.3s ease;
        }
        #detail-sidebar.collapsed { width: 0; padding: 0; overflow: hidden; opacity: 0; }
        #detail-sidebar .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.25rem; background: var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-elevated);
            position: sticky; top: 0; z-index: 5;
        }
        #detail-sidebar .panel-header h3 {
            font-size: 0.9rem; font-weight: 600; color: var(--fg);
            display: flex; align-items: center; gap: 0.5rem;
        }
        #detail-sidebar .panel-header .icon { color: var(--gold); }
        .detach-btn {
            background: var(--bg-elevated); border: 1px solid var(--fg-dim);
            color: var(--fg-muted); padding: 0.375rem 0.75rem; border-radius: 6px;
            cursor: pointer; font-size: 0.75rem; transition: all 0.15s ease;
            display: flex; align-items: center; gap: 0.375rem;
        }
        .detach-btn:hover { background: var(--purple); color: white; border-color: var(--purple); }
        #detail-sidebar .no-selection {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; color: var(--fg-muted); text-align: center; padding: 2rem;
        }
        #detail-sidebar .no-selection-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        #detail-sidebar .no-selection-text { font-size: 0.875rem; }
        #detail-sidebar .detail-content { padding: 1.25rem; flex: 1; }

        #graph-wrapper { flex: 1; position: relative; }
        #graph-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, var(--bg-secondary) 0%, var(--bg) 100%);
        }

        /* Overlay Stats */
        .overlay-stats {
            position: absolute; top: 1rem; left: 1rem;
            background: var(--bg-glass); backdrop-filter: blur(15px);
            padding: 0.75rem 1rem; border-radius: var(--radius);
            font-size: 0.8rem; color: var(--fg-muted);
            z-index: 10; display: flex; gap: 1.25rem;
            border: 1px solid var(--bg-elevated);
            box-shadow: var(--shadow);
        }
        .overlay-stats .stat { display: flex; align-items: center; gap: 0.375rem; }
        .overlay-stats .stat-value { color: var(--cyan); font-weight: 600; font-family: 'JetBrains Mono', monospace; }

        /* Hover Panel - Full Details (Floating Mode) */
        #hover-panel {
            position: absolute; top: 1rem; left: 50%; transform: translateX(-50%);
            background: var(--bg-glass); backdrop-filter: blur(20px);
            border: 1px solid var(--gold); border-radius: var(--radius-lg);
            padding: 1.25rem; width: 500px; max-height: 70vh;
            overflow-y: auto; z-index: 50;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 60px var(--gold-glow);
            display: none;
        }
        #hover-panel.visible { display: block; animation: panelIn 0.2s ease-out; }
        #hover-panel.docked { display: none !important; } /* Hidden when docked mode active */
        @keyframes panelIn { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } }

        /* Docked Panel Content - inside detail-sidebar */
        #docked-panel {
            display: none;
        }
        #docked-panel.visible { display: block; }
        .hover-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .hover-id { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--cyan); font-weight: 600; }
        .hover-type-badge {
            padding: 0.25rem 0.625rem; border-radius: 6px;
            font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .hover-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; line-height: 1.4; }
        .hover-badges { display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 1rem; }
        .hover-section { margin-bottom: 1rem; }
        .hover-section-title {
            font-size: 0.7rem; font-weight: 600; color: var(--purple);
            text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;
            padding-bottom: 0.25rem; border-bottom: 1px solid var(--bg-elevated);
        }
        .hover-content { font-size: 0.875rem; color: var(--fg); line-height: 1.6; }
        .hover-content p { margin-bottom: 0.5rem; }
        .hover-content ul, .hover-content ol { margin-left: 1.25rem; margin-bottom: 0.5rem; }
        .hover-content code {
            background: var(--bg); padding: 0.125rem 0.375rem; border-radius: 4px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
        }
        .hover-content pre {
            background: var(--bg); padding: 0.75rem; border-radius: 8px;
            overflow-x: auto; margin: 0.5rem 0;
        }
        .hover-content pre code { padding: 0; background: none; }
        .hover-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.8rem; }
        .hover-meta-item { display: flex; flex-direction: column; }
        .hover-meta-label { color: var(--fg-muted); font-size: 0.7rem; }
        .hover-meta-value { font-weight: 500; }
        .hover-deps { display: flex; flex-wrap: wrap; gap: 0.375rem; }
        .hover-dep-chip {
            padding: 0.25rem 0.5rem; background: var(--bg);
            border-radius: 6px; font-size: 0.75rem; font-family: 'JetBrains Mono', monospace;
            cursor: pointer; transition: all 0.15s ease;
        }
        .hover-dep-chip:hover { background: var(--purple); color: white; }
        .hover-commits { max-height: 150px; overflow-y: auto; }
        .hover-commit {
            padding: 0.5rem; background: var(--bg); border-radius: 6px;
            margin-bottom: 0.375rem; font-size: 0.75rem;
        }
        .hover-commit-sha { font-family: 'JetBrains Mono', monospace; color: var(--cyan); }
        .hover-commit-msg { margin-top: 0.25rem; color: var(--fg-muted); }
        .hover-close {
            position: absolute; top: 0.75rem; right: 0.75rem;
            background: none; border: none; color: var(--fg-muted);
            cursor: pointer; font-size: 1.25rem; padding: 0.25rem;
        }
        .hover-close:hover { color: var(--fg); }

        /* Sidebar */
        #sidebar {
            width: 340px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg) 100%);
            border-left: 1px solid var(--purple);
            overflow-y: auto; padding: 1.25rem;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.625rem; }
        .stat-card {
            background: var(--bg-tertiary); padding: 0.875rem;
            border-radius: var(--radius); text-align: center;
            border: 1px solid var(--bg-elevated);
            transition: all 0.2s ease;
        }
        .stat-card:hover { border-color: var(--purple); transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-card .stat-value {
            font-size: 1.75rem; font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--green), var(--cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-card .stat-value.warning {
            background: linear-gradient(135deg, var(--orange), var(--red));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-card .stat-label {
            font-size: 0.7rem; color: var(--fg-muted);
            text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem;
        }

        /* Panels */
        .panel {
            background: var(--bg-tertiary); border-radius: var(--radius);
            padding: 1rem; border: 1px solid var(--bg-elevated);
        }
        .panel-title {
            font-size: 0.75rem; font-weight: 600; color: var(--purple);
            text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .panel-title::before {
            content: ''; width: 4px; height: 14px;
            background: linear-gradient(180deg, var(--purple), var(--pink));
            border-radius: 2px;
        }

        /* Legend */
        .legend { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .legend-item {
            display: flex; align-items: center; gap: 0.375rem;
            font-size: 0.75rem; color: var(--fg-muted);
            padding: 0.25rem 0.5rem; background: var(--bg); border-radius: 6px;
        }
        .legend-dot {
            width: 12px; height: 12px; border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        /* Triage Panel */
        .triage-item {
            padding: 0.75rem; background: var(--bg); border-radius: 8px;
            margin-bottom: 0.5rem; cursor: pointer; transition: all 0.15s ease;
            border-left: 3px solid var(--purple);
        }
        .triage-item:hover { transform: translateX(4px); border-left-color: var(--gold); }
        .triage-item-header { display: flex; justify-content: space-between; align-items: center; }
        .triage-item-id { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--cyan); font-weight: 600; }
        .triage-item-score { font-size: 0.7rem; color: var(--gold); font-weight: 600; }
        .triage-item-title { font-size: 0.8rem; margin-top: 0.25rem; }
        .triage-item-reason { font-size: 0.7rem; color: var(--fg-muted); margin-top: 0.375rem; }

        /* Badges */
        .badge {
            font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px;
            text-transform: uppercase; font-weight: 600; letter-spacing: 0.03em;
        }
        .badge-open { background: var(--green); color: var(--bg); }
        .badge-in_progress { background: var(--orange); color: var(--bg); }
        .badge-blocked { background: var(--red); color: white; }
        .badge-closed { background: var(--fg-dim); color: var(--bg); }
        .badge-type { background: var(--purple); color: white; }
        .badge-feature { background: linear-gradient(135deg, var(--purple), var(--pink)); color: white; }
        .badge-bug { background: var(--red); color: white; }
        .badge-task { background: var(--cyan); color: var(--bg); }
        .badge-epic { background: linear-gradient(135deg, var(--gold), var(--orange)); color: var(--bg); }
        .badge-articulation { background: linear-gradient(135deg, var(--pink), var(--purple)); color: white; animation: pulse 2s infinite; }
        .badge-critical { background: linear-gradient(135deg, var(--red), var(--orange)); color: white; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Node Detail */
        #node-detail { display: none; }
        #node-detail.visible { display: block; }
        .detail-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.75rem; }
        .detail-id { font-size: 1rem; font-weight: 700; color: var(--cyan); font-family: 'JetBrains Mono', monospace; }
        .detail-priority {
            padding: 0.25rem 0.625rem; border-radius: 6px;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        }
        .detail-name { font-size: 0.875rem; color: var(--fg); line-height: 1.5; margin-bottom: 0.625rem; }
        .detail-badges { display: flex; gap: 0.375rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .detail-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.375rem; font-size: 0.75rem; }
        .metric-item {
            display: flex; justify-content: space-between;
            padding: 0.375rem 0; border-bottom: 1px solid var(--bg-elevated);
        }
        .metric-label { color: var(--fg-muted); }
        .metric-value { color: var(--fg); font-weight: 500; font-family: 'JetBrains Mono', monospace; }
        .metric-value.highlight { color: var(--green); }
        .no-selection { text-align: center; padding: 2rem 1rem; color: var(--fg-muted); font-size: 0.8rem; }
        .no-selection-icon { font-size: 2rem; margin-bottom: 0.625rem; opacity: 0.4; }

        /* Shortcuts */
        .keyboard-hints { font-size: 0.75rem; color: var(--fg-muted); line-height: 1.8; }
        .keyboard-hints kbd {
            display: inline-block; background: var(--bg);
            padding: 0.2rem 0.5rem; border-radius: 4px;
            margin: 0 0.125rem; border: 1px solid var(--bg-elevated);
            font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
        }

        /* Footer */
        footer {
            background: var(--bg-tertiary); padding: 0.5rem 1.25rem;
            font-size: 0.75rem; color: var(--fg-muted);
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid var(--bg-elevated);
        }
        footer a { color: var(--cyan); text-decoration: none; transition: color 0.15s; }
        footer a:hover { color: var(--purple); }

        /* Toast */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--bg-glass); backdrop-filter: blur(15px);
            border: 1px solid var(--purple); padding: 0.75rem 1.5rem;
            border-radius: var(--radius); font-size: 0.875rem;
            z-index: 1000; box-shadow: var(--shadow);
            opacity: 0; transition: all 0.3s ease;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* Context Menu */
        .context-menu {
            position: fixed; background: var(--bg-glass); backdrop-filter: blur(20px);
            border: 1px solid var(--purple); border-radius: var(--radius);
            padding: 0.5rem 0; z-index: 1000; min-width: 200px;
            box-shadow: var(--shadow); display: none;
        }
        .context-menu.visible { display: block; animation: menuIn 0.15s ease-out; }
        @keyframes menuIn { from { opacity: 0; transform: scale(0.95); } }
        .context-menu-item {
            padding: 0.625rem 1rem; font-size: 0.8rem; cursor: pointer;
            display: flex; align-items: center; gap: 0.625rem; transition: all 0.1s;
        }
        .context-menu-item:hover { background: var(--bg-elevated); }
        .context-menu-divider { height: 1px; background: var(--bg-elevated); margin: 0.375rem 0; }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: absolute; top: 1rem; right: 1rem;
            background: var(--bg-glass); backdrop-filter: blur(10px);
            border: 1px solid var(--purple); color: var(--fg);
            padding: 0.5rem 0.75rem; border-radius: 8px;
            z-index: 10; cursor: pointer; font-size: 1rem;
            transition: all 0.2s ease;
        }
        .fullscreen-btn:hover { background: var(--bg-elevated); box-shadow: var(--shadow-glow); }

        /* Top Nodes Panel */
        .top-nodes-panel {
            position: absolute; top: 60px; right: 1rem;
            background: var(--bg-glass); backdrop-filter: blur(15px);
            border: 1px solid var(--purple); border-radius: var(--radius);
            padding: 0.75rem; z-index: 10; max-height: 250px;
            overflow-y: auto; width: 220px; display: none;
        }
        .top-nodes-panel.visible { display: block; }
        .top-node-item {
            padding: 0.5rem; font-size: 0.75rem; cursor: pointer;
            border-radius: 6px; display: flex; justify-content: space-between;
            transition: all 0.15s ease;
        }
        .top-node-item:hover { background: var(--bg-elevated); transform: translateX(4px); }
        .top-node-item .rank { color: var(--gold); font-weight: 600; }

        /* Heatmap Legend - Always visible */
        .heatmap-legend {
            position: absolute; bottom: 1rem; right: 1rem;
            background: var(--bg-glass); backdrop-filter: blur(15px);
            border: 1px solid var(--fg-dim); border-radius: var(--radius);
            padding: 0.75rem; z-index: 10;
            transition: all 0.2s ease;
        }
        .heatmap-legend.heatmap-active { border-color: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }
        .heatmap-gradient {
            width: 140px; height: 14px;
            background: linear-gradient(90deg, var(--green), var(--yellow), var(--orange), var(--red));
            border-radius: 4px; margin-bottom: 0.375rem;
        }

        /* Mini-map */
        .minimap {
            position: absolute; bottom: 5rem; right: 1rem;
            width: 160px; height: 120px;
            background: var(--bg-glass); backdrop-filter: blur(15px);
            border: 1px solid var(--fg-dim); border-radius: var(--radius);
            overflow: hidden; z-index: 10;
        }
        .minimap canvas { width: 100%; height: 100%; }
        .minimap-viewport {
            position: absolute; border: 2px solid var(--gold);
            background: rgba(251, 191, 36, 0.1); pointer-events: none;
        }

        /* Help Overlay */
        .help-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }
        .help-overlay.visible { display: flex; }
        .help-content {
            background: var(--bg-secondary); border: 1px solid var(--purple);
            border-radius: var(--radius-lg); padding: 2rem; max-width: 700px;
            max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-glow);
        }
        .help-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--gold); }
        .help-section { margin-bottom: 1.5rem; }
        .help-section-title { font-size: 0.8rem; font-weight: 600; color: var(--purple); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; }
        .help-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .help-item { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; }
        .help-key {
            background: var(--bg-elevated); padding: 0.25rem 0.5rem; border-radius: 4px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; min-width: 2rem; text-align: center;
            border: 1px solid var(--fg-dim);
        }
        .help-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--fg-muted); cursor: pointer; font-size: 1.5rem; }

        /* Recently Viewed */
        .recent-panel {
            position: absolute; top: 60px; left: 1rem;
            background: var(--bg-glass); backdrop-filter: blur(15px);
            border: 1px solid var(--purple); border-radius: var(--radius);
            padding: 0.75rem; z-index: 10; width: 200px; display: none;
        }
        .recent-panel.visible { display: block; }
        .recent-title { font-size: 0.7rem; font-weight: 600; color: var(--fg-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
        .recent-item {
            padding: 0.375rem 0.5rem; font-size: 0.75rem; cursor: pointer;
            border-radius: 4px; transition: all 0.15s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .recent-item:hover { background: var(--bg-elevated); }
        .recent-item .recent-id { color: var(--cyan); font-family: 'JetBrains Mono', monospace; }

        /* Path Finder Mode */
        .pathfinder-banner {
            position: absolute; top: 4rem; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #0f0f1a; padding: 0.5rem 1rem;
            border-radius: var(--radius); font-weight: 600; font-size: 0.875rem;
            z-index: 100; display: none; animation: pulse 1.5s infinite;
        }
        .pathfinder-banner.visible { display: block; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Edge Label Tooltip */
        .edge-tooltip {
            position: absolute; background: var(--bg-elevated); border: 1px solid var(--purple);
            padding: 0.375rem 0.625rem; border-radius: 6px; font-size: 0.75rem;
            pointer-events: none; z-index: 100; display: none; white-space: nowrap;
        }
        .edge-tooltip.visible { display: block; }
        .heatmap-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--fg-muted); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--purple); }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">bv</div>
            <h1><span>Insights</span> Graph</h1>
        </div>
        <div class="toolbar">
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="search-input" placeholder="Search beads... (full text)">
                <div class="search-results" id="search-results"></div>
            </div>
            <div class="toolbar-group">
                <select id="view-mode" title="Graph layout mode: Force (physics simulation), DAG (directed acyclic graph), or Radial. Press 1-4 for shortcuts.">
                    <option value="force">Force</option>
                    <option value="td">DAG ‚Üì</option>
                    <option value="lr">DAG ‚Üí</option>
                    <option value="radialout">Radial</option>
                </select>
            </div>
            <div class="toolbar-group">
                <select id="filter-status" title="Filter nodes by status. Shows only beads matching the selected status.">
                    <option value="">All Status</option>
                    <option value="open">Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="blocked">Blocked</option>
                    <option value="closed">Closed</option>
                </select>
                <select id="filter-type" title="Filter nodes by type. Shows only beads matching the selected type.">
                    <option value="">All Types</option>
                    <option value="feature">Feature</option>
                    <option value="bug">Bug</option>
                    <option value="task">Task</option>
                    <option value="epic">Epic</option>
                </select>
            </div>
            <div class="toolbar-group">
                <select id="size-by" title="Control what metric determines node size. Larger nodes have higher values of the selected metric.">
                    <option value="pagerank">Size: PageRank</option>
                    <option value="betweenness">Size: Betweenness</option>
                    <option value="critical">Size: Critical Path</option>
                    <option value="indegree">Size: In-Degree</option>
                </select>
            </div>
            <div class="toolbar-group">
                <select id="filter-priority" title="Filter nodes by priority level (P0=critical, P4=backlog)">
                    <option value="">All Priorities</option>
                    <option value="0">P0 Critical</option>
                    <option value="1">P1 High</option>
                    <option value="2">P2 Medium</option>
                    <option value="3">P3 Low</option>
                    <option value="4">P4 Backlog</option>
                </select>
                <select id="filter-label" title="Filter nodes by label">
                    <option value="">All Labels</option>
                </select>
            </div>
            <div class="toolbar-group">
                <button id="btn-heatmap" title="Toggle heatmap coloring - shows node importance by color intensity (H)">üî•</button>
                <button id="btn-triage" title="Show/hide triage recommendations panel with prioritized work items (G)">üìã</button>
                <button id="btn-top" title="Show/hide top nodes panel with highest PageRank nodes (T)">‚≠ê</button>
                <button id="btn-recent" title="Show/hide recently viewed nodes (Y)">üïê</button>
                <button id="btn-path" title="Enter path finder mode - click two nodes to find shortest path (P)">üõ§Ô∏è</button>
                <button id="btn-theme" title="Switch to light mode (L)">‚òÄÔ∏è</button>
                <button id="btn-help" title="Show keyboard shortcuts and help (?)">‚ùì</button>
                <button id="btn-fit" title="Fit all nodes in view (F)">Fit</button>
                <button id="btn-reset" title="Reset graph to initial state with all filters cleared (R)">Reset</button>
            </div>
        </div>
    </header>
    <main>
        <div id="detail-sidebar">
            <div class="panel-header">
                <h3><span class="icon">‚ú®</span> Bead Details</h3>
                <button class="detach-btn" id="btn-detach" title="Detach panel (D)">
                    <span>‚á±</span> Detach
                </button>
            </div>
            <div id="docked-no-selection" class="no-selection">
                <div class="no-selection-icon">üîç</div>
                <div class="no-selection-text">Hover over a node to see details</div>
            </div>
            <div id="docked-panel" class="detail-content">
                <div class="hover-header">
                    <span class="hover-id" id="docked-id">-</span>
                    <span class="hover-type-badge" id="docked-type-badge">-</span>
                </div>
                <div class="hover-title" id="docked-title">-</div>
                <div class="hover-badges" id="docked-badges"></div>
                <div id="docked-description" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Description</div>
                    <div class="hover-content" id="docked-description-content"></div>
                </div>
                <div id="docked-design" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Design</div>
                    <div class="hover-content" id="docked-design-content"></div>
                </div>
                <div id="docked-acceptance" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Acceptance Criteria</div>
                    <div class="hover-content" id="docked-acceptance-content"></div>
                </div>
                <div id="docked-notes" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Notes</div>
                    <div class="hover-content" id="docked-notes-content"></div>
                </div>
                <div class="hover-section">
                    <div class="hover-section-title">Metadata</div>
                    <div class="hover-meta" id="docked-meta"></div>
                </div>
                <div id="docked-blocked-by" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Blocked By</div>
                    <div class="hover-deps" id="docked-blocked-by-list"></div>
                </div>
                <div id="docked-blocks" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Blocks</div>
                    <div class="hover-deps" id="docked-blocks-list"></div>
                </div>
                <div id="docked-commits" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Related Commits</div>
                    <div class="hover-commits" id="docked-commits-list"></div>
                </div>
                <div class="hover-section">
                    <div class="hover-section-title">Graph Metrics</div>
                    <div class="hover-meta" id="docked-metrics"></div>
                </div>
            </div>
        </div>
        <div id="graph-wrapper">
            <div id="graph-container"></div>
            <div class="overlay-stats">
                <div class="stat"><span class="stat-value">146</span> nodes</div>
                <div class="stat"><span class="stat-value">118</span> edges</div>
                <div class="stat" id="stat-visible"><span class="stat-value">146</span> visible</div>
            </div>
            <button class="fullscreen-btn" id="btn-fullscreen" title="Toggle fullscreen mode for immersive graph viewing (Space)">‚õ∂</button>
            <div class="top-nodes-panel" id="top-nodes-panel"></div>
            <div class="heatmap-legend" id="heatmap-legend">
                <div class="heatmap-gradient"></div>
                <div class="heatmap-labels"><span>Low</span><span id="heatmap-metric">PageRank</span><span>High</span></div>
            </div>
            <div class="minimap" id="minimap">
                <canvas id="minimap-canvas"></canvas>
                <div class="minimap-viewport" id="minimap-viewport"></div>
            </div>
            <div class="recent-panel" id="recent-panel">
                <div class="recent-title">Recently Viewed</div>
                <div id="recent-list"></div>
            </div>
            <div class="pathfinder-banner" id="pathfinder-banner">üîó Path Finder: Click destination node (Esc to cancel)</div>
            <div class="edge-tooltip" id="edge-tooltip"></div>
            <div id="hover-panel">
                <button class="hover-close" id="hover-close">√ó</button>
                <div class="hover-header">
                    <span class="hover-id" id="hover-id">-</span>
                    <span class="hover-type-badge" id="hover-type-badge">-</span>
                </div>
                <div class="hover-title" id="hover-title">-</div>
                <div class="hover-badges" id="hover-badges"></div>
                <div id="hover-description" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Description</div>
                    <div class="hover-content" id="hover-description-content"></div>
                </div>
                <div id="hover-design" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Design</div>
                    <div class="hover-content" id="hover-design-content"></div>
                </div>
                <div id="hover-acceptance" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Acceptance Criteria</div>
                    <div class="hover-content" id="hover-acceptance-content"></div>
                </div>
                <div id="hover-notes" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Notes</div>
                    <div class="hover-content" id="hover-notes-content"></div>
                </div>
                <div class="hover-section">
                    <div class="hover-section-title">Metadata</div>
                    <div class="hover-meta" id="hover-meta"></div>
                </div>
                <div id="hover-blocked-by" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Blocked By</div>
                    <div class="hover-deps" id="hover-blocked-by-list"></div>
                </div>
                <div id="hover-blocks" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Blocks</div>
                    <div class="hover-deps" id="hover-blocks-list"></div>
                </div>
                <div id="hover-commits" class="hover-section" style="display:none;">
                    <div class="hover-section-title">Related Commits</div>
                    <div class="hover-commits" id="hover-commits-list"></div>
                </div>
                <div class="hover-section">
                    <div class="hover-section-title">Graph Metrics</div>
                    <div class="hover-meta" id="hover-metrics"></div>
                </div>
            </div>
        </div>
        <div id="sidebar">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-nodes">146</div><div class="stat-label">Nodes</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-edges">118</div><div class="stat-label">Edges</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-actionable">-</div><div class="stat-label">Actionable</div></div>
                <div class="stat-card"><div class="stat-value warning" id="stat-blocked">-</div><div class="stat-label">Blocked</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-critical">-</div><div class="stat-label">Critical</div></div>
                <div class="stat-card"><div class="stat-value warning" id="stat-articulation">-</div><div class="stat-label">Cut Pts</div></div>
            </div>
            <div class="panel" id="triage-panel" style="display:none;">
                <div class="panel-title">Top Recommendations</div>
                <div id="triage-list"></div>
            </div>
            <div class="panel">
                <div class="panel-title">Status Legend</div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#22c55e;color:#22c55e"></div>Open</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#f97316;color:#f97316"></div>In Progress</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ef4444;color:#ef4444"></div>Blocked</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#555577;color:#555577"></div>Closed</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Type Shapes</div>
                <div class="legend">
                    <div class="legend-item"><span style="font-size:1rem">‚óè</span> Feature</div>
                    <div class="legend-item"><span style="font-size:1rem">‚ñ≤</span> Bug</div>
                    <div class="legend-item"><span style="font-size:1rem">‚ñ†</span> Task</div>
                    <div class="legend-item"><span style="font-size:1rem">‚óÜ</span> Epic</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Selected Node</div>
                <div id="node-detail">
                    <div class="detail-header">
                        <div class="detail-id" id="detail-id">-</div>
                        <div class="detail-priority" id="detail-priority">P2</div>
                    </div>
                    <div class="detail-name" id="detail-name">-</div>
                    <div class="detail-badges" id="detail-badges"></div>
                    <div class="detail-metrics">
                        <div class="metric-item"><span class="metric-label">PageRank</span><span class="metric-value" id="m-pagerank">-</span></div>
                        <div class="metric-item"><span class="metric-label">Rank</span><span class="metric-value" id="m-prrank">-</span></div>
                        <div class="metric-item"><span class="metric-label">Betweenness</span><span class="metric-value" id="m-between">-</span></div>
                        <div class="metric-item"><span class="metric-label">BW Rank</span><span class="metric-value" id="m-bwrank">-</span></div>
                        <div class="metric-item"><span class="metric-label">Critical</span><span class="metric-value" id="m-critical">-</span></div>
                        <div class="metric-item"><span class="metric-label">Slack</span><span class="metric-value" id="m-slack">-</span></div>
                        <div class="metric-item"><span class="metric-label">In-Deg</span><span class="metric-value" id="m-indeg">-</span></div>
                        <div class="metric-item"><span class="metric-label">Out-Deg</span><span class="metric-value" id="m-outdeg">-</span></div>
                    </div>
                </div>
                <div class="no-selection" id="no-selection">
                    <div class="no-selection-icon">üîç</div>
                    Click a node to see details<br>
                    <small>or hover for full info</small>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Shortcuts</div>
                <div class="keyboard-hints">
                    <kbd>F</kbd> Fit ¬∑ <kbd>R</kbd> Reset ¬∑ <kbd>Space</kbd> Fullscreen<br>
                    <kbd>Esc</kbd> Clear ¬∑ <kbd>1-4</kbd> View modes<br>
                    <kbd>H</kbd> Heatmap ¬∑ <kbd>T</kbd> Top ¬∑ <kbd>G</kbd> Triage
                </div>
            </div>
        </div>
    </main>
    <footer>
        <div>Generated 2026-02-02 22:01:30 | Hash: a95ed9f159f20938</div>
        <div>Project: Insights | <a href="https://github.com/Dicklesworthstone/beads_viewer">bv</a></div>
    </footer>
    <div class="toast" id="toast"></div>
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="ctx-focus">üéØ Focus on this node</div>
        <div class="context-menu-item" id="ctx-details">üìÑ Show full details</div>
        <div class="context-menu-item" id="ctx-deps">üì• Show dependencies</div>
        <div class="context-menu-item" id="ctx-dependents">üì§ Show dependents</div>
        <div class="context-menu-item" id="ctx-connected">‚ú® Highlight connected</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctx-path">üõ§Ô∏è Find path to...</div>
        <div class="context-menu-item" id="ctx-copy">üìã Copy ID</div>
    </div>
    <div class="help-overlay" id="help-overlay">
        <div class="help-content">
            <button class="help-close" id="help-close">√ó</button>
            <div class="help-title">‚å®Ô∏è Keyboard Shortcuts</div>
            <div class="help-section">
                <div class="help-section-title">Navigation</div>
                <div class="help-grid">
                    <div class="help-item"><span class="help-key">F</span> Fit all nodes in view</div>
                    <div class="help-item"><span class="help-key">R</span> Reset to initial state</div>
                    <div class="help-item"><span class="help-key">Space</span> Toggle fullscreen</div>
                    <div class="help-item"><span class="help-key">Esc</span> Clear selection</div>
                </div>
            </div>
            <div class="help-section">
                <div class="help-section-title">Views & Panels</div>
                <div class="help-grid">
                    <div class="help-item"><span class="help-key">D</span> Dock/detach detail panel</div>
                    <div class="help-item"><span class="help-key">L</span> Toggle light/dark mode</div>
                    <div class="help-item"><span class="help-key">H</span> Toggle heatmap coloring</div>
                    <div class="help-item"><span class="help-key">T</span> Show top nodes panel</div>
                    <div class="help-item"><span class="help-key">G</span> Show triage panel</div>
                    <div class="help-item"><span class="help-key">Y</span> Show recently viewed</div>
                    <div class="help-item"><span class="help-key">P</span> Enter path finder mode</div>
                    <div class="help-item"><span class="help-key">?</span> Show this help</div>
                </div>
            </div>
            <div class="help-section">
                <div class="help-section-title">Layout Modes</div>
                <div class="help-grid">
                    <div class="help-item"><span class="help-key">1</span> Force-directed layout</div>
                    <div class="help-item"><span class="help-key">2</span> DAG top-down</div>
                    <div class="help-item"><span class="help-key">3</span> DAG left-right</div>
                    <div class="help-item"><span class="help-key">4</span> Radial layout</div>
                </div>
            </div>
            <div class="help-section">
                <div class="help-section-title">Mouse</div>
                <div class="help-grid">
                    <div class="help-item"><span class="help-key">Hover</span> Show node details</div>
                    <div class="help-item"><span class="help-key">Click</span> Select node</div>
                    <div class="help-item"><span class="help-key">Right-click</span> Context menu</div>
                    <div class="help-item"><span class="help-key">Scroll</span> Zoom in/out</div>
                    <div class="help-item"><span class="help-key">Drag</span> Pan the view</div>
                </div>
            </div>
        </div>
    </div>
    <script>// Version 1.43.5 force-graph - https://github.com/vasturiano/force-graph
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).ForceGraph=n()}(this,(function(){"use strict";function n(t,n,r){if(e())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,n);var o=new(t.bind.apply(t,i));return r&&s(o,r.prototype),o}function e(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(e=function(){return!!t})()}function r(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,r)}return e}function i(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?r(Object(e),!0).forEach((function(n){u(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):r(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}function o(t){var n=function(t,n){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==typeof n?n:String(n)}function a(t){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a(t)}function u(t,n,e){return(n=o(n))in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function s(t,n){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},s(t,n)}function l(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){var e=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=e){var r,i,o,a,u=[],s=!0,l=!1;try{if(o=(e=e.call(t)).next,0===n){if(Object(e)!==e)return;s=!1}else for(;!(s=(r=o.call(e)).done)&&(u.push(r.value),u.length!==n);s=!0);}catch(t){l=!0,i=t}finally{try{if(!s&&null!=e.return&&(a=e.return(),Object(a)!==a))return}finally{if(l)throw i}}return u}}(t,n)||h(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t){return function(t){if(Array.isArray(t))return f(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||h(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(t,n){if(t){if("string"==typeof t)return f(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?f(t,n):void 0}}function f(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}!function(t,n){void 0===n&&(n={});var e=n.insertAt;if(t&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===e&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t))}}(".force-graph-container canvas {\n  display: block;\n  user-select: none;\n  outline: none;\n  -webkit-tap-highlight-color: transparent;\n}\n\n.force-graph-container .graph-tooltip {\n  position: absolute;\n  top: 0;\n  font-family: sans-serif;\n  font-size: 16px;\n  padding: 4px;\n  border-radius: 3px;\n  color: #eee;\n  background: rgba(0,0,0,0.65);\n  visibility: hidden; /* by default */\n}\n\n.force-graph-container .clickable {\n  cursor: pointer;\n}\n\n.force-graph-container .grabbable {\n  cursor: move;\n  cursor: grab;\n  cursor: -moz-grab;\n  cursor: -webkit-grab;\n}\n\n.force-graph-container .grabbable:active {\n  cursor: grabbing;\n  cursor: -moz-grabbing;\n  cursor: -webkit-grabbing;\n}\n");var d="http://www.w3.org/1999/xhtml",p={svg:"http://www.w3.org/2000/svg",xhtml:d,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function g(t){var n=t+="",e=n.indexOf(":");return e>=0&&"xmlns"!==(n=t.slice(0,e))&&(t=t.slice(e+1)),p.hasOwnProperty(n)?{space:p[n],local:t}:t}function y(t){return function(){var n=this.ownerDocument,e=this.namespaceURI;return e===d&&n.documentElement.namespaceURI===d?n.createElement(t):n.createElementNS(e,t)}}function v(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}function _(t){var n=g(t);return(n.local?v:y)(n)}function m(){}function x(t){return null==t?m:function(){return this.querySelector(t)}}function b(){return[]}function w(t){return null==t?b:function(){return this.querySelectorAll(t)}}function k(t){return function(){return function(t){return null==t?[]:Array.isArray(t)?t:Array.from(t)}(t.apply(this,arguments))}}function M(t){return function(){return this.matches(t)}}function z(t){return function(n){return n.matches(t)}}var A=Array.prototype.find;function S(){return this.firstElementChild}var C=Array.prototype.filter;function E(){return Array.from(this.children)}function O(t){return new Array(t.length)}function N(t,n){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=n}function P(t,n,e,r,i,o){for(var a,u=0,s=n.length,l=o.length;u<l;++u)(a=n[u])?(a.__data__=o[u],r[u]=a):e[u]=new N(t,o[u]);for(;u<s;++u)(a=n[u])&&(i[u]=a)}function j(t,n,e,r,i,o,a){var u,s,l,c=new Map,h=n.length,f=o.length,d=new Array(h);for(u=0;u<h;++u)(s=n[u])&&(d[u]=l=a.call(s,s.__data__,u,n)+"",c.has(l)?i[u]=s:c.set(l,s));for(u=0;u<f;++u)l=a.call(t,o[u],u,o)+"",(s=c.get(l))?(r[u]=s,s.__data__=o[u],c.delete(l)):e[u]=new N(t,o[u]);for(u=0;u<h;++u)(s=n[u])&&c.get(d[u])===s&&(i[u]=s)}function T(t){return t.__data__}function R(t){return"object"==typeof t&&"length"in t?t:Array.from(t)}function D(t,n){return t<n?-1:t>n?1:t>=n?0:NaN}function I(t){return function(){this.removeAttribute(t)}}function U(t){return function(){this.removeAttributeNS(t.space,t.local)}}function F(t,n){return function(){this.setAttribute(t,n)}}function L(t,n){return function(){this.setAttributeNS(t.space,t.local,n)}}function q(t,n){return function(){var e=n.apply(this,arguments);null==e?this.removeAttribute(t):this.setAttribute(t,e)}}function B(t,n){return function(){var e=n.apply(this,arguments);null==e?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,e)}}function $(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function H(t){return function(){this.style.removeProperty(t)}}function V(t,n,e){return function(){this.style.setProperty(t,n,e)}}function X(t,n,e){return function(){var r=n.apply(this,arguments);null==r?this.style.removeProperty(t):this.style.setProperty(t,r,e)}}function G(t,n){return t.style.getPropertyValue(n)||$(t).getComputedStyle(t,null).getPropertyValue(n)}function Y(t){return function(){delete this[t]}}function W(t,n){return function(){this[t]=n}}function Z(t,n){return function(){var e=n.apply(this,arguments);null==e?delete this[t]:this[t]=e}}function Q(t){return t.trim().split(/^|\s+/)}function K(t){return t.classList||new J(t)}function J(t){this._node=t,this._names=Q(t.getAttribute("class")||"")}function tt(t,n){for(var e=K(t),r=-1,i=n.length;++r<i;)e.add(n[r])}function nt(t,n){for(var e=K(t),r=-1,i=n.length;++r<i;)e.remove(n[r])}function et(t){return function(){tt(this,t)}}function rt(t){return function(){nt(this,t)}}function it(t,n){return function(){(n.apply(this,arguments)?tt:nt)(this,t)}}function ot(){this.textContent=""}function at(t){return function(){this.textContent=t}}function ut(t){return function(){var n=t.apply(this,arguments);this.textContent=null==n?"":n}}function st(){this.innerHTML=""}function lt(t){return function(){this.innerHTML=t}}function ct(t){return function(){var n=t.apply(this,arguments);this.innerHTML=null==n?"":n}}function ht(){this.nextSibling&&this.parentNode.appendChild(this)}function ft(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function dt(){return null}function pt(){var t=this.parentNode;t&&t.removeChild(this)}function gt(){var t=this.cloneNode(!1),n=this.parentNode;return n?n.insertBefore(t,this.nextSibling):t}function yt(){var t=this.cloneNode(!0),n=this.parentNode;return n?n.insertBefore(t,this.nextSibling):t}function vt(t){return function(){var n=this.__on;if(n){for(var e,r=0,i=-1,o=n.length;r<o;++r)e=n[r],t.type&&e.type!==t.type||e.name!==t.name?n[++i]=e:this.removeEventListener(e.type,e.listener,e.options);++i?n.length=i:delete this.__on}}}function _t(t,n,e){return function(){var r,i=this.__on,o=function(t){return function(n){t.call(this,n,this.__data__)}}(n);if(i)for(var a=0,u=i.length;a<u;++a)if((r=i[a]).type===t.type&&r.name===t.name)return this.removeEventListener(r.type,r.listener,r.options),this.addEventListener(r.type,r.listener=o,r.options=e),void(r.value=n);this.addEventListener(t.type,o,e),r={type:t.type,name:t.name,value:n,listener:o,options:e},i?i.push(r):this.__on=[r]}}function mt(t,n,e){var r=$(t),i=r.CustomEvent;"function"==typeof i?i=new i(n,e):(i=r.document.createEvent("Event"),e?(i.initEvent(n,e.bubbles,e.cancelable),i.detail=e.detail):i.initEvent(n,!1,!1)),t.dispatchEvent(i)}function xt(t,n){return function(){return mt(this,t,n)}}function bt(t,n){return function(){return mt(this,t,n.apply(this,arguments))}}N.prototype={constructor:N,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,n){return this._parent.insertBefore(t,n)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}},J.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var n=this._names.indexOf(t);n>=0&&(this._names.splice(n,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};var wt=[null];function kt(t,n){this._groups=t,this._parents=n}function Mt(){return new kt([[document.documentElement]],wt)}function zt(t){return"string"==typeof t?new kt([[document.querySelector(t)]],[document.documentElement]):new kt([[t]],wt)}function At(t,n){if(t=function(t){let n;for(;n=t.sourceEvent;)t=n;return t}(t),void 0===n&&(n=t.currentTarget),n){var e=n.ownerSVGElement||n;if(e.createSVGPoint){var r=e.createSVGPoint();return r.x=t.clientX,r.y=t.clientY,[(r=r.matrixTransform(n.getScreenCTM().inverse())).x,r.y]}if(n.getBoundingClientRect){var i=n.getBoundingClientRect();return[t.clientX-i.left-n.clientLeft,t.clientY-i.top-n.clientTop]}}return[t.pageX,t.pageY]}kt.prototype=Mt.prototype={constructor:kt,select:function(t){"function"!=typeof t&&(t=x(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,a,u=n[i],s=u.length,l=r[i]=new Array(s),c=0;c<s;++c)(o=u[c])&&(a=t.call(o,o.__data__,c,u))&&("__data__"in o&&(a.__data__=o.__data__),l[c]=a);return new kt(r,this._parents)},selectAll:function(t){t="function"==typeof t?k(t):w(t);for(var n=this._groups,e=n.length,r=[],i=[],o=0;o<e;++o)for(var a,u=n[o],s=u.length,l=0;l<s;++l)(a=u[l])&&(r.push(t.call(a,a.__data__,l,u)),i.push(a));return new kt(r,i)},selectChild:function(t){return this.select(null==t?S:function(t){return function(){return A.call(this.children,t)}}("function"==typeof t?t:z(t)))},selectChildren:function(t){return this.selectAll(null==t?E:function(t){return function(){return C.call(this.children,t)}}("function"==typeof t?t:z(t)))},filter:function(t){"function"!=typeof t&&(t=M(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,a=n[i],u=a.length,s=r[i]=[],l=0;l<u;++l)(o=a[l])&&t.call(o,o.__data__,l,a)&&s.push(o);return new kt(r,this._parents)},data:function(t,n){if(!arguments.length)return Array.from(this,T);var e=n?j:P,r=this._parents,i=this._groups;"function"!=typeof t&&(t=function(t){return function(){return t}}(t));for(var o=i.length,a=new Array(o),u=new Array(o),s=new Array(o),l=0;l<o;++l){var c=r[l],h=i[l],f=h.length,d=R(t.call(c,c&&c.__data__,l,r)),p=d.length,g=u[l]=new Array(p),y=a[l]=new Array(p);e(c,h,g,y,s[l]=new Array(f),d,n);for(var v,_,m=0,x=0;m<p;++m)if(v=g[m]){for(m>=x&&(x=m+1);!(_=y[x])&&++x<p;);v._next=_||null}}return(a=new kt(a,r))._enter=u,a._exit=s,a},enter:function(){return new kt(this._enter||this._groups.map(O),this._parents)},exit:function(){return new kt(this._exit||this._groups.map(O),this._parents)},join:function(t,n,e){var r=this.enter(),i=this,o=this.exit();return"function"==typeof t?(r=t(r))&&(r=r.selection()):r=r.append(t+""),null!=n&&(i=n(i))&&(i=i.selection()),null==e?o.remove():e(o),r&&i?r.merge(i).order():i},merge:function(t){for(var n=t.selection?t.selection():t,e=this._groups,r=n._groups,i=e.length,o=r.length,a=Math.min(i,o),u=new Array(i),s=0;s<a;++s)for(var l,c=e[s],h=r[s],f=c.length,d=u[s]=new Array(f),p=0;p<f;++p)(l=c[p]||h[p])&&(d[p]=l);for(;s<i;++s)u[s]=e[s];return new kt(u,this._parents)},selection:function(){return this},order:function(){for(var t=this._groups,n=-1,e=t.length;++n<e;)for(var r,i=t[n],o=i.length-1,a=i[o];--o>=0;)(r=i[o])&&(a&&4^r.compareDocumentPosition(a)&&a.parentNode.insertBefore(r,a),a=r);return this},sort:function(t){function n(n,e){return n&&e?t(n.__data__,e.__data__):!n-!e}t||(t=D);for(var e=this._groups,r=e.length,i=new Array(r),o=0;o<r;++o){for(var a,u=e[o],s=u.length,l=i[o]=new Array(s),c=0;c<s;++c)(a=u[c])&&(l[c]=a);l.sort(n)}return new kt(i,this._parents).order()},call:function(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var t=this._groups,n=0,e=t.length;n<e;++n)for(var r=t[n],i=0,o=r.length;i<o;++i){var a=r[i];if(a)return a}return null},size:function(){let t=0;for(const n of this)++t;return t},empty:function(){return!this.node()},each:function(t){for(var n=this._groups,e=0,r=n.length;e<r;++e)for(var i,o=n[e],a=0,u=o.length;a<u;++a)(i=o[a])&&t.call(i,i.__data__,a,o);return this},attr:function(t,n){var e=g(t);if(arguments.length<2){var r=this.node();return e.local?r.getAttributeNS(e.space,e.local):r.getAttribute(e)}return this.each((null==n?e.local?U:I:"function"==typeof n?e.local?B:q:e.local?L:F)(e,n))},style:function(t,n,e){return arguments.length>1?this.each((null==n?H:"function"==typeof n?X:V)(t,n,null==e?"":e)):G(this.node(),t)},property:function(t,n){return arguments.length>1?this.each((null==n?Y:"function"==typeof n?Z:W)(t,n)):this.node()[t]},classed:function(t,n){var e=Q(t+"");if(arguments.length<2){for(var r=K(this.node()),i=-1,o=e.length;++i<o;)if(!r.contains(e[i]))return!1;return!0}return this.each(("function"==typeof n?it:n?et:rt)(e,n))},text:function(t){return arguments.length?this.each(null==t?ot:("function"==typeof t?ut:at)(t)):this.node().textContent},html:function(t){return arguments.length?this.each(null==t?st:("function"==typeof t?ct:lt)(t)):this.node().innerHTML},raise:function(){return this.each(ht)},lower:function(){return this.each(ft)},append:function(t){var n="function"==typeof t?t:_(t);return this.select((function(){return this.appendChild(n.apply(this,arguments))}))},insert:function(t,n){var e="function"==typeof t?t:_(t),r=null==n?dt:"function"==typeof n?n:x(n);return this.select((function(){return this.insertBefore(e.apply(this,arguments),r.apply(this,arguments)||null)}))},remove:function(){return this.each(pt)},clone:function(t){return this.select(t?yt:gt)},datum:function(t){return arguments.length?this.property("__data__",t):this.node().__data__},on:function(t,n,e){var r,i,o=function(t){return t.trim().split(/^|\s+/).map((function(t){var n="",e=t.indexOf(".");return e>=0&&(n=t.slice(e+1),t=t.slice(0,e)),{type:t,name:n}}))}(t+""),a=o.length;if(!(arguments.length<2)){for(u=n?_t:vt,r=0;r<a;++r)this.each(u(o[r],n,e));return this}var u=this.node().__on;if(u)for(var s,l=0,c=u.length;l<c;++l)for(r=0,s=u[l];r<a;++r)if((i=o[r]).type===s.type&&i.name===s.name)return s.value},dispatch:function(t,n){return this.each(("function"==typeof n?bt:xt)(t,n))},[Symbol.iterator]:function*(){for(var t=this._groups,n=0,e=t.length;n<e;++n)for(var r,i=t[n],o=0,a=i.length;o<a;++o)(r=i[o])&&(yield r)}};var St={value:()=>{}};function Ct(){for(var t,n=0,e=arguments.length,r={};n<e;++n){if(!(t=arguments[n]+"")||t in r||/[\s.]/.test(t))throw new Error("illegal type: "+t);r[t]=[]}return new Et(r)}function Et(t){this._=t}function Ot(t,n){for(var e,r=0,i=t.length;r<i;++r)if((e=t[r]).name===n)return e.value}function Nt(t,n,e){for(var r=0,i=t.length;r<i;++r)if(t[r].name===n){t[r]=St,t=t.slice(0,r).concat(t.slice(r+1));break}return null!=e&&t.push({name:n,value:e}),t}Et.prototype=Ct.prototype={constructor:Et,on:function(t,n){var e,r,i=this._,o=(r=i,(t+"").trim().split(/^|\s+/).map((function(t){var n="",e=t.indexOf(".");if(e>=0&&(n=t.slice(e+1),t=t.slice(0,e)),t&&!r.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:n}}))),a=-1,u=o.length;if(!(arguments.length<2)){if(null!=n&&"function"!=typeof n)throw new Error("invalid callback: "+n);for(;++a<u;)if(e=(t=o[a]).type)i[e]=Nt(i[e],t.name,n);else if(null==n)for(e in i)i[e]=Nt(i[e],t.name,null);return this}for(;++a<u;)if((e=(t=o[a]).type)&&(e=Ot(i[e],t.name)))return e},copy:function(){var t={},n=this._;for(var e in n)t[e]=n[e].slice();return new Et(t)},call:function(t,n){if((e=arguments.length-2)>0)for(var e,r,i=new Array(e),o=0;o<e;++o)i[o]=arguments[o+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=0,e=(r=this._[t]).length;o<e;++o)r[o].value.apply(n,i)},apply:function(t,n,e){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],i=0,o=r.length;i<o;++i)r[i].value.apply(n,e)}};const Pt={passive:!1},jt={capture:!0,passive:!1};function Tt(t){t.stopImmediatePropagation()}function Rt(t){t.preventDefault(),t.stopImmediatePropagation()}function Dt(t){var n=t.document.documentElement,e=zt(t).on("dragstart.drag",Rt,jt);"onselectstart"in n?e.on("selectstart.drag",Rt,jt):(n.__noselect=n.style.MozUserSelect,n.style.MozUserSelect="none")}function It(t,n){var e=t.document.documentElement,r=zt(t).on("dragstart.drag",null);n&&(r.on("click.drag",Rt,jt),setTimeout((function(){r.on("click.drag",null)}),0)),"onselectstart"in e?r.on("selectstart.drag",null):(e.style.MozUserSelect=e.__noselect,delete e.__noselect)}var Ut=t=>()=>t;function Ft(t,{sourceEvent:n,subject:e,target:r,identifier:i,active:o,x:a,y:u,dx:s,dy:l,dispatch:c}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:n,enumerable:!0,configurable:!0},subject:{value:e,enumerable:!0,configurable:!0},target:{value:r,enumerable:!0,configurable:!0},identifier:{value:i,enumerable:!0,configurable:!0},active:{value:o,enumerable:!0,configurable:!0},x:{value:a,enumerable:!0,configurable:!0},y:{value:u,enumerable:!0,configurable:!0},dx:{value:s,enumerable:!0,configurable:!0},dy:{value:l,enumerable:!0,configurable:!0},_:{value:c}})}function Lt(t){return!t.ctrlKey&&!t.button}function qt(){return this.parentNode}function Bt(t,n){return null==n?{x:t.x,y:t.y}:n}function $t(){return navigator.maxTouchPoints||"ontouchstart"in this}function Ht(t,n,e){t.prototype=n.prototype=e,e.constructor=t}function Vt(t,n){var e=Object.create(t.prototype);for(var r in n)e[r]=n[r];return e}function Xt(){}Ft.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};var Gt=.7,Yt=1/Gt,Wt="\\s*([+-]?\\d+)\\s*",Zt="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",Qt="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Kt=/^#([0-9a-f]{3,8})$/,Jt=new RegExp(`^rgb\\(${Wt},${Wt},${Wt}\\)$`),tn=new RegExp(`^rgb\\(${Qt},${Qt},${Qt}\\)$`),nn=new RegExp(`^rgba\\(${Wt},${Wt},${Wt},${Zt}\\)$`),en=new RegExp(`^rgba\\(${Qt},${Qt},${Qt},${Zt}\\)$`),rn=new RegExp(`^hsl\\(${Zt},${Qt},${Qt}\\)$`),on=new RegExp(`^hsla\\(${Zt},${Qt},${Qt},${Zt}\\)$`),an={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function un(){return this.rgb().formatHex()}function sn(){return this.rgb().formatRgb()}function ln(t){var n,e;return t=(t+"").trim().toLowerCase(),(n=Kt.exec(t))?(e=n[1].length,n=parseInt(n[1],16),6===e?cn(n):3===e?new dn(n>>8&15|n>>4&240,n>>4&15|240&n,(15&n)<<4|15&n,1):8===e?hn(n>>24&255,n>>16&255,n>>8&255,(255&n)/255):4===e?hn(n>>12&15|n>>8&240,n>>8&15|n>>4&240,n>>4&15|240&n,((15&n)<<4|15&n)/255):null):(n=Jt.exec(t))?new dn(n[1],n[2],n[3],1):(n=tn.exec(t))?new dn(255*n[1]/100,255*n[2]/100,255*n[3]/100,1):(n=nn.exec(t))?hn(n[1],n[2],n[3],n[4]):(n=en.exec(t))?hn(255*n[1]/100,255*n[2]/100,255*n[3]/100,n[4]):(n=rn.exec(t))?mn(n[1],n[2]/100,n[3]/100,1):(n=on.exec(t))?mn(n[1],n[2]/100,n[3]/100,n[4]):an.hasOwnProperty(t)?cn(an[t]):"transparent"===t?new dn(NaN,NaN,NaN,0):null}function cn(t){return new dn(t>>16&255,t>>8&255,255&t,1)}function hn(t,n,e,r){return r<=0&&(t=n=e=NaN),new dn(t,n,e,r)}function fn(t,n,e,r){return 1===arguments.length?((i=t)instanceof Xt||(i=ln(i)),i?new dn((i=i.rgb()).r,i.g,i.b,i.opacity):new dn):new dn(t,n,e,null==r?1:r);var i}function dn(t,n,e,r){this.r=+t,this.g=+n,this.b=+e,this.opacity=+r}function pn(){return`#${_n(this.r)}${_n(this.g)}${_n(this.b)}`}function gn(){const t=yn(this.opacity);return`${1===t?"rgb(":"rgba("}${vn(this.r)}, ${vn(this.g)}, ${vn(this.b)}${1===t?")":`, ${t})`}`}function yn(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function vn(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function _n(t){return((t=vn(t))<16?"0":"")+t.toString(16)}function mn(t,n,e,r){return r<=0?t=n=e=NaN:e<=0||e>=1?t=n=NaN:n<=0&&(t=NaN),new bn(t,n,e,r)}function xn(t){if(t instanceof bn)return new bn(t.h,t.s,t.l,t.opacity);if(t instanceof Xt||(t=ln(t)),!t)return new bn;if(t instanceof bn)return t;var n=(t=t.rgb()).r/255,e=t.g/255,r=t.b/255,i=Math.min(n,e,r),o=Math.max(n,e,r),a=NaN,u=o-i,s=(o+i)/2;return u?(a=n===o?(e-r)/u+6*(e<r):e===o?(r-n)/u+2:(n-e)/u+4,u/=s<.5?o+i:2-o-i,a*=60):u=s>0&&s<1?0:a,new bn(a,u,s,t.opacity)}function bn(t,n,e,r){this.h=+t,this.s=+n,this.l=+e,this.opacity=+r}function wn(t){return(t=(t||0)%360)<0?t+360:t}function kn(t){return Math.max(0,Math.min(1,t||0))}function Mn(t,n,e){return 255*(t<60?n+(e-n)*t/60:t<180?e:t<240?n+(e-n)*(240-t)/60:n)}Ht(Xt,ln,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:un,formatHex:un,formatHex8:function(){return this.rgb().formatHex8()},formatHsl:function(){return xn(this).formatHsl()},formatRgb:sn,toString:sn}),Ht(dn,fn,Vt(Xt,{brighter(t){return t=null==t?Yt:Math.pow(Yt,t),new dn(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=null==t?Gt:Math.pow(Gt,t),new dn(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new dn(vn(this.r),vn(this.g),vn(this.b),yn(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:pn,formatHex:pn,formatHex8:function(){return`#${_n(this.r)}${_n(this.g)}${_n(this.b)}${_n(255*(isNaN(this.opacity)?1:this.opacity))}`},formatRgb:gn,toString:gn})),Ht(bn,(function(t,n,e,r){return 1===arguments.length?xn(t):new bn(t,n,e,null==r?1:r)}),Vt(Xt,{brighter(t){return t=null==t?Yt:Math.pow(Yt,t),new bn(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=null==t?Gt:Math.pow(Gt,t),new bn(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+360*(this.h<0),n=isNaN(t)||isNaN(this.s)?0:this.s,e=this.l,r=e+(e<.5?e:1-e)*n,i=2*e-r;return new dn(Mn(t>=240?t-240:t+120,i,r),Mn(t,i,r),Mn(t<120?t+240:t-120,i,r),this.opacity)},clamp(){return new bn(wn(this.h),kn(this.s),kn(this.l),yn(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=yn(this.opacity);return`${1===t?"hsl(":"hsla("}${wn(this.h)}, ${100*kn(this.s)}%, ${100*kn(this.l)}%${1===t?")":`, ${t})`}`}}));var zn=t=>()=>t;function An(t){return 1==(t=+t)?Sn:function(n,e){return e-n?function(t,n,e){return t=Math.pow(t,e),n=Math.pow(n,e)-t,e=1/e,function(r){return Math.pow(t+r*n,e)}}(n,e,t):zn(isNaN(n)?e:n)}}function Sn(t,n){var e=n-t;return e?function(t,n){return function(e){return t+e*n}}(t,e):zn(isNaN(t)?n:t)}var Cn=function t(n){var e=An(n);function r(t,n){var r=e((t=fn(t)).r,(n=fn(n)).r),i=e(t.g,n.g),o=e(t.b,n.b),a=Sn(t.opacity,n.opacity);return function(n){return t.r=r(n),t.g=i(n),t.b=o(n),t.opacity=a(n),t+""}}return r.gamma=t,r}(1);function En(t,n){return t=+t,n=+n,function(e){return t*(1-e)+n*e}}var On=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Nn=new RegExp(On.source,"g");function Pn(t,n){var e,r,i,o=On.lastIndex=Nn.lastIndex=0,a=-1,u=[],s=[];for(t+="",n+="";(e=On.exec(t))&&(r=Nn.exec(n));)(i=r.index)>o&&(i=n.slice(o,i),u[a]?u[a]+=i:u[++a]=i),(e=e[0])===(r=r[0])?u[a]?u[a]+=r:u[++a]=r:(u[++a]=null,s.push({i:a,x:En(e,r)})),o=Nn.lastIndex;return o<n.length&&(i=n.slice(o),u[a]?u[a]+=i:u[++a]=i),u.length<2?s[0]?function(t){return function(n){return t(n)+""}}(s[0].x):function(t){return function(){return t}}(n):(n=s.length,function(t){for(var e,r=0;r<n;++r)u[(e=s[r]).i]=e.x(t);return u.join("")})}var jn,Tn=180/Math.PI,Rn={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function Dn(t,n,e,r,i,o){var a,u,s;return(a=Math.sqrt(t*t+n*n))&&(t/=a,n/=a),(s=t*e+n*r)&&(e-=t*s,r-=n*s),(u=Math.sqrt(e*e+r*r))&&(e/=u,r/=u,s/=u),t*r<n*e&&(t=-t,n=-n,s=-s,a=-a),{translateX:i,translateY:o,rotate:Math.atan2(n,t)*Tn,skewX:Math.atan(s)*Tn,scaleX:a,scaleY:u}}function In(t,n,e,r){function i(t){return t.length?t.pop()+" ":""}return function(o,a){var u=[],s=[];return o=t(o),a=t(a),function(t,r,i,o,a,u){if(t!==i||r!==o){var s=a.push("translate(",null,n,null,e);u.push({i:s-4,x:En(t,i)},{i:s-2,x:En(r,o)})}else(i||o)&&a.push("translate("+i+n+o+e)}(o.translateX,o.translateY,a.translateX,a.translateY,u,s),function(t,n,e,o){t!==n?(t-n>180?n+=360:n-t>180&&(t+=360),o.push({i:e.push(i(e)+"rotate(",null,r)-2,x:En(t,n)})):n&&e.push(i(e)+"rotate("+n+r)}(o.rotate,a.rotate,u,s),function(t,n,e,o){t!==n?o.push({i:e.push(i(e)+"skewX(",null,r)-2,x:En(t,n)}):n&&e.push(i(e)+"skewX("+n+r)}(o.skewX,a.skewX,u,s),function(t,n,e,r,o,a){if(t!==e||n!==r){var u=o.push(i(o)+"scale(",null,",",null,")");a.push({i:u-4,x:En(t,e)},{i:u-2,x:En(n,r)})}else 1===e&&1===r||o.push(i(o)+"scale("+e+","+r+")")}(o.scaleX,o.scaleY,a.scaleX,a.scaleY,u,s),o=a=null,function(t){for(var n,e=-1,r=s.length;++e<r;)u[(n=s[e]).i]=n.x(t);return u.join("")}}}var Un=In((function(t){const n=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(t+"");return n.isIdentity?Rn:Dn(n.a,n.b,n.c,n.d,n.e,n.f)}),"px, ","px)","deg)"),Fn=In((function(t){return null==t?Rn:(jn||(jn=document.createElementNS("http://www.w3.org/2000/svg","g")),jn.setAttribute("transform",t),(t=jn.transform.baseVal.consolidate())?Dn((t=t.matrix).a,t.b,t.c,t.d,t.e,t.f):Rn)}),", ",")",")");function Ln(t){return((t=Math.exp(t))+1/t)/2}var qn,Bn,$n=function t(n,e,r){function i(t,i){var o,a,u=t[0],s=t[1],l=t[2],c=i[0],h=i[1],f=i[2],d=c-u,p=h-s,g=d*d+p*p;if(g<1e-12)a=Math.log(f/l)/n,o=function(t){return[u+t*d,s+t*p,l*Math.exp(n*t*a)]};else{var y=Math.sqrt(g),v=(f*f-l*l+r*g)/(2*l*e*y),_=(f*f-l*l-r*g)/(2*f*e*y),m=Math.log(Math.sqrt(v*v+1)-v),x=Math.log(Math.sqrt(_*_+1)-_);a=(x-m)/n,o=function(t){var r=t*a,i=Ln(m),o=l/(e*y)*(i*function(t){return((t=Math.exp(2*t))-1)/(t+1)}(n*r+m)-function(t){return((t=Math.exp(t))-1/t)/2}(m));return[u+o*d,s+o*p,l*i/Ln(n*r+m)]}}return o.duration=1e3*a*n/Math.SQRT2,o}return i.rho=function(n){var e=Math.max(.001,+n),r=e*e;return t(e,r,r*r)},i}(Math.SQRT2,2,4),Hn=0,Vn=0,Xn=0,Gn=1e3,Yn=0,Wn=0,Zn=0,Qn="object"==typeof performance&&performance.now?performance:Date,Kn="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function Jn(){return Wn||(Kn(te),Wn=Qn.now()+Zn)}function te(){Wn=0}function ne(){this._call=this._time=this._next=null}function ee(t,n,e){var r=new ne;return r.restart(t,n,e),r}function re(){Wn=(Yn=Qn.now())+Zn,Hn=Vn=0;try{!function(){Jn(),++Hn;for(var t,n=qn;n;)(t=Wn-n._time)>=0&&n._call.call(void 0,t),n=n._next;--Hn}()}finally{Hn=0,function(){var t,n,e=qn,r=1/0;for(;e;)e._call?(r>e._time&&(r=e._time),t=e,e=e._next):(n=e._next,e._next=null,e=t?t._next=n:qn=n);Bn=t,oe(r)}(),Wn=0}}function ie(){var t=Qn.now(),n=t-Yn;n>Gn&&(Zn-=n,Yn=t)}function oe(t){Hn||(Vn&&(Vn=clearTimeout(Vn)),t-Wn>24?(t<1/0&&(Vn=setTimeout(re,t-Qn.now()-Zn)),Xn&&(Xn=clearInterval(Xn))):(Xn||(Yn=Qn.now(),Xn=setInterval(ie,Gn)),Hn=1,Kn(re)))}function ae(t,n,e){var r=new ne;return n=null==n?0:+n,r.restart((e=>{r.stop(),t(e+n)}),n,e),r}ne.prototype=ee.prototype={constructor:ne,restart:function(t,n,e){if("function"!=typeof t)throw new TypeError("callback is not a function");e=(null==e?Jn():+e)+(null==n?0:+n),this._next||Bn===this||(Bn?Bn._next=this:qn=this,Bn=this),this._call=t,this._time=e,oe()},stop:function(){this._call&&(this._call=null,this._time=1/0,oe())}};var ue=Ct("start","end","cancel","interrupt"),se=[],le=0,ce=1,he=2,fe=3,de=4,pe=5,ge=6;function ye(t,n,e,r,i,o){var a=t.__transition;if(a){if(e in a)return}else t.__transition={};!function(t,n,e){var r,i=t.__transition;function o(t){e.state=ce,e.timer.restart(a,e.delay,e.time),e.delay<=t&&a(t-e.delay)}function a(o){var l,c,h,f;if(e.state!==ce)return s();for(l in i)if((f=i[l]).name===e.name){if(f.state===fe)return ae(a);f.state===de?(f.state=ge,f.timer.stop(),f.on.call("interrupt",t,t.__data__,f.index,f.group),delete i[l]):+l<n&&(f.state=ge,f.timer.stop(),f.on.call("cancel",t,t.__data__,f.index,f.group),delete i[l])}if(ae((function(){e.state===fe&&(e.state=de,e.timer.restart(u,e.delay,e.time),u(o))})),e.state=he,e.on.call("start",t,t.__data__,e.index,e.group),e.state===he){for(e.state=fe,r=new Array(h=e.tween.length),l=0,c=-1;l<h;++l)(f=e.tween[l].value.call(t,t.__data__,e.index,e.group))&&(r[++c]=f);r.length=c+1}}function u(n){for(var i=n<e.duration?e.ease.call(null,n/e.duration):(e.timer.restart(s),e.state=pe,1),o=-1,a=r.length;++o<a;)r[o].call(t,i);e.state===pe&&(e.on.call("end",t,t.__data__,e.index,e.group),s())}function s(){for(var r in e.state=ge,e.timer.stop(),delete i[n],i)return;delete t.__transition}i[n]=e,e.timer=ee(o,0,e.time)}(t,e,{name:n,index:r,group:i,on:ue,tween:se,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:le})}function ve(t,n){var e=me(t,n);if(e.state>le)throw new Error("too late; already scheduled");return e}function _e(t,n){var e=me(t,n);if(e.state>fe)throw new Error("too late; already running");return e}function me(t,n){var e=t.__transition;if(!e||!(e=e[n]))throw new Error("transition not found");return e}function xe(t,n){var e,r,i,o=t.__transition,a=!0;if(o){for(i in n=null==n?null:n+"",o)(e=o[i]).name===n?(r=e.state>he&&e.state<pe,e.state=ge,e.timer.stop(),e.on.call(r?"interrupt":"cancel",t,t.__data__,e.index,e.group),delete o[i]):a=!1;a&&delete t.__transition}}function be(t,n){var e,r;return function(){var i=_e(this,t),o=i.tween;if(o!==e)for(var a=0,u=(r=e=o).length;a<u;++a)if(r[a].name===n){(r=r.slice()).splice(a,1);break}i.tween=r}}function we(t,n,e){var r,i;if("function"!=typeof e)throw new Error;return function(){var o=_e(this,t),a=o.tween;if(a!==r){i=(r=a).slice();for(var u={name:n,value:e},s=0,l=i.length;s<l;++s)if(i[s].name===n){i[s]=u;break}s===l&&i.push(u)}o.tween=i}}function ke(t,n,e){var r=t._id;return t.each((function(){var t=_e(this,r);(t.value||(t.value={}))[n]=e.apply(this,arguments)})),function(t){return me(t,r).value[n]}}function Me(t,n){var e;return("number"==typeof n?En:n instanceof ln?Cn:(e=ln(n))?(n=e,Cn):Pn)(t,n)}function ze(t){return function(){this.removeAttribute(t)}}function Ae(t){return function(){this.removeAttributeNS(t.space,t.local)}}function Se(t,n,e){var r,i,o=e+"";return function(){var a=this.getAttribute(t);return a===o?null:a===r?i:i=n(r=a,e)}}function Ce(t,n,e){var r,i,o=e+"";return function(){var a=this.getAttributeNS(t.space,t.local);return a===o?null:a===r?i:i=n(r=a,e)}}function Ee(t,n,e){var r,i,o;return function(){var a,u,s=e(this);if(null!=s)return(a=this.getAttribute(t))===(u=s+"")?null:a===r&&u===i?o:(i=u,o=n(r=a,s));this.removeAttribute(t)}}function Oe(t,n,e){var r,i,o;return function(){var a,u,s=e(this);if(null!=s)return(a=this.getAttributeNS(t.space,t.local))===(u=s+"")?null:a===r&&u===i?o:(i=u,o=n(r=a,s));this.removeAttributeNS(t.space,t.local)}}function Ne(t,n){var e,r;function i(){var i=n.apply(this,arguments);return i!==r&&(e=(r=i)&&function(t,n){return function(e){this.setAttributeNS(t.space,t.local,n.call(this,e))}}(t,i)),e}return i._value=n,i}function Pe(t,n){var e,r;function i(){var i=n.apply(this,arguments);return i!==r&&(e=(r=i)&&function(t,n){return function(e){this.setAttribute(t,n.call(this,e))}}(t,i)),e}return i._value=n,i}function je(t,n){return function(){ve(this,t).delay=+n.apply(this,arguments)}}function Te(t,n){return n=+n,function(){ve(this,t).delay=n}}function Re(t,n){return function(){_e(this,t).duration=+n.apply(this,arguments)}}function De(t,n){return n=+n,function(){_e(this,t).duration=n}}var Ie=Mt.prototype.constructor;function Ue(t){return function(){this.style.removeProperty(t)}}var Fe=0;function Le(t,n,e,r){this._groups=t,this._parents=n,this._name=e,this._id=r}function qe(){return++Fe}var Be=Mt.prototype;Le.prototype={constructor:Le,select:function(t){var n=this._name,e=this._id;"function"!=typeof t&&(t=x(t));for(var r=this._groups,i=r.length,o=new Array(i),a=0;a<i;++a)for(var u,s,l=r[a],c=l.length,h=o[a]=new Array(c),f=0;f<c;++f)(u=l[f])&&(s=t.call(u,u.__data__,f,l))&&("__data__"in u&&(s.__data__=u.__data__),h[f]=s,ye(h[f],n,e,f,h,me(u,e)));return new Le(o,this._parents,n,e)},selectAll:function(t){var n=this._name,e=this._id;"function"!=typeof t&&(t=w(t));for(var r=this._groups,i=r.length,o=[],a=[],u=0;u<i;++u)for(var s,l=r[u],c=l.length,h=0;h<c;++h)if(s=l[h]){for(var f,d=t.call(s,s.__data__,h,l),p=me(s,e),g=0,y=d.length;g<y;++g)(f=d[g])&&ye(f,n,e,g,d,p);o.push(d),a.push(s)}return new Le(o,a,n,e)},selectChild:Be.selectChild,selectChildren:Be.selectChildren,filter:function(t){"function"!=typeof t&&(t=M(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,a=n[i],u=a.length,s=r[i]=[],l=0;l<u;++l)(o=a[l])&&t.call(o,o.__data__,l,a)&&s.push(o);return new Le(r,this._parents,this._name,this._id)},merge:function(t){if(t._id!==this._id)throw new Error;for(var n=this._groups,e=t._groups,r=n.length,i=e.length,o=Math.min(r,i),a=new Array(r),u=0;u<o;++u)for(var s,l=n[u],c=e[u],h=l.length,f=a[u]=new Array(h),d=0;d<h;++d)(s=l[d]||c[d])&&(f[d]=s);for(;u<r;++u)a[u]=n[u];return new Le(a,this._parents,this._name,this._id)},selection:function(){return new Ie(this._groups,this._parents)},transition:function(){for(var t=this._name,n=this._id,e=qe(),r=this._groups,i=r.length,o=0;o<i;++o)for(var a,u=r[o],s=u.length,l=0;l<s;++l)if(a=u[l]){var c=me(a,n);ye(a,t,e,l,u,{time:c.time+c.delay+c.duration,delay:0,duration:c.duration,ease:c.ease})}return new Le(r,this._parents,t,e)},call:Be.call,nodes:Be.nodes,node:Be.node,size:Be.size,empty:Be.empty,each:Be.each,on:function(t,n){var e=this._id;return arguments.length<2?me(this.node(),e).on.on(t):this.each(function(t,n,e){var r,i,o=function(t){return(t+"").trim().split(/^|\s+/).every((function(t){var n=t.indexOf(".");return n>=0&&(t=t.slice(0,n)),!t||"start"===t}))}(n)?ve:_e;return function(){var a=o(this,t),u=a.on;u!==r&&(i=(r=u).copy()).on(n,e),a.on=i}}(e,t,n))},attr:function(t,n){var e=g(t),r="transform"===e?Fn:Me;return this.attrTween(t,"function"==typeof n?(e.local?Oe:Ee)(e,r,ke(this,"attr."+t,n)):null==n?(e.local?Ae:ze)(e):(e.local?Ce:Se)(e,r,n))},attrTween:function(t,n){var e="attr."+t;if(arguments.length<2)return(e=this.tween(e))&&e._value;if(null==n)return this.tween(e,null);if("function"!=typeof n)throw new Error;var r=g(t);return this.tween(e,(r.local?Ne:Pe)(r,n))},style:function(t,n,e){var r="transform"==(t+="")?Un:Me;return null==n?this.styleTween(t,function(t,n){var e,r,i;return function(){var o=G(this,t),a=(this.style.removeProperty(t),G(this,t));return o===a?null:o===e&&a===r?i:i=n(e=o,r=a)}}(t,r)).on("end.style."+t,Ue(t)):"function"==typeof n?this.styleTween(t,function(t,n,e){var r,i,o;return function(){var a=G(this,t),u=e(this),s=u+"";return null==u&&(this.style.removeProperty(t),s=u=G(this,t)),a===s?null:a===r&&s===i?o:(i=s,o=n(r=a,u))}}(t,r,ke(this,"style."+t,n))).each(function(t,n){var e,r,i,o,a="style."+n,u="end."+a;return function(){var s=_e(this,t),l=s.on,c=null==s.value[a]?o||(o=Ue(n)):void 0;l===e&&i===c||(r=(e=l).copy()).on(u,i=c),s.on=r}}(this._id,t)):this.styleTween(t,function(t,n,e){var r,i,o=e+"";return function(){var a=G(this,t);return a===o?null:a===r?i:i=n(r=a,e)}}(t,r,n),e).on("end.style."+t,null)},styleTween:function(t,n,e){var r="style."+(t+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(null==n)return this.tween(r,null);if("function"!=typeof n)throw new Error;return this.tween(r,function(t,n,e){var r,i;function o(){var o=n.apply(this,arguments);return o!==i&&(r=(i=o)&&function(t,n,e){return function(r){this.style.setProperty(t,n.call(this,r),e)}}(t,o,e)),r}return o._value=n,o}(t,n,null==e?"":e))},text:function(t){return this.tween("text","function"==typeof t?function(t){return function(){var n=t(this);this.textContent=null==n?"":n}}(ke(this,"text",t)):function(t){return function(){this.textContent=t}}(null==t?"":t+""))},textTween:function(t){var n="text";if(arguments.length<1)return(n=this.tween(n))&&n._value;if(null==t)return this.tween(n,null);if("function"!=typeof t)throw new Error;return this.tween(n,function(t){var n,e;function r(){var r=t.apply(this,arguments);return r!==e&&(n=(e=r)&&function(t){return function(n){this.textContent=t.call(this,n)}}(r)),n}return r._value=t,r}(t))},remove:function(){return this.on("end.remove",function(t){return function(){var n=this.parentNode;for(var e in this.__transition)if(+e!==t)return;n&&n.removeChild(this)}}(this._id))},tween:function(t,n){var e=this._id;if(t+="",arguments.length<2){for(var r,i=me(this.node(),e).tween,o=0,a=i.length;o<a;++o)if((r=i[o]).name===t)return r.value;return null}return this.each((null==n?be:we)(e,t,n))},delay:function(t){var n=this._id;return arguments.length?this.each(("function"==typeof t?je:Te)(n,t)):me(this.node(),n).delay},duration:function(t){var n=this._id;return arguments.length?this.each(("function"==typeof t?Re:De)(n,t)):me(this.node(),n).duration},ease:function(t){var n=this._id;return arguments.length?this.each(function(t,n){if("function"!=typeof n)throw new Error;return function(){_e(this,t).ease=n}}(n,t)):me(this.node(),n).ease},easeVarying:function(t){if("function"!=typeof t)throw new Error;return this.each(function(t,n){return function(){var e=n.apply(this,arguments);if("function"!=typeof e)throw new Error;_e(this,t).ease=e}}(this._id,t))},end:function(){var t,n,e=this,r=e._id,i=e.size();return new Promise((function(o,a){var u={value:a},s={value:function(){0==--i&&o()}};e.each((function(){var e=_e(this,r),i=e.on;i!==t&&((n=(t=i).copy())._.cancel.push(u),n._.interrupt.push(u),n._.end.push(s)),e.on=n})),0===i&&o()}))},[Symbol.iterator]:Be[Symbol.iterator]};var $e={time:null,delay:0,duration:250,ease:function(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}};function He(t,n){for(var e;!(e=t.__transition)||!(e=e[n]);)if(!(t=t.parentNode))throw new Error(`transition ${n} not found`);return e}Mt.prototype.interrupt=function(t){return this.each((function(){xe(this,t)}))},Mt.prototype.transition=function(t){var n,e;t instanceof Le?(n=t._id,t=t._name):(n=qe(),(e=$e).time=Jn(),t=null==t?null:t+"");for(var r=this._groups,i=r.length,o=0;o<i;++o)for(var a,u=r[o],s=u.length,l=0;l<s;++l)(a=u[l])&&ye(a,t,n,l,u,e||He(a,n));return new Le(r,this._parents,t,n)};var Ve=t=>()=>t;function Xe(t,{sourceEvent:n,target:e,transform:r,dispatch:i}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:n,enumerable:!0,configurable:!0},target:{value:e,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:i}})}function Ge(t,n,e){this.k=t,this.x=n,this.y=e}Ge.prototype={constructor:Ge,scale:function(t){return 1===t?this:new Ge(this.k*t,this.x,this.y)},translate:function(t,n){return 0===t&0===n?this:new Ge(this.k,this.x+this.k*t,this.y+this.k*n)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Ye=new Ge(1,0,0);function We(t){for(;!t.__zoom;)if(!(t=t.parentNode))return Ye;return t.__zoom}function Ze(t){t.stopImmediatePropagation()}function Qe(t){t.preventDefault(),t.stopImmediatePropagation()}function Ke(t){return!(t.ctrlKey&&"wheel"!==t.type||t.button)}function Je(){var t=this;return t instanceof SVGElement?(t=t.ownerSVGElement||t).hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]:[[0,0],[t.clientWidth,t.clientHeight]]}function tr(){return this.__zoom||Ye}function nr(t){return-t.deltaY*(1===t.deltaMode?.05:t.deltaMode?1:.002)*(t.ctrlKey?10:1)}function er(){return navigator.maxTouchPoints||"ontouchstart"in this}function rr(t,n,e){var r=t.invertX(n[0][0])-e[0][0],i=t.invertX(n[1][0])-e[1][0],o=t.invertY(n[0][1])-e[0][1],a=t.invertY(n[1][1])-e[1][1];return t.translate(i>r?(r+i)/2:Math.min(0,r)||Math.max(0,i),a>o?(o+a)/2:Math.min(0,o)||Math.max(0,a))}function ir(){var t,n,e,r=Ke,i=Je,o=rr,a=nr,u=er,s=[0,1/0],l=[[-1/0,-1/0],[1/0,1/0]],c=250,h=$n,f=Ct("start","zoom","end"),d=500,p=150,g=0,y=10;function v(t){t.property("__zoom",tr).on("wheel.zoom",M,{passive:!1}).on("mousedown.zoom",z).on("dblclick.zoom",A).filter(u).on("touchstart.zoom",S).on("touchmove.zoom",C).on("touchend.zoom touchcancel.zoom",E).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function _(t,n){return(n=Math.max(s[0],Math.min(s[1],n)))===t.k?t:new Ge(n,t.x,t.y)}function m(t,n,e){var r=n[0]-e[0]*t.k,i=n[1]-e[1]*t.k;return r===t.x&&i===t.y?t:new Ge(t.k,r,i)}function x(t){return[(+t[0][0]+ +t[1][0])/2,(+t[0][1]+ +t[1][1])/2]}function b(t,n,e,r){t.on("start.zoom",(function(){w(this,arguments).event(r).start()})).on("interrupt.zoom end.zoom",(function(){w(this,arguments).event(r).end()})).tween("zoom",(function(){var t=this,o=arguments,a=w(t,o).event(r),u=i.apply(t,o),s=null==e?x(u):"function"==typeof e?e.apply(t,o):e,l=Math.max(u[1][0]-u[0][0],u[1][1]-u[0][1]),c=t.__zoom,f="function"==typeof n?n.apply(t,o):n,d=h(c.invert(s).concat(l/c.k),f.invert(s).concat(l/f.k));return function(t){if(1===t)t=f;else{var n=d(t),e=l/n[2];t=new Ge(e,s[0]-n[0]*e,s[1]-n[1]*e)}a.zoom(null,t)}}))}function w(t,n,e){return!e&&t.__zooming||new k(t,n)}function k(t,n){this.that=t,this.args=n,this.active=0,this.sourceEvent=null,this.extent=i.apply(t,n),this.taps=0}function M(t,...n){if(r.apply(this,arguments)){var e=w(this,n).event(t),i=this.__zoom,u=Math.max(s[0],Math.min(s[1],i.k*Math.pow(2,a.apply(this,arguments)))),c=At(t);if(e.wheel)e.mouse[0][0]===c[0]&&e.mouse[0][1]===c[1]||(e.mouse[1]=i.invert(e.mouse[0]=c)),clearTimeout(e.wheel);else{if(i.k===u)return;e.mouse=[c,i.invert(c)],xe(this),e.start()}Qe(t),e.wheel=setTimeout((function(){e.wheel=null,e.end()}),p),e.zoom("mouse",o(m(_(i,u),e.mouse[0],e.mouse[1]),e.extent,l))}}function z(t,...n){if(!e&&r.apply(this,arguments)){var i=t.currentTarget,a=w(this,n,!0).event(t),u=zt(t.view).on("mousemove.zoom",(function(t){if(Qe(t),!a.moved){var n=t.clientX-c,e=t.clientY-h;a.moved=n*n+e*e>g}a.event(t).zoom("mouse",o(m(a.that.__zoom,a.mouse[0]=At(t,i),a.mouse[1]),a.extent,l))}),!0).on("mouseup.zoom",(function(t){u.on("mousemove.zoom mouseup.zoom",null),It(t.view,a.moved),Qe(t),a.event(t).end()}),!0),s=At(t,i),c=t.clientX,h=t.clientY;Dt(t.view),Ze(t),a.mouse=[s,this.__zoom.invert(s)],xe(this),a.start()}}function A(t,...n){if(r.apply(this,arguments)){var e=this.__zoom,a=At(t.changedTouches?t.changedTouches[0]:t,this),u=e.invert(a),s=e.k*(t.shiftKey?.5:2),h=o(m(_(e,s),a,u),i.apply(this,n),l);Qe(t),c>0?zt(this).transition().duration(c).call(b,h,a,t):zt(this).call(v.transform,h,a,t)}}function S(e,...i){if(r.apply(this,arguments)){var o,a,u,s,l=e.touches,c=l.length,h=w(this,i,e.changedTouches.length===c).event(e);for(Ze(e),a=0;a<c;++a)s=[s=At(u=l[a],this),this.__zoom.invert(s),u.identifier],h.touch0?h.touch1||h.touch0[2]===s[2]||(h.touch1=s,h.taps=0):(h.touch0=s,o=!0,h.taps=1+!!t);t&&(t=clearTimeout(t)),o&&(h.taps<2&&(n=s[0],t=setTimeout((function(){t=null}),d)),xe(this),h.start())}}function C(t,...n){if(this.__zooming){var e,r,i,a,u=w(this,n).event(t),s=t.changedTouches,c=s.length;for(Qe(t),e=0;e<c;++e)i=At(r=s[e],this),u.touch0&&u.touch0[2]===r.identifier?u.touch0[0]=i:u.touch1&&u.touch1[2]===r.identifier&&(u.touch1[0]=i);if(r=u.that.__zoom,u.touch1){var h=u.touch0[0],f=u.touch0[1],d=u.touch1[0],p=u.touch1[1],g=(g=d[0]-h[0])*g+(g=d[1]-h[1])*g,y=(y=p[0]-f[0])*y+(y=p[1]-f[1])*y;r=_(r,Math.sqrt(g/y)),i=[(h[0]+d[0])/2,(h[1]+d[1])/2],a=[(f[0]+p[0])/2,(f[1]+p[1])/2]}else{if(!u.touch0)return;i=u.touch0[0],a=u.touch0[1]}u.zoom("touch",o(m(r,i,a),u.extent,l))}}function E(t,...r){if(this.__zooming){var i,o,a=w(this,r).event(t),u=t.changedTouches,s=u.length;for(Ze(t),e&&clearTimeout(e),e=setTimeout((function(){e=null}),d),i=0;i<s;++i)o=u[i],a.touch0&&a.touch0[2]===o.identifier?delete a.touch0:a.touch1&&a.touch1[2]===o.identifier&&delete a.touch1;if(a.touch1&&!a.touch0&&(a.touch0=a.touch1,delete a.touch1),a.touch0)a.touch0[1]=this.__zoom.invert(a.touch0[0]);else if(a.end(),2===a.taps&&(o=At(o,this),Math.hypot(n[0]-o[0],n[1]-o[1])<y)){var l=zt(this).on("dblclick.zoom");l&&l.apply(this,arguments)}}}return v.transform=function(t,n,e,r){var i=t.selection?t.selection():t;i.property("__zoom",tr),t!==i?b(t,n,e,r):i.interrupt().each((function(){w(this,arguments).event(r).start().zoom(null,"function"==typeof n?n.apply(this,arguments):n).end()}))},v.scaleBy=function(t,n,e,r){v.scaleTo(t,(function(){return this.__zoom.k*("function"==typeof n?n.apply(this,arguments):n)}),e,r)},v.scaleTo=function(t,n,e,r){v.transform(t,(function(){var t=i.apply(this,arguments),r=this.__zoom,a=null==e?x(t):"function"==typeof e?e.apply(this,arguments):e,u=r.invert(a),s="function"==typeof n?n.apply(this,arguments):n;return o(m(_(r,s),a,u),t,l)}),e,r)},v.translateBy=function(t,n,e,r){v.transform(t,(function(){return o(this.__zoom.translate("function"==typeof n?n.apply(this,arguments):n,"function"==typeof e?e.apply(this,arguments):e),i.apply(this,arguments),l)}),null,r)},v.translateTo=function(t,n,e,r,a){v.transform(t,(function(){var t=i.apply(this,arguments),a=this.__zoom,u=null==r?x(t):"function"==typeof r?r.apply(this,arguments):r;return o(Ye.translate(u[0],u[1]).scale(a.k).translate("function"==typeof n?-n.apply(this,arguments):-n,"function"==typeof e?-e.apply(this,arguments):-e),t,l)}),r,a)},k.prototype={event:function(t){return t&&(this.sourceEvent=t),this},start:function(){return 1==++this.active&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(t,n){return this.mouse&&"mouse"!==t&&(this.mouse[1]=n.invert(this.mouse[0])),this.touch0&&"touch"!==t&&(this.touch0[1]=n.invert(this.touch0[0])),this.touch1&&"touch"!==t&&(this.touch1[1]=n.invert(this.touch1[0])),this.that.__zoom=n,this.emit("zoom"),this},end:function(){return 0==--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(t){var n=zt(this.that).datum();f.call(t,this.that,new Xe(t,{sourceEvent:this.sourceEvent,target:v,type:t,transform:this.that.__zoom,dispatch:f}),n)}},v.wheelDelta=function(t){return arguments.length?(a="function"==typeof t?t:Ve(+t),v):a},v.filter=function(t){return arguments.length?(r="function"==typeof t?t:Ve(!!t),v):r},v.touchable=function(t){return arguments.length?(u="function"==typeof t?t:Ve(!!t),v):u},v.extent=function(t){return arguments.length?(i="function"==typeof t?t:Ve([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),v):i},v.scaleExtent=function(t){return arguments.length?(s[0]=+t[0],s[1]=+t[1],v):[s[0],s[1]]},v.translateExtent=function(t){return arguments.length?(l[0][0]=+t[0][0],l[1][0]=+t[1][0],l[0][1]=+t[0][1],l[1][1]=+t[1][1],v):[[l[0][0],l[0][1]],[l[1][0],l[1][1]]]},v.constrain=function(t){return arguments.length?(o=t,v):o},v.duration=function(t){return arguments.length?(c=+t,v):c},v.interpolate=function(t){return arguments.length?(h=t,v):h},v.on=function(){var t=f.on.apply(f,arguments);return t===f?v:t},v.clickDistance=function(t){return arguments.length?(g=(t=+t)*t,v):Math.sqrt(g)},v.tapDistance=function(t){return arguments.length?(y=+t,v):y},v}We.prototype=Ge.prototype;class or extends Map{constructor(t,n=ur){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:n}}),null!=t)for(const[n,e]of t)this.set(n,e)}get(t){return super.get(ar(this,t))}has(t){return super.has(ar(this,t))}set(t,n){return super.set(function({_intern:t,_key:n},e){const r=n(e);return t.has(r)?t.get(r):(t.set(r,e),e)}(this,t),n)}delete(t){return super.delete(function({_intern:t,_key:n},e){const r=n(e);t.has(r)&&(e=t.get(r),t.delete(r));return e}(this,t))}}function ar({_intern:t,_key:n},e){const r=n(e);return t.has(r)?t.get(r):e}function ur(t){return null!==t&&"object"==typeof t?t.valueOf():t}function sr(t,n){let e;if(void 0===n)for(const n of t)null!=n&&(e<n||void 0===e&&n>=n)&&(e=n);else{let r=-1;for(let i of t)null!=(i=n(i,++r,t))&&(e<i||void 0===e&&i>=i)&&(e=i)}return e}function lr(t,n){let e;if(void 0===n)for(const n of t)null!=n&&(e>n||void 0===e&&n>=n)&&(e=n);else{let r=-1;for(let i of t)null!=(i=n(i,++r,t))&&(e>i||void 0===e&&i>=i)&&(e=i)}return e}var cr="object"==typeof global&&global&&global.Object===Object&&global,hr="object"==typeof self&&self&&self.Object===Object&&self,fr=cr||hr||Function("return this")(),dr=fr.Symbol,pr=Object.prototype,gr=pr.hasOwnProperty,yr=pr.toString,vr=dr?dr.toStringTag:void 0;var _r=Object.prototype.toString;var mr="[object Null]",xr="[object Undefined]",br=dr?dr.toStringTag:void 0;function wr(t){return null==t?void 0===t?xr:mr:br&&br in Object(t)?function(t){var n=gr.call(t,vr),e=t[vr];try{t[vr]=void 0;var r=!0}catch(t){}var i=yr.call(t);return r&&(n?t[vr]=e:delete t[vr]),i}(t):function(t){return _r.call(t)}(t)}var kr="[object Symbol]";var Mr=/\s/;var zr=/^\s+/;function Ar(t){return t?t.slice(0,function(t){for(var n=t.length;n--&&Mr.test(t.charAt(n)););return n}(t)+1).replace(zr,""):t}function Sr(t){var n=typeof t;return null!=t&&("object"==n||"function"==n)}var Cr=NaN,Er=/^[-+]0x[0-9a-f]+$/i,Or=/^0b[01]+$/i,Nr=/^0o[0-7]+$/i,Pr=parseInt;function jr(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return null!=t&&"object"==typeof t}(t)&&wr(t)==kr}(t))return Cr;if(Sr(t)){var n="function"==typeof t.valueOf?t.valueOf():t;t=Sr(n)?n+"":n}if("string"!=typeof t)return 0===t?t:+t;t=Ar(t);var e=Or.test(t);return e||Nr.test(t)?Pr(t.slice(2),e?2:8):Er.test(t)?Cr:+t}var Tr=function(){return fr.Date.now()},Rr="Expected a function",Dr=Math.max,Ir=Math.min;function Ur(t,n,e){var r,i,o,a,u,s,l=0,c=!1,h=!1,f=!0;if("function"!=typeof t)throw new TypeError(Rr);function d(n){var e=r,o=i;return r=i=void 0,l=n,a=t.apply(o,e)}function p(t){var e=t-s;return void 0===s||e>=n||e<0||h&&t-l>=o}function g(){var t=Tr();if(p(t))return y(t);u=setTimeout(g,function(t){var e=n-(t-s);return h?Ir(e,o-(t-l)):e}(t))}function y(t){return u=void 0,f&&r?d(t):(r=i=void 0,a)}function v(){var t=Tr(),e=p(t);if(r=arguments,i=this,s=t,e){if(void 0===u)return function(t){return l=t,u=setTimeout(g,n),c?d(t):a}(s);if(h)return clearTimeout(u),u=setTimeout(g,n),d(s)}return void 0===u&&(u=setTimeout(g,n)),a}return n=jr(n)||0,Sr(e)&&(c=!!e.leading,o=(h="maxWait"in e)?Dr(jr(e.maxWait)||0,n):o,f="trailing"in e?!!e.trailing:f),v.cancel=function(){void 0!==u&&clearTimeout(u),l=0,r=s=i=u=void 0},v.flush=function(){return void 0===u?a:y(Tr())},v}var Fr=Object.freeze({Linear:Object.freeze({None:function(t){return t},In:function(t){return this.None(t)},Out:function(t){return this.None(t)},InOut:function(t){return this.None(t)}}),Quadratic:Object.freeze({In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}}),Cubic:Object.freeze({In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}}),Quartic:Object.freeze({In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}}),Quintic:Object.freeze({In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}}),Sinusoidal:Object.freeze({In:function(t){return 1-Math.sin((1-t)*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.sin(Math.PI*(.5-t)))}}),Exponential:Object.freeze({In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}}),Circular:Object.freeze({In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}}),Elastic:Object.freeze({In:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},Out:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(t){var n=1.70158;return 1===t?1:t*t*((n+1)*t-n)},Out:function(t){var n=1.70158;return 0===t?0:--t*t*((n+1)*t+n)+1},InOut:function(t){var n=2.5949095;return(t*=2)<1?t*t*((n+1)*t-n)*.5:.5*((t-=2)*t*((n+1)*t+n)+2)}}),Bounce:Object.freeze({In:function(t){return 1-Fr.Bounce.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return t<.5?.5*Fr.Bounce.In(2*t):.5*Fr.Bounce.Out(2*t-1)+.5}}),generatePow:function(t){return void 0===t&&(t=4),t=(t=t<Number.EPSILON?Number.EPSILON:t)>1e4?1e4:t,{In:function(n){return Math.pow(n,t)},Out:function(n){return 1-Math.pow(1-n,t)},InOut:function(n){return n<.5?Math.pow(2*n,t)/2:(1-Math.pow(2-2*n,t))/2+.5}}}}),Lr=function(){return performance.now()},qr=function(){function t(){this._tweens={},this._tweensAddedDuringUpdate={}}return t.prototype.getAll=function(){var t=this;return Object.keys(this._tweens).map((function(n){return t._tweens[n]}))},t.prototype.removeAll=function(){this._tweens={}},t.prototype.add=function(t){this._tweens[t.getId()]=t,this._tweensAddedDuringUpdate[t.getId()]=t},t.prototype.remove=function(t){delete this._tweens[t.getId()],delete this._tweensAddedDuringUpdate[t.getId()]},t.prototype.update=function(t,n){void 0===t&&(t=Lr()),void 0===n&&(n=!1);var e=Object.keys(this._tweens);if(0===e.length)return!1;for(;e.length>0;){this._tweensAddedDuringUpdate={};for(var r=0;r<e.length;r++){var i=this._tweens[e[r]],o=!n;i&&!1===i.update(t,o)&&!n&&delete this._tweens[e[r]]}e=Object.keys(this._tweensAddedDuringUpdate)}return!0},t}(),Br={Linear:function(t,n){var e=t.length-1,r=e*n,i=Math.floor(r),o=Br.Utils.Linear;return n<0?o(t[0],t[1],r):n>1?o(t[e],t[e-1],e-r):o(t[i],t[i+1>e?e:i+1],r-i)},Bezier:function(t,n){for(var e=0,r=t.length-1,i=Math.pow,o=Br.Utils.Bernstein,a=0;a<=r;a++)e+=i(1-n,r-a)*i(n,a)*t[a]*o(r,a);return e},CatmullRom:function(t,n){var e=t.length-1,r=e*n,i=Math.floor(r),o=Br.Utils.CatmullRom;return t[0]===t[e]?(n<0&&(i=Math.floor(r=e*(1+n))),o(t[(i-1+e)%e],t[i],t[(i+1)%e],t[(i+2)%e],r-i)):n<0?t[0]-(o(t[0],t[0],t[1],t[1],-r)-t[0]):n>1?t[e]-(o(t[e],t[e],t[e-1],t[e-1],r-e)-t[e]):o(t[i?i-1:0],t[i],t[e<i+1?e:i+1],t[e<i+2?e:i+2],r-i)},Utils:{Linear:function(t,n,e){return(n-t)*e+t},Bernstein:function(t,n){var e=Br.Utils.Factorial;return e(t)/e(n)/e(t-n)},Factorial:function(){var t=[1];return function(n){var e=1;if(t[n])return t[n];for(var r=n;r>1;r--)e*=r;return t[n]=e,e}}(),CatmullRom:function(t,n,e,r,i){var o=.5*(e-t),a=.5*(r-n),u=i*i;return(2*n-2*e+o+a)*(i*u)+(-3*n+3*e-2*o-a)*u+o*i+n}}},$r=function(){function t(){}return t.nextId=function(){return t._nextId++},t._nextId=0,t}(),Hr=new qr,Vr=function(){function t(t,n){void 0===n&&(n=Hr),this._object=t,this._group=n,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Fr.Linear.None,this._interpolationFunction=Br.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=$r.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return t.prototype.getId=function(){return this._id},t.prototype.isPlaying=function(){return this._isPlaying},t.prototype.isPaused=function(){return this._isPaused},t.prototype.getDuration=function(){return this._duration},t.prototype.to=function(t,n){if(void 0===n&&(n=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=t,this._propertiesAreSetUp=!1,this._duration=n<0?0:n,this},t.prototype.duration=function(t){return void 0===t&&(t=1e3),this._duration=t<0?0:t,this},t.prototype.dynamic=function(t){return void 0===t&&(t=!1),this._isDynamic=t,this},t.prototype.start=function(t,n){if(void 0===t&&(t=Lr()),void 0===n&&(n=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed)for(var e in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(e),this._valuesStart[e]=this._valuesStartRepeat[e];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=t,this._startTime+=this._delayTime,!this._propertiesAreSetUp||n){if(this._propertiesAreSetUp=!0,!this._isDynamic){var r={};for(var i in this._valuesEnd)r[i]=this._valuesEnd[i];this._valuesEnd=r}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,n)}return this},t.prototype.startFromCurrentValues=function(t){return this.start(t,!0)},t.prototype._setupProperties=function(t,n,e,r,i){for(var o in e){var a=t[o],u=Array.isArray(a),s=u?"array":typeof a,l=!u&&Array.isArray(e[o]);if("undefined"!==s&&"function"!==s){if(l){if(0===(y=e[o]).length)continue;for(var c=[a],h=0,f=y.length;h<f;h+=1){var d=this._handleRelativeValue(a,y[h]);if(isNaN(d)){l=!1,console.warn("Found invalid interpolation list. Skipping.");break}c.push(d)}l&&(e[o]=c)}if("object"!==s&&!u||!a||l)(void 0===n[o]||i)&&(n[o]=a),u||(n[o]*=1),r[o]=l?e[o].slice().reverse():n[o]||0;else{n[o]=u?[]:{};var p=a;for(var g in p)n[o][g]=p[g];r[o]=u?[]:{};var y=e[o];if(!this._isDynamic){var v={};for(var g in y)v[g]=y[g];e[o]=y=v}this._setupProperties(p,n[o],y,r[o],i)}}}},t.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},t.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},t.prototype.pause=function(t){return void 0===t&&(t=Lr()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=t,this._group&&this._group.remove(this)),this},t.prototype.resume=function(t){return void 0===t&&(t=Lr()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=t-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this):this},t.prototype.stopChainedTweens=function(){for(var t=0,n=this._chainedTweens.length;t<n;t++)this._chainedTweens[t].stop();return this},t.prototype.group=function(t){return void 0===t&&(t=Hr),this._group=t,this},t.prototype.delay=function(t){return void 0===t&&(t=0),this._delayTime=t,this},t.prototype.repeat=function(t){return void 0===t&&(t=0),this._initialRepeat=t,this._repeat=t,this},t.prototype.repeatDelay=function(t){return this._repeatDelayTime=t,this},t.prototype.yoyo=function(t){return void 0===t&&(t=!1),this._yoyo=t,this},t.prototype.easing=function(t){return void 0===t&&(t=Fr.Linear.None),this._easingFunction=t,this},t.prototype.interpolation=function(t){return void 0===t&&(t=Br.Linear),this._interpolationFunction=t,this},t.prototype.chain=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this._chainedTweens=t,this},t.prototype.onStart=function(t){return this._onStartCallback=t,this},t.prototype.onEveryStart=function(t){return this._onEveryStartCallback=t,this},t.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},t.prototype.onRepeat=function(t){return this._onRepeatCallback=t,this},t.prototype.onComplete=function(t){return this._onCompleteCallback=t,this},t.prototype.onStop=function(t){return this._onStopCallback=t,this},t.prototype.update=function(t,n){var e,r,i=this;if(void 0===t&&(t=Lr()),void 0===n&&(n=!0),this._isPaused)return!0;var o=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(t>o)return!1;n&&this.start(t,!0)}if(this._goToEnd=!1,t<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var a=t-this._startTime,u=this._duration+(null!==(e=this._repeatDelayTime)&&void 0!==e?e:this._delayTime),s=this._duration+this._repeat*u,l=function(){if(0===i._duration)return 1;if(a>s)return 1;var t=Math.trunc(a/u),n=a-t*u,e=Math.min(n/i._duration,1);return 0===e&&a===i._duration?1:e}(),c=this._easingFunction(l);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,c),this._onUpdateCallback&&this._onUpdateCallback(this._object,l),0===this._duration||a>=this._duration){if(this._repeat>0){var h=Math.min(Math.trunc((a-this._duration)/u)+1,this._repeat);for(r in isFinite(this._repeat)&&(this._repeat-=h),this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[r]||(this._valuesStartRepeat[r]=this._valuesStartRepeat[r]+parseFloat(this._valuesEnd[r])),this._yoyo&&this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=u*h,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var f=0,d=this._chainedTweens.length;f<d;f++)this._chainedTweens[f].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},t.prototype._updateProperties=function(t,n,e,r){for(var i in e)if(void 0!==n[i]){var o=n[i]||0,a=e[i],u=Array.isArray(t[i]),s=Array.isArray(a);!u&&s?t[i]=this._interpolationFunction(a,r):"object"==typeof a&&a?this._updateProperties(t[i],o,a,r):"number"==typeof(a=this._handleRelativeValue(o,a))&&(t[i]=o+(a-o)*r)}},t.prototype._handleRelativeValue=function(t,n){return"string"!=typeof n?n:"+"===n.charAt(0)||"-"===n.charAt(0)?t+parseFloat(n):parseFloat(n)},t.prototype._swapEndStartRepeatValues=function(t){var n=this._valuesStartRepeat[t],e=this._valuesEnd[t];this._valuesStartRepeat[t]="string"==typeof e?this._valuesStartRepeat[t]+parseFloat(e):this._valuesEnd[t],this._valuesEnd[t]=n},t}(),Xr=Hr;Xr.getAll.bind(Xr),Xr.removeAll.bind(Xr),Xr.add.bind(Xr),Xr.remove.bind(Xr);var Gr=Xr.update.bind(Xr);function Yr(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,(i=r.key,o=void 0,"symbol"==typeof(o=function(t,n){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(i,"string"))?o:String(o)),r)}var i,o}function Wr(t,n,e){return n&&Yr(t.prototype,n),e&&Yr(t,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function Zr(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){var e=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=e){var r,i,o,a,u=[],s=!0,l=!1;try{if(o=(e=e.call(t)).next,0===n){if(Object(e)!==e)return;s=!1}else for(;!(s=(r=o.call(e)).done)&&(u.push(r.value),u.length!==n);s=!0);}catch(t){l=!0,i=t}finally{try{if(!s&&null!=e.return&&(a=e.return(),Object(a)!==a))return}finally{if(l)throw i}}return u}}(t,n)||function(t,n){if(!t)return;if("string"==typeof t)return Qr(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(t);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Qr(t,n)}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Qr(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}var Kr=Wr((function t(n,e){var r=e.default,i=void 0===r?null:r,o=e.triggerUpdate,a=void 0===o||o,u=e.onChange,s=void 0===u?function(t,n){}:u;!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),this.name=n,this.defaultVal=i,this.triggerUpdate=a,this.onChange=s}));function Jr(t){var n=t.stateInit,e=void 0===n?function(){return{}}:n,r=t.props,i=void 0===r?{}:r,o=t.methods,a=void 0===o?{}:o,u=t.aliases,s=void 0===u?{}:u,l=t.init,c=void 0===l?function(){}:l,h=t.update,f=void 0===h?function(){}:h,d=Object.keys(i).map((function(t){return new Kr(t,i[t])}));return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=Object.assign({},e instanceof Function?e(t):e,{initialised:!1}),r={};function i(n){return o(n,t),u(),i}var o=function(t,e){c.call(i,t,n,e),n.initialised=!0},u=Ur((function(){n.initialised&&(f.call(i,n,r),r={})}),1);return d.forEach((function(t){i[t.name]=function(t){var e=t.name,o=t.triggerUpdate,a=void 0!==o&&o,s=t.onChange,l=void 0===s?function(t,n){}:s,c=t.defaultVal,h=void 0===c?null:c;return function(t){var o=n[e];if(!arguments.length)return o;var s=void 0===t?h:t;return n[e]=s,l.call(i,s,n,o),!r.hasOwnProperty(e)&&(r[e]=o),a&&u(),i}}(t)})),Object.keys(a).forEach((function(t){i[t]=function(){for(var e,r=arguments.length,o=new Array(r),u=0;u<r;u++)o[u]=arguments[u];return(e=a[t]).call.apply(e,[i,n].concat(o))}})),Object.entries(s).forEach((function(t){var n=Zr(t,2),e=n[0],r=n[1];return i[e]=i[r]})),i.resetProps=function(){return d.forEach((function(t){i[t.name](t.defaultVal)})),i},i.resetProps(),n._rerender=u,i}}var ti=function(t){return"function"==typeof t?t:"string"==typeof t?function(n){return n[t]}:function(n){return t}};function ni(t){return ni="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ni(t)}var ei=/^\s+/,ri=/\s+$/;function ii(t,n){if(n=n||{},(t=t||"")instanceof ii)return t;if(!(this instanceof ii))return new ii(t,n);var e=function(t){var n={r:0,g:0,b:0},e=1,r=null,i=null,o=null,a=!1,u=!1;"string"==typeof t&&(t=function(t){t=t.replace(ei,"").replace(ri,"").toLowerCase();var n,e=!1;if(bi[t])t=bi[t],e=!0;else if("transparent"==t)return{r:0,g:0,b:0,a:0,format:"name"};if(n=Ti.rgb.exec(t))return{r:n[1],g:n[2],b:n[3]};if(n=Ti.rgba.exec(t))return{r:n[1],g:n[2],b:n[3],a:n[4]};if(n=Ti.hsl.exec(t))return{h:n[1],s:n[2],l:n[3]};if(n=Ti.hsla.exec(t))return{h:n[1],s:n[2],l:n[3],a:n[4]};if(n=Ti.hsv.exec(t))return{h:n[1],s:n[2],v:n[3]};if(n=Ti.hsva.exec(t))return{h:n[1],s:n[2],v:n[3],a:n[4]};if(n=Ti.hex8.exec(t))return{r:Ai(n[1]),g:Ai(n[2]),b:Ai(n[3]),a:Oi(n[4]),format:e?"name":"hex8"};if(n=Ti.hex6.exec(t))return{r:Ai(n[1]),g:Ai(n[2]),b:Ai(n[3]),format:e?"name":"hex"};if(n=Ti.hex4.exec(t))return{r:Ai(n[1]+""+n[1]),g:Ai(n[2]+""+n[2]),b:Ai(n[3]+""+n[3]),a:Oi(n[4]+""+n[4]),format:e?"name":"hex8"};if(n=Ti.hex3.exec(t))return{r:Ai(n[1]+""+n[1]),g:Ai(n[2]+""+n[2]),b:Ai(n[3]+""+n[3]),format:e?"name":"hex"};return!1}(t));"object"==ni(t)&&(Ri(t.r)&&Ri(t.g)&&Ri(t.b)?(s=t.r,l=t.g,c=t.b,n={r:255*Mi(s,255),g:255*Mi(l,255),b:255*Mi(c,255)},a=!0,u="%"===String(t.r).substr(-1)?"prgb":"rgb"):Ri(t.h)&&Ri(t.s)&&Ri(t.v)?(r=Ci(t.s),i=Ci(t.v),n=function(t,n,e){t=6*Mi(t,360),n=Mi(n,100),e=Mi(e,100);var r=Math.floor(t),i=t-r,o=e*(1-n),a=e*(1-i*n),u=e*(1-(1-i)*n),s=r%6,l=[e,a,o,o,u,e][s],c=[u,e,e,a,o,o][s],h=[o,o,u,e,e,a][s];return{r:255*l,g:255*c,b:255*h}}(t.h,r,i),a=!0,u="hsv"):Ri(t.h)&&Ri(t.s)&&Ri(t.l)&&(r=Ci(t.s),o=Ci(t.l),n=function(t,n,e){var r,i,o;function a(t,n,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?t+6*(n-t)*e:e<.5?n:e<2/3?t+(n-t)*(2/3-e)*6:t}if(t=Mi(t,360),n=Mi(n,100),e=Mi(e,100),0===n)r=i=o=e;else{var u=e<.5?e*(1+n):e+n-e*n,s=2*e-u;r=a(s,u,t+1/3),i=a(s,u,t),o=a(s,u,t-1/3)}return{r:255*r,g:255*i,b:255*o}}(t.h,r,o),a=!0,u="hsl"),t.hasOwnProperty("a")&&(e=t.a));var s,l,c;return e=ki(e),{ok:a,format:t.format||u,r:Math.min(255,Math.max(n.r,0)),g:Math.min(255,Math.max(n.g,0)),b:Math.min(255,Math.max(n.b,0)),a:e}}(t);this._originalInput=t,this._r=e.r,this._g=e.g,this._b=e.b,this._a=e.a,this._roundA=Math.round(100*this._a)/100,this._format=n.format||e.format,this._gradientType=n.gradientType,this._r<1&&(this._r=Math.round(this._r)),this._g<1&&(this._g=Math.round(this._g)),this._b<1&&(this._b=Math.round(this._b)),this._ok=e.ok}function oi(t,n,e){t=Mi(t,255),n=Mi(n,255),e=Mi(e,255);var r,i,o=Math.max(t,n,e),a=Math.min(t,n,e),u=(o+a)/2;if(o==a)r=i=0;else{var s=o-a;switch(i=u>.5?s/(2-o-a):s/(o+a),o){case t:r=(n-e)/s+(n<e?6:0);break;case n:r=(e-t)/s+2;break;case e:r=(t-n)/s+4}r/=6}return{h:r,s:i,l:u}}function ai(t,n,e){t=Mi(t,255),n=Mi(n,255),e=Mi(e,255);var r,i,o=Math.max(t,n,e),a=Math.min(t,n,e),u=o,s=o-a;if(i=0===o?0:s/o,o==a)r=0;else{switch(o){case t:r=(n-e)/s+(n<e?6:0);break;case n:r=(e-t)/s+2;break;case e:r=(t-n)/s+4}r/=6}return{h:r,s:i,v:u}}function ui(t,n,e,r){var i=[Si(Math.round(t).toString(16)),Si(Math.round(n).toString(16)),Si(Math.round(e).toString(16))];return r&&i[0].charAt(0)==i[0].charAt(1)&&i[1].charAt(0)==i[1].charAt(1)&&i[2].charAt(0)==i[2].charAt(1)?i[0].charAt(0)+i[1].charAt(0)+i[2].charAt(0):i.join("")}function si(t,n,e,r){return[Si(Ei(r)),Si(Math.round(t).toString(16)),Si(Math.round(n).toString(16)),Si(Math.round(e).toString(16))].join("")}function li(t,n){n=0===n?0:n||10;var e=ii(t).toHsl();return e.s-=n/100,e.s=zi(e.s),ii(e)}function ci(t,n){n=0===n?0:n||10;var e=ii(t).toHsl();return e.s+=n/100,e.s=zi(e.s),ii(e)}function hi(t){return ii(t).desaturate(100)}function fi(t,n){n=0===n?0:n||10;var e=ii(t).toHsl();return e.l+=n/100,e.l=zi(e.l),ii(e)}function di(t,n){n=0===n?0:n||10;var e=ii(t).toRgb();return e.r=Math.max(0,Math.min(255,e.r-Math.round(-n/100*255))),e.g=Math.max(0,Math.min(255,e.g-Math.round(-n/100*255))),e.b=Math.max(0,Math.min(255,e.b-Math.round(-n/100*255))),ii(e)}function pi(t,n){n=0===n?0:n||10;var e=ii(t).toHsl();return e.l-=n/100,e.l=zi(e.l),ii(e)}function gi(t,n){var e=ii(t).toHsl(),r=(e.h+n)%360;return e.h=r<0?360+r:r,ii(e)}function yi(t){var n=ii(t).toHsl();return n.h=(n.h+180)%360,ii(n)}function vi(t,n){if(isNaN(n)||n<=0)throw new Error("Argument to polyad must be a positive number");for(var e=ii(t).toHsl(),r=[ii(t)],i=360/n,o=1;o<n;o++)r.push(ii({h:(e.h+o*i)%360,s:e.s,l:e.l}));return r}function _i(t){var n=ii(t).toHsl(),e=n.h;return[ii(t),ii({h:(e+72)%360,s:n.s,l:n.l}),ii({h:(e+216)%360,s:n.s,l:n.l})]}function mi(t,n,e){n=n||6,e=e||30;var r=ii(t).toHsl(),i=360/e,o=[ii(t)];for(r.h=(r.h-(i*n>>1)+720)%360;--n;)r.h=(r.h+i)%360,o.push(ii(r));return o}function xi(t,n){n=n||6;for(var e=ii(t).toHsv(),r=e.h,i=e.s,o=e.v,a=[],u=1/n;n--;)a.push(ii({h:r,s:i,v:o})),o=(o+u)%1;return a}ii.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var t=this.toRgb();return(299*t.r+587*t.g+114*t.b)/1e3},getLuminance:function(){var t,n,e,r=this.toRgb();return t=r.r/255,n=r.g/255,e=r.b/255,.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4))},setAlpha:function(t){return this._a=ki(t),this._roundA=Math.round(100*this._a)/100,this},toHsv:function(){var t=ai(this._r,this._g,this._b);return{h:360*t.h,s:t.s,v:t.v,a:this._a}},toHsvString:function(){var t=ai(this._r,this._g,this._b),n=Math.round(360*t.h),e=Math.round(100*t.s),r=Math.round(100*t.v);return 1==this._a?"hsv("+n+", "+e+"%, "+r+"%)":"hsva("+n+", "+e+"%, "+r+"%, "+this._roundA+")"},toHsl:function(){var t=oi(this._r,this._g,this._b);return{h:360*t.h,s:t.s,l:t.l,a:this._a}},toHslString:function(){var t=oi(this._r,this._g,this._b),n=Math.round(360*t.h),e=Math.round(100*t.s),r=Math.round(100*t.l);return 1==this._a?"hsl("+n+", "+e+"%, "+r+"%)":"hsla("+n+", "+e+"%, "+r+"%, "+this._roundA+")"},toHex:function(t){return ui(this._r,this._g,this._b,t)},toHexString:function(t){return"#"+this.toHex(t)},toHex8:function(t){return function(t,n,e,r,i){var o=[Si(Math.round(t).toString(16)),Si(Math.round(n).toString(16)),Si(Math.round(e).toString(16)),Si(Ei(r))];if(i&&o[0].charAt(0)==o[0].charAt(1)&&o[1].charAt(0)==o[1].charAt(1)&&o[2].charAt(0)==o[2].charAt(1)&&o[3].charAt(0)==o[3].charAt(1))return o[0].charAt(0)+o[1].charAt(0)+o[2].charAt(0)+o[3].charAt(0);return o.join("")}(this._r,this._g,this._b,this._a,t)},toHex8String:function(t){return"#"+this.toHex8(t)},toRgb:function(){return{r:Math.round(this._r),g:Math.round(this._g),b:Math.round(this._b),a:this._a}},toRgbString:function(){return 1==this._a?"rgb("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+")":"rgba("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:Math.round(100*Mi(this._r,255))+"%",g:Math.round(100*Mi(this._g,255))+"%",b:Math.round(100*Mi(this._b,255))+"%",a:this._a}},toPercentageRgbString:function(){return 1==this._a?"rgb("+Math.round(100*Mi(this._r,255))+"%, "+Math.round(100*Mi(this._g,255))+"%, "+Math.round(100*Mi(this._b,255))+"%)":"rgba("+Math.round(100*Mi(this._r,255))+"%, "+Math.round(100*Mi(this._g,255))+"%, "+Math.round(100*Mi(this._b,255))+"%, "+this._roundA+")"},toName:function(){return 0===this._a?"transparent":!(this._a<1)&&(wi[ui(this._r,this._g,this._b,!0)]||!1)},toFilter:function(t){var n="#"+si(this._r,this._g,this._b,this._a),e=n,r=this._gradientType?"GradientType = 1, ":"";if(t){var i=ii(t);e="#"+si(i._r,i._g,i._b,i._a)}return"progid:DXImageTransform.Microsoft.gradient("+r+"startColorstr="+n+",endColorstr="+e+")"},toString:function(t){var n=!!t;t=t||this._format;var e=!1,r=this._a<1&&this._a>=0;return n||!r||"hex"!==t&&"hex6"!==t&&"hex3"!==t&&"hex4"!==t&&"hex8"!==t&&"name"!==t?("rgb"===t&&(e=this.toRgbString()),"prgb"===t&&(e=this.toPercentageRgbString()),"hex"!==t&&"hex6"!==t||(e=this.toHexString()),"hex3"===t&&(e=this.toHexString(!0)),"hex4"===t&&(e=this.toHex8String(!0)),"hex8"===t&&(e=this.toHex8String()),"name"===t&&(e=this.toName()),"hsl"===t&&(e=this.toHslString()),"hsv"===t&&(e=this.toHsvString()),e||this.toHexString()):"name"===t&&0===this._a?this.toName():this.toRgbString()},clone:function(){return ii(this.toString())},_applyModification:function(t,n){var e=t.apply(null,[this].concat([].slice.call(n)));return this._r=e._r,this._g=e._g,this._b=e._b,this.setAlpha(e._a),this},lighten:function(){return this._applyModification(fi,arguments)},brighten:function(){return this._applyModification(di,arguments)},darken:function(){return this._applyModification(pi,arguments)},desaturate:function(){return this._applyModification(li,arguments)},saturate:function(){return this._applyModification(ci,arguments)},greyscale:function(){return this._applyModification(hi,arguments)},spin:function(){return this._applyModification(gi,arguments)},_applyCombination:function(t,n){return t.apply(null,[this].concat([].slice.call(n)))},analogous:function(){return this._applyCombination(mi,arguments)},complement:function(){return this._applyCombination(yi,arguments)},monochromatic:function(){return this._applyCombination(xi,arguments)},splitcomplement:function(){return this._applyCombination(_i,arguments)},triad:function(){return this._applyCombination(vi,[3])},tetrad:function(){return this._applyCombination(vi,[4])}},ii.fromRatio=function(t,n){if("object"==ni(t)){var e={};for(var r in t)t.hasOwnProperty(r)&&(e[r]="a"===r?t[r]:Ci(t[r]));t=e}return ii(t,n)},ii.equals=function(t,n){return!(!t||!n)&&ii(t).toRgbString()==ii(n).toRgbString()},ii.random=function(){return ii.fromRatio({r:Math.random(),g:Math.random(),b:Math.random()})},ii.mix=function(t,n,e){e=0===e?0:e||50;var r=ii(t).toRgb(),i=ii(n).toRgb(),o=e/100;return ii({r:(i.r-r.r)*o+r.r,g:(i.g-r.g)*o+r.g,b:(i.b-r.b)*o+r.b,a:(i.a-r.a)*o+r.a})},
// <http://www.w3.org/TR/2008/REC-WCAG20-20081211/#contrast-ratiodef (WCAG Version 2)
// Analyze the 2 colors and returns the color contrast defined by (WCAG Version 2)
ii.readability=function(t,n){var e=ii(t),r=ii(n);return(Math.max(e.getLuminance(),r.getLuminance())+.05)/(Math.min(e.getLuminance(),r.getLuminance())+.05)},ii.isReadable=function(t,n,e){var r,i,o=ii.readability(t,n);switch(i=!1,(r=function(t){var n,e;n=((t=t||{level:"AA",size:"small"}).level||"AA").toUpperCase(),e=(t.size||"small").toLowerCase(),"AA"!==n&&"AAA"!==n&&(n="AA");"small"!==e&&"large"!==e&&(e="small");return{level:n,size:e}}(e)).level+r.size){case"AAsmall":case"AAAlarge":i=o>=4.5;break;case"AAlarge":i=o>=3;break;case"AAAsmall":i=o>=7}return i},ii.mostReadable=function(t,n,e){var r,i,o,a,u=null,s=0;i=(e=e||{}).includeFallbackColors,o=e.level,a=e.size;for(var l=0;l<n.length;l++)(r=ii.readability(t,n[l]))>s&&(s=r,u=ii(n[l]));return ii.isReadable(t,u,{level:o,size:a})||!i?u:(e.includeFallbackColors=!1,ii.mostReadable(t,["#fff","#000"],e))};var bi=ii.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},wi=ii.hexNames=function(t){var n={};for(var e in t)t.hasOwnProperty(e)&&(n[t[e]]=e);return n}(bi);function ki(t){return t=parseFloat(t),(isNaN(t)||t<0||t>1)&&(t=1),t}function Mi(t,n){(function(t){return"string"==typeof t&&-1!=t.indexOf(".")&&1===parseFloat(t)})(t)&&(t="100%");var e=function(t){return"string"==typeof t&&-1!=t.indexOf("%")}(t);return t=Math.min(n,Math.max(0,parseFloat(t))),e&&(t=parseInt(t*n,10)/100),Math.abs(t-n)<1e-6?1:t%n/parseFloat(n)}function zi(t){return Math.min(1,Math.max(0,t))}function Ai(t){return parseInt(t,16)}function Si(t){return 1==t.length?"0"+t:""+t}function Ci(t){return t<=1&&(t=100*t+"%"),t}function Ei(t){return Math.round(255*parseFloat(t)).toString(16)}function Oi(t){return Ai(t)/255}var Ni,Pi,ji,Ti=(Pi="[\\s|\\(]+("+(Ni="(?:[-\\+]?\\d*\\.\\d+%?)|(?:[-\\+]?\\d+%?)")+")[,|\\s]+("+Ni+")[,|\\s]+("+Ni+")\\s*\\)?",ji="[\\s|\\(]+("+Ni+")[,|\\s]+("+Ni+")[,|\\s]+("+Ni+")[,|\\s]+("+Ni+")\\s*\\)?",{CSS_UNIT:new RegExp(Ni),rgb:new RegExp("rgb"+Pi),rgba:new RegExp("rgba"+ji),hsl:new RegExp("hsl"+Pi),hsla:new RegExp("hsla"+ji),hsv:new RegExp("hsv"+Pi),hsva:new RegExp("hsva"+ji),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/});function Ri(t){return!!Ti.CSS_UNIT.exec(t)}function Di(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,(i=r.key,o=void 0,"symbol"==typeof(o=function(t,n){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(i,"string"))?o:String(o)),r)}var i,o}function Ii(t){return function(t){if(Array.isArray(t))return Ui(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,n){if(!t)return;if("string"==typeof t)return Ui(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(t);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Ui(t,n)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ui(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}var Fi=function(t,n,e){return(t<<16)+(n<<8)+e},Li=function(t,n){return 123*t%Math.pow(2,n)},qi=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6;!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),this.csBits=n,this.registry=["__reserved for background__"]}var n,e,r;return n=t,e=[{key:"register",value:function(t){if(this.registry.length>=Math.pow(2,24-this.csBits))return null;var n,e=this.registry.length,r=Li(e,this.csBits),i=(n=e+(r<<24-this.csBits),"#".concat(Math.min(n,Math.pow(2,24)).toString(16).padStart(6,"0")));return this.registry.push(t),i}},{key:"lookup",value:function(t){var n,e,r,i,o="string"==typeof t?(n=ii(t).toRgb(),e=n.r,r=n.g,i=n.b,Fi(e,r,i)):Fi.apply(void 0,Ii(t));if(!o)return null;var a=o&Math.pow(2,24-this.csBits)-1,u=o>>24-this.csBits&Math.pow(2,this.csBits)-1;return Li(a,this.csBits)!==u||a>=this.registry.length?null:this.registry[a]}}],e&&Di(n.prototype,e),r&&Di(n,r),Object.defineProperty(n,"prototype",{writable:!1}),t}();function Bi(t,n,e){var r,i=1;function o(){var o,a,u=r.length,s=0,l=0,c=0;for(o=0;o<u;++o)s+=(a=r[o]).x||0,l+=a.y||0,c+=a.z||0;for(s=(s/u-t)*i,l=(l/u-n)*i,c=(c/u-e)*i,o=0;o<u;++o)a=r[o],s&&(a.x-=s),l&&(a.y-=l),c&&(a.z-=c)}return null==t&&(t=0),null==n&&(n=0),null==e&&(e=0),o.initialize=function(t){r=t},o.x=function(n){return arguments.length?(t=+n,o):t},o.y=function(t){return arguments.length?(n=+t,o):n},o.z=function(t){return arguments.length?(e=+t,o):e},o.strength=function(t){return arguments.length?(i=+t,o):i},o}function $i(t,n,e){if(isNaN(n))return t;var r,i,o,a,u,s,l=t._root,c={data:e},h=t._x0,f=t._x1;if(!l)return t._root=c,t;for(;l.length;)if((a=n>=(i=(h+f)/2))?h=i:f=i,r=l,!(l=l[u=+a]))return r[u]=c,t;if(n===(o=+t._x.call(null,l.data)))return c.next=l,r?r[u]=c:t._root=c,t;do{r=r?r[u]=new Array(2):t._root=new Array(2),(a=n>=(i=(h+f)/2))?h=i:f=i}while((u=+a)==(s=+(o>=i)));return r[s]=l,r[u]=c,t}function Hi(t,n,e){this.node=t,this.x0=n,this.x1=e}function Vi(t){return t[0]}function Xi(t,n){var e=new Gi(null==n?Vi:n,NaN,NaN);return null==t?e:e.addAll(t)}function Gi(t,n,e){this._x=t,this._x0=n,this._x1=e,this._root=void 0}function Yi(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}var Wi=Xi.prototype=Gi.prototype;function Zi(t,n,e,r){if(isNaN(n)||isNaN(e))return t;var i,o,a,u,s,l,c,h,f,d=t._root,p={data:r},g=t._x0,y=t._y0,v=t._x1,_=t._y1;if(!d)return t._root=p,t;for(;d.length;)if((l=n>=(o=(g+v)/2))?g=o:v=o,(c=e>=(a=(y+_)/2))?y=a:_=a,i=d,!(d=d[h=c<<1|l]))return i[h]=p,t;if(u=+t._x.call(null,d.data),s=+t._y.call(null,d.data),n===u&&e===s)return p.next=d,i?i[h]=p:t._root=p,t;do{i=i?i[h]=new Array(4):t._root=new Array(4),(l=n>=(o=(g+v)/2))?g=o:v=o,(c=e>=(a=(y+_)/2))?y=a:_=a}while((h=c<<1|l)==(f=(s>=a)<<1|u>=o));return i[f]=d,i[h]=p,t}function Qi(t,n,e,r,i){this.node=t,this.x0=n,this.y0=e,this.x1=r,this.y1=i}function Ki(t){return t[0]}function Ji(t){return t[1]}function to(t,n,e){var r=new no(null==n?Ki:n,null==e?Ji:e,NaN,NaN,NaN,NaN);return null==t?r:r.addAll(t)}function no(t,n,e,r,i,o){this._x=t,this._y=n,this._x0=e,this._y0=r,this._x1=i,this._y1=o,this._root=void 0}function eo(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}Wi.copy=function(){var t,n,e=new Gi(this._x,this._x0,this._x1),r=this._root;if(!r)return e;if(!r.length)return e._root=Yi(r),e;for(t=[{source:r,target:e._root=new Array(2)}];r=t.pop();)for(var i=0;i<2;++i)(n=r.source[i])&&(n.length?t.push({source:n,target:r.target[i]=new Array(2)}):r.target[i]=Yi(n));return e},Wi.add=function(t){const n=+this._x.call(null,t);return $i(this.cover(n),n,t)},Wi.addAll=function(t){Array.isArray(t)||(t=Array.from(t));const n=t.length,e=new Float64Array(n);let r=1/0,i=-1/0;for(let o,a=0;a<n;++a)isNaN(o=+this._x.call(null,t[a]))||(e[a]=o,o<r&&(r=o),o>i&&(i=o));if(r>i)return this;this.cover(r).cover(i);for(let r=0;r<n;++r)$i(this,e[r],t[r]);return this},Wi.cover=function(t){if(isNaN(t=+t))return this;var n=this._x0,e=this._x1;if(isNaN(n))e=(n=Math.floor(t))+1;else{for(var r,i,o=e-n||1,a=this._root;n>t||t>=e;)switch(i=+(t<n),(r=new Array(2))[i]=a,a=r,o*=2,i){case 0:e=n+o;break;case 1:n=e-o}this._root&&this._root.length&&(this._root=a)}return this._x0=n,this._x1=e,this},Wi.data=function(){var t=[];return this.visit((function(n){if(!n.length)do{t.push(n.data)}while(n=n.next)})),t},Wi.extent=function(t){return arguments.length?this.cover(+t[0][0]).cover(+t[1][0]):isNaN(this._x0)?void 0:[[this._x0],[this._x1]]},Wi.find=function(t,n){var e,r,i,o,a,u=this._x0,s=this._x1,l=[],c=this._root;for(c&&l.push(new Hi(c,u,s)),null==n?n=1/0:(u=t-n,s=t+n);o=l.pop();)if(!(!(c=o.node)||(r=o.x0)>s||(i=o.x1)<u))if(c.length){var h=(r+i)/2;l.push(new Hi(c[1],h,i),new Hi(c[0],r,h)),(a=+(t>=h))&&(o=l[l.length-1],l[l.length-1]=l[l.length-1-a],l[l.length-1-a]=o)}else{var f=Math.abs(t-+this._x.call(null,c.data));f<n&&(n=f,u=t-f,s=t+f,e=c.data)}return e},Wi.remove=function(t){if(isNaN(o=+this._x.call(null,t)))return this;var n,e,r,i,o,a,u,s,l,c=this._root,h=this._x0,f=this._x1;if(!c)return this;if(c.length)for(;;){if((u=o>=(a=(h+f)/2))?h=a:f=a,n=c,!(c=c[s=+u]))return this;if(!c.length)break;n[s+1&1]&&(e=n,l=s)}for(;c.data!==t;)if(r=c,!(c=c.next))return this;return(i=c.next)&&delete c.next,r?(i?r.next=i:delete r.next,this):n?(i?n[s]=i:delete n[s],(c=n[0]||n[1])&&c===(n[1]||n[0])&&!c.length&&(e?e[l]=c:this._root=c),this):(this._root=i,this)},Wi.removeAll=function(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this},Wi.root=function(){return this._root},Wi.size=function(){var t=0;return this.visit((function(n){if(!n.length)do{++t}while(n=n.next)})),t},Wi.visit=function(t){var n,e,r,i,o=[],a=this._root;for(a&&o.push(new Hi(a,this._x0,this._x1));n=o.pop();)if(!t(a=n.node,r=n.x0,i=n.x1)&&a.length){var u=(r+i)/2;(e=a[1])&&o.push(new Hi(e,u,i)),(e=a[0])&&o.push(new Hi(e,r,u))}return this},Wi.visitAfter=function(t){var n,e=[],r=[];for(this._root&&e.push(new Hi(this._root,this._x0,this._x1));n=e.pop();){var i=n.node;if(i.length){var o,a=n.x0,u=n.x1,s=(a+u)/2;(o=i[0])&&e.push(new Hi(o,a,s)),(o=i[1])&&e.push(new Hi(o,s,u))}r.push(n)}for(;n=r.pop();)t(n.node,n.x0,n.x1);return this},Wi.x=function(t){return arguments.length?(this._x=t,this):this._x};var ro=to.prototype=no.prototype;function io(t,n,e,r,i){if(isNaN(n)||isNaN(e)||isNaN(r))return t;var o,a,u,s,l,c,h,f,d,p,g,y,v=t._root,_={data:i},m=t._x0,x=t._y0,b=t._z0,w=t._x1,k=t._y1,M=t._z1;if(!v)return t._root=_,t;for(;v.length;)if((f=n>=(a=(m+w)/2))?m=a:w=a,(d=e>=(u=(x+k)/2))?x=u:k=u,(p=r>=(s=(b+M)/2))?b=s:M=s,o=v,!(v=v[g=p<<2|d<<1|f]))return o[g]=_,t;if(l=+t._x.call(null,v.data),c=+t._y.call(null,v.data),h=+t._z.call(null,v.data),n===l&&e===c&&r===h)return _.next=v,o?o[g]=_:t._root=_,t;do{o=o?o[g]=new Array(8):t._root=new Array(8),(f=n>=(a=(m+w)/2))?m=a:w=a,(d=e>=(u=(x+k)/2))?x=u:k=u,(p=r>=(s=(b+M)/2))?b=s:M=s}while((g=p<<2|d<<1|f)==(y=(h>=s)<<2|(c>=u)<<1|l>=a));return o[y]=v,o[g]=_,t}function oo(t,n,e,r,i,o,a){this.node=t,this.x0=n,this.y0=e,this.z0=r,this.x1=i,this.y1=o,this.z1=a}function ao(t){return t[0]}function uo(t){return t[1]}function so(t){return t[2]}function lo(t,n,e,r){var i=new co(null==n?ao:n,null==e?uo:e,null==r?so:r,NaN,NaN,NaN,NaN,NaN,NaN);return null==t?i:i.addAll(t)}function co(t,n,e,r,i,o,a,u,s){this._x=t,this._y=n,this._z=e,this._x0=r,this._y0=i,this._z0=o,this._x1=a,this._y1=u,this._z1=s,this._root=void 0}function ho(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}ro.copy=function(){var t,n,e=new no(this._x,this._y,this._x0,this._y0,this._x1,this._y1),r=this._root;if(!r)return e;if(!r.length)return e._root=eo(r),e;for(t=[{source:r,target:e._root=new Array(4)}];r=t.pop();)for(var i=0;i<4;++i)(n=r.source[i])&&(n.length?t.push({source:n,target:r.target[i]=new Array(4)}):r.target[i]=eo(n));return e},ro.add=function(t){const n=+this._x.call(null,t),e=+this._y.call(null,t);return Zi(this.cover(n,e),n,e,t)},ro.addAll=function(t){var n,e,r,i,o=t.length,a=new Array(o),u=new Array(o),s=1/0,l=1/0,c=-1/0,h=-1/0;for(e=0;e<o;++e)isNaN(r=+this._x.call(null,n=t[e]))||isNaN(i=+this._y.call(null,n))||(a[e]=r,u[e]=i,r<s&&(s=r),r>c&&(c=r),i<l&&(l=i),i>h&&(h=i));if(s>c||l>h)return this;for(this.cover(s,l).cover(c,h),e=0;e<o;++e)Zi(this,a[e],u[e],t[e]);return this},ro.cover=function(t,n){if(isNaN(t=+t)||isNaN(n=+n))return this;var e=this._x0,r=this._y0,i=this._x1,o=this._y1;if(isNaN(e))i=(e=Math.floor(t))+1,o=(r=Math.floor(n))+1;else{for(var a,u,s=i-e||1,l=this._root;e>t||t>=i||r>n||n>=o;)switch(u=(n<r)<<1|t<e,(a=new Array(4))[u]=l,l=a,s*=2,u){case 0:i=e+s,o=r+s;break;case 1:e=i-s,o=r+s;break;case 2:i=e+s,r=o-s;break;case 3:e=i-s,r=o-s}this._root&&this._root.length&&(this._root=l)}return this._x0=e,this._y0=r,this._x1=i,this._y1=o,this},ro.data=function(){var t=[];return this.visit((function(n){if(!n.length)do{t.push(n.data)}while(n=n.next)})),t},ro.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},ro.find=function(t,n,e){var r,i,o,a,u,s,l,c=this._x0,h=this._y0,f=this._x1,d=this._y1,p=[],g=this._root;for(g&&p.push(new Qi(g,c,h,f,d)),null==e?e=1/0:(c=t-e,h=n-e,f=t+e,d=n+e,e*=e);s=p.pop();)if(!(!(g=s.node)||(i=s.x0)>f||(o=s.y0)>d||(a=s.x1)<c||(u=s.y1)<h))if(g.length){var y=(i+a)/2,v=(o+u)/2;p.push(new Qi(g[3],y,v,a,u),new Qi(g[2],i,v,y,u),new Qi(g[1],y,o,a,v),new Qi(g[0],i,o,y,v)),(l=(n>=v)<<1|t>=y)&&(s=p[p.length-1],p[p.length-1]=p[p.length-1-l],p[p.length-1-l]=s)}else{var _=t-+this._x.call(null,g.data),m=n-+this._y.call(null,g.data),x=_*_+m*m;if(x<e){var b=Math.sqrt(e=x);c=t-b,h=n-b,f=t+b,d=n+b,r=g.data}}return r},ro.remove=function(t){if(isNaN(o=+this._x.call(null,t))||isNaN(a=+this._y.call(null,t)))return this;var n,e,r,i,o,a,u,s,l,c,h,f,d=this._root,p=this._x0,g=this._y0,y=this._x1,v=this._y1;if(!d)return this;if(d.length)for(;;){if((l=o>=(u=(p+y)/2))?p=u:y=u,(c=a>=(s=(g+v)/2))?g=s:v=s,n=d,!(d=d[h=c<<1|l]))return this;if(!d.length)break;(n[h+1&3]||n[h+2&3]||n[h+3&3])&&(e=n,f=h)}for(;d.data!==t;)if(r=d,!(d=d.next))return this;return(i=d.next)&&delete d.next,r?(i?r.next=i:delete r.next,this):n?(i?n[h]=i:delete n[h],(d=n[0]||n[1]||n[2]||n[3])&&d===(n[3]||n[2]||n[1]||n[0])&&!d.length&&(e?e[f]=d:this._root=d),this):(this._root=i,this)},ro.removeAll=function(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this},ro.root=function(){return this._root},ro.size=function(){var t=0;return this.visit((function(n){if(!n.length)do{++t}while(n=n.next)})),t},ro.visit=function(t){var n,e,r,i,o,a,u=[],s=this._root;for(s&&u.push(new Qi(s,this._x0,this._y0,this._x1,this._y1));n=u.pop();)if(!t(s=n.node,r=n.x0,i=n.y0,o=n.x1,a=n.y1)&&s.length){var l=(r+o)/2,c=(i+a)/2;(e=s[3])&&u.push(new Qi(e,l,c,o,a)),(e=s[2])&&u.push(new Qi(e,r,c,l,a)),(e=s[1])&&u.push(new Qi(e,l,i,o,c)),(e=s[0])&&u.push(new Qi(e,r,i,l,c))}return this},ro.visitAfter=function(t){var n,e=[],r=[];for(this._root&&e.push(new Qi(this._root,this._x0,this._y0,this._x1,this._y1));n=e.pop();){var i=n.node;if(i.length){var o,a=n.x0,u=n.y0,s=n.x1,l=n.y1,c=(a+s)/2,h=(u+l)/2;(o=i[0])&&e.push(new Qi(o,a,u,c,h)),(o=i[1])&&e.push(new Qi(o,c,u,s,h)),(o=i[2])&&e.push(new Qi(o,a,h,c,l)),(o=i[3])&&e.push(new Qi(o,c,h,s,l))}r.push(n)}for(;n=r.pop();)t(n.node,n.x0,n.y0,n.x1,n.y1);return this},ro.x=function(t){return arguments.length?(this._x=t,this):this._x},ro.y=function(t){return arguments.length?(this._y=t,this):this._y};var fo=lo.prototype=co.prototype;function po(t){return function(){return t}}function go(t){return 1e-6*(t()-.5)}function yo(t){return t.index}function vo(t,n){var e=t.get(n);if(!e)throw new Error("node not found: "+n);return e}function _o(t){var n,e,r,i,o,a,u,s=yo,l=function(t){return 1/Math.min(o[t.source.index],o[t.target.index])},c=po(30),h=1;function f(r){for(var o=0,s=t.length;o<h;++o)for(var l,c,f,d,p,g=0,y=0,v=0,_=0;g<s;++g)c=(l=t[g]).source,y=(f=l.target).x+f.vx-c.x-c.vx||go(u),i>1&&(v=f.y+f.vy-c.y-c.vy||go(u)),i>2&&(_=f.z+f.vz-c.z-c.vz||go(u)),y*=d=((d=Math.sqrt(y*y+v*v+_*_))-e[g])/d*r*n[g],v*=d,_*=d,f.vx-=y*(p=a[g]),i>1&&(f.vy-=v*p),i>2&&(f.vz-=_*p),c.vx+=y*(p=1-p),i>1&&(c.vy+=v*p),i>2&&(c.vz+=_*p)}function d(){if(r){var i,u,l=r.length,c=t.length,h=new Map(r.map(((t,n)=>[s(t,n,r),t])));for(i=0,o=new Array(l);i<c;++i)(u=t[i]).index=i,"object"!=typeof u.source&&(u.source=vo(h,u.source)),"object"!=typeof u.target&&(u.target=vo(h,u.target)),o[u.source.index]=(o[u.source.index]||0)+1,o[u.target.index]=(o[u.target.index]||0)+1;for(i=0,a=new Array(c);i<c;++i)u=t[i],a[i]=o[u.source.index]/(o[u.source.index]+o[u.target.index]);n=new Array(c),p(),e=new Array(c),g()}}function p(){if(r)for(var e=0,i=t.length;e<i;++e)n[e]=+l(t[e],e,t)}function g(){if(r)for(var n=0,i=t.length;n<i;++n)e[n]=+c(t[n],n,t)}return null==t&&(t=[]),f.initialize=function(t,...n){r=t,u=n.find((t=>"function"==typeof t))||Math.random,i=n.find((t=>[1,2,3].includes(t)))||2,d()},f.links=function(n){return arguments.length?(t=n,d(),f):t},f.id=function(t){return arguments.length?(s=t,f):s},f.iterations=function(t){return arguments.length?(h=+t,f):h},f.strength=function(t){return arguments.length?(l="function"==typeof t?t:po(+t),p(),f):l},f.distance=function(t){return arguments.length?(c="function"==typeof t?t:po(+t),g(),f):c},f}fo.copy=function(){var t,n,e=new co(this._x,this._y,this._z,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1),r=this._root;if(!r)return e;if(!r.length)return e._root=ho(r),e;for(t=[{source:r,target:e._root=new Array(8)}];r=t.pop();)for(var i=0;i<8;++i)(n=r.source[i])&&(n.length?t.push({source:n,target:r.target[i]=new Array(8)}):r.target[i]=ho(n));return e},fo.add=function(t){const n=+this._x.call(null,t),e=+this._y.call(null,t),r=+this._z.call(null,t);return io(this.cover(n,e,r),n,e,r,t)},fo.addAll=function(t){Array.isArray(t)||(t=Array.from(t));const n=t.length,e=new Float64Array(n),r=new Float64Array(n),i=new Float64Array(n);let o=1/0,a=1/0,u=1/0,s=-1/0,l=-1/0,c=-1/0;for(let h,f,d,p,g=0;g<n;++g)isNaN(f=+this._x.call(null,h=t[g]))||isNaN(d=+this._y.call(null,h))||isNaN(p=+this._z.call(null,h))||(e[g]=f,r[g]=d,i[g]=p,f<o&&(o=f),f>s&&(s=f),d<a&&(a=d),d>l&&(l=d),p<u&&(u=p),p>c&&(c=p));if(o>s||a>l||u>c)return this;this.cover(o,a,u).cover(s,l,c);for(let o=0;o<n;++o)io(this,e[o],r[o],i[o],t[o]);return this},fo.cover=function(t,n,e){if(isNaN(t=+t)||isNaN(n=+n)||isNaN(e=+e))return this;var r=this._x0,i=this._y0,o=this._z0,a=this._x1,u=this._y1,s=this._z1;if(isNaN(r))a=(r=Math.floor(t))+1,u=(i=Math.floor(n))+1,s=(o=Math.floor(e))+1;else{for(var l,c,h=a-r||1,f=this._root;r>t||t>=a||i>n||n>=u||o>e||e>=s;)switch(c=(e<o)<<2|(n<i)<<1|t<r,(l=new Array(8))[c]=f,f=l,h*=2,c){case 0:a=r+h,u=i+h,s=o+h;break;case 1:r=a-h,u=i+h,s=o+h;break;case 2:a=r+h,i=u-h,s=o+h;break;case 3:r=a-h,i=u-h,s=o+h;break;case 4:a=r+h,u=i+h,o=s-h;break;case 5:r=a-h,u=i+h,o=s-h;break;case 6:a=r+h,i=u-h,o=s-h;break;case 7:r=a-h,i=u-h,o=s-h}this._root&&this._root.length&&(this._root=f)}return this._x0=r,this._y0=i,this._z0=o,this._x1=a,this._y1=u,this._z1=s,this},fo.data=function(){var t=[];return this.visit((function(n){if(!n.length)do{t.push(n.data)}while(n=n.next)})),t},fo.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1],+t[0][2]).cover(+t[1][0],+t[1][1],+t[1][2]):isNaN(this._x0)?void 0:[[this._x0,this._y0,this._z0],[this._x1,this._y1,this._z1]]},fo.find=function(t,n,e,r){var i,o,a,u,s,l,c,h,f,d=this._x0,p=this._y0,g=this._z0,y=this._x1,v=this._y1,_=this._z1,m=[],x=this._root;for(x&&m.push(new oo(x,d,p,g,y,v,_)),null==r?r=1/0:(d=t-r,p=n-r,g=e-r,y=t+r,v=n+r,_=e+r,r*=r);h=m.pop();)if(!(!(x=h.node)||(o=h.x0)>y||(a=h.y0)>v||(u=h.z0)>_||(s=h.x1)<d||(l=h.y1)<p||(c=h.z1)<g))if(x.length){var b=(o+s)/2,w=(a+l)/2,k=(u+c)/2;m.push(new oo(x[7],b,w,k,s,l,c),new oo(x[6],o,w,k,b,l,c),new oo(x[5],b,a,k,s,w,c),new oo(x[4],o,a,k,b,w,c),new oo(x[3],b,w,u,s,l,k),new oo(x[2],o,w,u,b,l,k),new oo(x[1],b,a,u,s,w,k),new oo(x[0],o,a,u,b,w,k)),(f=(e>=k)<<2|(n>=w)<<1|t>=b)&&(h=m[m.length-1],m[m.length-1]=m[m.length-1-f],m[m.length-1-f]=h)}else{var M=t-+this._x.call(null,x.data),z=n-+this._y.call(null,x.data),A=e-+this._z.call(null,x.data),S=M*M+z*z+A*A;if(S<r){var C=Math.sqrt(r=S);d=t-C,p=n-C,g=e-C,y=t+C,v=n+C,_=e+C,i=x.data}}return i},fo.remove=function(t){if(isNaN(o=+this._x.call(null,t))||isNaN(a=+this._y.call(null,t))||isNaN(u=+this._z.call(null,t)))return this;var n,e,r,i,o,a,u,s,l,c,h,f,d,p,g,y=this._root,v=this._x0,_=this._y0,m=this._z0,x=this._x1,b=this._y1,w=this._z1;if(!y)return this;if(y.length)for(;;){if((h=o>=(s=(v+x)/2))?v=s:x=s,(f=a>=(l=(_+b)/2))?_=l:b=l,(d=u>=(c=(m+w)/2))?m=c:w=c,n=y,!(y=y[p=d<<2|f<<1|h]))return this;if(!y.length)break;(n[p+1&7]||n[p+2&7]||n[p+3&7]||n[p+4&7]||n[p+5&7]||n[p+6&7]||n[p+7&7])&&(e=n,g=p)}for(;y.data!==t;)if(r=y,!(y=y.next))return this;return(i=y.next)&&delete y.next,r?(i?r.next=i:delete r.next,this):n?(i?n[p]=i:delete n[p],(y=n[0]||n[1]||n[2]||n[3]||n[4]||n[5]||n[6]||n[7])&&y===(n[7]||n[6]||n[5]||n[4]||n[3]||n[2]||n[1]||n[0])&&!y.length&&(e?e[g]=y:this._root=y),this):(this._root=i,this)},fo.removeAll=function(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this},fo.root=function(){return this._root},fo.size=function(){var t=0;return this.visit((function(n){if(!n.length)do{++t}while(n=n.next)})),t},fo.visit=function(t){var n,e,r,i,o,a,u,s,l=[],c=this._root;for(c&&l.push(new oo(c,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1));n=l.pop();)if(!t(c=n.node,r=n.x0,i=n.y0,o=n.z0,a=n.x1,u=n.y1,s=n.z1)&&c.length){var h=(r+a)/2,f=(i+u)/2,d=(o+s)/2;(e=c[7])&&l.push(new oo(e,h,f,d,a,u,s)),(e=c[6])&&l.push(new oo(e,r,f,d,h,u,s)),(e=c[5])&&l.push(new oo(e,h,i,d,a,f,s)),(e=c[4])&&l.push(new oo(e,r,i,d,h,f,s)),(e=c[3])&&l.push(new oo(e,h,f,o,a,u,d)),(e=c[2])&&l.push(new oo(e,r,f,o,h,u,d)),(e=c[1])&&l.push(new oo(e,h,i,o,a,f,d)),(e=c[0])&&l.push(new oo(e,r,i,o,h,f,d))}return this},fo.visitAfter=function(t){var n,e=[],r=[];for(this._root&&e.push(new oo(this._root,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1));n=e.pop();){var i=n.node;if(i.length){var o,a=n.x0,u=n.y0,s=n.z0,l=n.x1,c=n.y1,h=n.z1,f=(a+l)/2,d=(u+c)/2,p=(s+h)/2;(o=i[0])&&e.push(new oo(o,a,u,s,f,d,p)),(o=i[1])&&e.push(new oo(o,f,u,s,l,d,p)),(o=i[2])&&e.push(new oo(o,a,d,s,f,c,p)),(o=i[3])&&e.push(new oo(o,f,d,s,l,c,p)),(o=i[4])&&e.push(new oo(o,a,u,p,f,d,h)),(o=i[5])&&e.push(new oo(o,f,u,p,l,d,h)),(o=i[6])&&e.push(new oo(o,a,d,p,f,c,h)),(o=i[7])&&e.push(new oo(o,f,d,p,l,c,h))}r.push(n)}for(;n=r.pop();)t(n.node,n.x0,n.y0,n.z0,n.x1,n.y1,n.z1);return this},fo.x=function(t){return arguments.length?(this._x=t,this):this._x},fo.y=function(t){return arguments.length?(this._y=t,this):this._y},fo.z=function(t){return arguments.length?(this._z=t,this):this._z};const mo=1664525,xo=1013904223,bo=4294967296;function wo(t){return t.x}function ko(t){return t.y}function Mo(t){return t.z}var zo=Math.PI*(3-Math.sqrt(5)),Ao=20*Math.PI/(9+Math.sqrt(221));function So(t,n){n=n||2;var e,r=Math.min(3,Math.max(1,Math.round(n))),i=1,o=.001,a=1-Math.pow(o,1/300),u=0,s=.6,l=new Map,c=ee(d),h=Ct("tick","end"),f=function(){let t=1;return()=>(t=(mo*t+xo)%bo)/bo}();function d(){p(),h.call("tick",e),i<o&&(c.stop(),h.call("end",e))}function p(n){var o,c,h=t.length;void 0===n&&(n=1);for(var f=0;f<n;++f)for(i+=(u-i)*a,l.forEach((function(t){t(i)})),o=0;o<h;++o)null==(c=t[o]).fx?c.x+=c.vx*=s:(c.x=c.fx,c.vx=0),r>1&&(null==c.fy?c.y+=c.vy*=s:(c.y=c.fy,c.vy=0)),r>2&&(null==c.fz?c.z+=c.vz*=s:(c.z=c.fz,c.vz=0));return e}function g(){for(var n,e=0,i=t.length;e<i;++e){if((n=t[e]).index=e,null!=n.fx&&(n.x=n.fx),null!=n.fy&&(n.y=n.fy),null!=n.fz&&(n.z=n.fz),isNaN(n.x)||r>1&&isNaN(n.y)||r>2&&isNaN(n.z)){var o=10*(r>2?Math.cbrt(.5+e):r>1?Math.sqrt(.5+e):e),a=e*zo,u=e*Ao;1===r?n.x=o:2===r?(n.x=o*Math.cos(a),n.y=o*Math.sin(a)):(n.x=o*Math.sin(a)*Math.cos(u),n.y=o*Math.cos(a),n.z=o*Math.sin(a)*Math.sin(u))}(isNaN(n.vx)||r>1&&isNaN(n.vy)||r>2&&isNaN(n.vz))&&(n.vx=0,r>1&&(n.vy=0),r>2&&(n.vz=0))}}function y(n){return n.initialize&&n.initialize(t,f,r),n}return null==t&&(t=[]),g(),e={tick:p,restart:function(){return c.restart(d),e},stop:function(){return c.stop(),e},numDimensions:function(t){return arguments.length?(r=Math.min(3,Math.max(1,Math.round(t))),l.forEach(y),e):r},nodes:function(n){return arguments.length?(t=n,g(),l.forEach(y),e):t},alpha:function(t){return arguments.length?(i=+t,e):i},alphaMin:function(t){return arguments.length?(o=+t,e):o},alphaDecay:function(t){return arguments.length?(a=+t,e):+a},alphaTarget:function(t){return arguments.length?(u=+t,e):u},velocityDecay:function(t){return arguments.length?(s=1-t,e):1-s},randomSource:function(t){return arguments.length?(f=t,l.forEach(y),e):f},force:function(t,n){return arguments.length>1?(null==n?l.delete(t):l.set(t,y(n)),e):l.get(t)},find:function(){var n,e,i,o,a,u,s=Array.prototype.slice.call(arguments),l=s.shift()||0,c=(r>1?s.shift():null)||0,h=(r>2?s.shift():null)||0,f=s.shift()||1/0,d=0,p=t.length;for(f*=f,d=0;d<p;++d)(o=(n=l-(a=t[d]).x)*n+(e=c-(a.y||0))*e+(i=h-(a.z||0))*i)<f&&(u=a,f=o);return u},on:function(t,n){return arguments.length>1?(h.on(t,n),e):h.on(t)}}}function Co(){var t,n,e,r,i,o,a=po(-30),u=1,s=1/0,l=.81;function c(r){var o,a=t.length,u=(1===n?Xi(t,wo):2===n?to(t,wo,ko):3===n?lo(t,wo,ko,Mo):null).visitAfter(f);for(i=r,o=0;o<a;++o)e=t[o],u.visit(d)}function h(){if(t){var n,e,r=t.length;for(o=new Array(r),n=0;n<r;++n)e=t[n],o[e.index]=+a(e,n,t)}}function f(t){var e,r,i,a,u,s,l=0,c=0,h=t.length;if(h){for(i=a=u=s=0;s<h;++s)(e=t[s])&&(r=Math.abs(e.value))&&(l+=e.value,c+=r,i+=r*(e.x||0),a+=r*(e.y||0),u+=r*(e.z||0));l*=Math.sqrt(4/h),t.x=i/c,n>1&&(t.y=a/c),n>2&&(t.z=u/c)}else{(e=t).x=e.data.x,n>1&&(e.y=e.data.y),n>2&&(e.z=e.data.z);do{l+=o[e.data.index]}while(e=e.next)}t.value=l}function d(t,a,c,h,f){if(!t.value)return!0;var d=[c,h,f][n-1],p=t.x-e.x,g=n>1?t.y-e.y:0,y=n>2?t.z-e.z:0,v=d-a,_=p*p+g*g+y*y;if(v*v/l<_)return _<s&&(0===p&&(_+=(p=go(r))*p),n>1&&0===g&&(_+=(g=go(r))*g),n>2&&0===y&&(_+=(y=go(r))*y),_<u&&(_=Math.sqrt(u*_)),e.vx+=p*t.value*i/_,n>1&&(e.vy+=g*t.value*i/_),n>2&&(e.vz+=y*t.value*i/_)),!0;if(!(t.length||_>=s)){(t.data!==e||t.next)&&(0===p&&(_+=(p=go(r))*p),n>1&&0===g&&(_+=(g=go(r))*g),n>2&&0===y&&(_+=(y=go(r))*y),_<u&&(_=Math.sqrt(u*_)));do{t.data!==e&&(v=o[t.data.index]*i/_,e.vx+=p*v,n>1&&(e.vy+=g*v),n>2&&(e.vz+=y*v))}while(t=t.next)}}return c.initialize=function(e,...i){t=e,r=i.find((t=>"function"==typeof t))||Math.random,n=i.find((t=>[1,2,3].includes(t)))||2,h()},c.strength=function(t){return arguments.length?(a="function"==typeof t?t:po(+t),h(),c):a},c.distanceMin=function(t){return arguments.length?(u=t*t,c):Math.sqrt(u)},c.distanceMax=function(t){return arguments.length?(s=t*t,c):Math.sqrt(s)},c.theta=function(t){return arguments.length?(l=t*t,c):Math.sqrt(l)},c}const{abs:Eo,cos:Oo,sin:No,acos:Po,atan2:jo,sqrt:To,pow:Ro}=Math;function Do(t){return t<0?-Ro(-t,1/3):Ro(t,1/3)}const Io=Math.PI,Uo=2*Io,Fo=Io/2,Lo=Number.MAX_SAFE_INTEGER||9007199254740991,qo=Number.MIN_SAFE_INTEGER||-9007199254740991,Bo={x:0,y:0,z:0},$o={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,n){const e=n(t);let r=e.x*e.x+e.y*e.y;return void 0!==e.z&&(r+=e.z*e.z),To(r)},compute:function(t,n,e){if(0===t)return n[0].t=0,n[0];const r=n.length-1;if(1===t)return n[r].t=1,n[r];const i=1-t;let o=n;if(0===r)return n[0].t=t,n[0];if(1===r){const n={x:i*o[0].x+t*o[1].x,y:i*o[0].y+t*o[1].y,t:t};return e&&(n.z=i*o[0].z+t*o[1].z),n}if(r<4){let n,a,u,s=i*i,l=t*t,c=0;2===r?(o=[o[0],o[1],o[2],Bo],n=s,a=i*t*2,u=l):3===r&&(n=s*i,a=s*t*3,u=i*l*3,c=t*l);const h={x:n*o[0].x+a*o[1].x+u*o[2].x+c*o[3].x,y:n*o[0].y+a*o[1].y+u*o[2].y+c*o[3].y,t:t};return e&&(h.z=n*o[0].z+a*o[1].z+u*o[2].z+c*o[3].z),h}const a=JSON.parse(JSON.stringify(n));for(;a.length>1;){for(let n=0;n<a.length-1;n++)a[n]={x:a[n].x+(a[n+1].x-a[n].x)*t,y:a[n].y+(a[n+1].y-a[n].y)*t},void 0!==a[n].z&&(a[n].z=a[n].z+(a[n+1].z-a[n].z)*t);a.splice(a.length-1,1)}return a[0].t=t,a[0]},computeWithRatios:function(t,n,e,r){const i=1-t,o=e,a=n;let u,s=o[0],l=o[1],c=o[2],h=o[3];return s*=i,l*=t,2===a.length?(u=s+l,{x:(s*a[0].x+l*a[1].x)/u,y:(s*a[0].y+l*a[1].y)/u,z:!!r&&(s*a[0].z+l*a[1].z)/u,t:t}):(s*=i,l*=2*i,c*=t*t,3===a.length?(u=s+l+c,{x:(s*a[0].x+l*a[1].x+c*a[2].x)/u,y:(s*a[0].y+l*a[1].y+c*a[2].y)/u,z:!!r&&(s*a[0].z+l*a[1].z+c*a[2].z)/u,t:t}):(s*=i,l*=1.5*i,c*=3*i,h*=t*t*t,4===a.length?(u=s+l+c+h,{x:(s*a[0].x+l*a[1].x+c*a[2].x+h*a[3].x)/u,y:(s*a[0].y+l*a[1].y+c*a[2].y+h*a[3].y)/u,z:!!r&&(s*a[0].z+l*a[1].z+c*a[2].z+h*a[3].z)/u,t:t}):void 0))},derive:function(t,n){const e=[];for(let r=t,i=r.length,o=i-1;i>1;i--,o--){const t=[];for(let e,i=0;i<o;i++)e={x:o*(r[i+1].x-r[i].x),y:o*(r[i+1].y-r[i].y)},n&&(e.z=o*(r[i+1].z-r[i].z)),t.push(e);e.push(t),r=t}return e},between:function(t,n,e){return n<=t&&t<=e||$o.approximately(t,n)||$o.approximately(t,e)},approximately:function(t,n,e){return Eo(t-n)<=(e||1e-6)},length:function(t){const n=$o.Tvalues.length;let e=0;for(let r,i=0;i<n;i++)r=.5*$o.Tvalues[i]+.5,e+=$o.Cvalues[i]*$o.arcfn(r,t);return.5*e},map:function(t,n,e,r,i){return r+(i-r)*((t-n)/(e-n))},lerp:function(t,n,e){const r={x:n.x+t*(e.x-n.x),y:n.y+t*(e.y-n.y)};return void 0!==n.z&&void 0!==e.z&&(r.z=n.z+t*(e.z-n.z)),r},pointToString:function(t){let n=t.x+"/"+t.y;return void 0!==t.z&&(n+="/"+t.z),n},pointsToString:function(t){return"["+t.map($o.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,n,e){const r=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y;return jo(r*a-i*o,r*o+i*a)},round:function(t,n){const e=""+t,r=e.indexOf(".");return parseFloat(e.substring(0,r+1+n))},dist:function(t,n){const e=t.x-n.x,r=t.y-n.y;return To(e*e+r*r)},closest:function(t,n){let e,r,i=Ro(2,63);return t.forEach((function(t,o){r=$o.dist(n,t),r<i&&(i=r,e=o)})),{mdist:i,mpos:e}},abcratio:function(t,n){if(2!==n&&3!==n)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const e=Ro(t,n)+Ro(1-t,n);return Eo((e-1)/e)},projectionratio:function(t,n){if(2!==n&&3!==n)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const e=Ro(1-t,n);return e/(Ro(t,n)+e)},lli8:function(t,n,e,r,i,o,a,u){const s=(t-e)*(o-u)-(n-r)*(i-a);return 0!=s&&{x:((t*r-n*e)*(i-a)-(t-e)*(i*u-o*a))/s,y:((t*r-n*e)*(o-u)-(n-r)*(i*u-o*a))/s}},lli4:function(t,n,e,r){const i=t.x,o=t.y,a=n.x,u=n.y,s=e.x,l=e.y,c=r.x,h=r.y;return $o.lli8(i,o,a,u,s,l,c,h)},lli:function(t,n){return $o.lli4(t,t.c,n,n.c)},makeline:function(t,n){return new Jo(t.x,t.y,(t.x+n.x)/2,(t.y+n.y)/2,n.x,n.y)},findbbox:function(t){let n=Lo,e=Lo,r=qo,i=qo;return t.forEach((function(t){const o=t.bbox();n>o.x.min&&(n=o.x.min),e>o.y.min&&(e=o.y.min),r<o.x.max&&(r=o.x.max),i<o.y.max&&(i=o.y.max)})),{x:{min:n,mid:(n+r)/2,max:r,size:r-n},y:{min:e,mid:(e+i)/2,max:i,size:i-e}}},shapeintersections:function(t,n,e,r,i){if(!$o.bboxoverlap(n,r))return[];const o=[],a=[t.startcap,t.forward,t.back,t.endcap],u=[e.startcap,e.forward,e.back,e.endcap];return a.forEach((function(n){n.virtual||u.forEach((function(r){if(r.virtual)return;const a=n.intersects(r,i);a.length>0&&(a.c1=n,a.c2=r,a.s1=t,a.s2=e,o.push(a))}))})),o},makeshape:function(t,n,e){const r=n.points.length,i=t.points.length,o=$o.makeline(n.points[r-1],t.points[0]),a=$o.makeline(t.points[i-1],n.points[0]),u={startcap:o,forward:t,back:n,endcap:a,bbox:$o.findbbox([o,t,n,a]),intersections:function(t){return $o.shapeintersections(u,u.bbox,t,t.bbox,e)}};return u},getminmax:function(t,n,e){if(!e)return{min:0,max:0};let r,i,o=Lo,a=qo;-1===e.indexOf(0)&&(e=[0].concat(e)),-1===e.indexOf(1)&&e.push(1);for(let u=0,s=e.length;u<s;u++)r=e[u],i=t.get(r),i[n]<o&&(o=i[n]),i[n]>a&&(a=i[n]);return{min:o,mid:(o+a)/2,max:a,size:a-o}},align:function(t,n){const e=n.p1.x,r=n.p1.y,i=-jo(n.p2.y-r,n.p2.x-e);return t.map((function(t){return{x:(t.x-e)*Oo(i)-(t.y-r)*No(i),y:(t.x-e)*No(i)+(t.y-r)*Oo(i)}}))},roots:function(t,n){n=n||{p1:{x:0,y:0},p2:{x:1,y:0}};const e=t.length-1,r=$o.align(t,n),i=function(t){return 0<=t&&t<=1};if(2===e){const t=r[0].y,n=r[1].y,e=r[2].y,o=t-2*n+e;if(0!==o){const r=-To(n*n-t*e),a=-t+n;return[-(r+a)/o,-(-r+a)/o].filter(i)}return n!==e&&0===o?[(2*n-e)/(2*n-2*e)].filter(i):[]}const o=r[0].y,a=r[1].y,u=r[2].y;let s=3*a-o-3*u+r[3].y,l=3*o-6*a+3*u,c=-3*o+3*a,h=o;if($o.approximately(s,0)){if($o.approximately(l,0))return $o.approximately(c,0)?[]:[-h/c].filter(i);const t=To(c*c-4*l*h),n=2*l;return[(t-c)/n,(-c-t)/n].filter(i)}l/=s,c/=s,h/=s;const f=(3*c-l*l)/3,d=f/3,p=(2*l*l*l-9*l*c+27*h)/27,g=p/2,y=g*g+d*d*d;let v,_,m,x,b;if(y<0){const t=-f/3,n=To(t*t*t),e=-p/(2*n),r=Po(e<-1?-1:e>1?1:e),o=2*Do(n);return m=o*Oo(r/3)-l/3,x=o*Oo((r+Uo)/3)-l/3,b=o*Oo((r+2*Uo)/3)-l/3,[m,x,b].filter(i)}if(0===y)return v=g<0?Do(-g):-Do(g),m=2*v-l/3,x=-v-l/3,[m,x].filter(i);{const t=To(y);return v=Do(-g+t),_=Do(g+t),[v-_-l/3].filter(i)}},droots:function(t){if(3===t.length){const n=t[0],e=t[1],r=t[2],i=n-2*e+r;if(0!==i){const t=-To(e*e-n*r),o=-n+e;return[-(t+o)/i,-(-t+o)/i]}return e!==r&&0===i?[(2*e-r)/(2*(e-r))]:[]}if(2===t.length){const n=t[0],e=t[1];return n!==e?[n/(n-e)]:[]}return[]},curvature:function(t,n,e,r,i){let o,a,u,s,l=0,c=0;const h=$o.compute(t,n),f=$o.compute(t,e),d=h.x*h.x+h.y*h.y;if(r?(o=To(Ro(h.y*f.z-f.y*h.z,2)+Ro(h.z*f.x-f.z*h.x,2)+Ro(h.x*f.y-f.x*h.y,2)),a=Ro(d+h.z*h.z,1.5)):(o=h.x*f.y-h.y*f.x,a=Ro(d,1.5)),0===o||0===a)return{k:0,r:0};if(l=o/a,c=a/o,!i){const i=$o.curvature(t-.001,n,e,r,!0).k,o=$o.curvature(t+.001,n,e,r,!0).k;s=(o-l+(l-i))/2,u=(Eo(o-l)+Eo(l-i))/2}return{k:l,r:c,dk:s,adk:u}},inflections:function(t){if(t.length<4)return[];const n=$o.align(t,{p1:t[0],p2:t.slice(-1)[0]}),e=n[2].x*n[1].y,r=n[3].x*n[1].y,i=n[1].x*n[2].y,o=18*(-3*e+2*r+3*i-n[3].x*n[2].y),a=18*(3*e-r-3*i),u=18*(i-e);if($o.approximately(o,0)){if(!$o.approximately(a,0)){let t=-u/a;if(0<=t&&t<=1)return[t]}return[]}const s=2*o;if($o.approximately(s,0))return[];const l=a*a-4*o*u;if(l<0)return[];const c=Math.sqrt(l);return[(c-a)/s,-(a+c)/s].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,n){const e=["x","y"],r=e.length;for(let i,o,a,u,s=0;s<r;s++)if(i=e[s],o=t[i].mid,a=n[i].mid,u=(t[i].size+n[i].size)/2,Eo(o-a)>=u)return!1;return!0},expandbox:function(t,n){n.x.min<t.x.min&&(t.x.min=n.x.min),n.y.min<t.y.min&&(t.y.min=n.y.min),n.z&&n.z.min<t.z.min&&(t.z.min=n.z.min),n.x.max>t.x.max&&(t.x.max=n.x.max),n.y.max>t.y.max&&(t.y.max=n.y.max),n.z&&n.z.max>t.z.max&&(t.z.max=n.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,n,e){const r=t.bbox(),i=n.bbox(),o=1e5,a=e||.5;if(r.x.size+r.y.size<a&&i.x.size+i.y.size<a)return[(o*(t._t1+t._t2)/2|0)/o+"/"+(o*(n._t1+n._t2)/2|0)/o];let u=t.split(.5),s=n.split(.5),l=[{left:u.left,right:s.left},{left:u.left,right:s.right},{left:u.right,right:s.right},{left:u.right,right:s.left}];l=l.filter((function(t){return $o.bboxoverlap(t.left.bbox(),t.right.bbox())}));let c=[];return 0===l.length||(l.forEach((function(t){c=c.concat($o.pairiteration(t.left,t.right,a))})),c=c.filter((function(t,n){return c.indexOf(t)===n}))),c},getccenter:function(t,n,e){const r=n.x-t.x,i=n.y-t.y,o=e.x-n.x,a=e.y-n.y,u=r*Oo(Fo)-i*No(Fo),s=r*No(Fo)+i*Oo(Fo),l=o*Oo(Fo)-a*No(Fo),c=o*No(Fo)+a*Oo(Fo),h=(t.x+n.x)/2,f=(t.y+n.y)/2,d=(n.x+e.x)/2,p=(n.y+e.y)/2,g=h+u,y=f+s,v=d+l,_=p+c,m=$o.lli8(h,f,g,y,d,p,v,_),x=$o.dist(m,t);let b,w=jo(t.y-m.y,t.x-m.x),k=jo(n.y-m.y,n.x-m.x),M=jo(e.y-m.y,e.x-m.x);return w<M?((w>k||k>M)&&(w+=Uo),w>M&&(b=M,M=w,w=b)):M<k&&k<w?(b=M,M=w,w=b):M+=Uo,m.s=w,m.e=M,m.r=x,m},numberSort:function(t,n){return t-n}};class Ho{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return $o.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,n){return t+n}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var n=t[0].bbox(),e=1;e<t.length;e++)$o.expandbox(n,t[e].bbox());return n}offset(t){const n=[];return this.curves.forEach((function(e){n.push(...e.offset(t))})),new Ho(n)}}const{abs:Vo,min:Xo,max:Go,cos:Yo,sin:Wo,acos:Zo,sqrt:Qo}=Math,Ko=Math.PI;class Jo{constructor(t){let n=t&&t.forEach?t:Array.from(arguments).slice(),e=!1;if("object"==typeof n[0]){e=n.length;const t=[];n.forEach((function(n){["x","y","z"].forEach((function(e){void 0!==n[e]&&t.push(n[e])}))})),n=t}let r=!1;const i=n.length;if(e){if(e>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");r=!0}}else if(6!==i&&8!==i&&9!==i&&12!==i&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!r&&(9===i||12===i)||t&&t[0]&&void 0!==t[0].z,a=this.points=[];for(let t=0,e=o?3:2;t<i;t+=e){var u={x:n[t],y:n[t+1]};o&&(u.z=n[t+2]),a.push(u)}const s=this.order=a.length-1,l=this.dims=["x","y"];o&&l.push("z"),this.dimlen=l.length;const c=$o.align(a,{p1:a[0],p2:a[s]}),h=$o.dist(a[0],a[s]);this._linear=c.reduce(((t,n)=>t+Vo(n.y)),0)<h/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,n,e,r){if(void 0===r&&(r=.5),0===r)return new Jo(n,n,e);if(1===r)return new Jo(t,n,n);const i=Jo.getABC(2,t,n,e,r);return new Jo(t,i.A,e)}static cubicFromPoints(t,n,e,r,i){void 0===r&&(r=.5);const o=Jo.getABC(3,t,n,e,r);void 0===i&&(i=$o.dist(n,o.C));const a=i*(1-r)/r,u=$o.dist(t,e),s=(e.x-t.x)/u,l=(e.y-t.y)/u,c=i*s,h=i*l,f=a*s,d=a*l,p=n.x-c,g=n.y-h,y=n.x+f,v=n.y+d,_=o.A,m=_.x+(p-_.x)/(1-r),x=_.y+(g-_.y)/(1-r),b=_.x+(y-_.x)/r,w=_.y+(v-_.y)/r,k={x:t.x+(m-t.x)/r,y:t.y+(x-t.y)/r},M={x:e.x+(b-e.x)/(1-r),y:e.y+(w-e.y)/(1-r)};return new Jo(t,k,M,e)}static getUtils(){return $o}getUtils(){return Jo.getUtils()}static get PolyBezier(){return Ho}valueOf(){return this.toString()}toString(){return $o.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,n=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let e=1,r=t.length;e<r;e++)n.push(t[e].x),n.push(t[e].y);return n.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,n){return""+n+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=$o.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,n=$o.angle(t[0],t[this.order],t[1]);this.clockwise=n>0}length(){return $o.length(this.derivative.bind(this))}static getABC(t=2,n,e,r,i=.5){const o=$o.projectionratio(i,t),a=1-o,u={x:o*n.x+a*r.x,y:o*n.y+a*r.y},s=$o.abcratio(i,t);return{A:{x:e.x+(e.x-u.x)/s,y:e.y+(e.y-u.y)/s},B:e,C:u,S:n,E:r}}getABC(t,n){n=n||this.get(t);let e=this.points[0],r=this.points[this.order];return Jo.getABC(this.order,e,n,r,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t+1)return this._lut;this._lut=[],t++,this._lut=[];for(let n,e,r=0;r<t;r++)e=r/(t-1),n=this.compute(e),n.t=e,this._lut.push(n);return this._lut}on(n,e){e=e||5;const r=this.getLUT(),i=[];for(let t,o=0,a=0;o<r.length;o++)t=r[o],$o.dist(t,n)<e&&(i.push(t),a+=o/r.length);return!!i.length&&(t/=i.length)}project(t){const n=this.getLUT(),e=n.length-1,r=$o.closest(n,t),i=r.mpos,o=(i-1)/e,a=(i+1)/e,u=.1/e;let s,l=r.mdist,c=o,h=c;l+=1;for(let n;c<a+u;c+=u)s=this.compute(c),n=$o.dist(t,s),n<l&&(l=n,h=c);return h=h<0?0:h>1?1:h,s=this.compute(h),s.t=h,s.d=l,s}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?$o.computeWithRatios(t,this.points,this.ratios,this._3d):$o.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,n=[t[0]],e=t.length;for(let r,i,o=1;o<e;o++)r=t[o],i=t[o-1],n[o]={x:(e-o)/e*r.x+o/e*i.x,y:(e-o)/e*r.y+o/e*i.y};return n[e]=t[e-1],new Jo(n)}derivative(t){return $o.compute(t,this.dpoints[0],this._3d)}dderivative(t){return $o.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new Jo($o.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return $o.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return $o.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const n=this.derivative(t),e=Qo(n.x*n.x+n.y*n.y);return{t:t,x:-n.y/e,y:n.x/e}}__normal3(t){const n=this.derivative(t),e=this.derivative(t+.01),r=Qo(n.x*n.x+n.y*n.y+n.z*n.z),i=Qo(e.x*e.x+e.y*e.y+e.z*e.z);n.x/=r,n.y/=r,n.z/=r,e.x/=i,e.y/=i,e.z/=i;const o={x:e.y*n.z-e.z*n.y,y:e.z*n.x-e.x*n.z,z:e.x*n.y-e.y*n.x},a=Qo(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=a,o.y/=a,o.z/=a;const u=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{t:t,x:u[0]*n.x+u[1]*n.y+u[2]*n.z,y:u[3]*n.x+u[4]*n.y+u[5]*n.z,z:u[6]*n.x+u[7]*n.y+u[8]*n.z}}hull(t){let n=this.points,e=[],r=[],i=0;for(r[i++]=n[0],r[i++]=n[1],r[i++]=n[2],3===this.order&&(r[i++]=n[3]);n.length>1;){e=[];for(let o,a=0,u=n.length-1;a<u;a++)o=$o.lerp(t,n[a],n[a+1]),r[i++]=o,e.push(o);n=e}return r}split(t,n){if(0===t&&n)return this.split(n).left;if(1===n)return this.split(t).right;const e=this.hull(t),r={left:2===this.order?new Jo([e[0],e[3],e[5]]):new Jo([e[0],e[4],e[7],e[9]]),right:2===this.order?new Jo([e[5],e[4],e[2]]):new Jo([e[9],e[8],e[6],e[3]]),span:e};return r.left._t1=$o.map(0,0,1,this._t1,this._t2),r.left._t2=$o.map(t,0,1,this._t1,this._t2),r.right._t1=$o.map(t,0,1,this._t1,this._t2),r.right._t2=$o.map(1,0,1,this._t1,this._t2),n?(n=$o.map(n,t,1,0,1),r.right.split(n).left):r}extrema(){const t={};let n=[];return this.dims.forEach(function(e){let r=function(t){return t[e]},i=this.dpoints[0].map(r);t[e]=$o.droots(i),3===this.order&&(i=this.dpoints[1].map(r),t[e]=t[e].concat($o.droots(i))),t[e]=t[e].filter((function(t){return t>=0&&t<=1})),n=n.concat(t[e].sort($o.numberSort))}.bind(this)),t.values=n.sort($o.numberSort).filter((function(t,e){return n.indexOf(t)===e})),t}bbox(){const t=this.extrema(),n={};return this.dims.forEach(function(e){n[e]=$o.getminmax(this,e,t[e])}.bind(this)),n}overlaps(t){const n=this.bbox(),e=t.bbox();return $o.bboxoverlap(n,e)}offset(t,n){if(void 0!==n){const e=this.get(t),r=this.normal(t),i={c:e,n:r,x:e.x+r.x*n,y:e.y+r.y*n};return this._3d&&(i.z=e.z+r.z*n),i}if(this._linear){const n=this.normal(0),e=this.points.map((function(e){const r={x:e.x+t*n.x,y:e.y+t*n.y};return e.z&&n.z&&(r.z=e.z+t*n.z),r}));return[new Jo(e)]}return this.reduce().map((function(n){return n._linear?n.offset(t)[0]:n.scale(t)}))}simple(){if(3===this.order){const t=$o.angle(this.points[0],this.points[3],this.points[1]),n=$o.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&n<0||t<0&&n>0)return!1}const t=this.normal(0),n=this.normal(1);let e=t.x*n.x+t.y*n.y;return this._3d&&(e+=t.z*n.z),Vo(Zo(e))<Ko/3}reduce(){let t,n,e=0,r=0,i=.01,o=[],a=[],u=this.extrema().values;for(-1===u.indexOf(0)&&(u=[0].concat(u)),-1===u.indexOf(1)&&u.push(1),e=u[0],t=1;t<u.length;t++)r=u[t],n=this.split(e,r),n._t1=e,n._t2=r,o.push(n),e=r;return o.forEach((function(t){for(e=0,r=0;r<=1;)for(r=e+i;r<=1.01;r+=i)if(n=t.split(e,r),!n.simple()){if(r-=i,Vo(e-r)<i)return[];n=t.split(e,r),n._t1=$o.map(e,0,1,t._t1,t._t2),n._t2=$o.map(r,0,1,t._t1,t._t2),a.push(n),e=r;break}e<1&&(n=t.split(e,1),n._t1=$o.map(e,0,1,t._t1,t._t2),n._t2=t._t2,a.push(n))})),a}translate(t,n,e){e="number"==typeof e?e:n;const r=this.order;let i=this.points.map(((t,i)=>(1-i/r)*n+i/r*e));return new Jo(this.points.map(((n,e)=>({x:n.x+t.x*i[e],y:n.y+t.y*i[e]}))))}scale(t){const n=this.order;let e=!1;if("function"==typeof t&&(e=t),e&&2===n)return this.raise().scale(e);const r=this.clockwise,i=this.points;if(this._linear)return this.translate(this.normal(0),e?e(0):t,e?e(1):t);const o=e?e(0):t,a=e?e(1):t,u=[this.offset(0,10),this.offset(1,10)],s=[],l=$o.lli4(u[0],u[0].c,u[1],u[1].c);if(!l)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const e=s[t*n]=$o.copy(i[t*n]);e.x+=(t?a:o)*u[t].n.x,e.y+=(t?a:o)*u[t].n.y})),e?([0,1].forEach((function(o){if(2!==n||!o){var a=i[o+1],u={x:a.x-l.x,y:a.y-l.y},c=e?e((o+1)/n):t;e&&!r&&(c=-c);var h=Qo(u.x*u.x+u.y*u.y);u.x/=h,u.y/=h,s[o+1]={x:a.x+c*u.x,y:a.y+c*u.y}}})),new Jo(s)):([0,1].forEach((t=>{if(2===n&&t)return;const e=s[t*n],r=this.derivative(t),o={x:e.x+r.x,y:e.y+r.y};s[t+1]=$o.lli4(e,o,l,i[t+1])})),new Jo(s))}outline(t,n,e,r){if(n=void 0===n?t:n,this._linear){const i=this.normal(0),o=this.points[0],a=this.points[this.points.length-1];let u,s,l;void 0===e&&(e=t,r=n),u={x:o.x+i.x*t,y:o.y+i.y*t},l={x:a.x+i.x*e,y:a.y+i.y*e},s={x:(u.x+l.x)/2,y:(u.y+l.y)/2};const c=[u,s,l];u={x:o.x-i.x*n,y:o.y-i.y*n},l={x:a.x-i.x*r,y:a.y-i.y*r},s={x:(u.x+l.x)/2,y:(u.y+l.y)/2};const h=[l,s,u],f=$o.makeline(h[2],c[0]),d=$o.makeline(c[2],h[0]),p=[f,new Jo(c),d,new Jo(h)];return new Ho(p)}const i=this.reduce(),o=i.length,a=[];let u,s=[],l=0,c=this.length();const h=void 0!==e&&void 0!==r;function f(t,n,e,r,i){return function(o){const a=r/e,u=(r+i)/e,s=n-t;return $o.map(o,0,1,t+a*s,t+u*s)}}i.forEach((function(i){const o=i.length();h?(a.push(i.scale(f(t,e,c,l,o))),s.push(i.scale(f(-n,-r,c,l,o)))):(a.push(i.scale(t)),s.push(i.scale(-n))),l+=o})),s=s.map((function(t){return u=t.points,u[3]?t.points=[u[3],u[2],u[1],u[0]]:t.points=[u[2],u[1],u[0]],t})).reverse();const d=a[0].points[0],p=a[o-1].points[a[o-1].points.length-1],g=s[o-1].points[s[o-1].points.length-1],y=s[0].points[0],v=$o.makeline(g,d),_=$o.makeline(p,y),m=[v].concat(a).concat([_]).concat(s);return new Ho(m)}outlineshapes(t,n,e){n=n||t;const r=this.outline(t,n).curves,i=[];for(let t=1,n=r.length;t<n/2;t++){const o=$o.makeshape(r[t],r[n-t],e);o.startcap.virtual=t>1,o.endcap.virtual=t<n/2-1,i.push(o)}return i}intersects(t,n){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof Jo&&(t=t.reduce()),this.curveintersects(this.reduce(),t,n)):this.selfintersects(n)}lineIntersects(t){const n=Xo(t.p1.x,t.p2.x),e=Xo(t.p1.y,t.p2.y),r=Go(t.p1.x,t.p2.x),i=Go(t.p1.y,t.p2.y);return $o.roots(this.points,t).filter((t=>{var o=this.get(t);return $o.between(o.x,n,r)&&$o.between(o.y,e,i)}))}selfintersects(t){const n=this.reduce(),e=n.length-2,r=[];for(let i,o,a,u=0;u<e;u++)o=n.slice(u,u+1),a=n.slice(u+2),i=this.curveintersects(o,a,t),r.push(...i);return r}curveintersects(t,n,e){const r=[];t.forEach((function(t){n.forEach((function(n){t.overlaps(n)&&r.push({left:t,right:n})}))}));let i=[];return r.forEach((function(t){const n=$o.pairiteration(t.left,t.right,e);n.length>0&&(i=i.concat(n))})),i}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,n,e,r){const i=(r-e)/4,o=this.get(e+i),a=this.get(r-i),u=$o.dist(t,n),s=$o.dist(t,o),l=$o.dist(t,a);return Vo(s-u)+Vo(l-u)}_iterate(t,n){let e,r=0,i=1;do{e=0,i=1;let o,a,u,s,l,c=this.get(r),h=!1,f=!1,d=i,p=1;do{if(f=h,s=u,d=(r+i)/2,o=this.get(d),a=this.get(i),u=$o.getccenter(c,o,a),u.interval={start:r,end:i},h=this._error(u,c,r,i)<=t,l=f&&!h,l||(p=i),h){if(i>=1){if(u.interval.end=p=1,s=u,i>1){let t={x:u.x+u.r*Yo(u.e),y:u.y+u.r*Wo(u.e)};u.e+=$o.angle({x:u.x,y:u.y},t,this.get(1))}break}i+=(i-r)/2}else i=d}while(!l&&e++<100);if(e>=100)break;s=s||u,n.push(s),r=p}while(i<1);return n}}function ta(t,n){if(null==t)return{};var e,r,i=function(t,n){if(null==t)return{};var e,r,i={},o=Object.keys(t);for(r=0;r<o.length;r++)e=o[r],n.indexOf(e)>=0||(i[e]=t[e]);return i}(t,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)e=o[r],n.indexOf(e)>=0||Object.prototype.propertyIsEnumerable.call(t,e)&&(i[e]=t[e])}return i}function na(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){var e=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=e){var r,i,o,a,u=[],s=!0,l=!1;try{if(o=(e=e.call(t)).next,0===n){if(Object(e)!==e)return;s=!1}else for(;!(s=(r=o.call(e)).done)&&(u.push(r.value),u.length!==n);s=!0);}catch(t){l=!0,i=t}finally{try{if(!s&&null!=e.return&&(a=e.return(),Object(a)!==a))return}finally{if(l)throw i}}return u}}(t,n)||ra(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ea(t){return function(t){if(Array.isArray(t))return ia(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||ra(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ra(t,n){if(t){if("string"==typeof t)return ia(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?ia(t,n):void 0}}function ia(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}function oa(t){var n=function(t,n){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==typeof n?n:String(n)}function aa(t,n){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(n).domain(t)}return this}const ua=Symbol("implicit");var sa=function(t){for(var n=t.length/6|0,e=new Array(n),r=0;r<n;)e[r]="#"+t.slice(6*r,6*++r);return e}("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928"),la=function t(){var n=new or,e=[],r=[],i=ua;function o(t){let o=n.get(t);if(void 0===o){if(i!==ua)return i;n.set(t,o=e.push(t)-1)}return r[o%r.length]}return o.domain=function(t){if(!arguments.length)return e.slice();e=[],n=new or;for(const r of t)n.has(r)||n.set(r,e.push(r)-1);return o},o.range=function(t){return arguments.length?(r=Array.from(t),o):r.slice()},o.unknown=function(t){return arguments.length?(i=t,o):i},o.copy=function(){return t(e,r).unknown(i)},aa.apply(o,arguments),o}(sa);function ca(t,n,e){n&&"string"==typeof e&&t.filter((function(t){return!t[e]})).forEach((function(t){t[e]=la(n(t))}))}var ha=function(t,n){return n.onNeedsRedraw&&n.onNeedsRedraw()},fa=function(t,n){if(!n.isShadow){var e=ti(n.linkDirectionalParticles);n.graphData.links.forEach((function(t){var n=Math.round(Math.abs(e(t)));n?t.__photons=c(Array(n)).map((function(){return{}})):delete t.__photons}))}},da=Jr({props:{graphData:{default:{nodes:[],links:[]},onChange:function(t,n){n.engineRunning=!1,fa(0,n)}},dagMode:{onChange:function(t,n){!t&&(n.graphData.nodes||[]).forEach((function(t){return t.fx=t.fy=void 0}))}},dagLevelDistance:{},dagNodeFilter:{default:function(t){return!0}},onDagError:{triggerUpdate:!1},nodeRelSize:{default:4,triggerUpdate:!1,onChange:ha},nodeId:{default:"id"},nodeVal:{default:"val",triggerUpdate:!1,onChange:ha},nodeColor:{default:"color",triggerUpdate:!1,onChange:ha},nodeAutoColorBy:{},nodeCanvasObject:{triggerUpdate:!1,onChange:ha},nodeCanvasObjectMode:{default:function(){return"replace"},triggerUpdate:!1,onChange:ha},nodeVisibility:{default:!0,triggerUpdate:!1,onChange:ha},linkSource:{default:"source"},linkTarget:{default:"target"},linkVisibility:{default:!0,triggerUpdate:!1,onChange:ha},linkColor:{default:"color",triggerUpdate:!1,onChange:ha},linkAutoColorBy:{},linkLineDash:{triggerUpdate:!1,onChange:ha},linkWidth:{default:1,triggerUpdate:!1,onChange:ha},linkCurvature:{default:0,triggerUpdate:!1,onChange:ha},linkCanvasObject:{triggerUpdate:!1,onChange:ha},linkCanvasObjectMode:{default:function(){return"replace"},triggerUpdate:!1,onChange:ha},linkDirectionalArrowLength:{default:0,triggerUpdate:!1,onChange:ha},linkDirectionalArrowColor:{triggerUpdate:!1,onChange:ha},linkDirectionalArrowRelPos:{default:.5,triggerUpdate:!1,onChange:ha},linkDirectionalParticles:{default:0,triggerUpdate:!1,onChange:fa},linkDirectionalParticleSpeed:{default:.01,triggerUpdate:!1},linkDirectionalParticleWidth:{default:4,triggerUpdate:!1},linkDirectionalParticleColor:{triggerUpdate:!1},globalScale:{default:1,triggerUpdate:!1},d3AlphaMin:{default:0,triggerUpdate:!1},d3AlphaDecay:{default:.0228,triggerUpdate:!1,onChange:function(t,n){n.forceLayout.alphaDecay(t)}},d3AlphaTarget:{default:0,triggerUpdate:!1,onChange:function(t,n){n.forceLayout.alphaTarget(t)}},d3VelocityDecay:{default:.4,triggerUpdate:!1,onChange:function(t,n){n.forceLayout.velocityDecay(t)}},warmupTicks:{default:0,triggerUpdate:!1},cooldownTicks:{default:1/0,triggerUpdate:!1},cooldownTime:{default:15e3,triggerUpdate:!1},onUpdate:{default:function(){},triggerUpdate:!1},onFinishUpdate:{default:function(){},triggerUpdate:!1},onEngineTick:{default:function(){},triggerUpdate:!1},onEngineStop:{default:function(){},triggerUpdate:!1},onNeedsRedraw:{triggerUpdate:!1},isShadow:{default:!1,triggerUpdate:!1}},methods:{d3Force:function(t,n,e){return void 0===e?t.forceLayout.force(n):(t.forceLayout.force(n,e),this)},d3ReheatSimulation:function(t){return t.forceLayout.alpha(1),this.resetCountdown(),this},resetCountdown:function(t){return t.cntTicks=0,t.startTickTime=new Date,t.engineRunning=!0,this},isEngineRunning:function(t){return!!t.engineRunning},tickFrame:function(t){var e,r,i,o,a,u;return!t.isShadow&&t.engineRunning&&(++t.cntTicks>t.cooldownTicks||new Date-t.startTickTime>t.cooldownTime||t.d3AlphaMin>0&&t.forceLayout.alpha()<t.d3AlphaMin?(t.engineRunning=!1,t.onEngineStop()):(t.forceLayout.tick(),t.onEngineTick())),function(){var n=ti(t.linkVisibility),e=ti(t.linkColor),r=ti(t.linkWidth),i=ti(t.linkLineDash),o=ti(t.linkCurvature),a=ti(t.linkCanvasObjectMode),u=t.ctx,s=2*t.isShadow,h=t.graphData.links.filter(n);h.forEach((function(t){var n=o(t);if(!n)return void(t.__controlPoints=null);var e=t.source,r=t.target;if(!(e&&r&&e.hasOwnProperty("x")&&r.hasOwnProperty("x")))return;var i=Math.sqrt(Math.pow(r.x-e.x,2)+Math.pow(r.y-e.y,2));if(i>0){var a=Math.atan2(r.y-e.y,r.x-e.x),u=i*n,s={x:(e.x+r.x)/2+u*Math.cos(a-Math.PI/2),y:(e.y+r.y)/2+u*Math.sin(a-Math.PI/2)};t.__controlPoints=[s.x,s.y]}else{var l=70*n;t.__controlPoints=[r.x,r.y-l,r.x+l,r.y]}}));var f=[],d=[],p=h;if(t.linkCanvasObject){var g=[],y=[];h.forEach((function(t){return({before:f,after:d,replace:g}[a(t)]||y).push(t)})),p=[].concat(c(f),d,y),f=f.concat(g)}u.save(),f.forEach((function(n){return t.linkCanvasObject(n,u,t.globalScale)})),u.restore();var v=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=(n instanceof Array?n.length?n:[void 0]:[n]).map((function(t){return{keyAccessor:t,isProp:!(t instanceof Function)}})),o=t.reduce((function(t,n){var r=t,o=n;return i.forEach((function(t,n){var a,u=t.keyAccessor;if(t.isProp){var s=o,l=s[u],c=ta(s,[u].map(oa));a=l,o=c}else a=u(o,n);n+1<i.length?(r.hasOwnProperty(a)||(r[a]={}),r=r[a]):e?(r.hasOwnProperty(a)||(r[a]=[]),r[a].push(o)):r[a]=o})),t}),{});e instanceof Function&&function t(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;r===i.length?Object.keys(n).forEach((function(t){return n[t]=e(n[t])})):Object.values(n).forEach((function(n){return t(n,r+1)}))}(o);var a=o;return r&&(a=[],function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.length===i.length?a.push({keys:e,vals:n}):Object.entries(n).forEach((function(n){var r=na(n,2),i=r[0],o=r[1];return t(o,[].concat(ea(e),[i]))}))}(o),n instanceof Array&&0===n.length&&1===a.length&&(a[0].keys=[])),a}(p,[e,r,i]);u.save(),Object.entries(v).forEach((function(n){var e=l(n,2),r=e[0],o=e[1],a=r&&"undefined"!==r?r:"rgba(0,0,0,0.15)";Object.entries(o).forEach((function(n){var e=l(n,2),r=e[0],o=e[1],h=(r||1)/t.globalScale+s;Object.entries(o).forEach((function(t){var n=l(t,2);n[0];var e=n[1],r=i(e[0]);u.beginPath(),e.forEach((function(t){var n=t.source,e=t.target;if(n&&e&&n.hasOwnProperty("x")&&e.hasOwnProperty("x")){u.moveTo(n.x,n.y);var r=t.__controlPoints;r?u[2===r.length?"quadraticCurveTo":"bezierCurveTo"].apply(u,c(r).concat([e.x,e.y])):u.lineTo(e.x,e.y)}})),u.strokeStyle=a,u.lineWidth=h,u.setLineDash(r||[]),u.stroke()}))}))})),u.restore(),u.save(),d.forEach((function(n){return t.linkCanvasObject(n,u,t.globalScale)})),u.restore()}(),!t.isShadow&&(e=ti(t.linkDirectionalArrowLength),r=ti(t.linkDirectionalArrowRelPos),i=ti(t.linkVisibility),o=ti(t.linkDirectionalArrowColor||t.linkColor),a=ti(t.nodeVal),(u=t.ctx).save(),t.graphData.links.filter(i).forEach((function(i){var s=e(i);if(s&&!(s<0)){var l=i.source,h=i.target;if(l&&h&&l.hasOwnProperty("x")&&h.hasOwnProperty("x")){var f=Math.sqrt(Math.max(0,a(l)||1))*t.nodeRelSize,d=Math.sqrt(Math.max(0,a(h)||1))*t.nodeRelSize,p=Math.min(1,Math.max(0,r(i))),g=o(i)||"rgba(0,0,0,0.28)",y=s/1.6/2,v=i.__controlPoints&&n(Jo,[l.x,l.y].concat(c(i.__controlPoints),[h.x,h.y])),_=v?function(t){return v.get(t)}:function(t){return{x:l.x+(h.x-l.x)*t||0,y:l.y+(h.y-l.y)*t||0}},m=v?v.length():Math.sqrt(Math.pow(h.x-l.x,2)+Math.pow(h.y-l.y,2)),x=f+s+(m-f-d-s)*p,b=_(x/m),w=_((x-s)/m),k=_((x-.8*s)/m),M=Math.atan2(b.y-w.y,b.x-w.x)-Math.PI/2;u.beginPath(),u.moveTo(b.x,b.y),u.lineTo(w.x+y*Math.cos(M),w.y+y*Math.sin(M)),u.lineTo(k.x,k.y),u.lineTo(w.x-y*Math.cos(M),w.y-y*Math.sin(M)),u.fillStyle=g,u.fill()}}})),u.restore()),!t.isShadow&&function(){var e=ti(t.linkDirectionalParticles),r=ti(t.linkDirectionalParticleSpeed),i=ti(t.linkDirectionalParticleWidth),o=ti(t.linkVisibility),a=ti(t.linkDirectionalParticleColor||t.linkColor),u=t.ctx;u.save(),t.graphData.links.filter(o).forEach((function(o){var s=e(o);if(o.hasOwnProperty("__photons")&&o.__photons.length){var l=o.source,h=o.target;if(l&&h&&l.hasOwnProperty("x")&&h.hasOwnProperty("x")){var f=r(o),d=o.__photons||[],p=Math.max(0,i(o)/2)/Math.sqrt(t.globalScale),g=a(o)||"rgba(0,0,0,0.28)";u.fillStyle=g;var y=o.__controlPoints?n(Jo,[l.x,l.y].concat(c(o.__controlPoints),[h.x,h.y])):null,v=0,_=!1;d.forEach((function(t){var n=!!t.__singleHop;if(t.hasOwnProperty("__progressRatio")||(t.__progressRatio=n?0:v/s),!n&&v++,t.__progressRatio+=f,t.__progressRatio>=1){if(n)return void(_=!0);t.__progressRatio=t.__progressRatio%1}var e=t.__progressRatio,r=y?y.get(e):{x:l.x+(h.x-l.x)*e||0,y:l.y+(h.y-l.y)*e||0};u.beginPath(),u.arc(r.x,r.y,p,0,2*Math.PI,!1),u.fill()})),_&&(o.__photons=o.__photons.filter((function(t){return!t.__singleHop||t.__progressRatio<=1})))}}})),u.restore()}(),function(){var n=ti(t.nodeVisibility),e=ti(t.nodeVal),r=ti(t.nodeColor),i=ti(t.nodeCanvasObjectMode),o=t.ctx,a=t.isShadow/t.globalScale,u=t.graphData.nodes.filter(n);o.save(),u.forEach((function(n){var u=i(n);if(!t.nodeCanvasObject||"before"!==u&&"replace"!==u||(t.nodeCanvasObject(n,o,t.globalScale),"replace"!==u)){var s=Math.sqrt(Math.max(0,e(n)||1))*t.nodeRelSize+a;o.beginPath(),o.arc(n.x,n.y,s,0,2*Math.PI,!1),o.fillStyle=r(n)||"rgba(31, 120, 180, 0.92)",o.fill(),t.nodeCanvasObject&&"after"===u&&t.nodeCanvasObject(n,t.ctx,t.globalScale)}else o.restore()})),o.restore()}(),this},emitParticle:function(t,n){return n&&(!n.__photons&&(n.__photons=[]),n.__photons.push({__singleHop:!0})),this}},stateInit:function(){return{forceLayout:So().force("link",_o()).force("charge",Co()).force("center",Bi()).force("dagRadial",null).stop(),engineRunning:!1}},init:function(t,n){n.ctx=t},update:function(t){t.engineRunning=!1,t.onUpdate(),null!==t.nodeAutoColorBy&&ca(t.graphData.nodes,ti(t.nodeAutoColorBy),t.nodeColor),null!==t.linkAutoColorBy&&ca(t.graphData.links,ti(t.linkAutoColorBy),t.linkColor),t.graphData.links.forEach((function(n){n.source=n[t.linkSource],n.target=n[t.linkTarget]})),t.forceLayout.stop().alpha(1).nodes(t.graphData.nodes);var n=t.forceLayout.force("link");n&&n.id((function(n){return n[t.nodeId]})).links(t.graphData.links);var e=t.dagMode&&function(t,n){var e=t.nodes,r=t.links,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.nodeFilter,s=void 0===o?function(){return!0}:o,h=i.onLoopError,f=void 0===h?function(t){throw"Invalid DAG structure! Found cycle in node path: ".concat(t.join(" -> "),".")}:h,d={};e.forEach((function(t){return d[n(t)]={data:t,out:[],depth:-1,skip:!s(t)}})),r.forEach((function(t){var e=t.source,r=t.target,i=l(e),o=l(r);if(!d.hasOwnProperty(i))throw"Missing source node with id: ".concat(i);if(!d.hasOwnProperty(o))throw"Missing target node with id: ".concat(o);var u=d[i],s=d[o];function l(t){return"object"===a(t)?n(t):t}u.out.push(s)}));var p=[];return function t(e){for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=function(){var o=e[a];if(-1!==r.indexOf(o)){var u=[].concat(c(r.slice(r.indexOf(o))),[o]).map((function(t){return n(t.data)}));return p.some((function(t){return t.length===u.length&&t.every((function(t,n){return t===u[n]}))}))||(p.push(u),f(u)),1}i>o.depth&&(o.depth=i,t(o.out,[].concat(c(r),[o]),i+(o.skip?0:1)))},a=0,u=e.length;a<u;a++)o()}(Object.values(d)),Object.assign.apply(Object,[{}].concat(c(Object.entries(d).filter((function(t){return!l(t,2)[1].skip})).map((function(t){var n=l(t,2);return u({},n[0],n[1].depth)})))))}(t.graphData,(function(n){return n[t.nodeId]}),{nodeFilter:t.dagNodeFilter,onLoopError:t.onDagError||void 0}),r=Math.max.apply(Math,c(Object.values(e||[]))),i=t.dagLevelDistance||t.graphData.nodes.length/(r||1)*2*(-1!==["radialin","radialout"].indexOf(t.dagMode)?.7:1);if(t.dagMode){var o=function(n,o){return function(a){return n?(e[a[t.nodeId]]-r/2)*i*(o?-1:1):void 0}},s=o(-1!==["lr","rl"].indexOf(t.dagMode),"rl"===t.dagMode),h=o(-1!==["td","bu"].indexOf(t.dagMode),"bu"===t.dagMode);t.graphData.nodes.filter(t.dagNodeFilter).forEach((function(t){t.fx=s(t),t.fy=h(t)}))}t.forceLayout.force("dagRadial",-1!==["radialin","radialout"].indexOf(t.dagMode)?function(t,n,e,r){var i,o,a,u,s=po(.1);function l(t){for(var s=0,l=i.length;s<l;++s){var c=i[s],h=c.x-n||1e-6,f=(c.y||0)-e||1e-6,d=(c.z||0)-r||1e-6,p=Math.sqrt(h*h+f*f+d*d),g=(u[s]-p)*a[s]*t/p;c.vx+=h*g,o>1&&(c.vy+=f*g),o>2&&(c.vz+=d*g)}}function c(){if(i){var n,e=i.length;for(a=new Array(e),u=new Array(e),n=0;n<e;++n)u[n]=+t(i[n],n,i),a[n]=isNaN(u[n])?0:+s(i[n],n,i)}}return"function"!=typeof t&&(t=po(+t)),null==n&&(n=0),null==e&&(e=0),null==r&&(r=0),l.initialize=function(t,...n){i=t,o=n.find((t=>[1,2,3].includes(t)))||2,c()},l.strength=function(t){return arguments.length?(s="function"==typeof t?t:po(+t),c(),l):s},l.radius=function(n){return arguments.length?(t="function"==typeof n?n:po(+n),c(),l):t},l.x=function(t){return arguments.length?(n=+t,l):n},l.y=function(t){return arguments.length?(e=+t,l):e},l.z=function(t){return arguments.length?(r=+t,l):r},l}((function(n){var o=e[n[t.nodeId]]||-1;return("radialin"===t.dagMode?r-o:o)*i})).strength((function(n){return t.dagNodeFilter(n)?1:0})):null);for(var f=0;f<t.warmupTicks&&!(t.d3AlphaMin>0&&t.forceLayout.alpha()<t.d3AlphaMin);f++)t.forceLayout.tick();this.resetCountdown(),t.onFinishUpdate()}});function pa(t,n){var e=t instanceof Array?t:[t],r=new n;return r._destructor&&r._destructor(),{linkProp:function(t){return{default:r[t](),onChange:function(n,r){e.forEach((function(e){return r[e][t](n)}))},triggerUpdate:!1}},linkMethod:function(t){return function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[];return e.forEach((function(e){var r=n[e],o=r[t].apply(r,i);o!==r&&a.push(o)})),a.length?a[0]:this}}}}var ga=pa("forceGraph",da),ya=pa(["forceGraph","shadowGraph"],da),va=Object.assign.apply(Object,c(["nodeColor","nodeAutoColorBy","nodeCanvasObject","nodeCanvasObjectMode","linkColor","linkAutoColorBy","linkLineDash","linkWidth","linkCanvasObject","linkCanvasObjectMode","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","dagMode","dagLevelDistance","dagNodeFilter","onDagError","d3AlphaMin","d3AlphaDecay","d3VelocityDecay","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"].map((function(t){return u({},t,ga.linkProp(t))}))).concat(c(["nodeRelSize","nodeId","nodeVal","nodeVisibility","linkSource","linkTarget","linkVisibility","linkCurvature"].map((function(t){return u({},t,ya.linkProp(t))}))))),_a=Object.assign.apply(Object,c(["d3Force","d3ReheatSimulation","emitParticle"].map((function(t){return u({},t,ga.linkMethod(t))}))));function ma(t){if(t.canvas){var n=t.canvas.width,e=t.canvas.height;300===n&&150===e&&(n=e=0);var r=window.devicePixelRatio;n/=r,e/=r,[t.canvas,t.shadowCanvas].forEach((function(i){i.style.width="".concat(t.width,"px"),i.style.height="".concat(t.height,"px"),i.width=t.width*r,i.height=t.height*r,n||e||i.getContext("2d").scale(r,r)}));var i=We(t.canvas).k;t.zoom.translateBy(t.zoom.__baseElem,(t.width-n)/2/i,(t.height-e)/2/i),t.needsRedraw=!0}}function xa(t){var n=window.devicePixelRatio;t.setTransform(n,0,0,n,0,0)}function ba(t,n,e){t.save(),xa(t),t.clearRect(0,0,n,e),t.restore()}var wa=Jr({props:i({width:{default:window.innerWidth,onChange:function(t,n){return ma(n)},triggerUpdate:!1},height:{default:window.innerHeight,onChange:function(t,n){return ma(n)},triggerUpdate:!1},graphData:{default:{nodes:[],links:[]},onChange:function(t,n){[{type:"Node",objs:t.nodes},{type:"Link",objs:t.links}].forEach((function(t){var e=t.type;t.objs.filter((function(t){if(!t.hasOwnProperty("__indexColor"))return!0;var e=n.colorTracker.lookup(t.__indexColor);return!e||!e.hasOwnProperty("d")||e.d!==t})).forEach((function(t){t.__indexColor=n.colorTracker.register({type:e,d:t})}))})),n.forceGraph.graphData(t),n.shadowGraph.graphData(t)},triggerUpdate:!1},backgroundColor:{onChange:function(t,n){n.canvas&&t&&(n.canvas.style.background=t)},triggerUpdate:!1},nodeLabel:{default:"name",triggerUpdate:!1},nodePointerAreaPaint:{onChange:function(t,n){n.shadowGraph.nodeCanvasObject(t?function(n,e,r){return t(n,n.__indexColor,e,r)}:null),n.flushShadowCanvas&&n.flushShadowCanvas()},triggerUpdate:!1},linkPointerAreaPaint:{onChange:function(t,n){n.shadowGraph.linkCanvasObject(t?function(n,e,r){return t(n,n.__indexColor,e,r)}:null),n.flushShadowCanvas&&n.flushShadowCanvas()},triggerUpdate:!1},linkLabel:{default:"name",triggerUpdate:!1},linkHoverPrecision:{default:4,triggerUpdate:!1},minZoom:{default:.01,onChange:function(t,n){n.zoom.scaleExtent([t,n.zoom.scaleExtent()[1]])},triggerUpdate:!1},maxZoom:{default:1e3,onChange:function(t,n){n.zoom.scaleExtent([n.zoom.scaleExtent()[0],t])},triggerUpdate:!1},enableNodeDrag:{default:!0,triggerUpdate:!1},enableZoomInteraction:{default:!0,triggerUpdate:!1},enablePanInteraction:{default:!0,triggerUpdate:!1},enableZoomPanInteraction:{default:!0,triggerUpdate:!1},enablePointerInteraction:{default:!0,onChange:function(t,n){n.hoverObj=null},triggerUpdate:!1},autoPauseRedraw:{default:!0,triggerUpdate:!1},onNodeDrag:{default:function(){},triggerUpdate:!1},onNodeDragEnd:{default:function(){},triggerUpdate:!1},onNodeClick:{triggerUpdate:!1},onNodeRightClick:{triggerUpdate:!1},onNodeHover:{triggerUpdate:!1},onLinkClick:{triggerUpdate:!1},onLinkRightClick:{triggerUpdate:!1},onLinkHover:{triggerUpdate:!1},onBackgroundClick:{triggerUpdate:!1},onBackgroundRightClick:{triggerUpdate:!1},onZoom:{triggerUpdate:!1},onZoomEnd:{triggerUpdate:!1},onRenderFramePre:{triggerUpdate:!1},onRenderFramePost:{triggerUpdate:!1}},va),aliases:{stopAnimation:"pauseAnimation"},methods:i({graph2ScreenCoords:function(t,n,e){var r=We(t.canvas);return{x:n*r.k+r.x,y:e*r.k+r.y}},screen2GraphCoords:function(t,n,e){var r=We(t.canvas);return{x:(n-r.x)/r.k,y:(e-r.y)/r.k}},centerAt:function(t,n,e,r){if(!t.canvas)return null;if(void 0!==n||void 0!==e){var i=Object.assign({},void 0!==n?{x:n}:{},void 0!==e?{y:e}:{});return r?new Vr(o()).to(i,r).easing(Fr.Quadratic.Out).onUpdate(a).start():a(i),this}return o();function o(){var n=We(t.canvas);return{x:(t.width/2-n.x)/n.k,y:(t.height/2-n.y)/n.k}}function a(n){var e=n.x,r=n.y;t.zoom.translateTo(t.zoom.__baseElem,void 0===e?o().x:e,void 0===r?o().y:r),t.needsRedraw=!0}},zoom:function(t,n,e){return t.canvas?void 0!==n?(e?new Vr({k:r()}).to({k:n},e).easing(Fr.Quadratic.Out).onUpdate((function(t){return i(t.k)})).start():i(n),this):r():null;function r(){return We(t.canvas).k}function i(n){t.zoom.scaleTo(t.zoom.__baseElem,n),t.needsRedraw=!0}},zoomToFit:function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,r=arguments.length,i=new Array(r>3?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];var a=this.getGraphBbox.apply(this,i);if(a){var u={x:(a.x[0]+a.x[1])/2,y:(a.y[0]+a.y[1])/2},s=Math.max(1e-12,Math.min(1e12,(t.width-2*e)/(a.x[1]-a.x[0]),(t.height-2*e)/(a.y[1]-a.y[0])));this.centerAt(u.x,u.y,n),this.zoom(s,n)}return this},getGraphBbox:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},e=ti(t.nodeVal),r=function(n){return Math.sqrt(Math.max(0,e(n)||1))*t.nodeRelSize},i=t.graphData.nodes.filter(n).map((function(t){return{x:t.x,y:t.y,r:r(t)}}));return i.length?{x:[lr(i,(function(t){return t.x-t.r})),sr(i,(function(t){return t.x+t.r}))],y:[lr(i,(function(t){return t.y-t.r})),sr(i,(function(t){return t.y+t.r}))]}:null},pauseAnimation:function(t){return t.animationFrameRequestId&&(cancelAnimationFrame(t.animationFrameRequestId),t.animationFrameRequestId=null),this},resumeAnimation:function(t){return t.animationFrameRequestId||this._animationCycle(),this},_destructor:function(){this.pauseAnimation(),this.graphData({nodes:[],links:[]})}},_a),stateInit:function(){return{lastSetZoom:1,zoom:ir(),forceGraph:new da,shadowGraph:(new da).cooldownTicks(0).nodeColor("__indexColor").linkColor("__indexColor").isShadow(!0),colorTracker:new qi}},init:function(t,n){var e=this;t.innerHTML="";var r=document.createElement("div");r.classList.add("force-graph-container"),r.style.position="relative",t.appendChild(r),n.canvas=document.createElement("canvas"),n.backgroundColor&&(n.canvas.style.background=n.backgroundColor),r.appendChild(n.canvas),n.shadowCanvas=document.createElement("canvas");var o=n.canvas.getContext("2d"),a=n.shadowCanvas.getContext("2d",{willReadFrequently:!0}),u={x:-1e12,y:-1e12},s=function(){var t=null,e=window.devicePixelRatio,r=u.x>0&&u.y>0?a.getImageData(u.x*e,u.y*e,1,1):null;return r&&(t=n.colorTracker.lookup(r.data)),t};zt(n.canvas).call(function(){var t,n,e,r,i=Lt,o=qt,a=Bt,u=$t,s={},l=Ct("start","drag","end"),c=0,h=0;function f(t){t.on("mousedown.drag",d).filter(u).on("touchstart.drag",y).on("touchmove.drag",v,Pt).on("touchend.drag touchcancel.drag",_).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function d(a,u){if(!r&&i.call(this,a,u)){var s=m(this,o.call(this,a,u),a,u,"mouse");s&&(zt(a.view).on("mousemove.drag",p,jt).on("mouseup.drag",g,jt),Dt(a.view),Tt(a),e=!1,t=a.clientX,n=a.clientY,s("start",a))}}function p(r){if(Rt(r),!e){var i=r.clientX-t,o=r.clientY-n;e=i*i+o*o>h}s.mouse("drag",r)}function g(t){zt(t.view).on("mousemove.drag mouseup.drag",null),It(t.view,e),Rt(t),s.mouse("end",t)}function y(t,n){if(i.call(this,t,n)){var e,r,a=t.changedTouches,u=o.call(this,t,n),s=a.length;for(e=0;e<s;++e)(r=m(this,u,t,n,a[e].identifier,a[e]))&&(Tt(t),r("start",t,a[e]))}}function v(t){var n,e,r=t.changedTouches,i=r.length;for(n=0;n<i;++n)(e=s[r[n].identifier])&&(Rt(t),e("drag",t,r[n]))}function _(t){var n,e,i=t.changedTouches,o=i.length;for(r&&clearTimeout(r),r=setTimeout((function(){r=null}),500),n=0;n<o;++n)(e=s[i[n].identifier])&&(Tt(t),e("end",t,i[n]))}function m(t,n,e,r,i,o){var u,h,d,p=l.copy(),g=At(o||e,n);if(null!=(d=a.call(t,new Ft("beforestart",{sourceEvent:e,target:f,identifier:i,active:c,x:g[0],y:g[1],dx:0,dy:0,dispatch:p}),r)))return u=d.x-g[0]||0,h=d.y-g[1]||0,function e(o,a,l){var y,v=g;switch(o){case"start":s[i]=e,y=c++;break;case"end":delete s[i],--c;case"drag":g=At(l||a,n),y=c}p.call(o,t,new Ft(o,{sourceEvent:a,subject:d,target:f,identifier:i,active:y,x:g[0]+u,y:g[1]+h,dx:g[0]-v[0],dy:g[1]-v[1],dispatch:p}),r)}}return f.filter=function(t){return arguments.length?(i="function"==typeof t?t:Ut(!!t),f):i},f.container=function(t){return arguments.length?(o="function"==typeof t?t:Ut(t),f):o},f.subject=function(t){return arguments.length?(a="function"==typeof t?t:Ut(t),f):a},f.touchable=function(t){return arguments.length?(u="function"==typeof t?t:Ut(!!t),f):u},f.on=function(){var t=l.on.apply(l,arguments);return t===l?f:t},f.clickDistance=function(t){return arguments.length?(h=(t=+t)*t,f):Math.sqrt(h)},f}().subject((function(){if(!n.enableNodeDrag)return null;var t=s();return t&&"Node"===t.type?t.d:null})).on("start",(function(t){var e=t.subject;e.__initialDragPos={x:e.x,y:e.y,fx:e.fx,fy:e.fy},t.active||(e.fx=e.x,e.fy=e.y),n.canvas.classList.add("grabbable")})).on("drag",(function(t){var e=t.subject,r=e.__initialDragPos,i=t,o=We(n.canvas).k,a={x:r.x+(i.x-r.x)/o-e.x,y:r.y+(i.y-r.y)/o-e.y};["x","y"].forEach((function(t){return e["f".concat(t)]=e[t]=r[t]+(i[t]-r[t])/o})),n.forceGraph.d3AlphaTarget(.3).resetCountdown(),n.isPointerDragging=!0,e.__dragged=!0,n.onNodeDrag(e,a)})).on("end",(function(t){var e=t.subject,r=e.__initialDragPos,i={x:e.x-r.x,y:e.y-r.y};void 0===r.fx&&(e.fx=void 0),void 0===r.fy&&(e.fy=void 0),delete e.__initialDragPos,n.forceGraph.d3AlphaTarget()&&n.forceGraph.d3AlphaTarget(0).resetCountdown(),n.canvas.classList.remove("grabbable"),n.isPointerDragging=!1,e.__dragged&&(delete e.__dragged,n.onNodeDragEnd(e,i))}))),n.zoom(n.zoom.__baseElem=zt(n.canvas)),n.zoom.__baseElem.on("dblclick.zoom",null),n.zoom.filter((function(t){return!t.button&&n.enableZoomPanInteraction&&(n.enableZoomInteraction||"wheel"!==t.type)&&(n.enablePanInteraction||"wheel"===t.type)})).on("zoom",(function(t){var r=t.transform;[o,a].forEach((function(t){xa(t),t.translate(r.x,r.y),t.scale(r.k,r.k)})),n.onZoom&&n.onZoom(i(i({},r),e.centerAt())),n.needsRedraw=!0})).on("end",(function(t){return n.onZoomEnd&&n.onZoomEnd(i(i({},t.transform),e.centerAt()))})),ma(n),n.forceGraph.onNeedsRedraw((function(){return n.needsRedraw=!0})).onFinishUpdate((function(){We(n.canvas).k===n.lastSetZoom&&n.graphData.nodes.length&&(n.zoom.scaleTo(n.zoom.__baseElem,n.lastSetZoom=4/Math.cbrt(n.graphData.nodes.length)),n.needsRedraw=!0)}));var l=document.createElement("div");l.classList.add("graph-tooltip"),r.appendChild(l),["pointermove","pointerdown"].forEach((function(t){return r.addEventListener(t,(function(e){"pointerdown"===t&&(n.isPointerPressed=!0,n.pointerDownEvent=e),!n.isPointerDragging&&"pointermove"===e.type&&n.onBackgroundClick&&(e.pressure>0||n.isPointerPressed)&&("touch"!==e.pointerType||void 0===e.movementX||[e.movementX,e.movementY].some((function(t){return Math.abs(t)>1})))&&(n.isPointerDragging=!0);var i,o,a,s=(i=r.getBoundingClientRect(),o=window.pageXOffset||document.documentElement.scrollLeft,a=window.pageYOffset||document.documentElement.scrollTop,{top:i.top+a,left:i.left+o});u.x=e.pageX-s.left,u.y=e.pageY-s.top,l.style.top="".concat(u.y,"px"),l.style.left="".concat(u.x,"px"),l.style.transform="translate(-".concat(u.x/n.width*100,"%, ").concat(n.height-u.y<100?"calc(-100% - 8px)":"21px",")")}),{passive:!0})})),r.addEventListener("pointerup",(function(t){if(n.isPointerPressed=!1,n.isPointerDragging)n.isPointerDragging=!1;else{var e=[t,n.pointerDownEvent];requestAnimationFrame((function(){if(0===t.button)if(n.hoverObj){var r=n["on".concat(n.hoverObj.type,"Click")];r&&r.apply(void 0,[n.hoverObj.d].concat(e))}else n.onBackgroundClick&&n.onBackgroundClick.apply(n,e);if(2===t.button)if(n.hoverObj){var i=n["on".concat(n.hoverObj.type,"RightClick")];i&&i.apply(void 0,[n.hoverObj.d].concat(e))}else n.onBackgroundRightClick&&n.onBackgroundRightClick.apply(n,e)}))}}),{passive:!0}),r.addEventListener("contextmenu",(function(t){return!(n.onBackgroundRightClick||n.onNodeRightClick||n.onLinkRightClick)||(t.preventDefault(),!1)})),n.forceGraph(o),n.shadowGraph(a);var c=function(t,n,e){var r=!0,i=!0;if("function"!=typeof t)throw new TypeError("Expected a function");return Sr(e)&&(r="leading"in e?!!e.leading:r,i="trailing"in e?!!e.trailing:i),Ur(t,n,{leading:r,maxWait:n,trailing:i})}((function(){ba(a,n.width,n.height),n.shadowGraph.linkWidth((function(t){return ti(n.linkWidth)(t)+n.linkHoverPrecision}));var t=We(n.canvas);n.shadowGraph.globalScale(t.k).tickFrame()}),800);n.flushShadowCanvas=c.flush,(this._animationCycle=function t(){var e=!n.autoPauseRedraw||!!n.needsRedraw||n.forceGraph.isEngineRunning()||n.graphData.links.some((function(t){return t.__photons&&t.__photons.length}));if(n.needsRedraw=!1,n.enablePointerInteraction){var r=n.isPointerDragging?null:s();if(r!==n.hoverObj){var i=n.hoverObj,a=i?i.type:null,u=r?r.type:null;if(a&&a!==u){var h=n["on".concat(a,"Hover")];h&&h(null,i.d)}if(u){var f=n["on".concat(u,"Hover")];f&&f(r.d,a===u?i.d:null)}var d=r&&ti(n["".concat(r.type.toLowerCase(),"Label")])(r.d)||"";l.style.visibility=d?"visible":"hidden",l.innerHTML=d,n.canvas.classList[r&&n["on".concat(u,"Click")]||!r&&n.onBackgroundClick?"add":"remove"]("clickable"),n.hoverObj=r}e&&c()}if(e){ba(o,n.width,n.height);var p=We(n.canvas).k;n.onRenderFramePre&&n.onRenderFramePre(o,p),n.forceGraph.globalScale(p).tickFrame(),n.onRenderFramePost&&n.onRenderFramePost(o,p)}Gr(),n.animationFrameRequestId=requestAnimationFrame(t)})()},update:function(t){}});return wa}));
</script>
    <script>/**
 * marked v14.1.0 - a markdown parser
 * Copyright (c) 2011-2024, Christopher Jeffrey. (MIT Licensed)
 * https://github.com/markedjs/marked
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).marked={})}(this,(function(e){"use strict";function t(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}function n(t){e.defaults=t}e.defaults={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};const s=/[&<>"']/,r=new RegExp(s.source,"g"),i=/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,l=new RegExp(i.source,"g"),o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},a=e=>o[e];function c(e,t){if(t){if(s.test(e))return e.replace(r,a)}else if(i.test(e))return e.replace(l,a);return e}const h=/(^|[^\[])\^/g;function p(e,t){let n="string"==typeof e?e:e.source;t=t||"";const s={replace:(e,t)=>{let r="string"==typeof t?t:t.source;return r=r.replace(h,"$1"),n=n.replace(e,r),s},getRegex:()=>new RegExp(n,t)};return s}function u(e){try{e=encodeURI(e).replace(/%25/g,"%")}catch{return null}return e}const k={exec:()=>null};function g(e,t){const n=e.replace(/\|/g,((e,t,n)=>{let s=!1,r=t;for(;--r>=0&&"\\"===n[r];)s=!s;return s?"|":" |"})).split(/ \|/);let s=0;if(n[0].trim()||n.shift(),n.length>0&&!n[n.length-1].trim()&&n.pop(),t)if(n.length>t)n.splice(t);else for(;n.length<t;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(/\\\|/g,"|");return n}function f(e,t,n){const s=e.length;if(0===s)return"";let r=0;for(;r<s;){const i=e.charAt(s-r-1);if(i!==t||n){if(i===t||!n)break;r++}else r++}return e.slice(0,s-r)}function d(e,t,n,s){const r=t.href,i=t.title?c(t.title):null,l=e[1].replace(/\\([\[\]])/g,"$1");if("!"!==e[0].charAt(0)){s.state.inLink=!0;const e={type:"link",raw:n,href:r,title:i,text:l,tokens:s.inlineTokens(l)};return s.state.inLink=!1,e}return{type:"image",raw:n,href:r,title:i,text:c(l)}}class x{options;rules;lexer;constructor(t){this.options=t||e.defaults}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(/^ {1,4}/gm,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:f(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],n=function(e,t){const n=e.match(/^(\s+)(?:```)/);if(null===n)return t;const s=n[1];return t.split("\n").map((e=>{const t=e.match(/^\s+/);if(null===t)return e;const[n]=t;return n.length>=s.length?e.slice(s.length):e})).join("\n")}(e,t[3]||"");return{type:"code",raw:e,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(/#$/.test(e)){const t=f(e,"#");this.options.pedantic?e=t.trim():t&&!/ $/.test(t)||(e=t.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:this.lexer.inline(e)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:f(t[0],"\n")}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){let e=f(t[0],"\n").split("\n"),n="",s="";const r=[];for(;e.length>0;){let t=!1;const i=[];let l;for(l=0;l<e.length;l++)if(/^ {0,3}>/.test(e[l]))i.push(e[l]),t=!0;else{if(t)break;i.push(e[l])}e=e.slice(l);const o=i.join("\n"),a=o.replace(/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,"\n    $1").replace(/^ {0,3}>[ \t]?/gm,"");n=n?`${n}\n${o}`:o,s=s?`${s}\n${a}`:a;const c=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(a,r,!0),this.lexer.state.top=c,0===e.length)break;const h=r[r.length-1];if("code"===h?.type)break;if("blockquote"===h?.type){const t=h,i=t.raw+"\n"+e.join("\n"),l=this.blockquote(i);r[r.length-1]=l,n=n.substring(0,n.length-t.raw.length)+l.raw,s=s.substring(0,s.length-t.text.length)+l.text;break}if("list"!==h?.type);else{const t=h,i=t.raw+"\n"+e.join("\n"),l=this.list(i);r[r.length-1]=l,n=n.substring(0,n.length-h.raw.length)+l.raw,s=s.substring(0,s.length-t.raw.length)+l.raw,e=i.substring(r[r.length-1].raw.length).split("\n")}}return{type:"blockquote",raw:n,tokens:r,text:s}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim();const s=n.length>1,r={type:"list",raw:"",ordered:s,start:s?+n.slice(0,-1):"",loose:!1,items:[]};n=s?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=s?n:"[*+-]");const i=new RegExp(`^( {0,3}${n})((?:[\t ][^\\n]*)?(?:\\n|$))`);let l=!1;for(;e;){let n=!1,s="",o="";if(!(t=i.exec(e)))break;if(this.rules.block.hr.test(e))break;s=t[0],e=e.substring(s.length);let a=t[2].split("\n",1)[0].replace(/^\t+/,(e=>" ".repeat(3*e.length))),c=e.split("\n",1)[0],h=!a.trim(),p=0;if(this.options.pedantic?(p=2,o=a.trimStart()):h?p=t[1].length+1:(p=t[2].search(/[^ ]/),p=p>4?1:p,o=a.slice(p),p+=t[1].length),h&&/^ *$/.test(c)&&(s+=c+"\n",e=e.substring(c.length+1),n=!0),!n){const t=new RegExp(`^ {0,${Math.min(3,p-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ \t][^\\n]*)?(?:\\n|$))`),n=new RegExp(`^ {0,${Math.min(3,p-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),r=new RegExp(`^ {0,${Math.min(3,p-1)}}(?:\`\`\`|~~~)`),i=new RegExp(`^ {0,${Math.min(3,p-1)}}#`);for(;e;){const l=e.split("\n",1)[0];if(c=l,this.options.pedantic&&(c=c.replace(/^ {1,4}(?=( {4})*[^ ])/g,"  ")),r.test(c))break;if(i.test(c))break;if(t.test(c))break;if(n.test(e))break;if(c.search(/[^ ]/)>=p||!c.trim())o+="\n"+c.slice(p);else{if(h)break;if(a.search(/[^ ]/)>=4)break;if(r.test(a))break;if(i.test(a))break;if(n.test(a))break;o+="\n"+c}h||c.trim()||(h=!0),s+=l+"\n",e=e.substring(l.length+1),a=c.slice(p)}}r.loose||(l?r.loose=!0:/\n *\n *$/.test(s)&&(l=!0));let u,k=null;this.options.gfm&&(k=/^\[[ xX]\] /.exec(o),k&&(u="[ ] "!==k[0],o=o.replace(/^\[[ xX]\] +/,""))),r.items.push({type:"list_item",raw:s,task:!!k,checked:u,loose:!1,text:o,tokens:[]}),r.raw+=s}r.items[r.items.length-1].raw=r.items[r.items.length-1].raw.trimEnd(),r.items[r.items.length-1].text=r.items[r.items.length-1].text.trimEnd(),r.raw=r.raw.trimEnd();for(let e=0;e<r.items.length;e++)if(this.lexer.state.top=!1,r.items[e].tokens=this.lexer.blockTokens(r.items[e].text,[]),!r.loose){const t=r.items[e].tokens.filter((e=>"space"===e.type)),n=t.length>0&&t.some((e=>/\n.*\n/.test(e.raw)));r.loose=n}if(r.loose)for(let e=0;e<r.items.length;e++)r.items[e].loose=!0;return r}}html(e){const t=this.rules.block.html.exec(e);if(t){return{type:"html",block:!0,raw:t[0],pre:"pre"===t[1]||"script"===t[1]||"style"===t[1],text:t[0]}}}def(e){const t=this.rules.block.def.exec(e);if(t){const e=t[1].toLowerCase().replace(/\s+/g," "),n=t[2]?t[2].replace(/^<(.*)>$/,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:e,raw:t[0],href:n,title:s}}}table(e){const t=this.rules.block.table.exec(e);if(!t)return;if(!/[:|]/.test(t[2]))return;const n=g(t[1]),s=t[2].replace(/^\||\| *$/g,"").split("|"),r=t[3]&&t[3].trim()?t[3].replace(/\n[ \t]*$/,"").split("\n"):[],i={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===s.length){for(const e of s)/^ *-+: *$/.test(e)?i.align.push("right"):/^ *:-+: *$/.test(e)?i.align.push("center"):/^ *:-+ *$/.test(e)?i.align.push("left"):i.align.push(null);for(let e=0;e<n.length;e++)i.header.push({text:n[e],tokens:this.lexer.inline(n[e]),header:!0,align:i.align[e]});for(const e of r)i.rows.push(g(e,i.header.length).map(((e,t)=>({text:e,tokens:this.lexer.inline(e),header:!1,align:i.align[t]}))));return i}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e="\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:e,tokens:this.lexer.inline(e)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:c(t[1])}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&/^<a /i.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&/^<\/a>/i.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&/^</.test(e)){if(!/>$/.test(e))return;const t=f(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;let n=0;for(let s=0;s<e.length;s++)if("\\"===e[s])s++;else if(e[s]===t[0])n++;else if(e[s]===t[1]&&(n--,n<0))return s;return-1}(t[2],"()");if(e>-1){const n=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,n).trim(),t[3]=""}}let n=t[2],s="";if(this.options.pedantic){const e=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(n);e&&(n=e[1],s=e[3])}else s=t[3]?t[3].slice(1,-1):"";return n=n.trim(),/^</.test(n)&&(n=this.options.pedantic&&!/>$/.test(e)?n.slice(1):n.slice(1,-1)),d(t,{href:n?n.replace(this.rules.inline.anyPunctuation,"$1"):n,title:s?s.replace(this.rules.inline.anyPunctuation,"$1"):s},t[0],this.lexer)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){const e=t[(n[2]||n[1]).replace(/\s+/g," ").toLowerCase()];if(!e){const e=n[0].charAt(0);return{type:"text",raw:e,text:e}}return d(n,e,n[0],this.lexer)}}emStrong(e,t,n=""){let s=this.rules.inline.emStrongLDelim.exec(e);if(!s)return;if(s[3]&&n.match(/[\p{L}\p{N}]/u))return;if(!(s[1]||s[2]||"")||!n||this.rules.inline.punctuation.exec(n)){const n=[...s[0]].length-1;let r,i,l=n,o=0;const a="*"===s[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(a.lastIndex=0,t=t.slice(-1*e.length+n);null!=(s=a.exec(t));){if(r=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!r)continue;if(i=[...r].length,s[3]||s[4]){l+=i;continue}if((s[5]||s[6])&&n%3&&!((n+i)%3)){o+=i;continue}if(l-=i,l>0)continue;i=Math.min(i,i+l+o);const t=[...s[0]][0].length,a=e.slice(0,n+s.index+t+i);if(Math.min(n,i)%2){const e=a.slice(1,-1);return{type:"em",raw:a,text:e,tokens:this.lexer.inlineTokens(e)}}const c=a.slice(2,-2);return{type:"strong",raw:a,text:c,tokens:this.lexer.inlineTokens(c)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(/\n/g," ");const n=/[^ ]/.test(e),s=/^ /.test(e)&&/ $/.test(e);return n&&s&&(e=e.substring(1,e.length-1)),e=c(e,!0),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){const t=this.rules.inline.autolink.exec(e);if(t){let e,n;return"@"===t[2]?(e=c(t[1]),n="mailto:"+e):(e=c(t[1]),n=e),{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let e,n;if("@"===t[2])e=c(t[0]),n="mailto:"+e;else{let s;do{s=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??""}while(s!==t[0]);e=c(t[0]),n="www."===t[1]?"http://"+t[0]:t[0]}return{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e){const t=this.rules.inline.text.exec(e);if(t){let e;return e=this.lexer.state.inRawBlock?t[0]:c(t[0]),{type:"text",raw:t[0],text:e}}}}const b=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,w=/(?:[*+-]|\d{1,9}[.)])/,m=p(/^(?!bull |blockCode|fences|blockquote|heading|html)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html))+?)\n {0,3}(=+|-+) *(?:\n+|$)/).replace(/bull/g,w).replace(/blockCode/g,/ {4}/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).getRegex(),y=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,$=/(?!\s*\])(?:\\.|[^\[\]\\])+/,z=p(/^ {0,3}\[(label)\]: *(?:\n *)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n *)?| *\n *)(title))? *(?:\n+|$)/).replace("label",$).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),T=p(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,w).getRegex(),R="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",_=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,A=p("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n *)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$))","i").replace("comment",_).replace("tag",R).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),S=p(y).replace("hr",b).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",R).getRegex(),I={blockquote:p(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",S).getRegex(),code:/^( {4}[^\n]+(?:\n(?: *(?:\n|$))*)?)+/,def:z,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:b,html:A,lheading:m,list:T,newline:/^(?: *(?:\n|$))+/,paragraph:S,table:k,text:/^[^\n]+/},E=p("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",b).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",R).getRegex(),q={...I,table:E,paragraph:p(y).replace("hr",b).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",E).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",R).getRegex()},Z={...I,html:p("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",_).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:k,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:p(y).replace("hr",b).replace("heading"," *#{1,6} *[^\n]").replace("lheading",m).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},P=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,L=/^( {2,}|\\)\n(?!\s*$)/,v="\\p{P}\\p{S}",Q=p(/^((?![*_])[\spunctuation])/,"u").replace(/punctuation/g,v).getRegex(),B=p(/^(?:\*+(?:((?!\*)[punct])|[^\s*]))|^_+(?:((?!_)[punct])|([^\s_]))/,"u").replace(/punct/g,v).getRegex(),M=p("^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)[punct](\\*+)(?=[\\s]|$)|[^punct\\s](\\*+)(?!\\*)(?=[punct\\s]|$)|(?!\\*)[punct\\s](\\*+)(?=[^punct\\s])|[\\s](\\*+)(?!\\*)(?=[punct])|(?!\\*)[punct](\\*+)(?!\\*)(?=[punct])|[^punct\\s](\\*+)(?=[^punct\\s])","gu").replace(/punct/g,v).getRegex(),O=p("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)[punct](_+)(?=[\\s]|$)|[^punct\\s](_+)(?!_)(?=[punct\\s]|$)|(?!_)[punct\\s](_+)(?=[^punct\\s])|[\\s](_+)(?!_)(?=[punct])|(?!_)[punct](_+)(?!_)(?=[punct])","gu").replace(/punct/g,v).getRegex(),j=p(/\\([punct])/,"gu").replace(/punct/g,v).getRegex(),D=p(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),C=p(_).replace("(?:--\x3e|$)","--\x3e").getRegex(),H=p("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",C).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),U=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,X=p(/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/).replace("label",U).replace("href",/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),F=p(/^!?\[(label)\]\[(ref)\]/).replace("label",U).replace("ref",$).getRegex(),N=p(/^!?\[(ref)\](?:\[\])?/).replace("ref",$).getRegex(),G={_backpedal:k,anyPunctuation:j,autolink:D,blockSkip:/\[[^[\]]*?\]\([^\(\)]*?\)|`[^`]*?`|<[^<>]*?>/g,br:L,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:k,emStrongLDelim:B,emStrongRDelimAst:M,emStrongRDelimUnd:O,escape:P,link:X,nolink:N,punctuation:Q,reflink:F,reflinkSearch:p("reflink|nolink(?!\\()","g").replace("reflink",F).replace("nolink",N).getRegex(),tag:H,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:k},J={...G,link:p(/^!?\[(label)\]\((.*?)\)/).replace("label",U).getRegex(),reflink:p(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",U).getRegex()},K={...G,escape:p(P).replace("])","~|])").getRegex(),url:p(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])([\s\S]*?[^\s~])\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},V={...K,br:p(L).replace("{2,}","*").getRegex(),text:p(K.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},W={normal:I,gfm:q,pedantic:Z},Y={normal:G,gfm:K,breaks:V,pedantic:J};class ee{tokens;options;state;tokenizer;inlineQueue;constructor(t){this.tokens=[],this.tokens.links=Object.create(null),this.options=t||e.defaults,this.options.tokenizer=this.options.tokenizer||new x,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const n={block:W.normal,inline:Y.normal};this.options.pedantic?(n.block=W.pedantic,n.inline=Y.pedantic):this.options.gfm&&(n.block=W.gfm,this.options.breaks?n.inline=Y.breaks:n.inline=Y.gfm),this.tokenizer.rules=n}static get rules(){return{block:W,inline:Y}}static lex(e,t){return new ee(t).lex(e)}static lexInline(e,t){return new ee(t).inlineTokens(e)}lex(e){e=e.replace(/\r\n|\r/g,"\n"),this.blockTokens(e,this.tokens);for(let e=0;e<this.inlineQueue.length;e++){const t=this.inlineQueue[e];this.inlineTokens(t.src,t.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){let s,r,i;for(e=this.options.pedantic?e.replace(/\t/g,"    ").replace(/^ +$/gm,""):e.replace(/^( *)(\t+)/gm,((e,t,n)=>t+"    ".repeat(n.length)));e;)if(!(this.options.extensions&&this.options.extensions.block&&this.options.extensions.block.some((n=>!!(s=n.call({lexer:this},e,t))&&(e=e.substring(s.raw.length),t.push(s),!0)))))if(s=this.tokenizer.space(e))e=e.substring(s.raw.length),1===s.raw.length&&t.length>0?t[t.length-1].raw+="\n":t.push(s);else if(s=this.tokenizer.code(e))e=e.substring(s.raw.length),r=t[t.length-1],!r||"paragraph"!==r.type&&"text"!==r.type?t.push(s):(r.raw+="\n"+s.raw,r.text+="\n"+s.text,this.inlineQueue[this.inlineQueue.length-1].src=r.text);else if(s=this.tokenizer.fences(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.heading(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.hr(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.blockquote(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.list(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.html(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.def(e))e=e.substring(s.raw.length),r=t[t.length-1],!r||"paragraph"!==r.type&&"text"!==r.type?this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title}):(r.raw+="\n"+s.raw,r.text+="\n"+s.raw,this.inlineQueue[this.inlineQueue.length-1].src=r.text);else if(s=this.tokenizer.table(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.lheading(e))e=e.substring(s.raw.length),t.push(s);else{if(i=e,this.options.extensions&&this.options.extensions.startBlock){let t=1/0;const n=e.slice(1);let s;this.options.extensions.startBlock.forEach((e=>{s=e.call({lexer:this},n),"number"==typeof s&&s>=0&&(t=Math.min(t,s))})),t<1/0&&t>=0&&(i=e.substring(0,t+1))}if(this.state.top&&(s=this.tokenizer.paragraph(i)))r=t[t.length-1],n&&"paragraph"===r?.type?(r.raw+="\n"+s.raw,r.text+="\n"+s.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=r.text):t.push(s),n=i.length!==e.length,e=e.substring(s.raw.length);else if(s=this.tokenizer.text(e))e=e.substring(s.raw.length),r=t[t.length-1],r&&"text"===r.type?(r.raw+="\n"+s.raw,r.text+="\n"+s.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=r.text):t.push(s);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n,s,r,i,l,o,a=e;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(i=this.tokenizer.rules.inline.reflinkSearch.exec(a));)e.includes(i[0].slice(i[0].lastIndexOf("[")+1,-1))&&(a=a.slice(0,i.index)+"["+"a".repeat(i[0].length-2)+"]"+a.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(i=this.tokenizer.rules.inline.blockSkip.exec(a));)a=a.slice(0,i.index)+"["+"a".repeat(i[0].length-2)+"]"+a.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;null!=(i=this.tokenizer.rules.inline.anyPunctuation.exec(a));)a=a.slice(0,i.index)+"++"+a.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;e;)if(l||(o=""),l=!1,!(this.options.extensions&&this.options.extensions.inline&&this.options.extensions.inline.some((s=>!!(n=s.call({lexer:this},e,t))&&(e=e.substring(n.raw.length),t.push(n),!0)))))if(n=this.tokenizer.escape(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.tag(e))e=e.substring(n.raw.length),s=t[t.length-1],s&&"text"===n.type&&"text"===s.type?(s.raw+=n.raw,s.text+=n.text):t.push(n);else if(n=this.tokenizer.link(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.reflink(e,this.tokens.links))e=e.substring(n.raw.length),s=t[t.length-1],s&&"text"===n.type&&"text"===s.type?(s.raw+=n.raw,s.text+=n.text):t.push(n);else if(n=this.tokenizer.emStrong(e,a,o))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.codespan(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.br(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.del(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.autolink(e))e=e.substring(n.raw.length),t.push(n);else if(this.state.inLink||!(n=this.tokenizer.url(e))){if(r=e,this.options.extensions&&this.options.extensions.startInline){let t=1/0;const n=e.slice(1);let s;this.options.extensions.startInline.forEach((e=>{s=e.call({lexer:this},n),"number"==typeof s&&s>=0&&(t=Math.min(t,s))})),t<1/0&&t>=0&&(r=e.substring(0,t+1))}if(n=this.tokenizer.inlineText(r))e=e.substring(n.raw.length),"_"!==n.raw.slice(-1)&&(o=n.raw.slice(-1)),l=!0,s=t[t.length-1],s&&"text"===s.type?(s.raw+=n.raw,s.text+=n.text):t.push(n);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}else e=e.substring(n.raw.length),t.push(n);return t}}class te{options;parser;constructor(t){this.options=t||e.defaults}space(e){return""}code({text:e,lang:t,escaped:n}){const s=(t||"").match(/^\S*/)?.[0],r=e.replace(/\n$/,"")+"\n";return s?'<pre><code class="language-'+c(s)+'">'+(n?r:c(r,!0))+"</code></pre>\n":"<pre><code>"+(n?r:c(r,!0))+"</code></pre>\n"}blockquote({tokens:e}){return`<blockquote>\n${this.parser.parse(e)}</blockquote>\n`}html({text:e}){return e}heading({tokens:e,depth:t}){return`<h${t}>${this.parser.parseInline(e)}</h${t}>\n`}hr(e){return"<hr>\n"}list(e){const t=e.ordered,n=e.start;let s="";for(let t=0;t<e.items.length;t++){const n=e.items[t];s+=this.listitem(n)}const r=t?"ol":"ul";return"<"+r+(t&&1!==n?' start="'+n+'"':"")+">\n"+s+"</"+r+">\n"}listitem(e){let t="";if(e.task){const n=this.checkbox({checked:!!e.checked});e.loose?e.tokens.length>0&&"paragraph"===e.tokens[0].type?(e.tokens[0].text=n+" "+e.tokens[0].text,e.tokens[0].tokens&&e.tokens[0].tokens.length>0&&"text"===e.tokens[0].tokens[0].type&&(e.tokens[0].tokens[0].text=n+" "+e.tokens[0].tokens[0].text)):e.tokens.unshift({type:"text",raw:n+" ",text:n+" "}):t+=n+" "}return t+=this.parser.parse(e.tokens,!!e.loose),`<li>${t}</li>\n`}checkbox({checked:e}){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>\n`}table(e){let t="",n="";for(let t=0;t<e.header.length;t++)n+=this.tablecell(e.header[t]);t+=this.tablerow({text:n});let s="";for(let t=0;t<e.rows.length;t++){const r=e.rows[t];n="";for(let e=0;e<r.length;e++)n+=this.tablecell(r[e]);s+=this.tablerow({text:n})}return s&&(s=`<tbody>${s}</tbody>`),"<table>\n<thead>\n"+t+"</thead>\n"+s+"</table>\n"}tablerow({text:e}){return`<tr>\n${e}</tr>\n`}tablecell(e){const t=this.parser.parseInline(e.tokens),n=e.header?"th":"td";return(e.align?`<${n} align="${e.align}">`:`<${n}>`)+t+`</${n}>\n`}strong({tokens:e}){return`<strong>${this.parser.parseInline(e)}</strong>`}em({tokens:e}){return`<em>${this.parser.parseInline(e)}</em>`}codespan({text:e}){return`<code>${e}</code>`}br(e){return"<br>"}del({tokens:e}){return`<del>${this.parser.parseInline(e)}</del>`}link({href:e,title:t,tokens:n}){const s=this.parser.parseInline(n),r=u(e);if(null===r)return s;let i='<a href="'+(e=r)+'"';return t&&(i+=' title="'+t+'"'),i+=">"+s+"</a>",i}image({href:e,title:t,text:n}){const s=u(e);if(null===s)return n;let r=`<img src="${e=s}" alt="${n}"`;return t&&(r+=` title="${t}"`),r+=">",r}text(e){return"tokens"in e&&e.tokens?this.parser.parseInline(e.tokens):e.text}}class ne{strong({text:e}){return e}em({text:e}){return e}codespan({text:e}){return e}del({text:e}){return e}html({text:e}){return e}text({text:e}){return e}link({text:e}){return""+e}image({text:e}){return""+e}br(){return""}}class se{options;renderer;textRenderer;constructor(t){this.options=t||e.defaults,this.options.renderer=this.options.renderer||new te,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new ne}static parse(e,t){return new se(t).parse(e)}static parseInline(e,t){return new se(t).parseInline(e)}parse(e,t=!0){let n="";for(let s=0;s<e.length;s++){const r=e[s];if(this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[r.type]){const e=r,t=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==t||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){n+=t||"";continue}}const i=r;switch(i.type){case"space":n+=this.renderer.space(i);continue;case"hr":n+=this.renderer.hr(i);continue;case"heading":n+=this.renderer.heading(i);continue;case"code":n+=this.renderer.code(i);continue;case"table":n+=this.renderer.table(i);continue;case"blockquote":n+=this.renderer.blockquote(i);continue;case"list":n+=this.renderer.list(i);continue;case"html":n+=this.renderer.html(i);continue;case"paragraph":n+=this.renderer.paragraph(i);continue;case"text":{let r=i,l=this.renderer.text(r);for(;s+1<e.length&&"text"===e[s+1].type;)r=e[++s],l+="\n"+this.renderer.text(r);n+=t?this.renderer.paragraph({type:"paragraph",raw:l,text:l,tokens:[{type:"text",raw:l,text:l}]}):l;continue}default:{const e='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}parseInline(e,t){t=t||this.renderer;let n="";for(let s=0;s<e.length;s++){const r=e[s];if(this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[r.type]){const e=this.options.extensions.renderers[r.type].call({parser:this},r);if(!1!==e||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(r.type)){n+=e||"";continue}}const i=r;switch(i.type){case"escape":case"text":n+=t.text(i);break;case"html":n+=t.html(i);break;case"link":n+=t.link(i);break;case"image":n+=t.image(i);break;case"strong":n+=t.strong(i);break;case"em":n+=t.em(i);break;case"codespan":n+=t.codespan(i);break;case"br":n+=t.br(i);break;case"del":n+=t.del(i);break;default:{const e='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}}class re{options;block;constructor(t){this.options=t||e.defaults}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}provideLexer(){return this.block?ee.lex:ee.lexInline}provideParser(){return this.block?se.parse:se.parseInline}}class ie{defaults={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=se;Renderer=te;TextRenderer=ne;Lexer=ee;Tokenizer=x;Hooks=re;constructor(...e){this.use(...e)}walkTokens(e,t){let n=[];for(const s of e)switch(n=n.concat(t.call(this,s)),s.type){case"table":{const e=s;for(const s of e.header)n=n.concat(this.walkTokens(s.tokens,t));for(const s of e.rows)for(const e of s)n=n.concat(this.walkTokens(e.tokens,t));break}case"list":{const e=s;n=n.concat(this.walkTokens(e.items,t));break}default:{const e=s;this.defaults.extensions?.childTokens?.[e.type]?this.defaults.extensions.childTokens[e.type].forEach((s=>{const r=e[s].flat(1/0);n=n.concat(this.walkTokens(r,t))})):e.tokens&&(n=n.concat(this.walkTokens(e.tokens,t)))}}return n}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach((e=>{const n={...e};if(n.async=this.defaults.async||n.async||!1,e.extensions&&(e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if("renderer"in e){const n=t.renderers[e.name];t.renderers[e.name]=n?function(...t){let s=e.renderer.apply(this,t);return!1===s&&(s=n.apply(this,t)),s}:e.renderer}if("tokenizer"in e){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");const n=t[e.level];n?n.unshift(e.tokenizer):t[e.level]=[e.tokenizer],e.start&&("block"===e.level?t.startBlock?t.startBlock.push(e.start):t.startBlock=[e.start]:"inline"===e.level&&(t.startInline?t.startInline.push(e.start):t.startInline=[e.start]))}"childTokens"in e&&e.childTokens&&(t.childTokens[e.name]=e.childTokens)})),n.extensions=t),e.renderer){const t=this.defaults.renderer||new te(this.defaults);for(const n in e.renderer){if(!(n in t))throw new Error(`renderer '${n}' does not exist`);if(["options","parser"].includes(n))continue;const s=n,r=e.renderer[s],i=t[s];t[s]=(...e)=>{let n=r.apply(t,e);return!1===n&&(n=i.apply(t,e)),n||""}}n.renderer=t}if(e.tokenizer){const t=this.defaults.tokenizer||new x(this.defaults);for(const n in e.tokenizer){if(!(n in t))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;const s=n,r=e.tokenizer[s],i=t[s];t[s]=(...e)=>{let n=r.apply(t,e);return!1===n&&(n=i.apply(t,e)),n}}n.tokenizer=t}if(e.hooks){const t=this.defaults.hooks||new re;for(const n in e.hooks){if(!(n in t))throw new Error(`hook '${n}' does not exist`);if(["options","block"].includes(n))continue;const s=n,r=e.hooks[s],i=t[s];re.passThroughHooks.has(n)?t[s]=e=>{if(this.defaults.async)return Promise.resolve(r.call(t,e)).then((e=>i.call(t,e)));const n=r.call(t,e);return i.call(t,n)}:t[s]=(...e)=>{let n=r.apply(t,e);return!1===n&&(n=i.apply(t,e)),n}}n.hooks=t}if(e.walkTokens){const t=this.defaults.walkTokens,s=e.walkTokens;n.walkTokens=function(e){let n=[];return n.push(s.call(this,e)),t&&(n=n.concat(t.call(this,e))),n}}this.defaults={...this.defaults,...n}})),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return ee.lex(e,t??this.defaults)}parser(e,t){return se.parse(e,t??this.defaults)}parseMarkdown(e){return(t,n)=>{const s={...n},r={...this.defaults,...s},i=this.onError(!!r.silent,!!r.async);if(!0===this.defaults.async&&!1===s.async)return i(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(null==t)return i(new Error("marked(): input parameter is undefined or null"));if("string"!=typeof t)return i(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));r.hooks&&(r.hooks.options=r,r.hooks.block=e);const l=r.hooks?r.hooks.provideLexer():e?ee.lex:ee.lexInline,o=r.hooks?r.hooks.provideParser():e?se.parse:se.parseInline;if(r.async)return Promise.resolve(r.hooks?r.hooks.preprocess(t):t).then((e=>l(e,r))).then((e=>r.hooks?r.hooks.processAllTokens(e):e)).then((e=>r.walkTokens?Promise.all(this.walkTokens(e,r.walkTokens)).then((()=>e)):e)).then((e=>o(e,r))).then((e=>r.hooks?r.hooks.postprocess(e):e)).catch(i);try{r.hooks&&(t=r.hooks.preprocess(t));let e=l(t,r);r.hooks&&(e=r.hooks.processAllTokens(e)),r.walkTokens&&this.walkTokens(e,r.walkTokens);let n=o(e,r);return r.hooks&&(n=r.hooks.postprocess(n)),n}catch(e){return i(e)}}}onError(e,t){return n=>{if(n.message+="\nPlease report this to https://github.com/markedjs/marked.",e){const e="<p>An error occurred:</p><pre>"+c(n.message+"",!0)+"</pre>";return t?Promise.resolve(e):e}if(t)return Promise.reject(n);throw n}}}const le=new ie;function oe(e,t){return le.parse(e,t)}oe.options=oe.setOptions=function(e){return le.setOptions(e),oe.defaults=le.defaults,n(oe.defaults),oe},oe.getDefaults=t,oe.defaults=e.defaults,oe.use=function(...e){return le.use(...e),oe.defaults=le.defaults,n(oe.defaults),oe},oe.walkTokens=function(e,t){return le.walkTokens(e,t)},oe.parseInline=le.parseInline,oe.Parser=se,oe.parser=se.parse,oe.Renderer=te,oe.TextRenderer=ne,oe.Lexer=ee,oe.lexer=ee.lex,oe.Tokenizer=x,oe.Hooks=re,oe.parse=oe;const ae=oe.options,ce=oe.setOptions,he=oe.use,pe=oe.walkTokens,ue=oe.parseInline,ke=oe,ge=se.parse,fe=ee.lex;e.Hooks=re,e.Lexer=ee,e.Marked=ie,e.Parser=se,e.Renderer=te,e.TextRenderer=ne,e.Tokenizer=x,e.getDefaults=t,e.lexer=fe,e.marked=oe,e.options=ae,e.parse=ke,e.parseInline=ue,e.parser=ge,e.setOptions=ce,e.use=he,e.walkTokens=pe}));
</script>
    <script>
const DATA = {"links":[{"source":"Insights-0xh","target":"Insights-4ud","type":"parent-child","critical":false},{"source":"Insights-1c8","target":"Insights-1kk","type":"blocks","critical":false},{"source":"Insights-3z3","target":"Insights-1kk","type":"blocks","critical":false},{"source":"Insights-43a.1","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.10","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.11","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.12","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.2","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.2","target":"Insights-43a.1","type":"blocks","critical":true},{"source":"Insights-43a.3","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.3","target":"Insights-43a.2","type":"blocks","critical":true},{"source":"Insights-43a.4","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.4","target":"Insights-43a.3","type":"blocks","critical":true},{"source":"Insights-43a.5","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.6","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.7","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.8","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-43a.9","target":"Insights-43a","type":"parent-child","critical":false},{"source":"Insights-4dl","target":"Insights-4ud","type":"parent-child","critical":false},{"source":"Insights-4ud.1","target":"Insights-4ud","type":"parent-child","critical":false},{"source":"Insights-7t1.1","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.1.1","target":"Insights-7t1.1","type":"parent-child","critical":false},{"source":"Insights-7t1.1.2","target":"Insights-7t1.1","type":"parent-child","critical":false},{"source":"Insights-7t1.1.3","target":"Insights-7t1.1","type":"parent-child","critical":false},{"source":"Insights-7t1.1.4","target":"Insights-7t1.1","type":"parent-child","critical":false},{"source":"Insights-7t1.2","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.2.1","target":"Insights-7t1.2","type":"parent-child","critical":false},{"source":"Insights-7t1.2.2","target":"Insights-7t1.2","type":"parent-child","critical":false},{"source":"Insights-7t1.2.3","target":"Insights-7t1.2","type":"parent-child","critical":false},{"source":"Insights-7t1.3","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.3","target":"Insights-7t1.2","type":"blocks","critical":true},{"source":"Insights-7t1.3","target":"Insights-7t1.1","type":"blocks","critical":true},{"source":"Insights-7t1.3.1","target":"Insights-7t1.3","type":"parent-child","critical":false},{"source":"Insights-7t1.3.2","target":"Insights-7t1.3","type":"parent-child","critical":false},{"source":"Insights-7t1.3.3","target":"Insights-7t1.3","type":"parent-child","critical":false},{"source":"Insights-7t1.4","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.4","target":"Insights-7t1.3","type":"blocks","critical":true},{"source":"Insights-7t1.4","target":"Insights-7t1.5","type":"blocks","critical":true},{"source":"Insights-7t1.4.1","target":"Insights-7t1.4","type":"parent-child","critical":false},{"source":"Insights-7t1.4.2","target":"Insights-7t1.4","type":"parent-child","critical":false},{"source":"Insights-7t1.4.3","target":"Insights-7t1.4","type":"parent-child","critical":false},{"source":"Insights-7t1.5","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.5","target":"Insights-7t1.2","type":"blocks","critical":true},{"source":"Insights-7t1.5","target":"Insights-7t1.1","type":"blocks","critical":true},{"source":"Insights-7t1.5.1","target":"Insights-7t1.5","type":"parent-child","critical":false},{"source":"Insights-7t1.5.2","target":"Insights-7t1.5","type":"parent-child","critical":false},{"source":"Insights-7t1.5.3","target":"Insights-7t1.5","type":"parent-child","critical":false},{"source":"Insights-7t1.6","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.6","target":"Insights-7t1.2","type":"blocks","critical":true},{"source":"Insights-7t1.6","target":"Insights-7t1.1","type":"blocks","critical":true},{"source":"Insights-7t1.6","target":"Insights-7t1.5","type":"blocks","critical":true},{"source":"Insights-7t1.6.1","target":"Insights-7t1.6","type":"parent-child","critical":false},{"source":"Insights-7t1.6.2","target":"Insights-7t1.6","type":"parent-child","critical":false},{"source":"Insights-7t1.6.3","target":"Insights-7t1.6","type":"parent-child","critical":false},{"source":"Insights-7t1.7","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.7","target":"Insights-7t1.6","type":"blocks","critical":true},{"source":"Insights-7t1.7.1","target":"Insights-7t1.7","type":"parent-child","critical":false},{"source":"Insights-7t1.7.2","target":"Insights-7t1.7","type":"parent-child","critical":false},{"source":"Insights-7t1.7.3","target":"Insights-7t1.7","type":"parent-child","critical":false},{"source":"Insights-7t1.8","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.8","target":"Insights-7t1.2","type":"blocks","critical":true},{"source":"Insights-7t1.8","target":"Insights-7t1.3","type":"blocks","critical":true},{"source":"Insights-7t1.8","target":"Insights-7t1.6","type":"blocks","critical":true},{"source":"Insights-7t1.8.1","target":"Insights-7t1.8","type":"parent-child","critical":false},{"source":"Insights-7t1.8.2","target":"Insights-7t1.8","type":"parent-child","critical":false},{"source":"Insights-7t1.9","target":"Insights-7t1","type":"parent-child","critical":false},{"source":"Insights-7t1.9","target":"Insights-7t1.4","type":"blocks","critical":true},{"source":"Insights-7t1.9","target":"Insights-7t1.5","type":"blocks","critical":true},{"source":"Insights-7t1.9","target":"Insights-7t1.6","type":"blocks","critical":true},{"source":"Insights-7t1.9.1","target":"Insights-7t1.9","type":"parent-child","critical":false},{"source":"Insights-7t1.9.2","target":"Insights-7t1.9","type":"parent-child","critical":false},{"source":"Insights-7t1.9.3","target":"Insights-7t1.9","type":"parent-child","critical":false},{"source":"Insights-7t1.9.4","target":"Insights-7t1.9","type":"parent-child","critical":false},{"source":"Insights-989.1","target":"Insights-989","type":"parent-child","critical":false},{"source":"Insights-989.2","target":"Insights-989","type":"parent-child","critical":false},{"source":"Insights-avd","target":"Insights-1kk","type":"blocks","critical":false},{"source":"Insights-b1i.1","target":"Insights-b1i","type":"parent-child","critical":false},{"source":"Insights-b1i.2","target":"Insights-b1i","type":"parent-child","critical":false},{"source":"Insights-b1i.2","target":"Insights-b1i.1","type":"blocks","critical":false},{"source":"Insights-b1i.3","target":"Insights-b1i","type":"parent-child","critical":false},{"source":"Insights-c01","target":"Insights-h5d","type":"blocks","critical":true},{"source":"Insights-c01","target":"Insights-z99","type":"blocks","critical":true},{"source":"Insights-cb9","target":"Insights-h5d","type":"blocks","critical":true},{"source":"Insights-cb9","target":"Insights-z99","type":"blocks","critical":true},{"source":"Insights-e1z","target":"Insights-4v2","type":"blocks","critical":false},{"source":"Insights-e1z","target":"Insights-mbx","type":"blocks","critical":false},{"source":"Insights-egk","target":"Insights-1kk","type":"blocks","critical":false},{"source":"Insights-hab.1","target":"Insights-hab","type":"parent-child","critical":false},{"source":"Insights-hab.2","target":"Insights-hab","type":"parent-child","critical":false},{"source":"Insights-hab.3","target":"Insights-hab","type":"parent-child","critical":false},{"source":"Insights-hab.3","target":"Insights-hab.1","type":"blocks","critical":false},{"source":"Insights-hab.3","target":"Insights-hab.2","type":"blocks","critical":false},{"source":"Insights-kwa.1","target":"Insights-kwa","type":"parent-child","critical":false},{"source":"Insights-kwa.2","target":"Insights-kwa","type":"parent-child","critical":false},{"source":"Insights-ky0.1","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.10","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.11","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.2","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.3","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.3","target":"Insights-ky0.1","type":"blocks","critical":false},{"source":"Insights-ky0.4","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.4","target":"Insights-ky0.1","type":"blocks","critical":false},{"source":"Insights-ky0.5","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.5","target":"Insights-ky0.2","type":"blocks","critical":false},{"source":"Insights-ky0.6","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.7","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.8","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-ky0.9","target":"Insights-ky0","type":"parent-child","critical":false},{"source":"Insights-l1k","target":"Insights-1kk","type":"blocks","critical":false},{"source":"Insights-m5s","target":"Insights-h5d","type":"blocks","critical":true},{"source":"Insights-m5x.1","target":"Insights-m5x","type":"parent-child","critical":false},{"source":"Insights-m5x.2","target":"Insights-m5x","type":"parent-child","critical":false},{"source":"Insights-m5x.3","target":"Insights-m5x","type":"parent-child","critical":false},{"source":"Insights-mbx","target":"Insights-4v2","type":"blocks","critical":false},{"source":"Insights-z99","target":"Insights-h5d","type":"blocks","critical":true},{"source":"Insights-z99","target":"Insights-m5s","type":"blocks","critical":true},{"source":"Insights-zfm","target":"Insights-h5d","type":"blocks","critical":false},{"source":"Insights-zfm","target":"Insights-m5s","type":"blocks","critical":false}],"nodes":[{"id":"Insights-0kt","title":"Desktop App","status":"open","priority":3,"type":"epic","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":21,"betweenness_rank":0},{"id":"Insights-0xh","title":"Personalized video invite workflow for surveys","description":"Enable sending personalized video invites to survey recipients.\n\n**User workflow desired**:\n1. Record a personal or generic video\n2. Select list of people - one video for 50+ people, or select by attribute (e.g., VP, founder)\n3. Send via chat or from contacts/people page (Actions \u003e Add to survey)\n\n**Inspiration**: Loom and Cap.so (https://cap.so/pricing) make it easy to personalize videos. Could address recipients by name in email and use a general video for most cases.\n\n**Note**: Recording individual videos per person is too tasking - focus on 'one video, many recipients' with personalized email text.","status":"open","priority":3,"type":"feature","labels":null,"created_at":"2026-01-23 14:28","updated_at":"2026-01-23 14:28","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":22,"betweenness_rank":0},{"id":"Insights-15s","title":"Capture leads in waitlist/signup form with marketing metrics","description":"Enable comprehensive marketing analytics and attribution tracking for survey/Ask link leads.\n\n## Goals\n- Track lead sources and attribution via UTM parameters\n- Provide conversion rate analytics (view ‚Üí start ‚Üí complete ‚Üí qualified)\n- Enable affiliate/referral tracking with reward mechanics\n- Correlate marketing data with interview responses and behaviors\n\n## Key Features\n\n### UTM \u0026 Attribution Tracking\n- Capture UTM parameters (source, medium, campaign, term, content) on survey visits\n- Track referrer URLs and landing pages\n- Store first-touch and last-touch attribution\n- UI to create/manage UTM links for campaigns\n\n### Analytics Dashboard\n- Lead source breakdown (organic, paid, referral, direct)\n- Conversion funnel visualization\n- Campaign performance comparison\n- Time-based trends\n\n### Referral/Affiliate Program\n- Generate unique referral codes per user\n- Track referral conversions\n- Reward mechanics (e.g., \"free week for referrer + referee\")\n- Referral leaderboard/stats\n\n### Data Enrichment\n- Correlate attribution data with:\n  - People/org profiles\n  - Interview responses\n  - Activation patterns\n  - Response quality scores\n\n## Technical Scope\n- Schema: New tables for attribution events, referral codes, rewards\n- API: Endpoints for UTM link generation, referral tracking\n- UI: Campaign manager, analytics dashboard, referral settings\n- Integration: Connect to existing research_link_responses and people tables","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-01-24 13:20","updated_at":"2026-01-24 13:20","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":23,"betweenness_rank":0},{"id":"Insights-1c8","title":"Foundation: Session \u0026 page view tracking","description":"Implement session_started event, feature_viewed tracking, and lifecycle stage calculation. Week 1-2 foundation work.","notes":"Extends existing PostHog tracking (signup_complete in login_success.tsx). Add session_started, feature_viewed, lifecycle_stage calculation.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-25 18:10","updated_at":"2026-01-25 19:56","closed_at":"2026-01-25 19:56","blocked_by":["Insights-1kk"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":5.1444853089702216e-8,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":24,"betweenness_rank":0},{"id":"Insights-1kk","title":"PLG Instrumentation \u0026 Control","description":"Comprehensive server-side PostHog event capture for PLG optimization. Implement behavioral triggers, cohort definitions, and automated interventions. See docs/60-ops-observability/plg-instrumentation-plan.md","status":"closed","priority":1,"type":"epic","labels":null,"created_at":"2026-01-25 18:10","updated_at":"2026-01-25 19:44","closed_at":"2026-01-25 19:44","blocks":["Insights-1c8","Insights-3z3","Insights-avd","Insights-egk","Insights-l1k"],"pagerank":0.02973522149370556,"betweenness":0,"eigenvector":0,"hub":0,"authority":1.4257958182552767e-7,"critical_path":2,"in_degree":5,"out_degree":0,"core_number":1,"slack":2,"is_articulation":true,"pagerank_rank":1,"betweenness_rank":0},{"id":"Insights-379","title":"Capture URL parameters on survey responses","description":"## Problem\nWhen users open survey links (direct or embedded), we don't capture URL parameters like UTM tracking, custom embed params, or source attribution. This data is valuable for understanding where responses come from.\n\n## Current State\n- Only `email` and `responseId` URL params are captured\n- `app/utils/utm.ts` exists with UTM extraction utilities (used for PostHog signup attribution)\n- `research_link_responses` table has no metadata column\n\n## Solution\n\n### 1. Add metadata column to `research_link_responses`\n```sql\nALTER TABLE research_link_responses \nADD COLUMN metadata JSONB DEFAULT '{}';\n```\n\n### 2. Capture URL params on survey load\nReuse `extractUtmParamsFromSearch()` from `app/utils/utm.ts` plus custom params:\n- All UTM params (utm_source, utm_medium, utm_campaign, etc.)\n- gclid, fbclid (ad click IDs)\n- document.referrer\n- Any custom params passed by embed code\n\n### 3. Pass metadata in start request\nInclude in POST to `api.research-links.$slug.start.tsx`\n\n### 4. Preserve through embed redirect\nEmbed currently redirects with `?email=...\u0026responseId=...`. Either:\n- Forward all original params, OR\n- Store metadata on response creation (before redirect)\n\n## Files to modify\n- `supabase/schemas/18_research_links.sql` - add metadata column\n- `app/routes/research.$slug.tsx` - capture params\n- `app/routes/embed.$slug.tsx` - capture params before redirect\n- `app/routes/api.research-links.$slug.start.tsx` - store metadata","status":"open","priority":3,"type":"feature","labels":null,"created_at":"2026-01-30 22:24","updated_at":"2026-01-31 14:30","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":25,"betweenness_rank":0},{"id":"Insights-3vd","title":"Research competitor: Frill.co - pricing, marketing, and content strategy","description":"Research Frill.co (https://frill.co/) as a competitor and generate actionable recommendations.\n\n## Research Areas\n1. **Pricing Analysis**: Compare Frill's pricing tiers/model to UpSight's current pricing\n2. **Marketing Home Page**: Analyze their messaging, feature presentation, and CTAs\n3. **Survey Component**: How do they position feedback/survey features? Use insights to elevate UpSight's survey component\n4. **Feature Presentation**: How do they explain features upfront? Suggest improvements for UpSight\n\n## Deliverables\n- Add Frill.co to competitor docs list\n- Pricing recommendations compared to current UpSight pricing\n- Home page copy/structure suggestions to better explain features\n- 2-3 content piece ideas (video demos, blog posts) for marketing\n- Specific suggestions to elevate the survey component messaging","notes":"Completed Frill.co competitive analysis. Created comprehensive doc at docs/competitive/frill.md covering: (1) Product overview and positioning - feedback boards, roadmaps, announcements; (2) Pricing analysis - -349/mo tiers vs UpSight's free-/mo; (3) Marketing recommendations - clarify value prop, elevate survey component, add social proof, improve feature explanations; (4) Content marketing ideas - 3 pieces: competitor comparison guide, survey AI demo video, evidence-based decisions playbook. Key insight: Frill competes on simplicity and public-facing features, but can't match UpSight's conversation intelligence and evidence traceability.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-27 11:32","updated_at":"2026-01-27 13:09","closed_at":"2026-01-27 13:09","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":26,"betweenness_rank":0},{"id":"Insights-3z3","title":"Computed properties: User metrics scheduled job","description":"Create Trigger.dev scheduled task to calculate lifecycle_stage, is_activated, is_power_user, days_since_last_activity properties.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-25 18:10","updated_at":"2026-01-26 02:21","closed_at":"2026-01-26 02:21","blocked_by":["Insights-1kk"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":5.1444853089702216e-8,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":27,"betweenness_rank":0},{"id":"Insights-43a","title":"Agentic Strategy Implementation","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":28,"betweenness_rank":0},{"id":"Insights-43a.1","title":"Create assessProjectState tool","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","blocks":["Insights-43a.2"],"pagerank":0.018048547261799667,"betweenness":0,"eigenvector":0.13483997249264842,"hub":0,"authority":1.9595988512575926e-33,"critical_path":4,"in_degree":1,"out_degree":0,"core_number":1,"slack":0,"is_articulation":false,"pagerank_rank":5,"betweenness_rank":0},{"id":"Insights-43a.10","title":"Track user decisions and outcomes","status":"open","priority":4,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":29,"betweenness_rank":0},{"id":"Insights-43a.11","title":"Learn from patterns across users","status":"open","priority":4,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":30,"betweenness_rank":0},{"id":"Insights-43a.12","title":"Personalize recommendations","status":"open","priority":4,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":31,"betweenness_rank":0},{"id":"Insights-43a.2","title":"Create recommendNextActions tool/workflow","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","blocked_by":["Insights-43a.1"],"blocks":["Insights-43a.3"],"pagerank":0.014570231074647607,"betweenness":2,"eigenvector":0,"hub":7.070526770169462e-34,"authority":1.9595988512575926e-33,"critical_path":3,"in_degree":1,"out_degree":1,"core_number":1,"slack":0,"is_articulation":true,"pagerank_rank":8,"betweenness_rank":2},{"id":"Insights-43a.3","title":"Enhance Uppy instructions for state-aware responses","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","blocked_by":["Insights-43a.2"],"blocks":["Insights-43a.4"],"pagerank":0.010478125945660437,"betweenness":2,"eigenvector":0,"hub":7.070526770169462e-34,"authority":1.9595988512575926e-33,"critical_path":2,"in_degree":1,"out_degree":1,"core_number":1,"slack":0,"is_articulation":true,"pagerank_rank":12,"betweenness_rank":3},{"id":"Insights-43a.4","title":"Create createSurveyFromRecommendation tool","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","blocked_by":["Insights-43a.3"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":7.070526770169462e-34,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":0,"is_articulation":false,"pagerank_rank":32,"betweenness_rank":0},{"id":"Insights-43a.5","title":"Create findTargetUsers tool","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":33,"betweenness_rank":0},{"id":"Insights-43a.6","title":"Create generateMarketingInsights tool","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":34,"betweenness_rank":0},{"id":"Insights-43a.7","title":"Add scheduled state assessments","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":35,"betweenness_rank":0},{"id":"Insights-43a.8","title":"Surface recommendations in UI (not just chat)","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":36,"betweenness_rank":0},{"id":"Insights-43a.9","title":"Implement notification triggers","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":37,"betweenness_rank":0},{"id":"Insights-4dl","title":"Support voice/video responses in surveys","description":"Users want to send quick voice or video responses instead of typing.\n\n**User feedback**: 'Add voice audio and video responses up front, because some might just want to send back a quick answer that way.'\n\nThis would lower friction for respondents who prefer speaking over typing.","status":"open","priority":2,"type":"feature","labels":null,"created_at":"2026-01-23 14:28","updated_at":"2026-01-23 14:28","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":38,"betweenness_rank":0},{"id":"Insights-4g6","title":"Fix upsert-person tool SQL error and agent performance","description":"## Problem\nThe upsert-person Mastra tool has a critical SQL error that causes repeated failures:\n\n```\nERROR upsert-person: error creating/updating person { code: '42703',\n  message: 'column \"COALESCE\" does not exist' }\n```\n\nThe agent retries the same failing operation multiple times without detecting the error pattern, causing:\n- 3+ minute execution times for simple tasks\n- Wasted API calls and compute\n- Poor user experience\n\n## Root Cause\nThe SQL query is incorrectly using COALESCE - likely a syntax issue where COALESCE is being treated as a column name instead of a function.\n\n## Required Fixes\n\n### 1. Fix SQL syntax in upsert-person tool\n- Review and fix the COALESCE usage in the upsert query\n- Ensure proper SQL function syntax\n\n### 2. Improve error handling\n- Tool should return clear error messages on failure\n- Agent should detect repeated tool failures and stop retrying\n- Add max retry logic with exponential backoff\n\n### 3. Optimize agent flow\n- Create person record quickly first (basic info only)\n- Then do research and augment in background\n- Don't block on enrichment\n\n## Relevant Files\n- `app/mastra/tools/upsert-person.ts` - the failing tool\n- Agent that calls this tool (project-setup-agent or similar)\n\n## Logs\nMultiple failures over 2+ minutes:\n- 18:48:36 - first error\n- 18:48:41 - retry\n- 18:49:08 - retry\n- 18:50:15 - retry (still failing)\n- 18:50:45 - agent finally moved on to web research","status":"closed","priority":1,"type":"bug","labels":null,"created_at":"2026-01-26 10:57","updated_at":"2026-01-26 11:00","closed_at":"2026-01-26 11:00","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":39,"betweenness_rank":0},{"id":"Insights-4iz","title":"Auto-generate walkthrough thumbnails for email embeds","status":"closed","priority":2,"type":"feature","labels":null,"created_at":"2026-01-23 11:32","updated_at":"2026-01-23 11:32","closed_at":"2026-01-23 11:32","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":40,"betweenness_rank":0},{"id":"Insights-4oj","title":"Simplify onboarding chat options","description":"User feedback: Onboarding chat was hard to know which option to pick.\n\n**Suggestion**: Give fewer options, focus more on guiding the user through the flow rather than presenting many choices upfront.\n\nNote: User loved the suggestions feature ('Really good') - keep that working well.","status":"open","priority":1,"type":"task","labels":null,"created_at":"2026-01-23 14:28","updated_at":"2026-01-31 14:30","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":41,"betweenness_rank":0},{"id":"Insights-4ud","title":"Surveys \u0026 Video Outreach","description":"End-to-end survey creation, personalization, and distribution system.\n\n**Core capabilities**:\n- Survey builder with multiple question types\n- Voice/video response collection\n- Personalized video invites (Loom-style hyper-personalization with dynamic titles and audio clips)\n- Dynamic audience selection - filter and group people by attributes (role, company, tags, etc.) for targeted distribution\n- Multi-channel delivery (email, chat, embed)\n\n**Key workflows**:\n1. Create survey from scratch or AI recommendations\n2. Record one video, personalize for many recipients\n3. Dynamically select audience by attributes (e.g., all VPs, all founders, people tagged 'beta')\n4. Send and track responses","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-01-24 19:59","updated_at":"2026-01-24 19:59","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":42,"betweenness_rank":0},{"id":"Insights-4ud.1","title":"Dynamic audience selection for survey distribution","description":"Filter and group people dynamically by attributes for targeted survey distribution.\n\n**Selection criteria**:\n- Role/title (VP, Founder, PM, etc.)\n- Company/organization\n- Tags and labels\n- Custom attributes\n- Previous survey responses\n- Engagement level\n\n**UX**:\n- Build audience with filter chips (e.g., 'Role: VP' + 'Tag: beta-user')\n- Preview audience count before sending\n- Save audience as reusable segment\n- Select from People page: Actions \u003e Add to survey","status":"open","priority":2,"type":"feature","labels":null,"created_at":"2026-01-24 20:00","updated_at":"2026-01-24 20:00","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":43,"betweenness_rank":0},{"id":"Insights-4v2","title":"Document Gen-UI Threads v1 spec + API contract","description":"Spec + API contract for Gen-UI Threads v1 now at docs/20-features-prds/features/onboarding/gen-ui-threads-v1.md","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 17:27","updated_at":"2026-02-02 17:31","closed_at":"2026-02-02 17:31","blocks":["Insights-e1z","Insights-mbx"],"pagerank":0.014931315453659662,"betweenness":0,"eigenvector":0,"hub":0,"authority":4.1376637332533346e-18,"critical_path":3,"in_degree":2,"out_degree":0,"core_number":2,"slack":1,"is_articulation":false,"pagerank_rank":7,"betweenness_rank":0},{"id":"Insights-5q6","title":"PROD: Switch plan buttons do nothing on billing page","description":"**Critical production issue**\n\nURL: /a/{account_id}/billing?error=billing_not_configured\n\n**Symptoms**:\n- 'Switch plan' buttons do nothing when clicked\n- URL has error param: billing_not_configured\n- User arrived via 'View Plans' banner\n\n**To investigate**:\n- Why is billing_not_configured being set?\n- Why are switch plan buttons not working?","status":"closed","priority":0,"type":"bug","labels":null,"created_at":"2026-01-24 21:02","updated_at":"2026-01-24 22:24","closed_at":"2026-01-24 22:24","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":44,"betweenness_rank":0},{"id":"Insights-5ur","title":"Create Polar discount codes for launch","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 14:03","updated_at":"2026-01-23 14:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":45,"betweenness_rank":0},{"id":"Insights-63u","title":"Fix CORS for Pica AuthKit integration","description":"Fixed CORS preflight handling for Pica AuthKit OAuth flow. Vite dev server was intercepting OPTIONS requests before Hono. Added server.cors config to vite.config.ts.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-22 09:41","updated_at":"2026-01-22 09:42","closed_at":"2026-01-22 09:42","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":46,"betweenness_rank":0},{"id":"Insights-659","title":"Bug: Invited users cannot create teams due to incorrect quota counting","description":"## Problem Summary\nWhen a user is invited to a team before having an account, the invite flow has multiple issues:\n1. Team quota counts ALL teams user is member of (including invited teams), not just OWNED teams\n2. Trial may not be provisioned if user lands in invited team context first\n3. User ends up blocked from creating their own team\n\n## Root Cause Analysis\n\n### Issue 1: Team Quota Counting (Confirmed Bug)\n**File:** `app/routes/api.teams.create.tsx` lines 121-123\n\n```typescript\n// BUG: Counts all teams, not just owned ones\nconst teamCount = accounts?.filter((a) =\u003e \n  !(a.accounts as { personal_account?: boolean })?.personal_account\n).length ?? 0\n```\n\nThis counts teams where user is a MEMBER. Should count teams where user is PRIMARY OWNER.\n\n**Impact:**\n- User signs up ‚Üí gets 1 owned team (from trigger)\n- User accepts invite ‚Üí now member of 2 teams\n- teamCount = 2, but they only OWN 1 team\n- Free/Starter/Pro plans have teams: 0-1, so they get blocked\n\n### Issue 2: Trial Provisioning Logic\n**File:** `app/routes/_ProtectedLayout.tsx` lines 247-314\n\nThe trial provisioning correctly looks for owned teams:\n```typescript\nconst ownedTeamAccount = (user.accounts || []).find(\n  (acc: any) =\u003e !acc.personal_account \u0026\u0026 acc.is_primary_owner\n)\n```\n\nBut it only provisions if:\n- User has no `legacy_trial_provisioned_at` flag\n- Owned team has no existing subscription\n\n**Potential Issue:** If user never visits their OWN account context (always stays in invited team), trial may never be provisioned to their owned account.\n\n### Issue 3: Database Trigger\n**File:** `supabase/schemas/02_accounts.sql` function `run_new_user_setup()`\n\nThe trigger SHOULD create both personal and team accounts. Need to verify:\n- Is the team account actually being created?\n- Is `account_user` junction record created correctly?\n\n## Flows Comparison\n\n### Normal Signup (No Invite)\n1. User signs up ‚Üí `on_auth_user_created` trigger fires\n2. Creates: personal account, team account, account_user entries\n3. User visits protected page ‚Üí trial provisioned to owned team\n4. User on free plan but with trial = can use features\n\n### Invite Signup (Current Broken Flow)\n1. User clicks invite link ‚Üí redirected to signup\n2. User signs up ‚Üí trigger creates accounts\n3. User redirected to `/accept-invite?token=...`\n4. Invite accepted ‚Üí user added to INVITED team\n5. User lands in invited team context\n6. Trial check runs but user may not get trial provisioned correctly\n7. Team quota check counts invited team ‚Üí user blocked\n\n## Solution\n\n### Fix 1: Team Quota Counting (CRITICAL)\nChange `checkTeamCreationLimit()` to count only OWNED teams:\n\n```typescript\n// Get accounts where user is primary owner\nconst { data: ownedAccounts } = await supabaseAdmin\n  .from(\"accounts\")\n  .select(\"id, personal_account\")\n  .eq(\"primary_owner_user_id\", userId)\n\nconst ownedTeamCount = ownedAccounts?.filter(a =\u003e !a.personal_account).length ?? 0\n```\n\n### Fix 2: Ensure Trial Provisioning\nAfter invite acceptance, ensure user visits their own account to trigger trial provisioning. OR provision trial during invite acceptance if user doesn't have one.\n\n### Fix 3: Audit Signup Trigger\nVerify the trigger reliably creates both accounts. Add error logging if team creation fails.\n\n## Files to Modify\n- `app/routes/api.teams.create.tsx` - Fix quota counting\n- `app/routes/accept-invite.tsx` - Consider provisioning trial here\n- `supabase/schemas/02_accounts.sql` - Add error handling to trigger\n\n## Acceptance Criteria\n- [ ] Team quota counts only OWNED teams, not all memberships\n- [ ] Invited users can create their own team\n- [ ] Invited users receive trial on their owned team\n- [ ] Normal signup flow unchanged\n- [ ] Add tests for invite flow","status":"closed","priority":1,"type":"bug","labels":null,"created_at":"2026-01-30 22:33","updated_at":"2026-01-30 22:39","closed_at":"2026-01-30 22:39","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":47,"betweenness_rank":0},{"id":"Insights-6aj","title":"Add email linked preview snippet to survey embed tab","description":"Provide an email-safe linked preview code snippet in the survey embed tab.","notes":"Email preview option already present in EmbedCodeGenerator; no additional changes required.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-21 12:35","updated_at":"2026-01-21 16:51","closed_at":"2026-01-21 16:51","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":48,"betweenness_rank":0},{"id":"Insights-6oj","title":"Auto-generate walkthrough thumbnail for email embed","description":"Generate thumbnails for walkthrough videos and auto-populate the email preview thumbnail field.","status":"in_progress","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 01:35","updated_at":"2026-01-23 01:35","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":49,"betweenness_rank":0},{"id":"Insights-6py","title":"Record Live does not show prompts on screen","description":"When clicking 'Record Live' from the questions page, the prompts/interview questions are not displayed on screen during recording. Users need to see their prompts while conducting live interviews.","status":"open","priority":2,"type":"bug","labels":null,"created_at":"2026-01-26 18:05","updated_at":"2026-01-26 18:05","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":50,"betweenness_rank":0},{"id":"Insights-78c","title":"Track interview share link creation","description":"Add server-side PostHog tracking when user creates a share link from interview detail page.\n\n**Event**: interview_shared\n**Properties**: interview_id, project_id, account_id, share_type (link/pdf/etc)\n**Location**: Find the share link creation endpoint/action","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 00:07","updated_at":"2026-01-26 01:06","closed_at":"2026-01-26 01:06","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":51,"betweenness_rank":0},{"id":"Insights-7mk","title":"update home page marketing to accentuate AI-native CRM","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 00:53","updated_at":"2026-01-25 19:01","closed_at":"2026-01-25 19:01","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":52,"betweenness_rank":0},{"id":"Insights-7t1","title":"UpSight event-sourced UI + artifact orchestration","description":"# UpSight event-sourced UI + artifact orchestration\n\n## Why / outcome\nBuild a robust, event-sourced UI system that keeps chat, canvas artifacts, and agent-driven updates in sync with strict ordering, validated artifacts, and realtime delivery. This codifies the A2UI/AG-UI approach so the orchestrator can safely create and update UI artifacts while the frontend stays responsive and deterministic.\n\n## Non-negotiables (invariants)\n1) Events are append-only; no upsert-as-event.\n2) State is derived; ui_state is materialized from events.\n3) Ordering is explicit; monotonic seq per thread_id.\n4) Artifacts are declarative (A2UI); UI spec separate from data model.\n5) State sync uses snapshot + JSON Patch deltas (RFC 6902).\n6) Agent output is validated by allowlist before persistence/render.\n\n## Architecture diagram (Mermaid)\n```mermaid\nflowchart LR\n  subgraph Frontend\n    Chat[Chat Panel\\n(useChat)]\n    Canvas[Canvas Panel]\n    A1[Artifact v1]\n    A2[Artifact v2]\n    A3[Artifact v3 (active)]\n    Canvas --\u003e A1\n    Canvas --\u003e A2\n    Canvas --\u003e A3\n  end\n\n  Realtime[Supabase Realtime]\n  Chat \u003c--\u003e Realtime\n  Canvas \u003c--\u003e Realtime\n\n  subgraph Backend\n    ApiChat[/api/chat/]\n    ApiArtifacts[/api/artifacts (CRUD)/]\n    ApiUIState[/api/ui-state (CRUD)/]\n\n    subgraph Supabase\n      Threads[(threads)]\n      Messages[(messages)]\n      Artifacts[(artifacts)]\n      UIEvents[(ui_events)]\n      UIState[(ui_state)]\n      ThreadSeq[(thread_seq)]\n    end\n\n    Orchestrator[Orchestrator Agent\\n(subscribes to ui_events)]\n\n    ApiChat --\u003e Messages\n    ApiArtifacts --\u003e Artifacts\n    ApiUIState --\u003e UIState\n    UIEvents --\u003e UIState\n    ThreadSeq --\u003e UIEvents\n    Orchestrator --\u003e Artifacts\n    Orchestrator --\u003e Messages\n  end\n\n  Realtime \u003c---\u003e ApiChat\n  Realtime \u003c---\u003e ApiArtifacts\n  Realtime \u003c---\u003e ApiUIState\n  Realtime \u003c---\u003e Supabase\n```\n\n## Execution plan (robust + executable)\nPhase order is strict and matches implementation dependencies:\n1) DB migrations + RLS + realtime replication settings\n2) /api/ui-events with seq + idempotency (client_event_id)\n3) UI event emitter (never writes ui_state directly)\n4) UI realtime subscribers + canvas renderer\n5) A2UI artifact persistence + allowlist validation\n6) AG-UI snapshot/delta endpoints + JSON Patch apply\n7) Mastra orchestrator reads events, writes messages + artifacts\n8) Trigger.dev jobs for heavy workflows + retries\n9) Observability: trace_id everywhere (event -\u003e orchestrator -\u003e artifact -\u003e job)\n\n## Definition of done\n- ui_events is append-only, ordered by per-thread seq.\n- ui_state is derived and reconciles via snapshot + delta.\n- Artifacts use A2UI + validated capabilities allowlist.\n- Orchestrator reads ui_events inserts and writes artifacts/messages.\n- Frontend stays synced via realtime subscriptions.\n- Traceability from event -\u003e decision -\u003e artifact -\u003e job is measurable.\n\n## Original input (verbatim context)\nRecommended Architecture for UpSight\n\n  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n  ‚îÇ                           Frontend                                   ‚îÇ\n  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ\n  ‚îÇ  ‚îÇ Chat Panel  ‚îÇ  ‚îÇ            Canvas Panel                      ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ (messages)  ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ  ‚îÇArtifact ‚îÇ ‚îÇArtifact ‚îÇ ‚îÇArtifact ‚îÇ       ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ  useChat()  ‚îÇ  ‚îÇ  ‚îÇ   v3    ‚îÇ ‚îÇ   v1    ‚îÇ ‚îÇ   v2    ‚îÇ       ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ       ‚îÇ ‚Üê active artifact                   ‚îÇ  ‚îÇ\n  ‚îÇ         ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ\n  ‚îÇ         ‚îÇ                 ‚îÇ                                         ‚îÇ\n  ‚îÇ  Supabase Realtime ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ\n  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îò\n            ‚îÇ                                                        ‚îÇ\n            ‚ñº                                                        ‚îÇ\n  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n  ‚îÇ                           Backend                                    ‚îÇ\n  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n  ‚îÇ                                                                      ‚îÇ\n  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ\n  ‚îÇ  ‚îÇ /api/chat    ‚îÇ    ‚îÇ/api/artifacts‚îÇ    ‚îÇ /api/ui-state‚îÇ          ‚îÇ\n  ‚îÇ  ‚îÇ              ‚îÇ    ‚îÇ    (CRUD)    ‚îÇ    ‚îÇ   (CRUD)     ‚îÇ          ‚îÇ\n  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ\n  ‚îÇ         ‚îÇ                   ‚îÇ                    ‚îÇ                   ‚îÇ\n  ‚îÇ         ‚ñº                   ‚ñº                    ‚ñº                   ‚îÇ\n  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ\n  ‚îÇ  ‚îÇ                      Supabase                                ‚îÇ   ‚îÇ\n  ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ   ‚îÇ\n  ‚îÇ  ‚îÇ  ‚îÇ threads  ‚îÇ  ‚îÇ messages ‚îÇ  ‚îÇ artifacts‚îÇ  ‚îÇ ui_state ‚îÇ    ‚îÇ   ‚îÇ\n  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   ‚îÇ\n  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ\n  ‚îÇ         ‚ñ≤                   ‚ñ≤                    ‚ñ≤                   ‚îÇ\n  ‚îÇ         ‚îÇ                   ‚îÇ                    ‚îÇ                   ‚îÇ\n  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ\n  ‚îÇ  ‚îÇ                    Orchestrator Agent                         ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ  ‚Ä¢ Observes ui_state changes (Supabase subscription)         ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ  ‚Ä¢ Decides: respond? suggest? wait?                          ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ  ‚Ä¢ Creates/updates artifacts                                  ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îÇ  ‚Ä¢ Delegates to specialist agents                            ‚îÇ  ‚îÇ\n  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ\n  ‚îÇ                                                                      ‚îÇ\n  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n\n## Implementation plan for coding agent\n\n### 0) Non-negotiables (invariants)\n\n1. Events are append-only. Never ‚Äúupsert as event.‚Äù\n2. State is derived. ui_state is a materialized view of events (or computed updates), not a trigger source.\n3. Ordering is explicit. Every event has a monotonic seq per thread_id.\n4. Artifacts are declarative (A2UI). Store UI spec + data model separately. (A2UI)\n5. State sync uses snapshot + JSON Patch deltas (RFC 6902). (AG-UI)\n6. Agent output is validated by allowlist (capabilities gate) before persistence/render.\n\n---\n\n## 1) Repo structure (clear boundaries)\n\n/apps/web                 # UI renderer + event emitter\n/apps/api                 # HTTP API (ingest events, artifacts, state sync)\n/packages/protocols       # A2UI + AG-UI types, validators, JSON Patch helpers\n/packages/db              # migrations, typed queries\n/packages/agents          # Mastra orchestrator + specialist agents\n/packages/jobs            # trigger.dev tasks (async workflows)\n\n---\n\n## 2) Database (Supabase/Postgres) ‚Äî tables + indices\n\n### 2.1 Tables\n\nA) ui_events (append-only)\n- purpose: canonical ‚Äúwhat happened‚Äù\n- orchestrator subscribes to inserts\n\nB) ui_state (materialized)\n- purpose: fast load + reconciliation\n- updated by API (transactionally) when events ingested\n\nC) artifacts (versioned A2UI documents)\n- store A2UI UI spec (a2ui_doc) + separate data model (data_model)\n\nD) thread_seq (monotonic counter)\n- ensures per-thread seq increments in a single transaction\n\n### 2.2 RLS + Realtime\n- Enable Postgres Changes + subscribe by thread_id for the user‚Äôs threads. (Supabase)\n- Realtime subscriptions should listen to ui_events INSERT (and artifacts INSERT/UPDATE for UI refresh). (Supabase)\n\n---\n\n## 3) Protocol objects + validation (BAML + TS validators)\n\n### 3.1 A2UI artifacts\n- a2ui_doc: declarative component tree / surface\n- data_model: values/bindings (no executable code)\n- capabilities_snapshot: client renderer allowlist (what is permitted)\n\nUse A2UI spec as the source of truth. (A2UI)\n\n### 3.2 AG-UI state sync\n- STATE_SNAPSHOT: full state (load / big jumps) (AG-UI)\n- STATE_DELTA: JSON Patch ops (RFC 6902) (IETF)\n\n### 3.3 Validation rule\nOn every agent-produced artifact or delta:\n1. Validate JSON structure (schema)\n2. Validate against capabilities allowlist\n3. Reject or sanitize unknown components / actions\n\n---\n\n## 4) API contracts (make it impossible to misuse)\n\n### 4.1 POST /api/ui-events\nInput:\n- thread_id\n- client_event_id (uuid)\n- event_type (enum)\n- path (string JSON pointer-ish)\n- value (json)\n- artifact_id?\n- actor = \"user\"\n- ts_client\n\nServer does, in one DB transaction:\n1. get+increment thread_seq\n2. insert into ui_events with seq\n3. update ui_state (optional, deterministic)\n4. return { seq, server_ts }\n\n### 4.2 GET /api/state-snapshot?thread_id=...\nReturns:\n- latest ui_state (or computed)\n- last known seq\n- active artifact pointer(s)\n\n### 4.3 PATCH /api/state-delta\nInput:\n- base_seq\n- patch (RFC 6902 ops)\nServer:\n- verify base_seq matches (or reject + require snapshot)\n- apply patch (strict)\n- persist new state + seq\n\n---\n\n## 5) Realtime wiring (Supabase)\n\n### 5.1 UI listens to:\n- ui_events (agent events + system events)\n- artifacts changes (update canvas)\n\n### 5.2 Orchestrator listens to:\n- ui_events INSERT for a thread (not ui_state)\n\n---\n\n## 6) Orchestrator (Mastra) ‚Äî hot path vs async\n\n### 6.1 Hot path (fast, cheap)\n- Debounce events (250‚Äì750ms window)\n- Collapse into a single ‚Äúmeaningful change‚Äù\n- Decide: respond now / wait / enqueue background job\n\n### 6.2 Async path (Trigger.dev)\nUse Trigger.dev for:\n- long extraction, summarization, enrichment\n- multi-step workflows with retries and observability\n\n---\n\n## 7) ‚ÄúWOW‚Äù UI features (buildable in this system)\n1. Ghost preview artifact (agent proposes; user accepts -\u003e new artifact version)\n2. Artifact diff view (A2UI doc tree diff between versions)\n3. Timeline scrubber (replay ui_events by seq for demos/debug)\n4. Focus mode (orchestrator suppresses low-priority suggestions while typing)\n\n---\n\n## 8) Implementation order (strict)\n1. DB migrations + RLS + Realtime replication settings\n2. /api/ui-events with seq + idempotency (client_event_id)\n3. UI event emitter (only calls /api/ui-events, never writes ui_state directly)\n4. UI realtime subscribers + canvas renderer\n5. A2UI artifact persistence + allowlist validation\n6. AG-UI snapshot/delta endpoints + JSON Patch apply (RFC 6902)\n7. Mastra orchestrator reads events, writes messages + artifacts\n8. Trigger.dev jobs for heavy workflows + retries\n9. Observability: trace_id everywhere (event -\u003e orchestrator -\u003e artifact -\u003e job)\n\n---\n\n# Appendix: sample code (copy/paste templates)\n\n## A) SQL migrations (core tables)\n\n-- 1) thread_seq: monotonic per thread\ncreate table if not exists thread_seq (\n  thread_id uuid primary key,\n  next_seq  bigint not null default 1\n);\n\n-- 2) ui_events: append-only\ncreate table if not exists ui_events (\n  id uuid primary key default gen_random_uuid(),\n  thread_id uuid not null references threads(id),\n  seq bigint not null,\n  client_event_id uuid not null,\n  event_type text not null,\n  path text not null,\n  value jsonb,\n  artifact_id uuid references artifacts(id),\n  actor text not null check (actor in ('user','agent','system')),\n  trace_id uuid,\n  created_at timestamptz not null default now(),\n  unique(thread_id, seq),\n  unique(thread_id, client_event_id)\n);\n\ncreate index if not exists ui_events_thread_seq_idx\n  on ui_events(thread_id, seq desc);\n\n-- 3) ui_state: materialized latest values\ncreate table if not exists ui_state (\n  thread_id uuid not null references threads(id),\n  state_key text not null,\n  state_value jsonb not null,\n  updated_by text not null check (updated_by in ('user','agent','system')),\n  updated_at timestamptz not null default now(),\n  seq bigint not null,\n  primary key(thread_id, state_key)\n);\n\ncreate index if not exists ui_state_thread_idx on ui_state(thread_id);\n\n-- 4) artifacts: A2UI doc + data model + versions\ncreate table if not exists artifacts (\n  id uuid primary key default gen_random_uuid(),\n  thread_id uuid not null references threads(id),\n  artifact_type text not null,\n  version int not null default 1,\n  parent_id uuid references artifacts(id),\n  status text not null default 'active' check (status in ('draft','active','archived','deleted')),\n  created_by text not null check (created_by in ('user','agent','system')),\n\n  a2ui_doc jsonb not null,\n  data_model jsonb not null,\n  capabilities_snapshot jsonb not null,\n\n  etag text not null,\n  created_at timestamptz not null default now()\n);\n\ncreate index if not exists artifacts_thread_type_created_idx\n  on artifacts(thread_id, artifact_type, created_at desc);\n\n## B) /api/ui-events handler (atomic seq + idempotency)\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\n\nconst Input = z.object({\n  thread_id: z.string().uuid(),\n  client_event_id: z.string().uuid(),\n  event_type: z.string().min(1),\n  path: z.string().min(1),\n  value: z.unknown().optional(),\n  artifact_id: z.string().uuid().optional(),\n  ts_client: z.number().optional(),\n});\n\nexport async function postUiEvents(req: Request) {\n  const body = Input.parse(await req.json());\n\n  const supabase = createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!);\n\n  // Use a Postgres function for transaction + locking (recommended).\n  // This inline version is shown for clarity; implement as RPC for real.\n  const { data, error } = await supabase.rpc(\"ingest_ui_event\", {\n    p_thread_id: body.thread_id,\n    p_client_event_id: body.client_event_id,\n    p_event_type: body.event_type,\n    p_path: body.path,\n    p_value: body.value ?? null,\n    p_artifact_id: body.artifact_id ?? null,\n    p_actor: \"user\",\n  });\n\n  if (error) return new Response(JSON.stringify({ error: error.message }), { status: 400 });\n\n  return new Response(JSON.stringify(data), { status: 200 });\n}\n\n## C) Postgres RPC ingest_ui_event (true single-transaction)\n\ncreate or replace function ingest_ui_event(\n  p_thread_id uuid,\n  p_client_event_id uuid,\n  p_event_type text,\n  p_path text,\n  p_value jsonb,\n  p_artifact_id uuid,\n  p_actor text\n) returns jsonb\nlanguage plpgsql\nas $$\ndeclare\n  v_seq bigint;\nbegin\n  insert into thread_seq(thread_id) values (p_thread_id)\n  on conflict (thread_id) do nothing;\n\n  update thread_seq\n    set next_seq = next_seq + 1\n    where thread_id = p_thread_id\n    returning (next_seq - 1) into v_seq;\n\n  -- idempotent: if client_event_id already exists, return existing seq\n  begin\n    insert into ui_events(thread_id, seq, client_event_id, event_type, path, value, artifact_id, actor)\n    values (p_thread_id, v_seq, p_client_event_id, p_event_type, p_path, p_value, p_artifact_id, p_actor);\n  exception when unique_violation then\n    select seq into v_seq\n      from ui_events\n      where thread_id = p_thread_id and client_event_id = p_client_event_id;\n  end;\n\n  -- optional deterministic materialization example (simple key/value)\n  insert into ui_state(thread_id, state_key, state_value, updated_by, seq)\n  values (p_thread_id, p_path, coalesce(p_value,'{}'::jsonb), p_actor, v_seq)\n  on conflict (thread_id, state_key) do update\n    set state_value = excluded.state_value,\n        updated_by = excluded.updated_by,\n        updated_at = now(),\n        seq = excluded.seq;\n\n  return jsonb_build_object('seq', v_seq, 'server_ts', now());\nend;\n$$;\n\n## D) Supabase Realtime subscription (UI)\n\nconst channel = supabase\n  .channel(`thread:${threadId}`)\n  .on(\n    \"postgres_changes\",\n    { event: \"INSERT\", schema: \"public\", table: \"ui_events\", filter: `thread_id=eq.${threadId}` },\n    (payload) =\u003e {\n      // apply incoming agent/system events to local store\n      onUiEvent(payload.new);\n    }\n  )\n  .on(\n    \"postgres_changes\",\n    { event: \"*\", schema: \"public\", table: \"artifacts\", filter: `thread_id=eq.${threadId}` },\n    (payload) =\u003e {\n      onArtifactChange(payload);\n    }\n  )\n  .subscribe();\n\n## E) JSON Patch apply (AG-UI delta)\n\nimport { applyPatch, Operation } from \"fast-json-patch\"; // example lib\n\nexport function applyStateDelta\u003cT\u003e(state: T, patch: Operation[]): T {\n  const res = applyPatch(structuredClone(state), patch, /*validate*/ true);\n  return res.newDocument as T;\n}\n\n## F) Mastra orchestrator skeleton (event -\u003e decision -\u003e artifact)\n\nimport { Agent } from \"@mastra/core\"; // adjust to actual Mastra package structure you use\n\nexport const orchestrator = new Agent({\n  name: \"orchestrator\",\n  // model, tools, memory config...\n});\n\nexport async function onDebouncedEvents(threadId: string, events: any[]) {\n  // 1) summarize events (cheap deterministic)\n  // 2) ask orchestrator for decision\n  const decision = await orchestrator.run({\n    input: { threadId, events },\n  });\n\n  // 3) if decision includes artifact update:\n  //    - validate against capabilities allowlist\n  //    - write artifact row + broadcast via realtime\n}\n\n## G) Trigger.dev job template (heavy workflows)\n\nimport { task } from \"@trigger.dev/sdk\";\n\nexport const enrichThreadTask = task({\n  id: \"enrich-thread\",\n  retry: { maxAttempts: 5 },\n  run: async (payload: { threadId: string }) =\u003e {\n    // long-running: extraction, summarization, etc.\n    // write results back as artifacts or messages\n    return { ok: true };\n  },\n});\n\nConfidence: 0.86 (plan is explicit + failure-mode resistant; minor adjustments needed once you pick exact Mastra/BAML package APIs and your chosen JSON Patch library).\n\nReferences:\n- https://a2ui.org/specification/v0.8-a2ui/\n- https://docs.ag-ui.com/concepts/state\n- https://supabase.com/docs/guides/realtime/postgres-changes\n- https://datatracker.ietf.org/doc/html/rfc6902\n- https://mastra.ai/docs/agents/overview\n- https://trigger.dev/docs/introduction\n- https://supabase.com/partners/integrations/triggerdotdev\n","status":"closed","priority":1,"type":"epic","labels":null,"created_at":"2026-02-02 00:31","updated_at":"2026-02-02 01:26","closed_at":"2026-02-02 01:26","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":53,"betweenness_rank":0},{"id":"Insights-7t1.1","title":"Protocols + validators (A2UI/AG-UI/JSON Patch)","description":"Define protocol types and validators for A2UI artifacts and AG-UI state sync in /packages/protocols. Include strict JSON Patch validation and capabilities allowlist checks.","acceptance_criteria":"- A2UI artifact types/schemas exist for a2ui_doc, data_model, capabilities_snapshot.\n- AG-UI snapshot and delta types/schemas exist (STATE_SNAPSHOT and STATE_DELTA).\n- JSON Patch helper applies with validation and returns structured errors.\n- Capabilities allowlist validator rejects unknown components/actions.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:54","closed_at":"2026-02-02 00:54","blocks":["Insights-7t1.3","Insights-7t1.5","Insights-7t1.6"],"pagerank":0.01999429908071182,"betweenness":0,"eigenvector":0.674199862463242,"hub":0,"authority":0.5072685398773468,"critical_path":4,"in_degree":3,"out_degree":0,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":4,"betweenness_rank":0},{"id":"Insights-7t1.1.1","title":"Define A2UI artifact schemas/types","description":"Add TS types and schema validators for a2ui_doc, data_model, and capabilities_snapshot in /packages/protocols.","acceptance_criteria":"- Schemas validate structural requirements for A2UI artifacts.\n- Types are exported for API and agent use.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:54","closed_at":"2026-02-02 00:54","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":54,"betweenness_rank":0},{"id":"Insights-7t1.1.2","title":"Define AG-UI snapshot/delta schemas/types","description":"Add TS types and schema validators for STATE_SNAPSHOT and STATE_DELTA payloads (RFC 6902 ops) in /packages/protocols.","acceptance_criteria":"- Snapshot and delta schemas validate required fields.\n- Types are exported for API and agent use.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:54","closed_at":"2026-02-02 00:54","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":55,"betweenness_rank":0},{"id":"Insights-7t1.1.3","title":"Implement JSON Patch helper + validation","description":"Implement a JSON Patch apply helper with strict validation and structured error reporting in /packages/protocols.","acceptance_criteria":"- Patch apply rejects invalid ops and bad paths.\n- Errors include op index and reason.\n- Helper is used by state-delta API.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:54","closed_at":"2026-02-02 00:54","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":56,"betweenness_rank":0},{"id":"Insights-7t1.1.4","title":"Implement capabilities allowlist validator","description":"Add allowlist-based validation for components/actions before artifacts or deltas are persisted/rendered.","acceptance_criteria":"- Unknown components/actions are rejected or sanitized.\n- Validator returns explicit error details for logging.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:54","closed_at":"2026-02-02 00:54","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":57,"betweenness_rank":0},{"id":"Insights-7t1.2","title":"Database + Realtime foundation (Supabase)","description":"Create core tables, indices, RPC, and realtime configuration for ui_events, ui_state, artifacts, and thread_seq.","acceptance_criteria":"- Migrations add ui_events, ui_state, artifacts, thread_seq with indexes.\n- ingest_ui_event RPC exists and enforces seq/idempotency.\n- RLS policies and realtime publication are configured for ui_events and artifacts.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:49","closed_at":"2026-02-02 00:49","blocks":["Insights-7t1.3","Insights-7t1.5","Insights-7t1.6","Insights-7t1.8"],"pagerank":0.02159905704304891,"betweenness":0,"eigenvector":0.674199862463242,"hub":0,"authority":0.6629910866865841,"critical_path":4,"in_degree":4,"out_degree":0,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":3,"betweenness_rank":0},{"id":"Insights-7t1.2.1","title":"Create core migrations + indexes","description":"Add SQL migrations for ui_events, ui_state, artifacts, thread_seq and required indexes in /packages/db.","acceptance_criteria":"- Migrations create tables and indexes exactly as specified.\n- Migrations are idempotent and run cleanly.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:49","closed_at":"2026-02-02 00:49","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":58,"betweenness_rank":0},{"id":"Insights-7t1.2.2","title":"Implement ingest_ui_event RPC","description":"Create Postgres RPC ingest_ui_event to atomically increment seq, insert ui_events, and materialize ui_state with idempotency.","acceptance_criteria":"- RPC increments seq per thread in a single transaction.\n- Duplicate client_event_id returns existing seq.\n- ui_state materialization is deterministic.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:32","updated_at":"2026-02-02 00:49","closed_at":"2026-02-02 00:49","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":59,"betweenness_rank":0},{"id":"Insights-7t1.2.3","title":"Configure RLS + realtime publication","description":"Enable RLS and configure realtime publication for ui_events and artifacts with thread_id filtering.","acceptance_criteria":"- RLS policies are defined for user access by thread_id.\n- Postgres Changes is enabled for ui_events and artifacts tables.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 00:49","closed_at":"2026-02-02 00:49","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":60,"betweenness_rank":0},{"id":"Insights-7t1.3","title":"API endpoints for ui-events + state sync","description":"Implement POST /api/ui-events, GET /api/state-snapshot, and PATCH /api/state-delta with strict validation and seq enforcement.","acceptance_criteria":"- POST /api/ui-events uses ingest_ui_event RPC and returns seq + server_ts.\n- GET /api/state-snapshot returns ui_state + last seq + active artifact pointer(s).\n- PATCH /api/state-delta validates base_seq and applies JSON Patch strictly.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:00","closed_at":"2026-02-02 01:00","blocked_by":["Insights-7t1.2","Insights-7t1.1"],"blocks":["Insights-7t1.4","Insights-7t1.8"],"pagerank":0.010357764485989752,"betweenness":1.5,"eigenvector":0,"hub":0.4222472376098119,"authority":0.2367564950092941,"critical_path":3,"in_degree":2,"out_degree":2,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":16,"betweenness_rank":6},{"id":"Insights-7t1.3.1","title":"Implement POST /api/ui-events","description":"Create ui-events ingest endpoint with idempotency, validation, and RPC call.","acceptance_criteria":"- Validates input payload.\n- Uses ingest_ui_event RPC in a single transaction.\n- Returns seq + server_ts and handles duplicate client_event_id.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:00","closed_at":"2026-02-02 01:00","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":61,"betweenness_rank":0},{"id":"Insights-7t1.3.2","title":"Implement GET /api/state-snapshot","description":"Create snapshot endpoint returning ui_state, last seq, and active artifact pointers.","acceptance_criteria":"- Response includes state, last_seq, and active artifact ids.\n- Handles missing state with empty snapshot + seq 0.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:00","closed_at":"2026-02-02 01:00","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":62,"betweenness_rank":0},{"id":"Insights-7t1.3.3","title":"Implement PATCH /api/state-delta","description":"Apply validated JSON Patch deltas with base_seq checks and strict error handling.","acceptance_criteria":"- Rejects when base_seq mismatches.\n- Applies patch via protocol helper with validation.\n- Persists new state and seq.","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:00","closed_at":"2026-02-02 01:00","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":63,"betweenness_rank":0},{"id":"Insights-7t1.4","title":"Frontend event emission + realtime sync","description":"Wire frontend to emit ui-events and subscribe to realtime changes for ui_events and artifacts; render active artifact in canvas.","acceptance_criteria":"- UI emits only /api/ui-events (no direct ui_state writes).\n- Realtime subscription updates local state from ui_events and artifacts.\n- Canvas renders active artifact selection deterministically.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:15","closed_at":"2026-02-02 01:15","blocked_by":["Insights-7t1.3","Insights-7t1.5"],"blocks":["Insights-7t1.9"],"pagerank":0.00726861002098625,"betweenness":1,"eigenvector":0,"hub":0.22458696482999158,"authority":0.10208931789162878,"critical_path":2,"in_degree":1,"out_degree":2,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":20,"betweenness_rank":7},{"id":"Insights-7t1.4.1","title":"Add UI event emitter to /api/ui-events","description":"Emit user UI events with client_event_id, path, value, and ts_client.","acceptance_criteria":"- Each UI action sends a ui-event payload.\n- client_event_id is generated per event.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:15","closed_at":"2026-02-02 01:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":64,"betweenness_rank":0},{"id":"Insights-7t1.4.2","title":"Subscribe to realtime ui_events + artifacts","description":"Subscribe to Supabase Realtime for ui_events INSERT and artifacts changes filtered by thread_id.","acceptance_criteria":"- UI state updates in response to ui_events inserts.\n- Canvas refreshes on artifact INSERT/UPDATE.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:15","closed_at":"2026-02-02 01:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":65,"betweenness_rank":0},{"id":"Insights-7t1.4.3","title":"Render active artifact in canvas","description":"Select active artifact deterministically and render in canvas panel with versioning support.","acceptance_criteria":"- Active artifact is computed from state or event stream.\n- Canvas renders latest active artifact version without race conditions.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:15","closed_at":"2026-02-02 01:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":66,"betweenness_rank":0},{"id":"Insights-7t1.5","title":"Artifacts CRUD + validation gate","description":"Implement artifact CRUD with versioning and validate A2UI docs against capabilities allowlist before persistence and render.","acceptance_criteria":"- /api/artifacts supports create/read/update/archive with versioning.\n- Artifacts store a2ui_doc, data_model, capabilities_snapshot.\n- Validation gate blocks unknown components/actions.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:33","updated_at":"2026-02-02 01:03","closed_at":"2026-02-02 01:03","blocked_by":["Insights-7t1.2","Insights-7t1.1"],"blocks":["Insights-7t1.4","Insights-7t1.6","Insights-7t1.9"],"pagerank":0.01423591418665305,"betweenness":2,"eigenvector":0,"hub":0.4222472376098119,"authority":0.3856870266602134,"critical_path":3,"in_degree":3,"out_degree":2,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":9,"betweenness_rank":4},{"id":"Insights-7t1.5.1","title":"Implement /api/artifacts CRUD","description":"Add artifacts endpoints with versioning, parent_id, status transitions (draft/active/archived).","acceptance_criteria":"- Create/read/update endpoints exist.\n- Version increments and parent_id are preserved.\n- Status transitions are enforced.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:03","closed_at":"2026-02-02 01:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":67,"betweenness_rank":0},{"id":"Insights-7t1.5.2","title":"Persist A2UI doc + data_model + capabilities","description":"Ensure artifacts store a2ui_doc, data_model, and capabilities_snapshot fields with etag handling.","acceptance_criteria":"- Artifact records include A2UI doc, data model, and capabilities snapshot.\n- etag is generated and persisted.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:03","closed_at":"2026-02-02 01:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":68,"betweenness_rank":0},{"id":"Insights-7t1.5.3","title":"Enforce validation gate before persistence/render","description":"Run capabilities allowlist validator on all agent-produced artifacts and deltas before persistence or UI render.","acceptance_criteria":"- Invalid artifacts are rejected or sanitized.\n- Validation errors are logged with trace_id.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:03","closed_at":"2026-02-02 01:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":69,"betweenness_rank":0},{"id":"Insights-7t1.6","title":"Orchestrator hot path (Mastra)","description":"Implement Mastra orchestrator to subscribe to ui_events inserts, debounce, decide actions, and write artifacts/messages.","acceptance_criteria":"- Orchestrator subscribes to ui_events inserts by thread.\n- Debounce window collapses events into a single decision input.\n- Outputs messages/artifacts with validation + trace_id.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:07","closed_at":"2026-02-02 01:07","blocked_by":["Insights-7t1.2","Insights-7t1.1","Insights-7t1.5"],"blocks":["Insights-7t1.7","Insights-7t1.8","Insights-7t1.9"],"pagerank":0.013687641870334624,"betweenness":5.5,"eigenvector":0,"hub":0.5614089055786421,"authority":0.2963991271253353,"critical_path":2,"in_degree":3,"out_degree":3,"core_number":3,"slack":0,"is_articulation":true,"pagerank_rank":10,"betweenness_rank":1},{"id":"Insights-7t1.6.1","title":"Subscribe to ui_events + debounce","description":"Listen to ui_events INSERT and debounce (250-750ms) to produce a summarized event batch.","acceptance_criteria":"- Subscription uses thread_id filters.\n- Debounce consolidates bursts into one batch.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:07","closed_at":"2026-02-02 01:07","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":70,"betweenness_rank":0},{"id":"Insights-7t1.6.2","title":"Implement decision policy (respond/suggest/queue)","description":"Add orchestrator decision logic to respond immediately, suggest, or enqueue async work.","acceptance_criteria":"- Decision output is deterministic for identical inputs.\n- Each outcome is logged with trace_id and reason.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:07","closed_at":"2026-02-02 01:07","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":71,"betweenness_rank":0},{"id":"Insights-7t1.6.3","title":"Persist orchestrator outputs with trace_id","description":"Write messages and artifacts from orchestrator with trace_id and validation gate.","acceptance_criteria":"- Artifacts/messages include trace_id.\n- Validation gate runs before persistence.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:07","closed_at":"2026-02-02 01:07","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":72,"betweenness_rank":0},{"id":"Insights-7t1.7","title":"Async workflows (Trigger.dev)","description":"Implement Trigger.dev jobs for heavy workflows with retries and observability.","acceptance_criteria":"- Job skeletons exist in /packages/jobs.\n- Orchestrator can enqueue jobs with payloads.\n- Retry policy and logging are configured.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:20","closed_at":"2026-02-02 01:20","blocked_by":["Insights-7t1.6"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0.10694525370075662,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":0,"is_articulation":false,"pagerank_rank":73,"betweenness_rank":0},{"id":"Insights-7t1.7.1","title":"Create Trigger.dev job skeletons","description":"Add baseline Trigger.dev tasks for enrichment/summarization workflows.","acceptance_criteria":"- At least one job task exists with typed payload.\n- Job can run locally in dev environment.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:20","closed_at":"2026-02-02 01:20","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":74,"betweenness_rank":0},{"id":"Insights-7t1.7.2","title":"Wire orchestrator to enqueue jobs","description":"Add enqueue logic from orchestrator decision output to Trigger.dev tasks.","acceptance_criteria":"- Orchestrator can enqueue with threadId payload.\n- Job run IDs are logged with trace_id.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:34","updated_at":"2026-02-02 01:20","closed_at":"2026-02-02 01:20","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":75,"betweenness_rank":0},{"id":"Insights-7t1.7.3","title":"Configure retries + observability for jobs","description":"Set retry policy and ensure logs/trace_id are attached to Trigger.dev runs.","acceptance_criteria":"- Retry policy defined (max attempts, backoff).\n- Job logs include trace_id and thread_id.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:20","closed_at":"2026-02-02 01:20","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":76,"betweenness_rank":0},{"id":"Insights-7t1.8","title":"Observability + trace propagation","description":"Ensure trace_id is propagated across events, state changes, artifacts, and jobs; add basic audit trails for replay/debug.","acceptance_criteria":"- trace_id flows from ui_events to artifacts/messages and jobs.\n- Logs include thread_id, seq, and trace_id.\n- Basic audit trail supports event replay/diagnostics.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:18","closed_at":"2026-02-02 01:18","blocked_by":["Insights-7t1.2","Insights-7t1.3","Insights-7t1.6"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0.43158768542566106,"authority":0,"critical_path":1,"in_degree":0,"out_degree":3,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":77,"betweenness_rank":0},{"id":"Insights-7t1.8.1","title":"Propagate trace_id across records","description":"Add trace_id fields and ensure they are set in ui_events, artifacts, messages, and jobs.","acceptance_criteria":"- trace_id present in all relevant DB records.\n- Logs emit trace_id consistently.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:18","closed_at":"2026-02-02 01:18","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":78,"betweenness_rank":0},{"id":"Insights-7t1.8.2","title":"Add event replay helper","description":"Implement a minimal API or script to replay ui_events by seq for diagnostics.","acceptance_criteria":"- Can fetch ui_events by thread_id and replay in seq order.\n- Used for debugging timeline issues.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:18","closed_at":"2026-02-02 01:18","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":79,"betweenness_rank":0},{"id":"Insights-7t1.9","title":"WOW UI features (ghost preview, diff, timeline, focus)","description":"Implement user-facing features enabled by the event/artifact system: ghost preview, artifact diff view, timeline scrubber, and focus mode.","acceptance_criteria":"- Ghost preview allows propose/accept artifact versions.\n- Artifact diff view shows A2UI tree deltas.\n- Timeline scrubber replays ui_events by seq.\n- Focus mode suppresses low-priority suggestions while typing.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:26","closed_at":"2026-02-02 01:26","blocked_by":["Insights-7t1.4","Insights-7t1.5","Insights-7t1.6"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0.28294227981637604,"authority":0,"critical_path":1,"in_degree":0,"out_degree":3,"core_number":3,"slack":0,"is_articulation":false,"pagerank_rank":80,"betweenness_rank":0},{"id":"Insights-7t1.9.1","title":"Ghost preview artifact flow","description":"Implement propose/accept flow for ghost preview artifacts with versioning.","acceptance_criteria":"- Agent can create a draft artifact.\n- User can accept to create a new active version.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:26","closed_at":"2026-02-02 01:26","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":81,"betweenness_rank":0},{"id":"Insights-7t1.9.2","title":"Artifact diff view","description":"Build diff view for A2UI doc tree between artifact versions.","acceptance_criteria":"- Diff highlights added/removed/changed nodes.\n- Works for adjacent versions and selected pairs.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:26","closed_at":"2026-02-02 01:26","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":82,"betweenness_rank":0},{"id":"Insights-7t1.9.3","title":"Timeline scrubber UI","description":"Add UI to scrub through ui_events by seq and replay state/artifacts.","acceptance_criteria":"- Timeline slider replays events deterministically.\n- Uses snapshot + delta reconciliation.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:24","closed_at":"2026-02-02 01:24","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":83,"betweenness_rank":0},{"id":"Insights-7t1.9.4","title":"Focus mode for suggestions","description":"Suppress low-priority orchestrator suggestions while user is actively typing.","acceptance_criteria":"- Typing activity disables low-priority suggestions.\n- Suggestions resume after idle window.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-02-02 00:35","updated_at":"2026-02-02 01:24","closed_at":"2026-02-02 01:24","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":84,"betweenness_rank":0},{"id":"Insights-8hh","title":"Track annotation/comment creation with entity context","description":"Add PostHog tracking when annotations/comments are posted. Capture what entity type they're associated with.\n\n**Event**: annotation_created\n**Properties**:\n- annotation_id\n- project_id\n- account_id\n- entity_type: 'task' | 'insight' | 'evidence' | 'interview' | 'opportunity'\n- entity_id\n- has_mentions: boolean (if @ mentions supported)\n- $groups: { account: account_id }\n\n**Location**: Find the annotation/comment creation endpoint","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 00:07","updated_at":"2026-01-26 01:11","closed_at":"2026-01-26 01:11","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":85,"betweenness_rank":0},{"id":"Insights-910","title":"Move client-side tracking to server-side","description":"Several tracking events are firing via PostHog autocapture on the client, which can be blocked by ad blockers. Move these to server-side tracking:\n\n**Events to migrate:**\n- 'Create Task' button click ‚Üí should use existing task_created event (verify it fires)\n- 'New Survey' click ‚Üí verify survey_created fires from server action, not autocapture\n- 'Analyze' button click ‚Üí add analyze_started event from server action\n\n**Nav menu clicks** (Tasks, Conversations spans):\n- These are redundant if we track page views server-side\n- Consider adding route-level tracking in loaders instead of click tracking\n- Lower priority - autocapture pageviews may be sufficient\n\n**Why server-side:**\n- Not blocked by ad blockers/privacy extensions\n- More reliable\n- Richer context available","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 00:07","updated_at":"2026-01-26 01:06","closed_at":"2026-01-26 01:06","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":86,"betweenness_rank":0},{"id":"Insights-989","title":"Insights \u0026 Theme Consolidation","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-01-19 00:14","updated_at":"2026-01-19 00:14","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":87,"betweenness_rank":0},{"id":"Insights-989.1","title":"Lower evidence linking threshold (currently 0.4)","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":88,"betweenness_rank":0},{"id":"Insights-989.2","title":"Add Expand All / Collapse All toggle for evidence accordions","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":89,"betweenness_rank":0},{"id":"Insights-9ym","title":"Survey builder UI polish: slug validation, question box sizing, gray text, image uploads","description":"Multiple small UI issues in the survey builder identified from user feedback:\n\n1. **Public slug field**: Should slugify as user types (validation/transform)\n2. **Question boxes**: Should expand to fit size of text content\n3. **Gray placeholder text**: Makes users think they can't click on it - needs better affordance\n4. **Image uploads in questions tab**: Could not upload pics - need to update allowed file types\n5. **Context badge**: Didn't update (needs investigation)\n\nAll are small polish items that hurt UX.","status":"closed","priority":2,"type":"bug","labels":null,"created_at":"2026-01-23 14:28","updated_at":"2026-01-23 18:23","closed_at":"2026-01-23 18:23","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":90,"betweenness_rank":0},{"id":"Insights-a41","title":"onboarding chat doesn't sync answers to contextcomponent and update display in realtime","description":"switching to form shows the data. swithcing back to chat causes some flashing but eventually shows it","status":"open","priority":1,"type":"task","labels":null,"created_at":"2026-01-28 09:39","updated_at":"2026-01-28 09:39","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":91,"betweenness_rank":0},{"id":"Insights-a7x","title":"Fix $groups.account not appearing in PostHog events","description":"User reports $groups.account is not visible in PostHog dashboard despite being included in event properties.\n\n**Investigation needed**:\n1. Verify group analytics is enabled in PostHog project settings\n2. Check if group type 'account' needs to be registered first via posthog.groupIdentify()\n3. Confirm the $groups property is being sent correctly in capture() calls\n4. Check PostHog plan - group analytics may require paid tier\n\n**Possible fix**:\nIn _ProtectedLayout.tsx or login_success.tsx, ensure we call:\n```typescript\nposthog.groupIdentify('account', accountId, {\n  name: accountName,\n  plan: currentPlan,\n  // other account properties\n})\n```\n\nThis registers the group type before events can be associated with it.\n\n**Reference**: https://posthog.com/docs/product-analytics/group-analytics","status":"closed","priority":1,"type":"bug","labels":null,"created_at":"2026-01-26 00:07","updated_at":"2026-01-26 01:00","closed_at":"2026-01-26 01:00","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":92,"betweenness_rank":0},{"id":"Insights-aaf","title":"Team plan: Request demo ‚Üí auto-provision trial flow","description":"White glove approach for Team plan sales.\n\nFlow:\n1. Team plan CTA ‚Üí Request Demo form (company size, use case, timeline)\n2. Auto-provision Team trial (14 days)\n3. Notify sales (Slack/email) of new Team trial request\n4. Sales reaches out for personalized onboarding call\n5. Convert or downgrade after trial\n\nKeep current cal.com link as fallback option.","status":"open","priority":2,"type":"feature","labels":null,"created_at":"2026-01-22 11:33","updated_at":"2026-01-22 11:33","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":93,"betweenness_rank":0},{"id":"Insights-abs","title":"Set up nurture email sequence for trial conversion","description":"Email sequence to encourage trial ‚Üí paid conversion.\n\nEmails:\n- Day 1: Welcome, here's what you can do\n- Day 3: Feature highlight (calendar sync, voice chat)\n- Day 7: Case study / social proof\n- Day 10: Trial ending soon reminder\n- Day 13: Last chance, special offer?\n- Day 14: Trial ended, here's what you lose\n\nNeeds: Email service (Resend/Loops), user email preferences, unsubscribe handling","notes":"‚úÖ CODE COMPLETE - Using PostHog native Brevo destination (no custom sync needed)\n\nImplementation:\n- updateUserMetricsTask: Daily scheduled job calculates lifecycle_stage, is_activated, is_power_user, etc.\n- PostHog native Brevo destination: Already configured and working (39 triggers/7 days)\n- No custom sync code needed - PostHog sends events directly to Brevo\n\nManual setup remaining (~5-6 hours):\n1. Create PostHog cohorts in dashboard (20 min)\n   - activation-eligible, trial-active, trial-expiring, trial-expired, activation-stalled, activation-dormant\n2. Add attribute mappings to PostHog Brevo destination (30 min)\n   - USER_ID, LIFECYCLE_STAGE, INTERVIEW_COUNT, TASK_COMPLETED_COUNT, etc.\n3. Create Brevo contact lists (30 min)\n4. Create email templates in Brevo (3 hours)\n   - 10 templates for 4 automation workflows\n5. Set up automation workflows in Brevo (1 hour)\n   - Trial welcome, trial ending, trial expired win-back, dormant win-back\n6. Test end-to-end (1 hour)\n\nPrerequisites:\n‚úÖ DNS and SMTP configured\n‚úÖ Brevo sending Supabase auth emails\n‚úÖ PostHog ‚Üí Brevo destination active\n‚úÖ updateUserMetricsTask deployed\n\nNext: Manual dashboard configuration (non-code work)\nSee: docs/60-ops-observability/email-campaigns-setup.md","status":"in_progress","priority":1,"type":"feature","labels":null,"created_at":"2026-01-22 11:33","updated_at":"2026-01-26 02:36","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":94,"betweenness_rank":0},{"id":"Insights-ael","title":"Fix duplicate person created on transcript reprocess","status":"open","priority":2,"type":"bug","labels":null,"created_at":"2026-01-19 08:31","updated_at":"2026-01-19 08:31","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":95,"betweenness_rank":0},{"id":"Insights-avd","title":"Activation: Survey/insight/task event tracking","description":"Track survey_created, insight_viewed, task_created events. Implement activation detection logic.","notes":"Extends existing PostHog events (interview_added, project_created). Add survey_created, insight_viewed, task_created/completed, lens_applied, crm_contact_added.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-25 18:10","updated_at":"2026-01-25 21:58","closed_at":"2026-01-25 21:58","blocked_by":["Insights-1kk"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":5.1444853089702216e-8,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":96,"betweenness_rank":0},{"id":"Insights-b1i","title":"HITL Web Research Workflow","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":97,"betweenness_rank":0},{"id":"Insights-b1i.1","title":"Implement workflow skeleton in web-research-hitl.ts","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","blocks":["Insights-b1i.2"],"pagerank":0.010478125945660437,"betweenness":0,"eigenvector":0,"hub":0,"authority":1.9595988512575926e-33,"critical_path":2,"in_degree":1,"out_degree":0,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":13,"betweenness_rank":0},{"id":"Insights-b1i.2","title":"Add prompt templates for each research intent type","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:16","updated_at":"2026-01-19 00:16","blocked_by":["Insights-b1i.1"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":7.070526770169462e-34,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":98,"betweenness_rank":0},{"id":"Insights-b1i.3","title":"Add PDF ingestion tool or extend fetchWebContent","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-19 00:17","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":99,"betweenness_rank":0},{"id":"Insights-b49","title":"Resolve existing biome check failures","description":"pnpm run check fails due to existing lint errors; pre-commit hook auto-fixes multiple files and still reports errors.","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-21 16:51","updated_at":"2026-01-21 16:51","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":100,"betweenness_rank":0},{"id":"Insights-b6l","title":"Track task due date and assignment changes","description":"Add PostHog tracking for task field updates beyond status.\n\n**Events**:\n1. task_due_date_changed\n   - task_id, project_id, account_id\n   - previous_due_date (nullable)\n   - new_due_date (nullable)\n   - days_until_due (computed)\n\n2. task_assigned\n   - task_id, project_id, account_id\n   - assignee_user_id\n   - assigner_user_id (who made the assignment)\n   - is_self_assign: boolean\n\n**Location**: /app/routes/api.tasks.tsx - update action","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 00:07","updated_at":"2026-01-26 01:11","closed_at":"2026-01-26 01:11","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":101,"betweenness_rank":0},{"id":"Insights-c01","title":"Write E2E tests for signup and project creation flows","description":"Write E2E tests validating these PostHog events:\n- account_signed_up (OAuth and email flows)\n- project_created (with is_first_project tracking)\n\nTests should intercept network requests to PostHog and validate event properties.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 01:28","updated_at":"2026-01-28 16:51","closed_at":"2026-01-28 16:51","blocked_by":["Insights-h5d","Insights-z99"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0.0027399942366055255,"authority":0,"critical_path":1,"in_degree":0,"out_degree":2,"core_number":2,"slack":0,"is_articulation":false,"pagerank_rank":102,"betweenness_rank":0},{"id":"Insights-cb4","title":"Persist gen-ui-live chat thread history for return visits","description":"Persist gen-ui-live messages per thread so returning users see history/context. Likely store messages + tool outputs keyed by thread_id/project_id; rehydrate on page load. Avoid storing transient UI-only events; include minimal metadata for agent context.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 15:05","updated_at":"2026-02-02 18:23","closed_at":"2026-02-02 18:23","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":103,"betweenness_rank":0},{"id":"Insights-cb9","title":"Write E2E tests for interview and task tracking events","description":"Write E2E tests validating these PostHog events:\n- interview_added (upload flow)\n- interview_detail_viewed\n- task_created, task_status_changed, task_completed\n- annotation_created\n\nTests should intercept network requests and validate event properties.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 01:28","updated_at":"2026-01-28 16:51","closed_at":"2026-01-28 16:51","blocked_by":["Insights-h5d","Insights-z99"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0.0027399942366055255,"authority":0,"critical_path":1,"in_degree":0,"out_degree":2,"core_number":2,"slack":0,"is_articulation":false,"pagerank_rank":104,"betweenness_rank":0},{"id":"Insights-cny","title":"Improve email preview clarity and thumbnail in survey embed","description":"Clarify email preview copy and show thumbnail preview in embed tab.","notes":"Added placeholder image block in email HTML when no thumbnail URL is set, with clearer replacement guidance.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 00:03","updated_at":"2026-01-23 01:24","closed_at":"2026-01-23 00:38","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":105,"betweenness_rank":0},{"id":"Insights-e1z","title":"Gen-UI Threads v1: single active thread + thread list","description":"Epic for Gen-UI Threads v1. See spec: docs/20-features-prds/features/onboarding/gen-ui-threads-v1.md","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-02-02 17:27","updated_at":"2026-02-02 17:30","blocked_by":["Insights-4v2","Insights-mbx"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":2.4156133870331085e-18,"authority":0,"critical_path":1,"in_degree":0,"out_degree":2,"core_number":2,"slack":1,"is_articulation":false,"pagerank_rank":106,"betweenness_rank":0},{"id":"Insights-eaj","title":"Mobile App","status":"open","priority":3,"type":"epic","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":107,"betweenness_rank":0},{"id":"Insights-egk","title":"Email sync: Brevo webhook integration","description":"Implement /api/webhooks/brevo to sync email_opened, email_clicked events to PostHog.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-01-25 18:10","updated_at":"2026-01-26 02:43","closed_at":"2026-01-26 02:43","blocked_by":["Insights-1kk"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":5.1444853089702216e-8,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":108,"betweenness_rank":0},{"id":"Insights-ei6","title":"Remove duplicate Project Context from sidebar footer","description":"Remove the Project Context link from the sidebar footer utility links since it already exists above.","notes":"Removed Project Context from sidebar footer utility links.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 01:12","updated_at":"2026-01-23 01:16","closed_at":"2026-01-23 01:16","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":109,"betweenness_rank":0},{"id":"Insights-gz7","title":"Persona Facet Summaries - summarize facet group takeaways","status":"open","priority":2,"type":"feature","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":110,"betweenness_rank":0},{"id":"Insights-h5d","title":"Set up Playwright E2E testing for PostHog tracking validation","description":"Set up Playwright for automated E2E testing to validate PostHog tracking events fire correctly during key user flows.\n\n## Context\n- Playwright 1.53.2 is already installed in devDependencies\n- No playwright.config.ts or e2e test directory exists\n- Need to validate 21 PostHog events implemented in ky0.7-ky0.9\n\n## Acceptance Criteria\n- [ ] Playwright configured and working\n- [ ] Test directory structure created\n- [ ] Initial tests for key tracking flows\n- [ ] npm scripts for running tests\n- [ ] CI integration considerations documented","status":"closed","priority":2,"type":"feature","labels":null,"created_at":"2026-01-26 01:28","updated_at":"2026-01-28 16:51","closed_at":"2026-01-28 16:51","blocks":["Insights-c01","Insights-cb9","Insights-m5s","Insights-z99","Insights-zfm"],"pagerank":0.02798398950673978,"betweenness":0,"eigenvector":0.26967994498529685,"hub":0,"authority":0.005327594790474413,"critical_path":4,"in_degree":5,"out_degree":0,"core_number":2,"slack":0,"is_articulation":false,"pagerank_rank":2,"betweenness_rank":0},{"id":"Insights-hab","title":"Code Quality - Linting \u0026 Type Errors","status":"open","priority":1,"type":"epic","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":111,"betweenness_rank":0},{"id":"Insights-hab.1","title":"Fix ESLint errors across codebase","status":"open","priority":1,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-19 00:17","blocks":["Insights-hab.3"],"pagerank":0.008070989002154796,"betweenness":0,"eigenvector":0,"hub":0,"authority":1.3466260767088846e-22,"critical_path":2,"in_degree":1,"out_degree":0,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":17,"betweenness_rank":0},{"id":"Insights-hab.2","title":"Fix TypeScript type errors","status":"open","priority":1,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-19 00:17","blocks":["Insights-hab.3"],"pagerank":0.008070989002154796,"betweenness":0,"eigenvector":0,"hub":0,"authority":1.3466260767088846e-22,"critical_path":2,"in_degree":1,"out_degree":0,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":18,"betweenness_rank":0},{"id":"Insights-hab.3","title":"Re-enable pre-commit hooks","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-19 00:17","blocked_by":["Insights-hab.1","Insights-hab.2"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":9.717657997878512e-23,"authority":0,"critical_path":1,"in_degree":0,"out_degree":2,"core_number":1,"slack":2,"is_articulation":true,"pagerank_rank":112,"betweenness_rank":0},{"id":"Insights-ht2","title":"Simplify AI-generated survey questions - too verbose","description":"AI-generated survey questions are defaulting to be too long and verbose.\n\n**Expected (concise):**\n- What excites you about this?\n- What questions?\n- What are your creative gifts?\n\n**Actual (too verbose):**\n- What aspects of this opportunity excite you most, and what do you hope to achieve or experience through your involvement?\n- What specific questions or concerns do you have about this experience that you'd like to see addressed?\n- How would you describe your unique creative strengths and talents, and how do you envision applying them in this context?\n- What challenges or obstacles have you faced in the past when trying to express or develop your creativity, and what would ideal support look like?\n- What would success look like to you six months after participating, and how would you measure that impact in your creative work or personal growth?\n\n**Fix needed:**\nUpdate the prompt/instructions for survey question generation to produce shorter, more conversational questions. The current output sounds like a formal research questionnaire rather than a friendly conversation starter.","status":"open","priority":1,"type":"bug","labels":null,"created_at":"2026-01-27 13:34","updated_at":"2026-01-27 13:34","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":113,"betweenness_rank":0},{"id":"Insights-j50","title":"Fix upsert-person null company constraint error","status":"open","priority":2,"type":"bug","labels":null,"created_at":"2026-01-19 08:31","updated_at":"2026-01-19 08:31","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":114,"betweenness_rank":0},{"id":"Insights-kcb","title":"PicaOS Google Calendar Integration - CORS \u0026 OAuth flow","status":"open","priority":3,"type":"feature","labels":null,"created_at":"2026-01-22 08:12","updated_at":"2026-01-22 09:21","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":115,"betweenness_rank":0},{"id":"Insights-kwa","title":"Sidebar UX Improvements","status":"open","priority":2,"type":"epic","labels":null,"created_at":"2026-01-19 00:14","updated_at":"2026-01-19 00:14","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":116,"betweenness_rank":0},{"id":"Insights-kwa.1","title":"Add progress indicator (Step 2 of 4) in Journey group","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":117,"betweenness_rank":0},{"id":"Insights-kwa.2","title":"Group main nav by workflow (Input, Analysis, Action)","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":118,"betweenness_rank":0},{"id":"Insights-ky0","title":"Billing, Usage \u0026 Feature Gating","status":"open","priority":1,"type":"epic","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":119,"betweenness_rank":0},{"id":"Insights-ky0.1","title":"Implement Stripe billing integration","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-23 00:08","closed_at":"2026-01-23 00:08","blocks":["Insights-ky0.3","Insights-ky0.4"],"pagerank":0.015292399832671718,"betweenness":0,"eigenvector":0,"hub":0,"authority":2.693252153417769e-22,"critical_path":2,"in_degree":2,"out_degree":0,"core_number":1,"slack":2,"is_articulation":true,"pagerank_rank":6,"betweenness_rank":0},{"id":"Insights-ky0.10","title":"Implement real-time voice minutes tracking with LiveKit","notes":"Alternative quick approach: wrap external call timer with termination callback if limits exceeded by 5%. No need for real-time LiveKit integration initially.","status":"open","priority":3,"type":"task","labels":null,"created_at":"2026-01-23 13:42","updated_at":"2026-01-26 01:26","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":120,"betweenness_rank":0},{"id":"Insights-ky0.11","title":"Implement Team plan seat billing (add/remove seats)","status":"in_progress","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 13:42","updated_at":"2026-01-23 14:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":121,"betweenness_rank":0},{"id":"Insights-ky0.2","title":"Build usage tracking system (API calls, storage, etc.)","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-22 08:12","closed_at":"2026-01-22 08:12","blocks":["Insights-ky0.5"],"pagerank":0.010478125945660437,"betweenness":0,"eigenvector":0,"hub":0,"authority":1.9595988512575926e-33,"critical_path":2,"in_degree":1,"out_degree":0,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":14,"betweenness_rank":0},{"id":"Insights-ky0.3","title":"Implement feature gating per plan tiers","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-26 02:37","closed_at":"2026-01-26 02:37","blocked_by":["Insights-ky0.1"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":9.717657997878512e-23,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":122,"betweenness_rank":0},{"id":"Insights-ky0.4","title":"Create plan management UI (upgrade/downgrade)","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-23 00:08","closed_at":"2026-01-23 00:08","blocked_by":["Insights-ky0.1"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":9.717657997878512e-23,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":123,"betweenness_rank":0},{"id":"Insights-ky0.5","title":"Add usage dashboard/analytics for users","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-19 00:17","updated_at":"2026-01-19 00:17","blocked_by":["Insights-ky0.2"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":7.070526770169462e-34,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":124,"betweenness_rank":0},{"id":"Insights-ky0.6","title":"Wire usage instrumentation into Trigger.dev interview tasks","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-01-23 13:42","updated_at":"2026-01-25 02:03","closed_at":"2026-01-25 02:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":125,"betweenness_rank":0},{"id":"Insights-ky0.7","title":"Wire usage instrumentation into Mastra agents","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-01-23 13:42","updated_at":"2026-01-25 02:01","closed_at":"2026-01-25 02:01","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":126,"betweenness_rank":0},{"id":"Insights-ky0.8","title":"Add soft cap warning banner at 80% usage","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 13:42","updated_at":"2026-01-23 13:42","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":127,"betweenness_rank":0},{"id":"Insights-ky0.9","title":"Add upgrade prompt modal at 100% usage","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 13:42","updated_at":"2026-01-23 13:42","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":128,"betweenness_rank":0},{"id":"Insights-l1k","title":"Conversion: Billing flow and trial tracking","description":"Track billing_page_viewed, checkout_*, trial_started/ended events. Implement conversion cohorts.","notes":"Separate from billing instrumentation (ky0.6/7 tracks to Supabase for costs). This tracks to PostHog for PLG conversion analysis.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-25 18:10","updated_at":"2026-01-25 22:03","closed_at":"2026-01-25 22:03","blocked_by":["Insights-1kk"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":5.1444853089702216e-8,"authority":0,"critical_path":1,"in_degree":0,"out_degree":1,"core_number":1,"slack":2,"is_articulation":false,"pagerank_rank":129,"betweenness_rank":0},{"id":"Insights-l74","title":"create new team limit message should link to billing upgrade option","description":"Create a New Team\nCreate a team workspace to collaborate with others on research projects.\n\nKingdom\nkingdom\nUsed in URLs: /a/kingdom\n\nYou've reached your limit of 1 team. Upgrade to create more teams.\n","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-27 12:40","updated_at":"2026-01-27 12:40","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":130,"betweenness_rank":0},{"id":"Insights-m32","title":"Improve interview prompt generation with maximum context","description":"Enhance the interview prompt generation to utilize maximum available context for better, more targeted prompts.\n\n**Goal:** Generate higher quality interview prompts by leveraging all available project and company context.\n\n**Context sources to consider:**\n- Company description, industry, customer problem\n- Target orgs and roles\n- Research goals and unknowns\n- Existing insights and themes from prior interviews\n- Personas and segments\n- Conversation lenses applied to the project\n\n**Outcome:** More specific, relevant interview prompts that help users get better insights faster.","status":"closed","priority":2,"type":"feature","labels":null,"created_at":"2026-01-23 17:54","updated_at":"2026-01-25 01:52","closed_at":"2026-01-25 01:52","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":131,"betweenness_rank":0},{"id":"Insights-m5s","title":"Create playwright.config.ts with project defaults","description":"Create playwright.config.ts in project root with:\n- Base URL pointing to local dev server (localhost:4280)\n- Chromium, Firefox, and WebKit browser configs\n- Test directory pointing to tests/e2e\n- Screenshot and trace capture on failure\n- Reasonable timeouts for CI","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 01:28","updated_at":"2026-01-26 18:08","closed_at":"2026-01-26 18:08","blocked_by":["Insights-h5d"],"blocks":["Insights-z99","Insights-zfm"],"pagerank":0.012524178510154022,"betweenness":0,"eigenvector":0,"hub":0.0019222761619037644,"authority":0.0022663083698355566,"critical_path":3,"in_degree":2,"out_degree":1,"core_number":2,"slack":0,"is_articulation":false,"pagerank_rank":11,"betweenness_rank":0},{"id":"Insights-m5x","title":"Refactoring \u0026 Tech Debt","status":"open","priority":4,"type":"epic","labels":null,"created_at":"2026-01-19 00:14","updated_at":"2026-01-19 00:14","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":132,"betweenness_rank":0},{"id":"Insights-m5x.1","title":"Refactor processInterviewServer.ts into smaller trigger tasks","status":"open","priority":4,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":133,"betweenness_rank":0},{"id":"Insights-m5x.2","title":"Remove research_goal_details in favor of ad-hoc project_section kinds","status":"open","priority":4,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":134,"betweenness_rank":0},{"id":"Insights-m5x.3","title":"Ship R2 upload progress UI with percent + cancel support","status":"open","priority":4,"type":"task","labels":null,"created_at":"2026-01-19 00:15","updated_at":"2026-01-19 00:15","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":135,"betweenness_rank":0},{"id":"Insights-mbx","title":"Implement Gen-UI thread list + switching (chat + canvas)","description":"Implement v1 UI: thread list, create thread (scope+title), switch active thread, restore chat history via Mastra memory and canvas via ui_state snapshot. Feature-flagged.","status":"in_progress","priority":2,"type":"task","labels":null,"created_at":"2026-02-02 17:27","updated_at":"2026-02-02 17:31","blocked_by":["Insights-4v2"],"blocks":["Insights-e1z"],"pagerank":0.008070989002154796,"betweenness":0,"eigenvector":0,"hub":1.4929311768657156e-18,"authority":2.5572168211683393e-18,"critical_path":2,"in_degree":1,"out_degree":1,"core_number":2,"slack":1,"is_articulation":false,"pagerank_rank":19,"betweenness_rank":0},{"id":"Insights-o63","title":"Track all task status changes, not just completion","description":"Currently task_completed only fires when status changes to 'done'. User changed task from backlog ‚Üí To Do ‚Üí Done and only the final transition fired.\n\n**Fix**: Fire task_status_changed event on every status transition\n\n**Event**: task_status_changed\n**Properties**:\n- task_id\n- project_id  \n- account_id\n- previous_status\n- new_status\n- $groups: { account: account_id }\n\n**Location**: /app/routes/api.tasks.tsx - update action\n\nKeep task_completed as a separate event for funnel analysis, but also fire the generic status change event.","status":"closed","priority":2,"type":"bug","labels":null,"created_at":"2026-01-26 00:07","updated_at":"2026-01-26 01:06","closed_at":"2026-01-26 01:06","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":136,"betweenness_rank":0},{"id":"Insights-s64","title":"Implement reverse trial flow (Pro ‚Üí Free after 14 days)","description":"New users start on Pro plan for 14 days, then drop to Free if not converted.\n\nImplementation:\n1. Configure Polar products with trial_days=14\n2. Auto-create trial subscription on signup\n3. Handle subscription.trial_ended webhook\n4. Downgrade to Free plan on trial end\n5. In-app banner showing trial days remaining","status":"closed","priority":1,"type":"feature","labels":null,"created_at":"2026-01-22 11:33","updated_at":"2026-01-23 14:13","closed_at":"2026-01-23 14:13","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":137,"betweenness_rank":0},{"id":"Insights-tut","title":"test signup flow","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 18:03","updated_at":"2026-01-23 18:03","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":138,"betweenness_rank":0},{"id":"Insights-uio","title":"Remove 'specific details or context' input prompt","description":"Remove the input field that currently asks: 'Any specific details or context to add? Help us understand your situation better - challenges, constraints, timeline, etc.' This appears during project setup flow.","status":"closed","priority":3,"type":"task","labels":null,"created_at":"2026-01-25 01:42","updated_at":"2026-01-26 02:45","closed_at":"2026-01-26 02:45","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":139,"betweenness_rank":0},{"id":"Insights-v1p","title":"survey should handle anonymous submissions","description":"## Problem\nCurrently surveys always require email for identification. Users need the ability to create anonymous surveys where no email is collected.\n\n## Requirements\n\n### Survey Configuration\nAdd `identity_mode` setting to research_links:\n- `anonymous` - No identification collected, fully anonymous responses\n- `identified` (default) - Requires identification before responding\n\n### Identified Mode Options\nWhen `identity_mode = 'identified'`, add `identity_field` setting:\n- `email` (default) - Collect email address\n- `phone` - Collect phone number instead\n\n### UX Flow\n- **Anonymous**: Skip email collection step entirely, go straight to questions\n- **Email identified**: Current flow (collect email first)\n- **Phone identified**: Collect phone number instead of email\n\n### Data Model\n- `research_link_responses.email` becomes nullable for anonymous\n- Add `research_link_responses.phone` for phone identification\n- `person_id` linking only works for identified responses\n\n### Survey Creator UX\nAdd toggle/select in survey settings:\n- \"Require respondent identification\" (default: on)\n- When on: \"Identify by: Email / Phone number\"\n\n## Files to modify\n- `supabase/schemas/18_research_links.sql` - add identity_mode, identity_field columns\n- `app/routes/research.$slug.tsx` - conditional email/phone collection\n- `app/routes/embed.$slug.tsx` - handle anonymous embeds\n- `app/routes/api.research-links.$slug.start.tsx` - allow anonymous starts\n- Survey settings UI (TBD)","status":"closed","priority":1,"type":"task","labels":null,"created_at":"2026-01-30 21:42","updated_at":"2026-01-30 22:42","closed_at":"2026-01-30 22:42","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":140,"betweenness_rank":0},{"id":"Insights-v4b","title":"Fix missing unique index on people(account_id,name_hash,company)","status":"closed","priority":1,"type":"bug","labels":null,"created_at":"2026-01-28 17:04","updated_at":"2026-01-28 17:50","closed_at":"2026-01-28 17:50","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":141,"betweenness_rank":0},{"id":"Insights-vnq","title":"signup must tell user to check email","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-23 12:00","updated_at":"2026-01-23 16:54","closed_at":"2026-01-23 16:54","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":142,"betweenness_rank":0},{"id":"Insights-vzn","title":"make transparent bg for survey embed codes","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-28 17:44","updated_at":"2026-01-31 14:31","closed_at":"2026-01-31 14:31","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":143,"betweenness_rank":0},{"id":"Insights-z99","title":"Set up tests/e2e directory structure and fixtures","description":"Set up test directory structure:\n- tests/e2e/ - main test directory\n- tests/e2e/fixtures/ - reusable test helpers\n- tests/e2e/auth/ - authentication tests\n- tests/e2e/tracking/ - PostHog event validation tests\n- Consider fixtures for authenticated user state","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 01:28","updated_at":"2026-01-26 18:08","closed_at":"2026-01-26 18:08","blocked_by":["Insights-h5d","Insights-m5s"],"blocks":["Insights-c01","Insights-cb9"],"pagerank":0.010478125945660437,"betweenness":2,"eigenvector":0,"hub":0.0027399942366055255,"authority":0.0022663083698355566,"critical_path":2,"in_degree":2,"out_degree":2,"core_number":2,"slack":0,"is_articulation":false,"pagerank_rank":15,"betweenness_rank":5},{"id":"Insights-zfm","title":"Add npm scripts for Playwright (test:e2e, test:e2e:ui)","description":"Add npm scripts to package.json:\n- test:e2e - run Playwright tests headless\n- test:e2e:ui - run Playwright with UI mode\n- test:e2e:debug - run with debug mode enabled\n\nUpdate validate script to optionally include e2e tests.","status":"closed","priority":2,"type":"task","labels":null,"created_at":"2026-01-26 01:28","updated_at":"2026-01-26 18:08","closed_at":"2026-01-26 18:08","blocked_by":["Insights-h5d","Insights-m5s"],"pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0.0027399942366055255,"authority":0,"critical_path":1,"in_degree":0,"out_degree":2,"core_number":2,"slack":1,"is_articulation":false,"pagerank_rank":144,"betweenness_rank":0},{"id":"Insights-zn2","title":"CRITICAL: Fix all Mastra tools using ~/path aliases","description":"## Problem\nMastra bundler DOES NOT support ~/path aliases. This causes production crashes:\n\n```\nError [ERR_MODULE_NOT_FOUND]: Cannot find package '~' imported from /app/.mastra/output/tools/...\n```\n\n## Impact\n- Production errors RIGHT NOW\n- 50 files affected in app/mastra/\n\n## Solution\nALL Mastra tools must use dynamic imports inside execute() instead of static imports:\n\n### WRONG:\n```typescript\nimport { createSupabaseAdminClient } from '~/lib/supabase/client.server'\n\nexport const myTool = createTool({\n  execute: async (input) =\u003e {\n    const supabase = createSupabaseAdminClient()\n    // ...\n  }\n})\n```\n\n### CORRECT:\n```typescript\n// External packages can be static\nimport { createTool } from '@mastra/core'\n\nexport const myTool = createTool({\n  execute: async (input) =\u003e {\n    // Dynamic import inside execute()\n    const { createSupabaseAdminClient } = await import('~/lib/supabase/client.server')\n    const supabase = createSupabaseAdminClient()\n    // ...\n  }\n})\n```\n\n## Files to Fix\nRun: `grep -r \"from '~/\" app/mastra/ | wc -l` ‚Üí ~50 files\n\n## This is the 3RD TIME we've made this mistake\nWe MUST remember: **NO ~/imports in Mastra tools - ONLY dynamic imports in execute()**","status":"closed","priority":0,"type":"bug","labels":null,"created_at":"2026-01-31 02:33","updated_at":"2026-02-01 22:11","closed_at":"2026-02-01 22:11","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":145,"betweenness_rank":0},{"id":"Insights-ztp","title":"bug sending confirmation email from supabase inserts localhost:4280","status":"open","priority":2,"type":"task","labels":null,"created_at":"2026-01-28 15:23","updated_at":"2026-01-28 15:23","pagerank":0.005663852058649156,"betweenness":0,"eigenvector":0,"hub":0,"authority":0,"critical_path":1,"in_degree":0,"out_degree":0,"core_number":0,"slack":3,"is_articulation":false,"pagerank_rank":146,"betweenness_rank":0}],"triage":{"meta":{"version":"1.0.0","generated_at":"2026-02-02T22:01:30.274846-08:00","phase2_ready":true,"issue_count":146,"compute_time_ms":0},"quick_ref":{"open_count":63,"actionable_count":57,"blocked_count":6,"in_progress_count":4,"top_picks":[{"id":"Insights-43a.1","title":"Create assessProjectState tool","score":0.31448119089715054,"reasons":["üîì Unblocks 1 item(s): Insights-43a.2","üìä High centrality in dependency graph (PageRank: 61%)","üìÖ Last updated 14 days ago","‚ö° Low effort, high impact - good starting point","‚úÖ Currently unclaimed - available for work"],"unblocks":1},{"id":"Insights-b1i.1","title":"Implement workflow skeleton in web-research-hitl.ts","score":0.25497098662894824,"reasons":["üîì Unblocks 1 item(s): Insights-b1i.2","üìä High centrality in dependency graph (PageRank: 35%)","üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work"],"unblocks":1},{"id":"Insights-hab.1","title":"Fix ESLint errors across codebase","score":0.23108247802274562,"reasons":["üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","üö® High priority (P1) - prioritize this work"],"unblocks":0}]},"recommendations":[{"id":"Insights-43a.2","title":"Create recommendNextActions tool/workflow","type":"task","status":"open","priority":2,"labels":null,"score":0.3297409486550332,"breakdown":{"pagerank":0.1077997968537417,"betweenness":0.07272727272727274,"blocker_ratio":0.026000000000000002,"staleness":0.024844024863097995,"priority_boost":0.05,"time_to_impact":0.04725,"urgency":0.04405509137467901,"risk":0.0020000000000000005,"pagerank_norm":0.48999907660791686,"betweenness_norm":0.36363636363636365,"blocker_ratio_norm":0.2,"staleness_norm":0.4968804972619599,"priority_boost_norm":0.5,"time_to_impact_norm":0.4725,"urgency_norm":0.44055091374679006,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"Deep in critical path (depth 3), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Work on Insights-43a.1 first to unblock this","reasons":["üîì Unblocks 1 item(s): Insights-43a.3","üìä High centrality in dependency graph (PageRank: 49%)","üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","‚è≥ Blocked by Insights-43a.1 - complete that first"],"unblocks_ids":["Insights-43a.3"],"blocked_by":["Insights-43a.1"]},{"id":"Insights-43a.1","title":"Create assessProjectState tool","type":"task","status":"open","priority":2,"labels":null,"score":0.31448119089715054,"breakdown":{"pagerank":0.13353458283256617,"betweenness":0,"blocker_ratio":0.026000000000000002,"staleness":0.024844061248668985,"priority_boost":0.05,"time_to_impact":0.05425,"urgency":0.044055109915412505,"risk":0.0020000000000000005,"pagerank_norm":0.6069753765116643,"betweenness_norm":0,"blocker_ratio_norm":0.2,"staleness_norm":0.49688122497337966,"priority_boost_norm":0.5,"time_to_impact_norm":0.5425,"urgency_norm":0.44055109915412505,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"Deep in critical path (depth 4), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Quick win - start here for fast progress","reasons":["üîì Unblocks 1 item(s): Insights-43a.2","üìä High centrality in dependency graph (PageRank: 61%)","üìÖ Last updated 14 days ago","‚ö° Low effort, high impact - good starting point","‚úÖ Currently unclaimed - available for work"],"unblocks_ids":["Insights-43a.2"]},{"id":"Insights-43a.3","title":"Enhance Uppy instructions for state-aware responses","type":"task","status":"open","priority":2,"labels":null,"score":0.2830501051223725,"breakdown":{"pagerank":0.077523811569161,"betweenness":0.07272727272727274,"blocker_ratio":0.026000000000000002,"staleness":0.024843984870736885,"priority_boost":0.05,"time_to_impact":0.04025,"urgency":0.04405507099599272,"risk":0.0020000000000000005,"pagerank_norm":0.35238096167800453,"betweenness_norm":0.36363636363636365,"blocker_ratio_norm":0.2,"staleness_norm":0.49687969741473764,"priority_boost_norm":0.5,"time_to_impact_norm":0.40249999999999997,"urgency_norm":0.4405507099599272,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"On dependency chain (depth 2), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Work on Insights-43a.2 first to unblock this","reasons":["üîì Unblocks 1 item(s): Insights-43a.4","üìä High centrality in dependency graph (PageRank: 35%)","üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","‚è≥ Blocked by Insights-43a.2 - complete that first"],"unblocks_ids":["Insights-43a.4"],"blocked_by":["Insights-43a.2"]},{"id":"Insights-b1i.1","title":"Implement workflow skeleton in web-research-hitl.ts","type":"task","status":"open","priority":2,"labels":null,"score":0.25497098662894824,"breakdown":{"pagerank":0.077523811569161,"betweenness":0,"blocker_ratio":0.026000000000000002,"staleness":0.02484324396298225,"priority_boost":0.05,"time_to_impact":0.04025,"urgency":0.04405469344309007,"risk":0.0020000000000000005,"pagerank_norm":0.35238096167800453,"betweenness_norm":0,"blocker_ratio_norm":0.2,"staleness_norm":0.496864879259645,"priority_boost_norm":0.5,"time_to_impact_norm":0.40249999999999997,"urgency_norm":0.44054693443090065,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"On dependency chain (depth 2), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["üîì Unblocks 1 item(s): Insights-b1i.2","üìä High centrality in dependency graph (PageRank: 35%)","üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work"],"unblocks_ids":["Insights-b1i.2"]},{"id":"Insights-hab.1","title":"Fix ESLint errors across codebase","type":"task","status":"open","priority":1,"labels":null,"score":0.23108247802274562,"breakdown":{"pagerank":0.05971428801530612,"betweenness":0,"blocker_ratio":0.026000000000000002,"staleness":0.024842921646103393,"priority_boost":0.07500000000000001,"time_to_impact":0.04025,"urgency":0.04405452918887943,"risk":0.0020000000000000005,"pagerank_norm":0.2714285818877551,"betweenness_norm":0,"blocker_ratio_norm":0.2,"staleness_norm":0.4968584329220678,"priority_boost_norm":0.75,"time_to_impact_norm":0.40249999999999997,"urgency_norm":0.44054529188879427,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"On dependency chain (depth 2), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","üö® High priority (P1) - prioritize this work"]},{"id":"Insights-hab.2","title":"Fix TypeScript type errors","type":"task","status":"open","priority":1,"labels":null,"score":0.2310823921487616,"breakdown":{"pagerank":0.05971428801530612,"betweenness":0,"blocker_ratio":0.026000000000000002,"staleness":0.024842854722858798,"priority_boost":0.07500000000000001,"time_to_impact":0.04025,"urgency":0.044054495083907554,"risk":0.0020000000000000005,"pagerank_norm":0.2714285818877551,"betweenness_norm":0,"blocker_ratio_norm":0.2,"staleness_norm":0.4968570944571759,"priority_boost_norm":0.75,"time_to_impact_norm":0.40249999999999997,"urgency_norm":0.4405449508390755,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"On dependency chain (depth 2), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","üö® High priority (P1) - prioritize this work"]},{"id":"Insights-ky0","title":"Billing, Usage \u0026 Feature Gating","type":"epic","status":"open","priority":1,"labels":null,"score":0.18789757475720154,"breakdown":{"pagerank":0.041904764461451256,"betweenness":0,"blocker_ratio":0,"staleness":0.02484540913416281,"priority_boost":0.07500000000000001,"time_to_impact":0.033249999999999995,"urgency":0.04405579670697596,"risk":0.0020000000000000005,"pagerank_norm":0.1904762020975057,"betweenness_norm":0,"blocker_ratio_norm":0,"staleness_norm":0.4969081826832562,"priority_boost_norm":0.75,"time_to_impact_norm":0.33249999999999996,"urgency_norm":0.4405579670697596,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"On dependency chain (depth 1), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","üö® High priority (P1) - prioritize this work"]},{"id":"Insights-hab","title":"Code Quality - Linting \u0026 Type Errors","type":"epic","status":"open","priority":1,"labels":null,"score":0.18789751815443168,"breakdown":{"pagerank":0.041904764461451256,"betweenness":0,"blocker_ratio":0,"staleness":0.024845365019347993,"priority_boost":0.07500000000000001,"time_to_impact":0.033249999999999995,"urgency":0.04405577423029682,"risk":0.0020000000000000005,"pagerank_norm":0.1904762020975057,"betweenness_norm":0,"blocker_ratio_norm":0,"staleness_norm":0.49690730038695985,"priority_boost_norm":0.75,"time_to_impact_norm":0.33249999999999996,"urgency_norm":0.4405577423029682,"risk_norm":0.020000000000000004,"time_to_impact_explanation":"On dependency chain (depth 1), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.020000000000000004,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work","üö® High priority (P1) - prioritize this work"]},{"id":"Insights-4oj","title":"Simplify onboarding chat options","type":"task","status":"open","priority":1,"labels":null,"score":0.17328314393769914,"breakdown":{"pagerank":0.041904764461451256,"betweenness":0,"blocker_ratio":0,"staleness":0.0038555949062307098,"priority_boost":0.07500000000000001,"time_to_impact":0.033249999999999995,"urgency":0.038543594672201746,"risk":0.011308568239762326,"pagerank_norm":0.1904762020975057,"betweenness_norm":0,"blocker_ratio_norm":0,"staleness_norm":0.07711189812461419,"priority_boost_norm":0.75,"time_to_impact_norm":0.33249999999999996,"urgency_norm":0.3854359467220174,"risk_norm":0.11308568239762325,"time_to_impact_explanation":"On dependency chain (depth 1), median estimate 60m","urgency_explanation":"moderate time pressure","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0.3102856079920775,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.11308568239762325,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["‚úÖ Currently unclaimed - available for work","üö® High priority (P1) - prioritize this work"]},{"id":"Insights-ky0.5","title":"Add usage dashboard/analytics for users","type":"task","status":"open","priority":2,"labels":null,"score":0.16767088288753773,"breakdown":{"pagerank":0.041904764461451256,"betweenness":0,"blocker_ratio":0,"staleness":0.024842962364969134,"priority_boost":0.05,"time_to_impact":0.033249999999999995,"urgency":0.044054549939657024,"risk":0.0032075854545552417,"pagerank_norm":0.1904762020975057,"betweenness_norm":0,"blocker_ratio_norm":0,"staleness_norm":0.4968592472993827,"priority_boost_norm":0.5,"time_to_impact_norm":0.33249999999999996,"urgency_norm":0.44054549939657023,"risk_norm":0.03207585454555242,"time_to_impact_explanation":"On dependency chain (depth 1), median estimate 60m","urgency_explanation":"aging (15 days)","risk_explanation":"Low risk - stable dependency structure","risk_signals":{"fan_variance":0,"activity_churn":0.04025284848517471,"cross_repo_risk":0,"status_risk":0.1,"composite_risk":0.03207585454555242,"explanation":"Low risk - stable dependency structure"}},"action":"Start work on this issue","reasons":["üìÖ Last updated 14 days ago","‚úÖ Currently unclaimed - available for work"]}],"quick_wins":[{"id":"Insights-43a.1","title":"Create assessProjectState tool","score":0.6000000000000001,"reason":"Unblocks 1 items","unblocks_ids":["Insights-43a.2"]},{"id":"Insights-43a.2","title":"Create recommendNextActions tool/workflow","score":0.6000000000000001,"reason":"Unblocks 1 items","unblocks_ids":["Insights-43a.3"]},{"id":"Insights-43a.3","title":"Enhance Uppy instructions for state-aware responses","score":0.6000000000000001,"reason":"Unblocks 1 items","unblocks_ids":["Insights-43a.4"]},{"id":"Insights-b1i.1","title":"Implement workflow skeleton in web-research-hitl.ts","score":0.6000000000000001,"reason":"Unblocks 1 items","unblocks_ids":["Insights-b1i.2"]},{"id":"Insights-mbx","title":"Implement Gen-UI thread list + switching (chat + canvas)","score":0.6000000000000001,"reason":"Unblocks 1 items","unblocks_ids":["Insights-e1z"]}],"blockers_to_clear":[{"id":"Insights-43a.1","title":"Create assessProjectState tool","unblocks_count":1,"unblocks_ids":["Insights-43a.2"],"actionable":true},{"id":"Insights-43a.2","title":"Create recommendNextActions tool/workflow","unblocks_count":1,"unblocks_ids":["Insights-43a.3"],"actionable":false,"blocked_by":["Insights-43a.1"]},{"id":"Insights-43a.3","title":"Enhance Uppy instructions for state-aware responses","unblocks_count":1,"unblocks_ids":["Insights-43a.4"],"actionable":false,"blocked_by":["Insights-43a.2"]},{"id":"Insights-b1i.1","title":"Implement workflow skeleton in web-research-hitl.ts","unblocks_count":1,"unblocks_ids":["Insights-b1i.2"],"actionable":true},{"id":"Insights-mbx","title":"Implement Gen-UI thread list + switching (chat + canvas)","unblocks_count":1,"unblocks_ids":["Insights-e1z"],"actionable":true}],"project_health":{"counts":{"total":146,"open":63,"closed":83,"blocked":6,"actionable":57,"by_status":{"closed":83,"in_progress":4,"open":59},"by_type":{"bug":12,"epic":14,"feature":12,"task":108},"by_priority":{"0":2,"1":29,"2":84,"3":24,"4":7}},"graph":{"node_count":146,"edge_count":42,"density":0.0019839395370807745,"has_cycles":false,"phase2_ready":true},"velocity":{"closed_last_7_days":49,"closed_last_30_days":83,"avg_days_to_close":0.5495985441185575,"weekly":[{"week_start":"2026-02-02T00:00:00Z","closed":41},{"week_start":"2026-01-26T00:00:00Z","closed":27},{"week_start":"2026-01-19T00:00:00Z","closed":15},{"week_start":"2026-01-12T00:00:00Z","closed":0},{"week_start":"2026-01-05T00:00:00Z","closed":0},{"week_start":"2025-12-29T00:00:00Z","closed":0},{"week_start":"2025-12-22T00:00:00Z","closed":0},{"week_start":"2025-12-15T00:00:00Z","closed":0}]}},"commands":{"claim_top":"CI=1 bd update Insights-43a.2 --status in_progress --json","show_top":"CI=1 bd show Insights-43a.2 --json","list_ready":"CI=1 bd ready --json","list_blocked":"CI=1 bd blocked --json","refresh_triage":"bv --robot-triage"}}};
const STATUS_COLORS = { open: '#22c55e', in_progress: '#f97316', blocked: '#ef4444', closed: '#555577' };
const PRIORITY_COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#555577'];
const TYPE_COLORS = { feature: '#a855f7', bug: '#ef4444', task: '#22d3ee', epic: '#fbbf24' };

// Configure marked for safe HTML rendering
marked.setOptions({ breaks: true, gfm: true });

// Stats calculation
let actionable = 0, blocked = 0, onCriticalPath = 0, articulationCount = 0;
const blockerCount = {};
DATA.links.forEach(l => blockerCount[l.source] = (blockerCount[l.source] || 0) + 1);
DATA.nodes.forEach(n => {
    n.blockerCount = blockerCount[n.id] || 0;
    if ((n.status === 'open' || n.status === 'in_progress') && n.blockerCount === 0) actionable++;
    if (n.status === 'blocked') blocked++;
    if (n.slack === 0) onCriticalPath++;
    if (n.is_articulation) articulationCount++;
});
document.getElementById('stat-actionable').textContent = actionable;
document.getElementById('stat-blocked').textContent = blocked;
document.getElementById('stat-critical').textContent = onCriticalPath;
document.getElementById('stat-articulation').textContent = articulationCount;

// Max values for sizing
const maxPR = Math.max(...DATA.nodes.map(n => n.pagerank || 0), 0.001);
const maxBW = Math.max(...DATA.nodes.map(n => n.betweenness || 0), 0.001);
const maxCP = Math.max(...DATA.nodes.map(n => n.critical_path || 0), 1);
const maxInDeg = Math.max(...DATA.nodes.map(n => n.in_degree || 0), 1);

let sizeMetric = 'pagerank', heatmapMode = false, hoveredNode = null, highlightedNodes = new Set();

function getNodeSize(n) {
    const base = 5, scale = 16;
    switch(sizeMetric) {
        case 'pagerank': return base + ((n.pagerank || 0) / maxPR) * scale;
        case 'betweenness': return base + ((n.betweenness || 0) / maxBW) * scale;
        case 'critical': return base + ((n.critical_path || 0) / maxCP) * scale;
        case 'indegree': return base + ((n.in_degree || 0) / maxInDeg) * scale;
        default: return base + ((n.pagerank || 0) / maxPR) * scale;
    }
}

function getHeatmapColor(n) {
    let val = 0, max = 1;
    switch(sizeMetric) {
        case 'pagerank': val = n.pagerank || 0; max = maxPR; break;
        case 'betweenness': val = n.betweenness || 0; max = maxBW; break;
        case 'critical': val = n.critical_path || 0; max = maxCP; break;
        case 'indegree': val = n.in_degree || 0; max = maxInDeg; break;
    }
    const ratio = val / max;
    const hue = 120 - ratio * 120; // Green to red
    return 'hsl(' + hue + ', 80%, 50%)';
}

// Get connected subgraph (for golden glow highlight)
function getConnectedNodes(nodeId, depth = 2) {
    const connected = new Set([nodeId]);
    const queue = [{id: nodeId, d: 0}];
    while (queue.length > 0) {
        const {id, d} = queue.shift();
        if (d >= depth) continue;
        DATA.links.forEach(l => {
            const src = typeof l.source === 'object' ? l.source.id : l.source;
            const tgt = typeof l.target === 'object' ? l.target.id : l.target;
            if (src === id && !connected.has(tgt)) { connected.add(tgt); queue.push({id: tgt, d: d+1}); }
            if (tgt === id && !connected.has(src)) { connected.add(src); queue.push({id: src, d: d+1}); }
        });
    }
    return connected;
}

const container = document.getElementById('graph-container');
const Graph = ForceGraph()(container)
    .graphData(JSON.parse(JSON.stringify(DATA)))
    .backgroundColor('transparent')
    .nodeId('id')
    .nodeLabel(null)
    .nodeColor(n => {
        if (highlightedNodes.size > 0 && !highlightedNodes.has(n.id)) return (STATUS_COLORS[n.status] || '#555577') + '20';
        if (heatmapMode) return getHeatmapColor(n);
        return STATUS_COLORS[n.status] || '#555577';
    })
    .nodeVal(n => getNodeSize(n))
    .linkColor(l => {
        const src = typeof l.source === 'object' ? l.source.id : l.source;
        const tgt = typeof l.target === 'object' ? l.target.id : l.target;
        if (highlightedNodes.size > 0) {
            if (highlightedNodes.has(src) && highlightedNodes.has(tgt)) return '#fbbf24aa';
            return '#44475a15';
        }
        return l.critical ? '#ec489980' : '#44475a40';
    })
    .linkWidth(l => {
        const src = typeof l.source === 'object' ? l.source.id : l.source;
        const tgt = typeof l.target === 'object' ? l.target.id : l.target;
        if (highlightedNodes.size > 0 && highlightedNodes.has(src) && highlightedNodes.has(tgt)) return 3;
        return l.critical ? 2 : 1;
    })
    .linkDirectionalArrowLength(5)
    .linkDirectionalArrowColor(l => {
        const src = typeof l.source === 'object' ? l.source.id : l.source;
        const tgt = typeof l.target === 'object' ? l.target.id : l.target;
        if (highlightedNodes.size > 0 && highlightedNodes.has(src) && highlightedNodes.has(tgt)) return '#fbbf24';
        return l.critical ? '#ec4899' : '#44475a';
    })
    .linkDirectionalArrowRelPos(1)
    .linkCurvature(0.1)
    .linkDirectionalParticles(l => l.critical ? 2 : 0)
    .linkDirectionalParticleSpeed(0.003)
    .linkDirectionalParticleWidth(2)
    .linkDirectionalParticleColor(() => '#ec4899')
    .d3AlphaDecay(0.02)
    .d3VelocityDecay(0.25)
    .nodeCanvasObject((node, ctx, globalScale) => {
        const x = node.x, y = node.y;
        if (x === undefined || y === undefined || !isFinite(x) || !isFinite(y)) return;
        const size = getNodeSize(node);
        const baseColor = heatmapMode ? getHeatmapColor(node) : STATUS_COLORS[node.status] || '#555577';
        const isHighlighted = highlightedNodes.size === 0 || highlightedNodes.has(node.id);
        const isHovered = hoveredNode && hoveredNode.id === node.id;
        const alpha = isHighlighted ? 1 : 0.15;

        // Golden glow for hovered node's connected subgraph
        if (isHovered || (highlightedNodes.has(node.id) && highlightedNodes.size > 0)) {
            ctx.beginPath(); ctx.arc(x, y, size + 8, 0, 2 * Math.PI);
            const g = ctx.createRadialGradient(x, y, size, x, y, size + 12);
            g.addColorStop(0, 'rgba(251, 191, 36, 0.6)'); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fill();
        }

        // Articulation point glow
        if (node.is_articulation && isHighlighted) {
            ctx.beginPath(); ctx.arc(x, y, size + 6, 0, 2 * Math.PI);
            const g = ctx.createRadialGradient(x, y, size, x, y, size + 8);
            g.addColorStop(0, '#ec489960'); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fill();
        }

        // Critical path indicator
        if (node.slack === 0 && isHighlighted) {
            ctx.beginPath(); ctx.arc(x, y, size + 3, 0, 2 * Math.PI);
            ctx.fillStyle = baseColor + '30'; ctx.fill();
        }

        // Priority ring
        const pColor = PRIORITY_COLORS[node.priority] || PRIORITY_COLORS[2];
        ctx.globalAlpha = alpha;
        ctx.beginPath(); ctx.arc(x, y, size + 1.5, 0, 2 * Math.PI);
        ctx.strokeStyle = pColor; ctx.lineWidth = 2; ctx.stroke();

        // Node shape based on type
        ctx.fillStyle = baseColor;
        ctx.beginPath();
        switch(node.type) {
            case 'bug': // Triangle
                ctx.moveTo(x, y - size);
                ctx.lineTo(x + size * 0.866, y + size * 0.5);
                ctx.lineTo(x - size * 0.866, y + size * 0.5);
                ctx.closePath();
                break;
            case 'task': // Square
                ctx.rect(x - size * 0.7, y - size * 0.7, size * 1.4, size * 1.4);
                break;
            case 'epic': // Diamond
                ctx.moveTo(x, y - size);
                ctx.lineTo(x + size, y);
                ctx.lineTo(x, y + size);
                ctx.lineTo(x - size, y);
                ctx.closePath();
                break;
            default: // Circle (feature)
                ctx.arc(x, y, size, 0, 2 * Math.PI);
        }
        ctx.fill();

        // Highlight effect
        const hl = ctx.createRadialGradient(x - size/3, y - size/3, 0, x, y, size);
        hl.addColorStop(0, 'rgba(255,255,255,0.2)'); hl.addColorStop(1, 'transparent');
        ctx.fillStyle = hl; ctx.fill();
        ctx.globalAlpha = 1;

        // Labels at zoom
        if (globalScale > 1.2 && isHighlighted) {
            const fontSize = Math.max(10 / globalScale, 3);
            ctx.font = fontSize + 'px Inter, sans-serif';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = '#e8e8f0';
            ctx.fillText(node.id, x, y + size + fontSize + 2);
            if (globalScale > 2) {
                ctx.fillStyle = pColor;
                ctx.font = (fontSize * 0.8) + 'px JetBrains Mono, monospace';
                ctx.fillText('P' + node.priority, x, y);
            }
        }
    })
    .nodePointerAreaPaint((n, c, ctx) => {
        if (n.x === undefined || n.y === undefined || !isFinite(n.x) || !isFinite(n.y)) return;
        const size = getNodeSize(n) + 4;
        ctx.fillStyle = c; ctx.beginPath(); ctx.arc(n.x, n.y, size, 0, 2 * Math.PI); ctx.fill();
    })
    .onNodeClick(handleNodeClick)
    .onNodeRightClick((node, event) => { event.preventDefault(); showContextMenu(node, event); })
    .onNodeHover(handleNodeHover)
    .onBackgroundClick(() => { clearSelection(); hideContextMenu(); hideHoverPanel(); })
    .onBackgroundRightClick(() => hideContextMenu());

// Hover handling with golden glow and detail panel
function handleNodeHover(node) {
    hoveredNode = node;
    container.style.cursor = node ? 'pointer' : 'grab';
    if (node) {
        highlightedNodes = getConnectedNodes(node.id, 2);
        showHoverPanel(node);
    } else {
        highlightedNodes = new Set();
        hideHoverPanel();
    }
    Graph.nodeColor(Graph.nodeColor()); // Trigger re-render
    Graph.linkColor(Graph.linkColor());
    Graph.linkWidth(Graph.linkWidth());
}

// Panel mode: 'docked' (left sidebar) or 'floating' (center overlay)
let panelMode = 'docked';

// Populate panel content for a given prefix (hover- or docked-)
function populatePanelContent(prefix, node) {
    document.getElementById(prefix + 'id').textContent = node.id;
    document.getElementById(prefix + 'title').textContent = node.title;

    // Type badge
    const typeBadge = document.getElementById(prefix + 'type-badge');
    typeBadge.textContent = node.type || 'task';
    typeBadge.className = 'hover-type-badge badge-' + (node.type || 'task');

    // Badges
    const badgesEl = document.getElementById(prefix + 'badges');
    badgesEl.innerHTML = '';
    const addBadge = (cls, text) => { const b = document.createElement('span'); b.className = 'badge ' + cls; b.textContent = text; badgesEl.appendChild(b); };
    addBadge('badge-' + node.status, node.status.replace('_', ' '));
    addBadge('', 'P' + node.priority);
    if (node.is_articulation) addBadge('badge-articulation', 'Cut Vertex');
    if (node.slack === 0) addBadge('badge-critical', 'Critical Path');
    (node.labels || []).forEach(l => addBadge('badge-type', l));

    // Description
    const descSection = document.getElementById(prefix + 'description');
    if (node.description) {
        descSection.style.display = 'block';
        document.getElementById(prefix + 'description-content').innerHTML = marked.parse(node.description);
    } else { descSection.style.display = 'none'; }

    // Design
    const designSection = document.getElementById(prefix + 'design');
    if (node.design) {
        designSection.style.display = 'block';
        document.getElementById(prefix + 'design-content').innerHTML = marked.parse(node.design);
    } else { designSection.style.display = 'none'; }

    // Acceptance Criteria
    const acSection = document.getElementById(prefix + 'acceptance');
    if (node.acceptance_criteria) {
        acSection.style.display = 'block';
        document.getElementById(prefix + 'acceptance-content').innerHTML = marked.parse(node.acceptance_criteria);
    } else { acSection.style.display = 'none'; }

    // Notes
    const notesSection = document.getElementById(prefix + 'notes');
    if (node.notes) {
        notesSection.style.display = 'block';
        document.getElementById(prefix + 'notes-content').innerHTML = marked.parse(node.notes);
    } else { notesSection.style.display = 'none'; }

    // Metadata
    const metaEl = document.getElementById(prefix + 'meta');
    metaEl.innerHTML = '';
    const addMeta = (label, value) => {
        if (!value) return;
        metaEl.innerHTML += '<div class="hover-meta-item"><span class="hover-meta-label">' + label + '</span><span class="hover-meta-value">' + value + '</span></div>';
    };
    addMeta('Assignee', node.assignee);
    addMeta('Created', node.created_at);
    addMeta('Updated', node.updated_at);
    addMeta('Due Date', node.due_date);
    if (node.closed_at) addMeta('Closed', node.closed_at);

    // Blocked By
    const blockedBySection = document.getElementById(prefix + 'blocked-by');
    const blockedByList = document.getElementById(prefix + 'blocked-by-list');
    if (node.blocked_by && node.blocked_by.length > 0) {
        blockedBySection.style.display = 'block';
        blockedByList.innerHTML = node.blocked_by.map(id => '<span class="hover-dep-chip" data-id="' + id + '">' + id + '</span>').join('');
    } else { blockedBySection.style.display = 'none'; }

    // Blocks
    const blocksSection = document.getElementById(prefix + 'blocks');
    const blocksList = document.getElementById(prefix + 'blocks-list');
    if (node.blocks && node.blocks.length > 0) {
        blocksSection.style.display = 'block';
        blocksList.innerHTML = node.blocks.map(id => '<span class="hover-dep-chip" data-id="' + id + '">' + id + '</span>').join('');
    } else { blocksSection.style.display = 'none'; }

    // Commits
    const commitsSection = document.getElementById(prefix + 'commits');
    const commitsList = document.getElementById(prefix + 'commits-list');
    if (node.commits && node.commits.length > 0) {
        commitsSection.style.display = 'block';
        commitsList.innerHTML = node.commits.slice(0, 5).map(c => '<div class="hover-commit"><span class="hover-commit-sha">' + c.short_sha + '</span> <span class="hover-commit-msg">' + (c.message || '').split('\\n')[0].substring(0, 60) + '</span></div>').join('');
    } else { commitsSection.style.display = 'none'; }

    // Metrics
    const metricsEl = document.getElementById(prefix + 'metrics');
    metricsEl.innerHTML = '';
    const addMetric = (label, value) => {
        metricsEl.innerHTML += '<div class="hover-meta-item"><span class="hover-meta-label">' + label + '</span><span class="hover-meta-value">' + value + '</span></div>';
    };
    const fmt = (v, d) => (v != null && isFinite(v)) ? v.toFixed(d) : '-';
    addMetric('PageRank', fmt(node.pagerank * 100, 3) + '%');
    addMetric('PR Rank', '#' + (node.pagerank_rank || '-'));
    addMetric('Betweenness', fmt(node.betweenness, 4));
    addMetric('BW Rank', '#' + (node.betweenness_rank || '-'));
    addMetric('Critical Path', fmt(node.critical_path, 1));
    addMetric('Slack', fmt(node.slack, 1));
    addMetric('In-Degree', node.in_degree ?? '-');
    addMetric('Out-Degree', node.out_degree ?? '-');
}

// Wire up dep chip clicks for a container
function wireDepChips(container) {
    container.querySelectorAll('.hover-dep-chip').forEach(chip => {
        chip.onclick = () => {
            const targetId = chip.dataset.id;
            const graphNodes = Graph.graphData().nodes;
            const target = graphNodes.find(n => n.id === targetId);
            if (target) {
                Graph.centerAt(target.x, target.y, 500);
                Graph.zoom(2.5, 500);
                setTimeout(() => showHoverPanel(target), 600);
            }
        };
    });
}

// Show full details panel (docked or floating based on mode)
function showHoverPanel(node) {
    if (panelMode === 'docked') {
        // Update docked panel
        populatePanelContent('docked-', node);
        document.getElementById('docked-panel').classList.add('visible');
        document.getElementById('docked-no-selection').style.display = 'none';
        wireDepChips(document.getElementById('docked-panel'));
    } else {
        // Update floating panel
        populatePanelContent('hover-', node);
        document.getElementById('hover-panel').classList.add('visible');
        wireDepChips(document.getElementById('hover-panel'));
    }
}

function hideHoverPanel() {
    if (panelMode === 'docked') {
        document.getElementById('docked-panel').classList.remove('visible');
        document.getElementById('docked-no-selection').style.display = 'flex';
    } else {
        document.getElementById('hover-panel').classList.remove('visible');
    }
}

// Toggle between docked and floating modes
function togglePanelMode() {
    const detachBtn = document.getElementById('btn-detach');
    const sidebar = document.getElementById('detail-sidebar');

    if (panelMode === 'docked') {
        panelMode = 'floating';
        sidebar.classList.add('collapsed');
        detachBtn.innerHTML = '<span>‚á≤</span> Dock';
        detachBtn.title = 'Dock panel to left side (D)';
        // Show floating panel if we have a hovered node
        if (hoveredNode) {
            populatePanelContent('hover-', hoveredNode);
            document.getElementById('hover-panel').classList.add('visible');
            wireDepChips(document.getElementById('hover-panel'));
        }
    } else {
        panelMode = 'docked';
        sidebar.classList.remove('collapsed');
        detachBtn.innerHTML = '<span>‚á±</span> Detach';
        detachBtn.title = 'Detach panel to float (D)';
        document.getElementById('hover-panel').classList.remove('visible');
        // Show docked panel if we have a hovered node
        if (hoveredNode) {
            populatePanelContent('docked-', hoveredNode);
            document.getElementById('docked-panel').classList.add('visible');
            document.getElementById('docked-no-selection').style.display = 'none';
            wireDepChips(document.getElementById('docked-panel'));
        }
    }
}

document.getElementById('btn-detach').onclick = togglePanelMode;
document.getElementById('hover-close').onclick = () => document.getElementById('hover-panel').classList.remove('visible');

let selectedNode = null;
function selectNode(node) {
    selectedNode = node;
    showHoverPanel(node);
    document.getElementById('detail-id').textContent = node.id;
    document.getElementById('detail-name').textContent = node.title;
    const prioEl = document.getElementById('detail-priority');
    prioEl.textContent = 'P' + node.priority;
    prioEl.style.background = PRIORITY_COLORS[node.priority];
    prioEl.style.color = node.priority <= 1 ? 'white' : '#0f0f1a';
    const badgesEl = document.getElementById('detail-badges');
    badgesEl.innerHTML = '';
    const sb = document.createElement('span'); sb.className = 'badge badge-' + node.status; sb.textContent = node.status.replace('_', ' '); badgesEl.appendChild(sb);
    const tb = document.createElement('span'); tb.className = 'badge badge-' + (node.type || 'task'); tb.textContent = node.type || 'task'; badgesEl.appendChild(tb);
    const fmtSide = (v, d) => (v != null && isFinite(v)) ? v.toFixed(d) : '-';
    document.getElementById('m-pagerank').textContent = fmtSide(node.pagerank * 100, 2) + '%';
    document.getElementById('m-prrank').textContent = '#' + (node.pagerank_rank || '-');
    document.getElementById('m-between').textContent = fmtSide(node.betweenness, 4);
    document.getElementById('m-bwrank').textContent = '#' + (node.betweenness_rank || '-');
    document.getElementById('m-critical').textContent = fmtSide(node.critical_path, 1);
    const slackEl = document.getElementById('m-slack');
    slackEl.textContent = fmtSide(node.slack, 1);
    slackEl.className = 'metric-value' + (node.slack === 0 ? ' highlight' : '');
    document.getElementById('m-indeg').textContent = node.in_degree ?? '-';
    document.getElementById('m-outdeg').textContent = node.out_degree ?? '-';
    document.getElementById('node-detail').classList.add('visible');
    document.getElementById('no-selection').style.display = 'none';
}

function clearSelection() {
    selectedNode = null;
    highlightedNodes = new Set();
    document.getElementById('node-detail').classList.remove('visible');
    document.getElementById('no-selection').style.display = 'block';
    Graph.nodeColor(Graph.nodeColor());
    Graph.linkColor(Graph.linkColor());
}

// Full-text search
let searchDebounce = null;
document.getElementById('search-input').oninput = e => {
    clearTimeout(searchDebounce);
    searchDebounce = setTimeout(() => performSearch(e.target.value), 150);
};

function performSearch(query) {
    const resultsEl = document.getElementById('search-results');
    if (!query || query.length < 2) {
        resultsEl.classList.remove('visible');
        applyFilters();
        return;
    }
    const q = query.toLowerCase();
    const matches = DATA.nodes.filter(n => {
        return n.id.toLowerCase().includes(q) ||
               n.title.toLowerCase().includes(q) ||
               (n.description || '').toLowerCase().includes(q) ||
               (n.design || '').toLowerCase().includes(q) ||
               (n.notes || '').toLowerCase().includes(q) ||
               (n.acceptance_criteria || '').toLowerCase().includes(q) ||
               (n.labels || []).some(l => l.toLowerCase().includes(q)) ||
               (n.assignee || '').toLowerCase().includes(q);
    }).slice(0, 8);

    if (matches.length === 0) {
        resultsEl.innerHTML = '<div class="search-result-item">No results found</div>';
    } else {
        resultsEl.innerHTML = matches.map(n => {
            let preview = '';
            const fields = [n.description, n.design, n.notes, n.acceptance_criteria];
            for (const f of fields) {
                if (f && f.toLowerCase().includes(q)) {
                    const idx = f.toLowerCase().indexOf(q);
                    const start = Math.max(0, idx - 30);
                    const end = Math.min(f.length, idx + q.length + 50);
                    preview = '...' + f.substring(start, end).replace(new RegExp(q, 'gi'), '<mark>$&</mark>') + '...';
                    break;
                }
            }
            return '<div class="search-result-item" data-id="' + n.id + '">' +
                   '<div class="search-result-id">' + n.id + ' <span class="badge badge-' + n.status + '">' + n.status + '</span></div>' +
                   '<div class="search-result-title">' + n.title + '</div>' +
                   (preview ? '<div class="search-result-preview">' + preview + '</div>' : '') +
                   '</div>';
        }).join('');
    }
    resultsEl.classList.add('visible');

    resultsEl.querySelectorAll('.search-result-item[data-id]').forEach(item => {
        item.onclick = () => {
            const id = item.dataset.id;
            const graphNodes = Graph.graphData().nodes;
            const node = graphNodes.find(n => n.id === id);
            if (node) {
                selectNode(node);
                Graph.centerAt(node.x, node.y, 500);
                Graph.zoom(2.5, 500);
            }
            resultsEl.classList.remove('visible');
            document.getElementById('search-input').value = '';
        };
    });
}

// Close search on click outside
document.addEventListener('click', e => {
    if (!e.target.closest('.search-container')) {
        document.getElementById('search-results').classList.remove('visible');
    }
});

// Context menu
let contextNode = null;
function showContextMenu(node, event) {
    contextNode = node;
    const menu = document.getElementById('context-menu');
    menu.style.left = event.clientX + 'px';
    menu.style.top = event.clientY + 'px';
    menu.classList.add('visible');
}
function hideContextMenu() { document.getElementById('context-menu').classList.remove('visible'); contextNode = null; }
document.getElementById('ctx-focus').onclick = () => { if (contextNode) { Graph.centerAt(contextNode.x, contextNode.y, 500); Graph.zoom(3, 500); } hideContextMenu(); };
document.getElementById('ctx-details').onclick = () => { if (contextNode) showHoverPanel(contextNode); hideContextMenu(); };
document.getElementById('ctx-deps').onclick = () => { if (contextNode) highlightDependencies(contextNode, 'deps'); hideContextMenu(); };
document.getElementById('ctx-dependents').onclick = () => { if (contextNode) highlightDependencies(contextNode, 'dependents'); hideContextMenu(); };
document.getElementById('ctx-connected').onclick = () => {
    if (contextNode) {
        highlightedNodes = getConnectedNodes(contextNode.id, 3);
        Graph.nodeColor(Graph.nodeColor());
        Graph.linkColor(Graph.linkColor());
        showToast(highlightedNodes.size + ' connected nodes highlighted');
    }
    hideContextMenu();
};
document.getElementById('ctx-copy').onclick = () => { if (contextNode) { navigator.clipboard.writeText(contextNode.id); showToast('Copied: ' + contextNode.id); } hideContextMenu(); };
document.getElementById('ctx-path').onclick = () => { showToast('Click another node to find path'); pathStartNode = contextNode; hideContextMenu(); };

let pathStartNode = null;
function findPath(startId, endId) {
    const queue = [[startId]];
    const visited = new Set([startId]);
    while (queue.length > 0) {
        const path = queue.shift();
        const current = path[path.length - 1];
        if (current === endId) return path;
        DATA.links.forEach(l => {
            const src = typeof l.source === 'object' ? l.source.id : l.source;
            const tgt = typeof l.target === 'object' ? l.target.id : l.target;
            if (src === current && !visited.has(tgt)) { visited.add(tgt); queue.push([...path, tgt]); }
            if (tgt === current && !visited.has(src)) { visited.add(src); queue.push([...path, src]); }
        });
    }
    return null;
}

function highlightPath(path) {
    highlightedNodes = new Set(path);
    Graph.nodeColor(Graph.nodeColor());
    Graph.linkColor(Graph.linkColor());
    updateVisibleCount();
    showToast('Path: ' + path.length + ' nodes');
}

function handleNodeClick(node) {
    if (pathStartNode) {
        const path = findPath(pathStartNode.id, node.id);
        if (path) highlightPath(path);
        else showToast('No path found');
        pathStartNode = null;
    } else {
        selectNode(node);
    }
}

function highlightDependencies(node, type) {
    const connected = new Set([node.id]);
    DATA.links.forEach(l => {
        const src = typeof l.source === 'object' ? l.source.id : l.source;
        const tgt = typeof l.target === 'object' ? l.target.id : l.target;
        if (type === 'deps' && src === node.id) connected.add(tgt);
        if (type === 'dependents' && tgt === node.id) connected.add(src);
    });
    highlightedNodes = connected;
    Graph.nodeColor(Graph.nodeColor());
    Graph.linkColor(Graph.linkColor());
    updateVisibleCount();
    showToast(connected.size + ' nodes shown');
}

// Filters
let statusFilter = '', typeFilter = '';
let currentVisibilityFilter = () => true;
document.getElementById('filter-status').onchange = e => { statusFilter = e.target.value; applyFilters(); };
document.getElementById('filter-type').onchange = e => { typeFilter = e.target.value; applyFilters(); };

function applyFilters() {
    const searchVal = document.getElementById('search-input').value.toLowerCase();
    currentVisibilityFilter = n => {
        const matchSearch = !searchVal || n.id.toLowerCase().includes(searchVal) || n.title.toLowerCase().includes(searchVal);
        const matchStatus = !statusFilter || n.status === statusFilter;
        const matchType = !typeFilter || n.type === typeFilter;
        return matchSearch && matchStatus && matchType;
    };
    Graph.nodeVisibility(currentVisibilityFilter);
    updateVisibleCount();
}

function updateVisibleCount() {
    const count = DATA.nodes.filter(n => currentVisibilityFilter(n)).length;
    document.getElementById('stat-visible').innerHTML = '<span class="stat-value">' + count + '</span> visible';
}

// View mode
document.getElementById('view-mode').onchange = e => {
    const mode = e.target.value;
    Graph.dagMode(mode === 'force' ? null : mode);
    setTimeout(() => Graph.zoomToFit(400), 100);
};

// Size metric
document.getElementById('size-by').onchange = e => {
    sizeMetric = e.target.value;
    document.getElementById('heatmap-metric').textContent = { pagerank: 'PageRank', betweenness: 'Betweenness', critical: 'Critical Path', indegree: 'In-Degree' }[sizeMetric];
    Graph.nodeVal(n => getNodeSize(n));
    if (heatmapMode) Graph.nodeColor(n => getHeatmapColor(n));
};

// Controls
document.getElementById('btn-fit').onclick = () => Graph.zoomToFit(400, 50);
document.getElementById('btn-reset').onclick = () => {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-type').value = '';
    document.getElementById('search-input').value = '';
    document.getElementById('view-mode').value = 'force';
    document.getElementById('size-by').value = 'pagerank';
    statusFilter = ''; typeFilter = ''; sizeMetric = 'pagerank'; heatmapMode = false;
    highlightedNodes = new Set();
    Graph.dagMode(null); Graph.nodeVisibility(() => true); Graph.nodeVal(n => getNodeSize(n));
    Graph.nodeColor(n => STATUS_COLORS[n.status] || '#555577');
    Graph.linkColor(l => l.critical ? '#ec489980' : '#44475a40');
    clearSelection(); hideHoverPanel(); Graph.zoomToFit(400, 50); updateVisibleCount();
    document.getElementById('heatmap-legend').classList.remove('heatmap-active');
    document.getElementById('top-nodes-panel').classList.remove('visible');
    document.getElementById('triage-panel').style.display = 'none';
    document.getElementById('btn-heatmap').classList.remove('active');
    document.getElementById('btn-triage').classList.remove('active');
    document.getElementById('btn-top').classList.remove('active');
};

// Heatmap toggle - legend always visible, toggle controls coloring mode
document.getElementById('btn-heatmap').onclick = () => {
    heatmapMode = !heatmapMode;
    document.getElementById('btn-heatmap').classList.toggle('active', heatmapMode);
    document.getElementById('heatmap-legend').classList.toggle('heatmap-active', heatmapMode);
    Graph.nodeColor(n => heatmapMode ? getHeatmapColor(n) : STATUS_COLORS[n.status] || '#555577');
};

// Triage panel
document.getElementById('btn-triage').onclick = () => {
    const panel = document.getElementById('triage-panel');
    const btn = document.getElementById('btn-triage');
    const visible = panel.style.display === 'none';
    panel.style.display = visible ? 'block' : 'none';
    btn.classList.toggle('active', visible);
    if (visible && DATA.triage && DATA.triage.recommendations) {
        const list = document.getElementById('triage-list');
        list.innerHTML = DATA.triage.recommendations.slice(0, 5).map(r => {
            const score = (r.score != null && isFinite(r.score)) ? r.score.toFixed(2) : '-';
            const reason = (r.reasons && r.reasons.length > 0) ? r.reasons[0] : '';
            return '<div class="triage-item" data-id="' + (r.id || '') + '">' +
                '<div class="triage-item-header"><span class="triage-item-id">' + (r.id || '-') + '</span><span class="triage-item-score">' + score + '</span></div>' +
                '<div class="triage-item-title">' + (r.title || '') + '</div>' +
                '<div class="triage-item-reason">' + reason + '</div></div>';
        }).join('');
        list.querySelectorAll('.triage-item').forEach(item => {
            item.onclick = () => {
                const graphNodes = Graph.graphData().nodes;
                const node = graphNodes.find(n => n.id === item.dataset.id);
                if (node) { selectNode(node); Graph.centerAt(node.x, node.y, 500); Graph.zoom(2.5, 500); }
            };
        });
    }
};

// Top nodes panel
document.getElementById('btn-top').onclick = () => {
    const panel = document.getElementById('top-nodes-panel');
    const visible = panel.classList.toggle('visible');
    document.getElementById('btn-top').classList.toggle('active', visible);
    if (visible) {
        const sorted = [...DATA.nodes].sort((a, b) => (b.pagerank || 0) - (a.pagerank || 0)).slice(0, 10);
        panel.innerHTML = sorted.map((n, i) => '<div class="top-node-item" data-id="' + n.id + '"><span class="rank">#' + (i+1) + '</span><span>' + n.id + '</span></div>').join('');
        panel.querySelectorAll('.top-node-item').forEach(el => {
            el.onclick = () => {
                const graphNodes = Graph.graphData().nodes;
                const node = graphNodes.find(n => n.id === el.dataset.id);
                if (node) { selectNode(node); Graph.centerAt(node.x, node.y, 500); Graph.zoom(2.5, 500); }
            };
        });
    }
};

// Fullscreen
document.getElementById('btn-fullscreen').onclick = () => {
    if (!document.fullscreenElement) container.requestFullscreen();
    else document.exitFullscreen();
};

// Toast
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg; toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), 2500);
}

// Light/Dark mode toggle
let isDarkMode = true;
function toggleLightMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('light-mode', !isDarkMode);
    const btn = document.getElementById('btn-theme');
    btn.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
    btn.title = isDarkMode ? 'Switch to light mode (L)' : 'Switch to dark mode (L)';
    localStorage.setItem('bv-graph-theme', isDarkMode ? 'dark' : 'light');
}

// Recently viewed nodes
const recentlyViewed = [];
const MAX_RECENT = 8;
function addToRecent(node) {
    const idx = recentlyViewed.findIndex(n => n.id === node.id);
    if (idx > -1) recentlyViewed.splice(idx, 1);
    recentlyViewed.unshift({ id: node.id, title: node.title });
    if (recentlyViewed.length > MAX_RECENT) recentlyViewed.pop();
    updateRecentPanel();
}
function updateRecentPanel() {
    const list = document.getElementById('recent-list');
    list.innerHTML = recentlyViewed.map(n =>
        '<div class="recent-item" data-id="' + n.id + '"><span class="recent-id">' + n.id + '</span></div>'
    ).join('');
    list.querySelectorAll('.recent-item').forEach(el => {
        el.onclick = () => {
            const graphNodes = Graph.graphData().nodes;
            const node = graphNodes.find(n => n.id === el.dataset.id);
            if (node) { selectNode(node); Graph.centerAt(node.x, node.y, 500); Graph.zoom(2.5, 500); }
        };
    });
}
document.getElementById('btn-recent').onclick = () => {
    const panel = document.getElementById('recent-panel');
    const visible = panel.classList.toggle('visible');
    document.getElementById('btn-recent').classList.toggle('active', visible);
};

// Path finder mode
let pathFinderMode = false;
let pathFinderStart = null;
function togglePathFinder() {
    pathFinderMode = !pathFinderMode;
    document.getElementById('btn-path').classList.toggle('active', pathFinderMode);
    document.getElementById('pathfinder-banner').classList.toggle('visible', pathFinderMode);
    if (!pathFinderMode) { pathFinderStart = null; }
    else if (selectedNode) { pathFinderStart = selectedNode; showToast('Now click destination node'); }
}
document.getElementById('btn-path').onclick = togglePathFinder;

// BFS for shortest path
function bfsPath(startId, endId) {
    const links = DATA.links;
    const adj = {};
    links.forEach(l => {
        const s = typeof l.source === 'object' ? l.source.id : l.source;
        const t = typeof l.target === 'object' ? l.target.id : l.target;
        if (!adj[s]) adj[s] = [];
        if (!adj[t]) adj[t] = [];
        adj[s].push(t);
        adj[t].push(s); // Undirected for path finding
    });
    const queue = [[startId]];
    const visited = new Set([startId]);
    while (queue.length > 0) {
        const path = queue.shift();
        const node = path[path.length - 1];
        if (node === endId) return path;
        for (const neighbor of (adj[node] || [])) {
            if (!visited.has(neighbor)) {
                visited.add(neighbor);
                queue.push([...path, neighbor]);
            }
        }
    }
    return null;
}

// Help overlay
function toggleHelp() {
    document.getElementById('help-overlay').classList.toggle('visible');
}
document.getElementById('btn-help').onclick = toggleHelp;
document.getElementById('help-close').onclick = toggleHelp;
document.getElementById('help-overlay').onclick = e => { if (e.target.id === 'help-overlay') toggleHelp(); };

// Priority filter
let priorityFilter = '';
document.getElementById('filter-priority').onchange = e => {
    priorityFilter = e.target.value;
    applyFilters();
};

// Label filter - populate from data
const allLabels = new Set();
DATA.nodes.forEach(n => (n.labels || []).forEach(l => allLabels.add(l)));
const labelSelect = document.getElementById('filter-label');
[...allLabels].sort().forEach(l => {
    const opt = document.createElement('option');
    opt.value = l; opt.textContent = l;
    labelSelect.appendChild(opt);
});
let labelFilter = '';
labelSelect.onchange = e => {
    labelFilter = e.target.value;
    applyFilters();
};

// Combined filter function
function applyFilters() {
    Graph.nodeVisibility(n => {
        if (statusFilter && n.status !== statusFilter) return false;
        if (typeFilter && n.type !== typeFilter) return false;
        if (priorityFilter && n.priority !== parseInt(priorityFilter)) return false;
        if (labelFilter && !(n.labels || []).includes(labelFilter)) return false;
        return true;
    });
    updateVisibleCount();
}

// Override existing filter handlers to use combined function
document.getElementById('filter-status').onchange = e => { statusFilter = e.target.value; applyFilters(); };
document.getElementById('filter-type').onchange = e => { typeFilter = e.target.value; applyFilters(); };

// Mini-map
const minimapCanvas = document.getElementById('minimap-canvas');
const minimapCtx = minimapCanvas.getContext('2d');
function updateMinimap() {
    const nodes = Graph.graphData().nodes;
    if (nodes.length === 0) return;
    const bounds = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity };
    nodes.forEach(n => {
        if (n.x != null && n.y != null) {
            bounds.minX = Math.min(bounds.minX, n.x);
            bounds.maxX = Math.max(bounds.maxX, n.x);
            bounds.minY = Math.min(bounds.minY, n.y);
            bounds.maxY = Math.max(bounds.maxY, n.y);
        }
    });
    const padding = 20;
    const w = minimapCanvas.width = 160;
    const h = minimapCanvas.height = 120;
    const scaleX = (w - padding * 2) / (bounds.maxX - bounds.minX || 1);
    const scaleY = (h - padding * 2) / (bounds.maxY - bounds.minY || 1);
    const scale = Math.min(scaleX, scaleY);
    minimapCtx.fillStyle = isDarkMode ? '#1a1a2e' : '#f0f2f5';
    minimapCtx.fillRect(0, 0, w, h);
    nodes.forEach(n => {
        if (n.x == null || n.y == null) return;
        const x = padding + (n.x - bounds.minX) * scale;
        const y = padding + (n.y - bounds.minY) * scale;
        minimapCtx.fillStyle = STATUS_COLORS[n.status] || '#555577';
        minimapCtx.beginPath();
        minimapCtx.arc(x, y, 2, 0, Math.PI * 2);
        minimapCtx.fill();
    });
}
setInterval(updateMinimap, 2000);

// LocalStorage preferences
function loadPreferences() {
    const theme = localStorage.getItem('bv-graph-theme');
    if (theme === 'light') { isDarkMode = false; toggleLightMode(); toggleLightMode(); }
    const layout = localStorage.getItem('bv-graph-layout');
    if (layout) {
        document.getElementById('view-mode').value = layout;
        Graph.dagMode(layout === 'force' ? null : layout);
    }
}
document.getElementById('view-mode').addEventListener('change', e => {
    localStorage.setItem('bv-graph-layout', e.target.value);
});

// Keyboard shortcuts
document.onkeydown = e => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key === '?') { toggleHelp(); return; }
    switch(e.key.toLowerCase()) {
        case 'f': Graph.zoomToFit(400, 50); break;
        case 'r': document.getElementById('btn-reset').click(); break;
        case 'escape':
            if (pathFinderMode) { pathFinderMode = false; pathFinderStart = null; document.getElementById('pathfinder-banner').classList.remove('visible'); document.getElementById('btn-path').classList.remove('active'); }
            else { clearSelection(); hideHoverPanel(); highlightedNodes = new Set(); Graph.nodeColor(Graph.nodeColor()); }
            break;
        case ' ': e.preventDefault(); document.getElementById('btn-fullscreen').click(); break;
        case 'h': document.getElementById('btn-heatmap').click(); break;
        case 't': document.getElementById('btn-top').click(); break;
        case 'g': document.getElementById('btn-triage').click(); break;
        case 'd': togglePanelMode(); break;
        case 'l': toggleLightMode(); break;
        case 'y': document.getElementById('btn-recent').click(); break;
        case 'p': togglePathFinder(); break;
        case '1': document.getElementById('view-mode').value = 'force'; Graph.dagMode(null); localStorage.setItem('bv-graph-layout', 'force'); break;
        case '2': document.getElementById('view-mode').value = 'td'; Graph.dagMode('td'); localStorage.setItem('bv-graph-layout', 'td'); break;
        case '3': document.getElementById('view-mode').value = 'lr'; Graph.dagMode('lr'); localStorage.setItem('bv-graph-layout', 'lr'); break;
        case '4': document.getElementById('view-mode').value = 'radialout'; Graph.dagMode('radialout'); localStorage.setItem('bv-graph-layout', 'radialout'); break;
    }
};

// Wire up theme button
document.getElementById('btn-theme').onclick = toggleLightMode;

// Load preferences and initial fit
loadPreferences();
setTimeout(() => { Graph.zoomToFit(400, 50); updateVisibleCount(); updateMinimap(); }, 800);
    </script>
</body>
</html>